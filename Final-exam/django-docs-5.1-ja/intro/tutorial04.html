<!DOCTYPE html>

<html lang="ja" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>はじめての Django アプリ作成、その 4 &#8212; Django 5.1.6.dev20250122212402 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=34bb78ad" />
    <link rel="stylesheet" type="text/css" href="../_static/default.css?v=bf4d74af" />
    <script src="../_static/documentation_options.js?v=d2885b0a"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=4755f45a"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="はじめての Django アプリ作成、その 5" href="tutorial05.html" />
    <link rel="prev" title="はじめての Django アプリ作成、その 3" href="tutorial03.html" />



 
<script src="../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../index.html">Django 5.1.6.dev20250122212402 ドキュメント</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../index.html">Home</a>  |
        <a title="Table of contents" href="../contents.html">Table of contents</a>  |
        <a title="Global index" href="../genindex.html">Index</a>  |
        <a title="Module index" href="../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="tutorial03.html" title="はじめての Django アプリ作成、その 3">previous</a>
     |
    <a href="index.html" title="さぁ始めましょう" accesskey="U">up</a>
   |
    <a href="tutorial05.html" title="はじめての Django アプリ作成、その 5">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="intro-tutorial04">
            
  <section id="s-writing-your-first-django-app-part-4">
<span id="writing-your-first-django-app-part-4"></span><h1>はじめての Django アプリ作成、その 4<a class="headerlink" href="#writing-your-first-django-app-part-4" title="Link to this heading">¶</a></h1>
<p>このチュートリアルは <a class="reference internal" href="tutorial03.html"><span class="doc">チュートリアルその 3</span></a> の続きです。ここでは、引き続きWeb投票アプリケーションの開発を例にして、簡単なフォー ム処理とコードの縮小化を中心に解説します。</p>
<div class="admonition-where-to-get-help admonition">
<p class="admonition-title">困ったときは:</p>
<p>このチュートリアルの実行に問題がある場合は、FAQ の <a class="reference internal" href="../faq/help.html"><span class="doc">Getting Help</span></a> セクションに進んでください。</p>
</div>
<section id="s-write-a-minimal-form">
<span id="write-a-minimal-form"></span><h2>簡単なフォームを書く<a class="headerlink" href="#write-a-minimal-form" title="Link to this heading">¶</a></h2>
<p>それでは、前回のチュートリアルで作成した投票詳細テンプレート (&quot;polls/detail.html&quot;) を更新して、HTML の <code class="docutils literal notranslate"><span class="pre">&lt;form&gt;</span></code> 要素を入れましょう。</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">polls/templates/polls/detail.html</span></code></span><a class="headerlink" href="#id1" title="Link to this code">¶</a></div>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">action</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;polls:vote&#39;</span> <span class="nv">question.id</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
<span class="p">&lt;</span><span class="nt">fieldset</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">legend</span><span class="p">&gt;&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">question.question_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;&lt;/</span><span class="nt">legend</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">error_message</span> <span class="cp">%}</span><span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">error_message</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;&lt;/</span><span class="nt">p</span><span class="p">&gt;</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">question.choice_set.all</span> <span class="cp">%}</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;radio&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;choice&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;choice</span><span class="cp">{{</span> <span class="nb">forloop</span><span class="nv">.counter</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">choice.id</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;choice</span><span class="cp">{{</span> <span class="nb">forloop</span><span class="nv">.counter</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">choice.choice_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;&lt;</span><span class="nt">br</span><span class="p">&gt;</span>
    <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="p">&lt;/</span><span class="nt">fieldset</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Vote&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<p>簡単に説明:</p>
<ul class="simple">
<li><p>上のテンプレートは、各質問の選択肢のラジオボタンを表示するものです。各ラジオボタンの <code class="docutils literal notranslate"><span class="pre">value</span></code> は、関連する質問の選択肢のIDです。各ラジオボタンの <code class="docutils literal notranslate"><span class="pre">name</span></code> は <code class="docutils literal notranslate"><span class="pre">&quot;choice&quot;</span></code> です。つまり、投票者がラジオボタンの1つを選択し、フォームを送信すると、POSTデータ <code class="docutils literal notranslate"><span class="pre">choice=#</span></code> （#は選んだ選択肢のID）が送信されます。これは、HTMLフォームの基本的な概念です。</p></li>
<li><p>フォームの <code class="docutils literal notranslate"><span class="pre">action</span></code> を <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">url</span> <span class="pre">'polls:vote'</span> <span class="pre">question.id</span> <span class="pre">%}</span></code> に設定し、<code class="docutils literal notranslate"><span class="pre">method=&quot;post&quot;</span></code> を指定しています。 (<code class="docutils literal notranslate"><span class="pre">method=&quot;get&quot;</span></code> ではなく) <code class="docutils literal notranslate"><span class="pre">method=&quot;post&quot;</span></code> を使用することは非常に重要です。なぜなら、フォームの送信はサーバ側のデータの更新につながるからです。サーバ側のデータを更新するフォームを作成する場合は、<code class="docutils literal notranslate"><span class="pre">method=&quot;post&quot;</span></code> を使いましょう。これは、 Django 固有のものではなく、いわばウェブ開発の王道です。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">forloop.counter</span></code> は、 <a class="reference internal" href="../ref/templates/builtins.html#std-templatetag-for"><code class="xref std std-ttag docutils literal notranslate"><span class="pre">for</span></code></a> タグのループが何度実行されたかを表す値です。</p></li>
<li><p>(データを改ざんされる恐れのある) POST フォームを作成しているので、クロスサイトリクエストフォージェリを気にする必要があります。ありがたいことに、 Django にはそれに対処するための便利な仕組みがあるので、あまり心配する必要はありません。簡単に言うと、自サイト内の URL を対象とする POST フォームにはすべて、 <a class="reference internal" href="../ref/templates/builtins.html#std-templatetag-csrf_token"><code class="xref std std-ttag docutils literal notranslate"><span class="pre">{%</span> <span class="pre">csrf_token</span> <span class="pre">%}</span></code></a> テンプレートタグを使うべきです。</p></li>
</ul>
<p>送信されたデータを処理するための Django のビューを作成しましょう。 <a class="reference internal" href="tutorial03.html"><span class="doc">チュートリアルその 3</span></a> で、以下のような投票アプリケーションの URLconf を作成したことを思い出しましょう:</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">polls/urls.py</span></code></span><a class="headerlink" href="#id2" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">path</span><span class="p">(</span><span class="s2">&quot;&lt;int:question_id&gt;/vote/&quot;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vote&quot;</span><span class="p">),</span>
</pre></div>
</div>
</div>
<p>このとき、 <code class="docutils literal notranslate"><span class="pre">vote()</span></code> 関数のダミー実装も作成しました。今度は本物を実装しましょう。以下を <code class="docutils literal notranslate"><span class="pre">polls/views.py</span></code> に追加してください:</p>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">polls/views.py</span></code></span><a class="headerlink" href="#id3" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>


<span class="c1"># ...</span>
<span class="k">def</span><span class="w"> </span><span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">selected_choice</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s2">&quot;choice&quot;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="c1"># Redisplay the question voting form.</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span>
            <span class="n">request</span><span class="p">,</span>
            <span class="s2">&quot;polls/detail.html&quot;</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span>
                <span class="s2">&quot;error_message&quot;</span><span class="p">:</span> <span class="s2">&quot;You didn&#39;t select a choice.&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">votes</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;votes&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1"># Always return an HttpResponseRedirect after successfully dealing</span>
        <span class="c1"># with POST data. This prevents data from being posted twice if a</span>
        <span class="c1"># user hits the Back button.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;polls:results&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">question</span><span class="o">.</span><span class="n">id</span><span class="p">,)))</span>
</pre></div>
</div>
</div>
<p>このコードには、これまでのチュートリアルで扱っていなかったことがいくつか入っています:</p>
<ul>
<li><p><a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.POST</span></code></a> は辞書のようなオブジェクトです。キーを指定すると、送信したデータにアクセスできます。この場合、 <code class="docutils literal notranslate"><span class="pre">request.POST['choice']</span></code> は、選択された選択肢の ID を文字列として返します。 <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.POST</span></code></a> の値は常に文字列です。</p>
<p>Django では、同じ方法で GET データにアクセスするために <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.GET" title="django.http.HttpRequest.GET"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.GET</span></code></a> も提供しています。ただし、このコードでは、POST 呼び出し以外でデータが更新されないようにするために、<a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal notranslate"><span class="pre">request.POST</span></code></a> を明示的に使っています。</p>
</li>
<li><p>POST データに <code class="docutils literal notranslate"><span class="pre">choice</span></code> がなければ、 <code class="docutils literal notranslate"><span class="pre">request.POST['choice']</span></code> は <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">KeyError</span></code></a> を送出します。上のコードでは <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#KeyError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">KeyError</span></code></a> をチェックし、 <code class="docutils literal notranslate"><span class="pre">choice</span></code> がない場合にはエラーメッセージ付きの質問フォームを再表示します。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">F(&quot;votes&quot;)</span> <span class="pre">+</span> <span class="pre">1</span></code> は、 <a class="reference internal" href="../ref/models/expressions.html#avoiding-race-conditions-using-f"><span class="std std-ref">データベースに投票数を 1 増やすよう指示します</span></a> 。</p></li>
<li><p>choice のカウントをインクリメントした後、このコードは、  通常の <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a> ではなく <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponseRedirect</span></code></a> を返します。 <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponseRedirect</span></code></a> はひとつの引数（リダイレクト先のURL）をとります  (この場合にURLをどう構築するかについては、以下のポイントを参照してください)。</p>
<p>上記の Python コメントが指摘するように、POST データが成功した後は常に <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponseRedirect</span></code></a> を返す必要があります。これは Django 固有のものではなく、Web開発における良いプラクティスです。</p>
</li>
<li><p>この例では、 <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponseRedirect</span></code></a> コンストラクタの中で <a class="reference internal" href="../ref/urlresolvers.html#django.urls.reverse" title="django.urls.reverse"><code class="xref py py-func docutils literal notranslate"><span class="pre">reverse()</span></code></a> 関数を使用しています。この関数を使うと、ビュー関数中での URL のハードコードを防げます。関数には、制御を渡したいビューの名前と、そのビューに与える URL パターンの位置引数を与えます。この例では、 <a class="reference internal" href="tutorial03.html"><span class="doc">チュートリアルその 3</span></a> で設定した URLconf を使っているので、 <a class="reference internal" href="../ref/urlresolvers.html#django.urls.reverse" title="django.urls.reverse"><code class="xref py py-func docutils literal notranslate"><span class="pre">reverse()</span></code></a> を呼ぶと、次のような文字列が返ってきます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;/polls/3/results/&quot;</span>
</pre></div>
</div>
<p>この <code class="docutils literal notranslate"><span class="pre">3</span></code> は <code class="docutils literal notranslate"><span class="pre">question.id</span></code> の値です。 リダイレクト先の URL は <code class="docutils literal notranslate"><span class="pre">'results'</span></code> ビューを呼び出し、最終的なページを表示します。</p>
</li>
</ul>
<p><a class="reference internal" href="tutorial03.html"><span class="doc">チュートリアルその 3</span></a> で触れたように、 <code class="docutils literal notranslate"><span class="pre">request</span></code> は <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a> オブジェクトです。 <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a> オブジェクトの詳細は <a class="reference internal" href="../ref/request-response.html"><span class="doc">リクエスト・レスポンスオブジェクトのドキュメント</span></a> を参照してください。</p>
<p>誰かが質問に投票すると、 <code class="docutils literal notranslate"><span class="pre">vote()</span></code> ビューは質問の結果ページにリダイレクトします。このビューを書いてみましょう。</p>
<div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">polls/views.py</span></code></span><a class="headerlink" href="#id4" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>


<span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">question_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;polls/results.html&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;question&quot;</span><span class="p">:</span> <span class="n">question</span><span class="p">})</span>
</pre></div>
</div>
</div>
<p><a class="reference internal" href="tutorial03.html"><span class="doc">チュートリアルその 3</span></a> の <code class="docutils literal notranslate"><span class="pre">detail()</span></code> とほぼ同じです。テンプレートの名前のみ違います。この冗長さは後で修正することにします。</p>
<p>次に <code class="docutils literal notranslate"><span class="pre">polls/results.html</span></code> テンプレートを作成します:</p>
<div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">polls/templates/polls/results.html</span></code></span><a class="headerlink" href="#id5" title="Link to this code">¶</a></div>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">question.question_text</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">question.choice_set.all</span> <span class="cp">%}</span>
    <span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">choice.choice_text</span> <span class="cp">}}</span> -- <span class="cp">{{</span> <span class="nv">choice.votes</span> <span class="cp">}}</span> vote<span class="cp">{{</span> <span class="nv">choice.votes</span><span class="o">|</span><span class="nf">pluralize</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;polls:detail&#39;</span> <span class="nv">question.id</span> <span class="cp">%}</span><span class="s">&quot;</span><span class="p">&gt;</span>Vote again?<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>
</div>
<p>ブラウザで <code class="docutils literal notranslate"><span class="pre">/polls/1/</span></code> を表示して投票してみましょう。票を入れるたびに、結果のページが更新されていることがわかるはずです。選択肢を選ばずにフォームを送信すると、エラーメッセージを表示されるはずです。</p>
</section>
<section id="s-use-generic-views-less-code-is-better">
<span id="use-generic-views-less-code-is-better"></span><h2>汎用ビューを使う: コードが少ないのはいいことだ<a class="headerlink" href="#use-generic-views-less-code-is-better" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">detail()</span></code> ( <a class="reference internal" href="tutorial03.html"><span class="doc">チュートリアルその 3</span></a> ) と <code class="docutils literal notranslate"><span class="pre">results()</span></code> ビューはとても簡単で、先程も述べたように冗長です。投票の一覧を表示する <code class="docutils literal notranslate"><span class="pre">index()</span></code> ビューも同様です。</p>
<p>これらのビューは基本的な Web開発の一般的なケースを表します。すなわち、 URL を介して渡されたパラメータに従ってデータベースからデータを取り出し、テンプレートをロードして、レンダリングしたテンプレートを返します。これはきわめてよくあることなので、 Django では、汎用ビュー（generic view）というショートカットを提供しています。</p>
<p>汎用ビューは一般的なパターンを抽象化し、Pythonコードを書かなくてもアプリを実装できるようになっています。例えば、 <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal notranslate"><span class="pre">ListView</span></code></a> と <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetailView</span></code></a> は、それぞれ「オブジェクトの一覧を表示する」「特定のオブジェクトの詳細ページを表示する」という概念を抽象化したものです。</p>
<p>これまで作成してきた poll アプリを汎用ビューシステムに変換して、 コードをばっさり捨てられるようにしましょう。変換にはほんの数ステップしかか かりません。そのステップは:</p>
<ol class="arabic simple">
<li><p>URLconf を変換する。</p></li>
<li><p>古い不要なビューを削除する。</p></li>
<li><p>新しいビューに Djangoの汎用ビューを設定する。</p></li>
</ol>
<p>詳しく見てゆきましょう。</p>
<div class="admonition-why-the-code-shuffle admonition">
<p class="admonition-title">なぜコードを入れ換えるの？</p>
<p>一般に Django アプリケーションを書く場合は、まず自分の問題を解決するために汎用ビューが適しているか考えた上で、最初から汎用ビューを使い、途中まで書き上げたコードをリファクタすることはありません。ただ、このチュートリアルでは中核となるコンセプトに焦点を合わせるために、わざと「大変な」ビューの作成に集中してもらったのです。</p>
<p>電卓を使う前に、算数の基本を知っておかねばならないのと同じです。</p>
</div>
<section id="s-amend-urlconf">
<span id="amend-urlconf"></span><h3>URLconf の修正<a class="headerlink" href="#amend-urlconf" title="Link to this heading">¶</a></h3>
<p>まず、 URLconf の <code class="docutils literal notranslate"><span class="pre">polls/urls.py</span></code> を開き、次のように変更します:</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">polls/urls.py</span></code></span><a class="headerlink" href="#id6" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">views</span>

<span class="n">app_name</span> <span class="o">=</span> <span class="s2">&quot;polls&quot;</span>
<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">IndexView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">&quot;&lt;int:pk&gt;/&quot;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;detail&quot;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">&quot;&lt;int:pk&gt;/results/&quot;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">ResultsView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;results&quot;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">&quot;&lt;int:question_id&gt;/vote/&quot;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;vote&quot;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<p>2番目と3番目のパターンのパス文字列にマッチしたパターンの名前が、 &lt;question_id&gt; から &lt;pk&gt; に変わっていることに注意してください。こうする必要があるのは、この後 <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetailView</span></code></a> という汎用ビューを使って <code class="docutils literal notranslate"><span class="pre">detail()</span></code> と <code class="docutils literal notranslate"><span class="pre">results()</span></code> ビューを置き換えますが、このビューではURLから取得したプライマリーキーの値を <code class="docutils literal notranslate"><span class="pre">&quot;pk&quot;</span></code> として扱うためです。</p>
</section>
<section id="s-amend-views">
<span id="amend-views"></span><h3>views の修正<a class="headerlink" href="#amend-views" title="Link to this heading">¶</a></h3>
<p>次に、古い <code class="docutils literal notranslate"><span class="pre">index</span></code> 、 <code class="docutils literal notranslate"><span class="pre">detail</span></code> 、と <code class="docutils literal notranslate"><span class="pre">results</span></code> のビューを削除し、代わりに Django の汎用ビューを使用します。これを行うには、 <code class="docutils literal notranslate"><span class="pre">polls/views.py</span></code> ファイルを開き、次のように変更します:</p>
<div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">polls/views.py</span></code></span><a class="headerlink" href="#id7" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponseRedirect</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views</span><span class="w"> </span><span class="kn">import</span> <span class="n">generic</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Question</span>


<span class="k">class</span><span class="w"> </span><span class="nc">IndexView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;polls/index.html&quot;</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s2">&quot;latest_question_list&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the last five published questions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Question</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-pub_date&quot;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DetailView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;polls/detail.html&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ResultsView</span><span class="p">(</span><span class="n">generic</span><span class="o">.</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Question</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;polls/results.html&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">question_id</span><span class="p">):</span>
    <span class="c1"># same as above, no changes needed.</span>
    <span class="o">...</span>
</pre></div>
</div>
</div>
<p>それぞれの汎用ビューには、どのモデルに対して動作するかを認識させる必要があります。これは(<code class="docutils literal notranslate"><span class="pre">DetailView</span></code> と <code class="docutils literal notranslate"><span class="pre">ResultsView</span></code> の <code class="docutils literal notranslate"><span class="pre">model</span> <span class="pre">=</span> <span class="pre">Question</span></code> のように) <code class="docutils literal notranslate"><span class="pre">model</span></code> 属性を指定するか、( <code class="docutils literal notranslate"><span class="pre">IndexView</span></code> のように) <a class="reference internal" href="../ref/class-based-views/mixins-multiple-object.html#django.views.generic.list.MultipleObjectMixin.get_queryset" title="django.views.generic.list.MultipleObjectMixin.get_queryset"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_queryset()</span></code></a> 関数を定義することで実現できます。</p>
<p>デフォルトでは、 <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetailView</span></code></a> 汎用ビューは <code class="docutils literal notranslate"><span class="pre">&lt;app</span> <span class="pre">name&gt;/&lt;model</span> <span class="pre">name&gt;_detail.html</span></code> という名前のテンプレートを使います。この場合、テンプレートの名前は <code class="docutils literal notranslate"><span class="pre">&quot;polls/question_detail.html&quot;</span></code> です。 <code class="docutils literal notranslate"><span class="pre">template_name</span></code> 属性を指定すると、自動生成されたデフォルトのテンプレート名ではなく、指定したテンプレート名を使うように Django に伝えることができます。また、 <code class="docutils literal notranslate"><span class="pre">results</span></code> リストビューにも <code class="docutils literal notranslate"><span class="pre">template_name</span></code> を指定します。これによって、 結果ビューと詳細ビューをレンダリングしたとき、（裏側ではどちらも <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetailView</span></code></a> ですが）それぞれ違った見た目になります。</p>
<p>同様に、 <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal notranslate"><span class="pre">ListView</span></code></a> 汎用ビューは <code class="docutils literal notranslate"><span class="pre">&lt;app</span> <span class="pre">name&gt;/&lt;model</span> <span class="pre">name&gt;_list.html</span></code> というデフォルトのテンプレートを使うので、 <code class="docutils literal notranslate"><span class="pre">template_name</span></code> を使って <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal notranslate"><span class="pre">ListView</span></code></a> に既存の <code class="docutils literal notranslate"><span class="pre">&quot;polls/index.html&quot;</span></code> テンプレートを使用するように伝えます。</p>
<p>このチュートリアルの前の部分では、 <code class="docutils literal notranslate"><span class="pre">question</span></code> や <code class="docutils literal notranslate"><span class="pre">latest_question_list</span></code> といったコンテキスト変数が含まれるコンテキストをテンプレートに渡していました。<code class="docutils literal notranslate"><span class="pre">DetailView</span></code> には <code class="docutils literal notranslate"><span class="pre">question</span></code> という変数が自動的に渡されます。なぜなら、 Django モデル (<code class="docutils literal notranslate"><span class="pre">Question</span></code>) を使用していて、 Django はコンテキスト変数にふさわしい名前を決めることができるからです。一方で、 ListView では、自動的に生成されるコンテキスト変数は <code class="docutils literal notranslate"><span class="pre">question_list</span></code> になります。これを上書きするには、 <code class="docutils literal notranslate"><span class="pre">context_object_name</span></code> 属性を与え、 <code class="docutils literal notranslate"><span class="pre">latest_question_list</span></code> を代わりに使用すると指定します。この代替アプローチとして、テンプレートのほうを変えて、新しいデフォルトのコンテキスト変数の名前と一致させることもできます。しかし、使用したい変数名を Django に伝えるだけのほうが簡単でしょう。</p>
<p>サーバを実行して、新しく汎用ビューベースにした投票アプリケーションを使ってみましょう。</p>
<p>汎用ビューの詳細は、<a class="reference internal" href="../topics/class-based-views/index.html"><span class="doc">汎用ビューのドキュメント</span></a> を参照してください。</p>
<p>フォームや汎用ビューを使いこなせるようになったら、 <a class="reference internal" href="tutorial05.html"><span class="doc">チュートリアルその5</span></a> に進んで、投票アプリのテストについて学びましょう。</p>
</section>
</section>
</section>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../contents.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">はじめての Django アプリ作成、その 4</a><ul>
<li><a class="reference internal" href="#write-a-minimal-form">簡単なフォームを書く</a></li>
<li><a class="reference internal" href="#use-generic-views-less-code-is-better">汎用ビューを使う: コードが少ないのはいいことだ</a><ul>
<li><a class="reference internal" href="#amend-urlconf">URLconf の修正</a></li>
<li><a class="reference internal" href="#amend-views">views の修正</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="tutorial03.html"
                          title="前の章へ">はじめての Django アプリ作成、その 3</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="tutorial05.html"
                          title="次の章へ">はじめての Django アプリ作成、その 5</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/intro/tutorial04.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">1月 22, 2025</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="tutorial03.html" title="はじめての Django アプリ作成、その 3">previous</a>
     |
    <a href="index.html" title="さぁ始めましょう" accesskey="U">up</a>
   |
    <a href="tutorial05.html" title="はじめての Django アプリ作成、その 5">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>