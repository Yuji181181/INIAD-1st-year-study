<!DOCTYPE html>

<html lang="ja" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>データベースアクセスの最適化 &#8212; Django 5.1.6.dev20250122212402 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=34bb78ad" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css?v=bf4d74af" />
    <script src="../../_static/documentation_options.js?v=d2885b0a"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=4755f45a"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="データベースの計測" href="instrumentation.html" />
    <link rel="prev" title="テーブル空間（tablespace）" href="tablespaces.html" />



 
<script src="../../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../../index.html">Django 5.1.6.dev20250122212402 ドキュメント</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../../index.html">Home</a>  |
        <a title="Table of contents" href="../../contents.html">Table of contents</a>  |
        <a title="Global index" href="../../genindex.html">Index</a>  |
        <a title="Module index" href="../../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="tablespaces.html" title="テーブル空間（tablespace）">previous</a>
     |
    <a href="../index.html" title="Django を使う" accesskey="U">up</a>
   |
    <a href="instrumentation.html" title="データベースの計測">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="topics-db-optimization">
            
  <section id="s-database-access-optimization">
<span id="database-access-optimization"></span><h1>データベースアクセスの最適化<a class="headerlink" href="#database-access-optimization" title="Link to this heading">¶</a></h1>
<p>Djangoのデータベース層は、開発者がデータベースを最大限活用できるように、さまざまな方法を提供しています。このドキュメントでは、データベースアクセスを最適化する際にとるべき手順を、大まかにいくつかの見出しとしてまとめています。それぞれの見出しの下に、関連するドキュメントへのリンクを集約した上で、さまざまなヒントを追加しています。</p>
<section id="s-profile-first">
<span id="profile-first"></span><h2>まずはプロファイルを取る<a class="headerlink" href="#profile-first" title="Link to this heading">¶</a></h2>
<p>一般的なプログラミングの習慣として、これは言うまでもありません。 <a class="reference internal" href="../../faq/models.html#faq-see-raw-sql-queries"><span class="std std-ref">どんなクエリを実行しているか、それにどれくらいのコストがかかっているかを確認してください</span></a> 。特定の <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> がデータベースによってどのように実行されるのかを理解するには、 <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.explain" title="django.db.models.query.QuerySet.explain"><code class="xref py py-meth docutils literal notranslate"><span class="pre">QuerySet.explain()</span></code></a> を使用してください。また、 <a class="extlink-pypi reference external" href="https://pypi.org/project/django-debug-toolbar/">django-debug-toolbar</a> のような外部プロジェクトや、データベースを直接監視するツールを使用するのも良いでしょう。</p>
<p>要件に従って、速度またはメモリ、およびその両方を最適化できます。片方を最適化することは、もう片方に悪影響を及ぼすことがありますが、互いに助けになることもあります。また、データベースプロセスによって行われる処理と Python のプロセスによる処理は (あなたにとって) 必ずしも同等のコストとはなりません。その優先順位とバランスを決めるのはあなた自身です。そして、その設計はアプリケーションやサーバーに依存するため、要求通りに設計するのもあなたの仕事です。</p>
<p>以下で紹介する項目すべてにおいて、あらゆる変更の後に忘れずに分析を行い、施した変更が有益だったこと、およびその恩恵が可読性の低下を十分上回ることを確認してください。以下の <strong>すべて</strong> の提案において、一般的な原則があなたの状況に当てはまらない可能性があること、それどころか逆効果になりかねない可能性さえあることに十分注意してください。</p>
</section>
<section id="s-use-standard-db-optimization-techniques">
<span id="use-standard-db-optimization-techniques"></span><h2>標準的な DB 最適化のテクニックを使う<a class="headerlink" href="#use-standard-db-optimization-techniques" title="Link to this heading">¶</a></h2>
<p>以下のようなものが上げられます:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://en.wikipedia.org/wiki/Database_index">Indexes</a>. プロファイリングでどのようなインデックスを追加すべきかを決定した <em>後に</em> 、最優先事項として行うべきことです。Djangoからインデックスを追加するには、 <a class="reference internal" href="../../ref/models/options.html#django.db.models.Options.indexes" title="django.db.models.Options.indexes"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Meta.indexes</span></code></a> や <a class="reference internal" href="../../ref/models/fields.html#django.db.models.Field.db_index" title="django.db.models.Field.db_index"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Field.db_index</span></code></a> を使用します。 <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">filter()</span></code></a> 、 <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.exclude" title="django.db.models.query.QuerySet.exclude"><code class="xref py py-meth docutils literal notranslate"><span class="pre">exclude()</span></code></a> 、 <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">order_by()</span></code></a> などで頻繁に参照するフィールドにインデックスを追加することで、参照を高速化させることができるかもしれません。ただし、最適なインデックスの決定は、各個のアプリケーションのデータベースに依存する複雑な問題であることに留意してください。インデックスを維持するためのオーバーヘッドは、クエリの高速化によるメリットよりも大きいかもしれません。</p></li>
</ul>
<ul class="simple">
<li><p>フィールドタイプの適切な使用。</p></li>
</ul>
<p>以降は、上記の明確な対処は実行済みだという前提で進めていきます。このドキュメントの残りの部分では、不要な作業をしなくて済むように、Django をどのように使えばいいかを中心に説明します。またこのドキュメントでは、<a class="reference internal" href="../cache.html"><span class="doc">汎用キャッシュ</span></a> のような高コストな最適化手法については説明しません。</p>
</section>
<section id="s-understand-querysets">
<span id="understand-querysets"></span><h2><code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> を理解する<a class="headerlink" href="#understand-querysets" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="../../ref/models/querysets.html"><span class="doc">QuerySet</span></a> を理解することは、シンプルなコードでパフォーマンスを上げるために極めて重要です。特に:</p>
<section id="s-understand-queryset-evaluation">
<span id="understand-queryset-evaluation"></span><h3><code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> の評価を理解する<a class="headerlink" href="#understand-queryset-evaluation" title="Link to this heading">¶</a></h3>
<p>パフォーマンスの問題を回避するには、以下を理解することが重要です:</p>
<ul class="simple">
<li><p><a class="reference internal" href="queries.html#querysets-are-lazy"><span class="std std-ref">QuerySet は遅延評価される</span></a> こと。</p></li>
<li><p><a class="reference internal" href="../../ref/models/querysets.html#when-querysets-are-evaluated"><span class="std std-ref">いつQuerySet が評価されるのか</span></a> 。</p></li>
<li><p>どのように <a class="reference internal" href="queries.html#caching-and-querysets"><span class="std std-ref">データがメモリ上に保持されるか</span></a>。</p></li>
</ul>
</section>
<section id="s-understand-cached-attributes">
<span id="understand-cached-attributes"></span><h3>キャッシュされる属性を理解する<a class="headerlink" href="#understand-cached-attributes" title="Link to this heading">¶</a></h3>
<p>クエリセット全体のキャッシュだけでなく、ORM オブジェクトの属性の結果のキャッシュもあります。通常、呼び出し可能でない属性はキャッシュされます。例えば、<a class="reference internal" href="aggregation.html#queryset-model-example"><span class="std std-ref">例のブログモデル</span></a> においても:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span><span class="o">.</span><span class="n">blog</span>  <span class="c1"># Blog object is retrieved at this point</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span><span class="o">.</span><span class="n">blog</span>  <span class="c1"># cached version, no DB access</span>
</pre></div>
</div>
<p>しかし、一般に、呼び出し可能な属性は毎回DBルックアップを引き起こします:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># query performed</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># query performed again</span>
</pre></div>
</div>
<p>テンプレート上のコードを読む際には注意が必要です。テンプレートシステムは括弧を許容していませんが、呼び出し可能なオブジェクトは自動的に呼び出されるので、上記の区別が隠れてしまいます。</p>
<p>独自のプロパティにも注意が必要です - 必要なときにキャッシングを実装するのはあなた次第です。たとえば <a class="reference internal" href="../../ref/utils.html#django.utils.functional.cached_property" title="django.utils.functional.cached_property"><code class="xref py py-class docutils literal notranslate"><span class="pre">cached_property</span></code></a> デコレータを使用します。</p>
</section>
<section id="s-use-the-with-template-tag">
<span id="use-the-with-template-tag"></span><h3><code class="docutils literal notranslate"><span class="pre">with</span></code> テンプレートタグを使用する<a class="headerlink" href="#use-the-with-template-tag" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> のキャッシュ処理を活用するため、<a class="reference internal" href="../../ref/templates/builtins.html#std-templatetag-with"><code class="xref std std-ttag docutils literal notranslate"><span class="pre">with</span></code></a> テンプレートタグの使用が推奨されます。</p>
</section>
<section id="s-use-iterator">
<span id="use-iterator"></span><h3><code class="docutils literal notranslate"><span class="pre">iterator()</span></code> を使用する<a class="headerlink" href="#use-iterator" title="Link to this heading">¶</a></h3>
<p>多くのオブジェクトを扱う際には、<code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> のキャッシュ動作に多くのメモリが使われる可能性があります。この場合、<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.iterator" title="django.db.models.query.QuerySet.iterator"><code class="xref py py-meth docutils literal notranslate"><span class="pre">iterator()</span></code></a> が有用です。</p>
</section>
<section id="s-use-explain">
<span id="use-explain"></span><h3><code class="docutils literal notranslate"><span class="pre">explain()</span></code> を使用する<a class="headerlink" href="#use-explain" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.explain" title="django.db.models.query.QuerySet.explain"><code class="xref py py-meth docutils literal notranslate"><span class="pre">QuerySet.explain()</span></code></a> を使うと、使用されているインデックスや結合など、データベースがクエリをどのように実行しているのか、詳細な情報を得られます。この詳細情報は、より効率的になるようにクエリを書き換えたり、パフォーマンスを向上させるために追加できるインデックスを特定するのに役立ちます。</p>
</section>
</section>
<section id="s-do-database-work-in-the-database-rather-than-in-python">
<span id="do-database-work-in-the-database-rather-than-in-python"></span><h2>データベースの仕事を Python ではなくデータベースに行わせる<a class="headerlink" href="#do-database-work-in-the-database-rather-than-in-python" title="Link to this heading">¶</a></h2>
<p>例えば:</p>
<ul class="simple">
<li><p>最も基本的なレベルでは、<a class="reference internal" href="../../ref/models/querysets.html#queryset-api"><span class="std std-ref">filter や exclude</span></a> を使ってデータベース内でフィルタリングを行います。</p></li>
<li><p><a class="reference internal" href="../../ref/models/expressions.html#django.db.models.F" title="django.db.models.F"><code class="xref py py-class docutils literal notranslate"><span class="pre">F</span> <span class="pre">式</span></code></a> を使い、同一モデル内で他のフィールドに基づくフィルタリングを行います。</p></li>
<li><p><a class="reference internal" href="aggregation.html"><span class="doc">データベース内の集計をするためアノテーション</span></a> を使います。</p></li>
</ul>
<p>必要な SQL を生成するのに不十分な場合は:</p>
<section id="s-use-rawsql">
<span id="use-rawsql"></span><h3><code class="docutils literal notranslate"><span class="pre">RawSQL</span></code> を使用する<a class="headerlink" href="#use-rawsql" title="Link to this heading">¶</a></h3>
<p>保守性は高くありませんが、より強力な方法は <a class="reference internal" href="../../ref/models/expressions.html#django.db.models.expressions.RawSQL" title="django.db.models.expressions.RawSQL"><code class="xref py py-class docutils literal notranslate"><span class="pre">RawSQL</span></code></a> 表現です。これにより、SQL を明示的にクエリに追加できます。これでもまだ不十分な場合は:</p>
</section>
<section id="s-use-raw-sql">
<span id="use-raw-sql"></span><h3>素の SQL を使用する<a class="headerlink" href="#use-raw-sql" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="sql.html"><span class="doc">モデルの取り出しおよび書き込みをするためのカスタム SQL</span></a> を記述します。<code class="docutils literal notranslate"><span class="pre">django.db.connection.queries</span></code> を使い、Django があなたのために何を書いているのかを理解して、そこから始めましょう。</p>
</section>
</section>
<section id="s-retrieve-individual-objects-using-a-unique-indexed-column">
<span id="retrieve-individual-objects-using-a-unique-indexed-column"></span><h2>ユニークかつインデックス済みの列を使用して個別のオブジェクトを取得する<a class="headerlink" href="#retrieve-individual-objects-using-a-unique-indexed-column" title="Link to this heading">¶</a></h2>
<p>個々のオブジェクトを取得するために <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.get" title="django.db.models.query.QuerySet.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get()</span></code></a> を使用する際に、<a class="reference internal" href="../../ref/models/fields.html#django.db.models.Field.unique" title="django.db.models.Field.unique"><code class="xref py py-attr docutils literal notranslate"><span class="pre">unique</span></code></a> や <a class="reference internal" href="../../ref/models/fields.html#django.db.models.Field.db_index" title="django.db.models.Field.db_index"><code class="xref py py-attr docutils literal notranslate"><span class="pre">db_index</span></code></a> を持つカラムを使用する理由は2つあります。まず、データベースインデックスによりクエリが高速になります。また、ルックアップに一致するオブジェクトが複数ある場合、クエリは非常に遅くなる可能性があります。カラムに一意の制約を持つことで、これが決して起こらないことが保証されます。</p>
<p>例えば、<a class="reference internal" href="aggregation.html#queryset-model-example"><span class="std std-ref">例のブログモデル</span></a> を使うと:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>上記は以下よりも高速です:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;News Item Title&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>これは、<code class="docutils literal notranslate"><span class="pre">id</span></code> がデータベースによってインデックス化されていて、ユニークだと保証されているからです。</p>
<p>以下のようにすると非常に遅くなる恐れがあります:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">entry</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">headline__startswith</span><span class="o">=</span><span class="s2">&quot;News&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>まず第一に、<code class="docutils literal notranslate"><span class="pre">headline</span></code> はインデックス化されておらず、データベースのデータ取り出しを遅くします。</p>
<p>そして第二に、このルックアップでは単一のオブジェクトが返されることは保証されません。クエリが 1 つ以上のオブジェクトと一致する場合、すべてのオブジェクトをデータベースから取り出して転送します。この余分な負荷は、100 とか 1000 といった多量のレコードが返されるときには相当な量になります。データベースが複数のサーバーによって構成される場合、ネットワークのオーバーヘッドと待ち時間が発生するため、この負荷はさらに大きくなります。</p>
</section>
<section id="s-retrieve-everything-at-once-if-you-know-you-will-need-it">
<span id="retrieve-everything-at-once-if-you-know-you-will-need-it"></span><h2>必要なものが分かっているときは一度にすべてを取り出す<a class="headerlink" href="#retrieve-everything-at-once-if-you-know-you-will-need-it" title="Link to this heading">¶</a></h2>
<p>すべての部分を必要とする単一のデータセットの異なる部分に対してデータベースを何度もヒットするのは、一般的に、1 つのクエリですべてを取得するよりも非効率です。 これは、1 つのクエリだけが必要なときにループ内でクエリを実行し、その結果何度もデータベースクエリを実行することになってしまう場合に、特に重要となります。そこで:</p>
<section id="s-use-queryset-select-related-and-prefetch-related">
<span id="use-queryset-select-related-and-prefetch-related"></span><h3><code class="docutils literal notranslate"><span class="pre">QuerySet.select_related()</span></code> や <code class="docutils literal notranslate"><span class="pre">prefetch_related()</span></code> を使用する<a class="headerlink" href="#use-queryset-select-related-and-prefetch-related" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.select_related" title="django.db.models.query.QuerySet.select_related"><code class="xref py py-meth docutils literal notranslate"><span class="pre">select_related()</span></code></a> と <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.prefetch_related" title="django.db.models.query.QuerySet.prefetch_related"><code class="xref py py-meth docutils literal notranslate"><span class="pre">prefetch_related()</span></code></a> を徹底的に理解し、使用してください:</p>
<ul class="simple">
<li><p>必要に応じて、<a class="reference internal" href="managers.html"><span class="doc">マネージャとデフォルトマネージャ</span></a> の中で。マネージャが使用されているときと使用されていないときに注意してください; 誤りやすい部分なので、思い込みのないようにしてください。</p></li>
<li><p>ビューのコードや他のレイヤーの中で。必要に応じて <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.prefetch_related_objects" title="django.db.models.prefetch_related_objects"><code class="xref py py-func docutils literal notranslate"><span class="pre">prefetch_related_objects()</span></code></a> が利用できます。</p></li>
</ul>
</section>
</section>
<section id="s-don-t-retrieve-things-you-don-t-need">
<span id="don-t-retrieve-things-you-don-t-need"></span><h2>必要ないものを取り出さない<a class="headerlink" href="#don-t-retrieve-things-you-don-t-need" title="Link to this heading">¶</a></h2>
<section id="s-use-queryset-values-and-values-list">
<span id="use-queryset-values-and-values-list"></span><h3><code class="docutils literal notranslate"><span class="pre">QuerySet.values()</span></code> や <code class="docutils literal notranslate"><span class="pre">values_list()</span></code> を使用する<a class="headerlink" href="#use-queryset-values-and-values-list" title="Link to this heading">¶</a></h3>
<p>単に値の <code class="docutils literal notranslate"><span class="pre">dict</span></code> や <code class="docutils literal notranslate"><span class="pre">list</span></code> がほしいだけで ORM モデルオブジェクトが必要ないときは、<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">values()</span></code></a> を適切に使用してください。テンプレートのコード内で、モデルオブジェクトを置き換えるのに役立ちます - 辞書がテンプレートで使われているものと同じ属性を持っている限り問題ありません。</p>
</section>
<section id="s-use-queryset-defer-and-only">
<span id="use-queryset-defer-and-only"></span><h3><code class="docutils literal notranslate"><span class="pre">QuerySet.defer()</span></code> や <code class="docutils literal notranslate"><span class="pre">only()</span></code> を使用する<a class="headerlink" href="#use-queryset-defer-and-only" title="Link to this heading">¶</a></h3>
<p>データベースに不要な(もしくはほとんど必要とされない)列がある場合は、それらを読み込むことを防ぐために、 <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">defer()</span></code></a> や <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.only" title="django.db.models.query.QuerySet.only"><code class="xref py py-meth docutils literal notranslate"><span class="pre">only()</span></code></a> を使用します。もし除外した列を <em>使用する</em> 場合、ORMは異なるクエリでそれらを取得する必要があるため、不適切な使用はパフォーマンスの低下を招くことに注意してください。</p>
<p>プロファイリングなしに、あまり積極的にフィールドの遅延を行わないようにしてください。たとえ、いくつかのカラムしか使用しないことになったとしても、データベースは結果の1行のために、非テキスト、非 <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> データのほとんどをディスクから読み込まなければならないからです。 <code class="docutils literal notranslate"><span class="pre">defer()</span></code> と <code class="docutils literal notranslate"><span class="pre">only()</span></code> メソッドは、多くのテキストデータの読み込みを避けられる場合や、Python に戻すのに多くの処理が必要なフィールドに対して最も有効なメソッドです。いつものように、まずはプロファイルを作成し、次に最適化を行ってください。</p>
</section>
<section id="s-use-queryset-contains-obj">
<span id="use-queryset-contains-obj"></span><h3><code class="docutils literal notranslate"><span class="pre">QuerySet.contains(obj)</span></code> を使用する<a class="headerlink" href="#use-queryset-contains-obj" title="Link to this heading">¶</a></h3>
<p>...単に <code class="docutils literal notranslate"><span class="pre">obj</span></code> がクエリセットに存在するかどうかを知りたいだけなら、 <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">obj</span> <span class="pre">in</span> <span class="pre">queryset</span></code> よりも適切です。</p>
</section>
<section id="s-use-queryset-count">
<span id="use-queryset-count"></span><h3><code class="docutils literal notranslate"><span class="pre">QuerySet.count()</span></code> を使用する<a class="headerlink" href="#use-queryset-count" title="Link to this heading">¶</a></h3>
<p>...単に数を知りたいだけなら、 <code class="docutils literal notranslate"><span class="pre">len(queryset)</span></code> よりも適切です。</p>
</section>
<section id="s-use-queryset-exists">
<span id="use-queryset-exists"></span><h3><code class="docutils literal notranslate"><span class="pre">QuerySet.exists()</span></code> を使用する<a class="headerlink" href="#use-queryset-exists" title="Link to this heading">¶</a></h3>
<p>...単に1つ以上の結果が存在するかどうかを知りたいだけなら、 <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">queryset</span></code> よりも適切です。</p>
<p>しかし:</p>
</section>
<section id="s-don-t-overuse-contains-count-and-exists">
<span id="s-overuse-of-count-and-exists"></span><span id="don-t-overuse-contains-count-and-exists"></span><span id="overuse-of-count-and-exists"></span><h3><code class="docutils literal notranslate"><span class="pre">contains()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">count()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">exists()</span></code> を使いすぎない<a class="headerlink" href="#don-t-overuse-contains-count-and-exists" title="Link to this heading">¶</a></h3>
<p>もしクエリセットの他のデータが必要になったときは、すぐに評価を行います。</p>
<p>例えば、 <code class="docutils literal notranslate"><span class="pre">User</span></code> と多対多の関連をもつ <code class="docutils literal notranslate"><span class="pre">Group</span></code> モデルを考えたとき、以下のコードが最適です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">members</span> <span class="o">=</span> <span class="n">group</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<span class="k">if</span> <span class="n">display_group_members</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">members</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">current_user</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You and&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;other users are members of this group.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">members</span><span class="p">),</span> <span class="s2">&quot;members in this group.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">member</span> <span class="ow">in</span> <span class="n">members</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">member</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are no members in this group.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>最適である理由:</p>
<ol class="arabic simple">
<li><p>クエリセットは遅延評価されるので、 <code class="docutils literal notranslate"><span class="pre">display_group_members</span></code> が <code class="docutils literal notranslate"><span class="pre">False</span></code> の場合、データベースクエリは発行されない</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">members</span></code> 変数に <code class="docutils literal notranslate"><span class="pre">group.members.all()</span></code> を格納することで、クエリ結果のキャッシュを再利用できる。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">members:</span></code> の行は <code class="docutils literal notranslate"><span class="pre">QuerySet.__bool__()</span></code> を呼び出すことになり、その結果、データベースで <code class="docutils literal notranslate"><span class="pre">group.members.all()</span></code> クエリが実行される。もし結果が無ければ <code class="docutils literal notranslate"><span class="pre">False</span></code> を返し、結果があれば <code class="docutils literal notranslate"><span class="pre">True</span></code> を返す。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">current_user</span> <span class="pre">in</span> <span class="pre">members:</span></code> の行は、結果のキャッシュにユーザーが含まれるかどうかを確認するので、新たなデータベースクエリは発行されない。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">len(members)</span></code> を使用することで <code class="docutils literal notranslate"><span class="pre">QuerySet.__len__()</span></code> が呼び出される。このとき、結果のキャッシュが再利用されるので、新たなデータベースクエリは発行されない。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">for</span> <span class="pre">member</span></code> は結果のキャッシュを繰り返し処理する。</p></li>
</ol>
<p>このコードは合計で、データベースクエリを1回または0回実行します。ここで行った唯一の意図的な最適化は、 <code class="docutils literal notranslate"><span class="pre">members</span></code> 変数を使用することです。もし <code class="docutils literal notranslate"><span class="pre">if</span></code> に対して <code class="docutils literal notranslate"><span class="pre">QuerySet.exists()</span></code> を使用したり、<code class="docutils literal notranslate"><span class="pre">in</span></code> に対して <code class="docutils literal notranslate"><span class="pre">QuerySet.contains()</span></code> を使用したり、<code class="docutils literal notranslate"><span class="pre">count</span></code> に対して <code class="docutils literal notranslate"><span class="pre">QuerySet.count()</span></code> を使用したりした場合、それぞれ追加のクエリが発生します。</p>
</section>
<section id="s-use-queryset-update-and-delete">
<span id="use-queryset-update-and-delete"></span><h3><code class="docutils literal notranslate"><span class="pre">QuerySet.update()</span></code> や <code class="docutils literal notranslate"><span class="pre">delete()</span></code> を使用する<a class="headerlink" href="#use-queryset-update-and-delete" title="Link to this heading">¶</a></h3>
<p>複数のオブジェクトを読み込んで値を設定し、それらを個別に保存するのではなく、<a class="reference internal" href="queries.html#topics-db-queries-update"><span class="std std-ref">QuerySet.update()</span></a> を用いてSQLの一括UPDATE文を使用してください。同様に、可能であれば <a class="reference internal" href="queries.html#topics-db-queries-delete"><span class="std std-ref">一括削除</span></a> を使用してください。</p>
<p>ただし、これらの一括更新メソッドは、個々のインスタンスの <code class="docutils literal notranslate"><span class="pre">save()</span></code> や <code class="docutils literal notranslate"><span class="pre">delete()</span></code> メソッドを呼び出すことはできないので、通常のデータベースオブジェクト <a class="reference internal" href="../../ref/signals.html"><span class="doc">シグナル</span></a> に由来するものを含め、これらのメソッドに追加した独自の処理は実行されないことに注意してください。</p>
</section>
<section id="s-use-foreign-key-values-directly">
<span id="use-foreign-key-values-directly"></span><h3>外部キーの値を直接使用する<a class="headerlink" href="#use-foreign-key-values-directly" title="Link to this heading">¶</a></h3>
<p>外部キーの値だけが必要な場合は、関連するオブジェクト全体を取得してそのプライマリキーを取得するのではなく、すでに取得したオブジェクトにある外部キーの値を使います。つまり、次のように書きます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">entry</span><span class="o">.</span><span class="n">blog_id</span>
</pre></div>
</div>
<p>次のようには書かないようにします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">entry</span><span class="o">.</span><span class="n">blog</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>
</section>
<section id="s-don-t-order-results-if-you-don-t-care">
<span id="don-t-order-results-if-you-don-t-care"></span><h3>気にならないなら結果を並べ替えない<a class="headerlink" href="#don-t-order-results-if-you-don-t-care" title="Link to this heading">¶</a></h3>
<p>ソートには計算コストがかかります。データベースはソートする各フィールドに対して操作を行わなければなりません。モデルにデフォルトのソート順 (<a class="reference internal" href="../../ref/models/options.html#django.db.models.Options.ordering" title="django.db.models.Options.ordering"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Meta.ordering</span></code></a>) があり、それが不要な場合は、パラメータなしで <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.order_by" title="django.db.models.query.QuerySet.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">order_by()</span></code></a> を呼び出すことで <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> からそれを削除します。</p>
<p>データベースにインデックスを追加すると、並べ替えのパフォーマンスが向上する可能性があります。</p>
</section>
</section>
<section id="s-use-bulk-methods">
<span id="use-bulk-methods"></span><h2>一括メソッドを使用する<a class="headerlink" href="#use-bulk-methods" title="Link to this heading">¶</a></h2>
<p>SQL文の数を減らすために一括（bulk）メソッドを使用する</p>
<section id="s-create-in-bulk">
<span id="create-in-bulk"></span><h3>一括で作成する<a class="headerlink" href="#create-in-bulk" title="Link to this heading">¶</a></h3>
<p>オブジェクトを作成するとき、可能であれば <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.bulk_create" title="django.db.models.query.QuerySet.bulk_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">bulk_create()</span></code></a> を呼び出し、SQL文の数を減らしてください。例えば:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">Entry</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is a test&quot;</span><span class="p">),</span>
        <span class="n">Entry</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is only a test&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>...これは下記よりも適切です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is a test&quot;</span><span class="p">)</span>
<span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is only a test&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.bulk_create" title="django.db.models.query.QuerySet.bulk_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">このメソッド</span></code></a> には多くの注意事項があるので、自分のユースケースに適切であることを確認してください。</p>
</section>
<section id="s-update-in-bulk">
<span id="update-in-bulk"></span><h3>一括で更新する<a class="headerlink" href="#update-in-bulk" title="Link to this heading">¶</a></h3>
<p>オブジェクトを更新するとき、可能であれば <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.bulk_create" title="django.db.models.query.QuerySet.bulk_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">bulk_create()</span></code></a> を呼び出し、SQL文の数を減らしてください。次のようなオブジェクトのリストまたはクエリセットを考えます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">entries</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">Entry</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is a test&quot;</span><span class="p">),</span>
        <span class="n">Entry</span><span class="p">(</span><span class="n">headline</span><span class="o">=</span><span class="s2">&quot;This is only a test&quot;</span><span class="p">),</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>以下のような例を考えます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">headline</span> <span class="o">=</span> <span class="s2">&quot;This is not a test&quot;</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">headline</span> <span class="o">=</span> <span class="s2">&quot;This is no longer a test&quot;</span>
<span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_update</span><span class="p">(</span><span class="n">entries</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;headline&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p>...これは下記よりも適切です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">headline</span> <span class="o">=</span> <span class="s2">&quot;This is not a test&quot;</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">headline</span> <span class="o">=</span> <span class="s2">&quot;This is no longer a test&quot;</span>
<span class="n">entries</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.bulk_update" title="django.db.models.query.QuerySet.bulk_update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">このメソッド</span></code></a> には多くの注意事項があるので、自分のユースケースに適切であることを確認してください。</p>
</section>
<section id="s-insert-in-bulk">
<span id="insert-in-bulk"></span><h3>一括で挿入する<a class="headerlink" href="#insert-in-bulk" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="../../ref/models/fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><code class="xref py py-class docutils literal notranslate"><span class="pre">ManyToManyFields</span></code></a> にオブジェクトを追加するとき、可能であれば <a class="reference internal" href="../../ref/models/relations.html#django.db.models.fields.related.RelatedManager.add" title="django.db.models.fields.related.RelatedManager.add"><code class="xref py py-meth docutils literal notranslate"><span class="pre">add()</span></code></a> を呼び出し、SQL文の数を減らしてください。例えば:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">my_friend</span><span class="p">)</span>
</pre></div>
</div>
<p>...これは下記よりも適切です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
<span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">my_friend</span><span class="p">)</span>
</pre></div>
</div>
<p>... ここで、 <code class="docutils literal notranslate"><span class="pre">Bands</span></code> と <code class="docutils literal notranslate"><span class="pre">Artists</span></code> は多対多の関係です。</p>
<p><a class="reference internal" href="../../ref/models/fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><code class="xref py py-class docutils literal notranslate"><span class="pre">ManyToManyField</span></code></a> に異なるオブジェクトのペアを挿入する場合、またはカスタムの <a class="reference internal" href="../../ref/models/fields.html#django.db.models.ManyToManyField.through" title="django.db.models.ManyToManyField.through"><code class="xref py py-attr docutils literal notranslate"><span class="pre">through</span></code></a> テーブルが定義されている場合は、SQLクエリの数を減らすために <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.bulk_create" title="django.db.models.query.QuerySet.bulk_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">bulk_create()</span></code></a> メソッドを使用します。例えば以下のようにします：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PizzaToppingRelationship</span> <span class="o">=</span> <span class="n">Pizza</span><span class="o">.</span><span class="n">toppings</span><span class="o">.</span><span class="n">through</span>
<span class="n">PizzaToppingRelationship</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">bulk_create</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">PizzaToppingRelationship</span><span class="p">(</span><span class="n">pizza</span><span class="o">=</span><span class="n">my_pizza</span><span class="p">,</span> <span class="n">topping</span><span class="o">=</span><span class="n">pepperoni</span><span class="p">),</span>
        <span class="n">PizzaToppingRelationship</span><span class="p">(</span><span class="n">pizza</span><span class="o">=</span><span class="n">your_pizza</span><span class="p">,</span> <span class="n">topping</span><span class="o">=</span><span class="n">pepperoni</span><span class="p">),</span>
        <span class="n">PizzaToppingRelationship</span><span class="p">(</span><span class="n">pizza</span><span class="o">=</span><span class="n">your_pizza</span><span class="p">,</span> <span class="n">topping</span><span class="o">=</span><span class="n">mushroom</span><span class="p">),</span>
    <span class="p">],</span>
    <span class="n">ignore_conflicts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>...これは下記よりも適切です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_pizza</span><span class="o">.</span><span class="n">toppings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pepperoni</span><span class="p">)</span>
<span class="n">your_pizza</span><span class="o">.</span><span class="n">toppings</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pepperoni</span><span class="p">,</span> <span class="n">mushroom</span><span class="p">)</span>
</pre></div>
</div>
<p>ここで、 <code class="docutils literal notranslate"><span class="pre">Pizza</span></code> と <code class="docutils literal notranslate"><span class="pre">Topping</span></code> は多対多の関連を持っています。<a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.bulk_create" title="django.db.models.query.QuerySet.bulk_create"><code class="xref py py-meth docutils literal notranslate"><span class="pre">このメソッド</span></code></a> には多くの注意事項があるので、自分のユースケースに適切であることを確認してください。</p>
</section>
<section id="s-remove-in-bulk">
<span id="remove-in-bulk"></span><h3>一括で削除する<a class="headerlink" href="#remove-in-bulk" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="../../ref/models/fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><code class="xref py py-class docutils literal notranslate"><span class="pre">ManyToManyFields</span></code></a> からオブジェクトを取り除くとき、可能であれば <a class="reference internal" href="../../ref/models/relations.html#django.db.models.fields.related.RelatedManager.remove" title="django.db.models.fields.related.RelatedManager.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">remove()</span></code></a> を呼び出し、SQL文の数を減らしてください。例えば:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">my_friend</span><span class="p">)</span>
</pre></div>
</div>
<p>...これは下記よりも適切です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
<span class="n">my_band</span><span class="o">.</span><span class="n">members</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">my_friend</span><span class="p">)</span>
</pre></div>
</div>
<p>... ここで、 <code class="docutils literal notranslate"><span class="pre">Bands</span></code> と <code class="docutils literal notranslate"><span class="pre">Artists</span></code> は多対多の関係です。</p>
<p><a class="reference internal" href="../../ref/models/fields.html#django.db.models.ManyToManyField" title="django.db.models.ManyToManyField"><code class="xref py py-class docutils literal notranslate"><span class="pre">ManyToManyFields</span></code></a> から異なるペアのオブジェクトを取り除くとき、複数の <a class="reference internal" href="../../ref/models/fields.html#django.db.models.ManyToManyField.through" title="django.db.models.ManyToManyField.through"><code class="xref py py-attr docutils literal notranslate"><span class="pre">through</span></code></a> モデルインスタンスと <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.Q" title="django.db.models.Q"><code class="xref py py-class docutils literal notranslate"><span class="pre">Q</span></code></a> 式を用いて、 <a class="reference internal" href="../../ref/models/querysets.html#django.db.models.query.QuerySet.delete" title="django.db.models.query.QuerySet.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">delete()</span></code></a> を呼び出し、SQL文の数を減らしてください。例えば:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Q</span>

<span class="n">PizzaToppingRelationship</span> <span class="o">=</span> <span class="n">Pizza</span><span class="o">.</span><span class="n">toppings</span><span class="o">.</span><span class="n">through</span>
<span class="n">PizzaToppingRelationship</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">Q</span><span class="p">(</span><span class="n">pizza</span><span class="o">=</span><span class="n">my_pizza</span><span class="p">,</span> <span class="n">topping</span><span class="o">=</span><span class="n">pepperoni</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">pizza</span><span class="o">=</span><span class="n">your_pizza</span><span class="p">,</span> <span class="n">topping</span><span class="o">=</span><span class="n">pepperoni</span><span class="p">)</span>
    <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">pizza</span><span class="o">=</span><span class="n">your_pizza</span><span class="p">,</span> <span class="n">topping</span><span class="o">=</span><span class="n">mushroom</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
</pre></div>
</div>
<p>...これは下記よりも適切です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">my_pizza</span><span class="o">.</span><span class="n">toppings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pepperoni</span><span class="p">)</span>
<span class="n">your_pizza</span><span class="o">.</span><span class="n">toppings</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">pepperoni</span><span class="p">,</span> <span class="n">mushroom</span><span class="p">)</span>
</pre></div>
</div>
<p>... ここで、 <code class="docutils literal notranslate"><span class="pre">Pizza</span></code> と <code class="docutils literal notranslate"><span class="pre">Topping</span></code> は多対多の関係です。</p>
</section>
</section>
</section>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../contents.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">データベースアクセスの最適化</a><ul>
<li><a class="reference internal" href="#profile-first">まずはプロファイルを取る</a></li>
<li><a class="reference internal" href="#use-standard-db-optimization-techniques">標準的な DB 最適化のテクニックを使う</a></li>
<li><a class="reference internal" href="#understand-querysets"><code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> を理解する</a><ul>
<li><a class="reference internal" href="#understand-queryset-evaluation"><code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> の評価を理解する</a></li>
<li><a class="reference internal" href="#understand-cached-attributes">キャッシュされる属性を理解する</a></li>
<li><a class="reference internal" href="#use-the-with-template-tag"><code class="docutils literal notranslate"><span class="pre">with</span></code> テンプレートタグを使用する</a></li>
<li><a class="reference internal" href="#use-iterator"><code class="docutils literal notranslate"><span class="pre">iterator()</span></code> を使用する</a></li>
<li><a class="reference internal" href="#use-explain"><code class="docutils literal notranslate"><span class="pre">explain()</span></code> を使用する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#do-database-work-in-the-database-rather-than-in-python">データベースの仕事を Python ではなくデータベースに行わせる</a><ul>
<li><a class="reference internal" href="#use-rawsql"><code class="docutils literal notranslate"><span class="pre">RawSQL</span></code> を使用する</a></li>
<li><a class="reference internal" href="#use-raw-sql">素の SQL を使用する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#retrieve-individual-objects-using-a-unique-indexed-column">ユニークかつインデックス済みの列を使用して個別のオブジェクトを取得する</a></li>
<li><a class="reference internal" href="#retrieve-everything-at-once-if-you-know-you-will-need-it">必要なものが分かっているときは一度にすべてを取り出す</a><ul>
<li><a class="reference internal" href="#use-queryset-select-related-and-prefetch-related"><code class="docutils literal notranslate"><span class="pre">QuerySet.select_related()</span></code> や <code class="docutils literal notranslate"><span class="pre">prefetch_related()</span></code> を使用する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#don-t-retrieve-things-you-don-t-need">必要ないものを取り出さない</a><ul>
<li><a class="reference internal" href="#use-queryset-values-and-values-list"><code class="docutils literal notranslate"><span class="pre">QuerySet.values()</span></code> や <code class="docutils literal notranslate"><span class="pre">values_list()</span></code> を使用する</a></li>
<li><a class="reference internal" href="#use-queryset-defer-and-only"><code class="docutils literal notranslate"><span class="pre">QuerySet.defer()</span></code> や <code class="docutils literal notranslate"><span class="pre">only()</span></code> を使用する</a></li>
<li><a class="reference internal" href="#use-queryset-contains-obj"><code class="docutils literal notranslate"><span class="pre">QuerySet.contains(obj)</span></code> を使用する</a></li>
<li><a class="reference internal" href="#use-queryset-count"><code class="docutils literal notranslate"><span class="pre">QuerySet.count()</span></code> を使用する</a></li>
<li><a class="reference internal" href="#use-queryset-exists"><code class="docutils literal notranslate"><span class="pre">QuerySet.exists()</span></code> を使用する</a></li>
<li><a class="reference internal" href="#don-t-overuse-contains-count-and-exists"><code class="docutils literal notranslate"><span class="pre">contains()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">count()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">exists()</span></code> を使いすぎない</a></li>
<li><a class="reference internal" href="#use-queryset-update-and-delete"><code class="docutils literal notranslate"><span class="pre">QuerySet.update()</span></code> や <code class="docutils literal notranslate"><span class="pre">delete()</span></code> を使用する</a></li>
<li><a class="reference internal" href="#use-foreign-key-values-directly">外部キーの値を直接使用する</a></li>
<li><a class="reference internal" href="#don-t-order-results-if-you-don-t-care">気にならないなら結果を並べ替えない</a></li>
</ul>
</li>
<li><a class="reference internal" href="#use-bulk-methods">一括メソッドを使用する</a><ul>
<li><a class="reference internal" href="#create-in-bulk">一括で作成する</a></li>
<li><a class="reference internal" href="#update-in-bulk">一括で更新する</a></li>
<li><a class="reference internal" href="#insert-in-bulk">一括で挿入する</a></li>
<li><a class="reference internal" href="#remove-in-bulk">一括で削除する</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="tablespaces.html"
                          title="前の章へ">テーブル空間（tablespace）</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="instrumentation.html"
                          title="次の章へ">データベースの計測</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/topics/db/optimization.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">1月 22, 2025</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="tablespaces.html" title="テーブル空間（tablespace）">previous</a>
     |
    <a href="../index.html" title="Django を使う" accesskey="U">up</a>
   |
    <a href="instrumentation.html" title="データベースの計測">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>