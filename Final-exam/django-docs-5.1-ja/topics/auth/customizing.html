<!DOCTYPE html>

<html lang="ja" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Django の認証方法のカスタマイズ &#8212; Django 5.1.6.dev20250122212402 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=34bb78ad" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css?v=bf4d74af" />
    <script src="../../_static/documentation_options.js?v=d2885b0a"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=4755f45a"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="Django のキャッシュフレームワーク" href="../cache.html" />
    <link rel="prev" title="Djangoにおけるパスワード管理" href="passwords.html" />



 
<script src="../../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../../index.html">Django 5.1.6.dev20250122212402 ドキュメント</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../../index.html">Home</a>  |
        <a title="Table of contents" href="../../contents.html">Table of contents</a>  |
        <a title="Global index" href="../../genindex.html">Index</a>  |
        <a title="Module index" href="../../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="passwords.html" title="Djangoにおけるパスワード管理">previous</a>
     |
    <a href="../index.html" title="Django を使う" accesskey="U">up</a>
   |
    <a href="../cache.html" title="Django のキャッシュフレームワーク">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="topics-auth-customizing">
            
  <section id="s-customizing-authentication-in-django">
<span id="customizing-authentication-in-django"></span><h1>Django の認証方法のカスタマイズ<a class="headerlink" href="#customizing-authentication-in-django" title="Link to this heading">¶</a></h1>
<p>Django がデフォルトで提供する認証機能は、ほとんどの一般的なケースでは十分なものですが、デフォルトではニーズにマッチしない場合もあると思います。自分のプロジェクトで認証のカスタマイズを行うためには、Django が提供する認証システムをどの場所で拡張・置換できるかという知識が必要です。このドキュメントでは、認証システムをカスタマイズする方法の詳細について説明します。</p>
<p><a class="reference internal" href="#authentication-backends"><span class="std std-ref">認証バックエンド</span></a> を利用すると、ユーザーモデルに保存されたユーザー名とパスワードを用いて異なるサービス間での認証を行う必要が生じた場合に Django 標準よりも高い拡張性を持たせることができます。</p>
<p>モデルには、Django の認可システムで検証可能な <a class="reference internal" href="#custom-permissions"><span class="std std-ref">カスタムパーミッション</span></a> を組み込むことができます。</p>
<p>デフォルトの <code class="docutils literal notranslate"><span class="pre">User</span></code> モデルを <a class="reference internal" href="#extending-user"><span class="std std-ref">拡張</span></a> したり、完全にカスタマイズしたモデルと <a class="reference internal" href="#auth-custom-user"><span class="std std-ref">置換</span></a> したりできます。</p>
<section id="s-other-authentication-sources">
<span id="s-authentication-backends"></span><span id="other-authentication-sources"></span><span id="authentication-backends"></span><h2>他の認証ソースを利用する<a class="headerlink" href="#other-authentication-sources" title="Link to this heading">¶</a></h2>
<p>別の認証ソース、つまり、ユーザー名とパスワード、または他の認証方法を持つ別のソースにフックする必要がある場合があるかも知れません。</p>
<p>たとえば、あなたの会社ですでに全ての従業員のユーザ名とパスワードを記録しているLDAP認証があるとしましょう。もしユーザがLDAP認証とDjangoアプリケーションで異なるアカウントだとしたらネットワーク管理者とユーザで口論になるでしょう。</p>
<p>そこでこのような状況に対応するためにDjangoの認証システムは他の認証システムのリソースと接続できます。あなたはDjangoのデフォルトのデータベーススキーマをオーバーライドするか、他のシステムを連携するためにデフォルトシステムを使うことができます。</p>
<p>Django に含まれている認証バックエンドに関する情報は <a class="reference internal" href="../../ref/contrib/auth.html#authentication-backends-reference"><span class="std std-ref">認証バックエンドリファレンス</span></a> を参照してください。</p>
<section id="s-specifying-authentication-backends">
<span id="specifying-authentication-backends"></span><h3>認証バックエンドを指定する<a class="headerlink" href="#specifying-authentication-backends" title="Link to this heading">¶</a></h3>
<p>Djangoは内部で、「認証バックエンド」と呼ばれるリストを保持しており、認証のためにそれをチェックします。誰かが <a class="reference internal" href="default.html#django.contrib.auth.authenticate" title="django.contrib.auth.authenticate"><code class="xref py py-func docutils literal notranslate"><span class="pre">django.contrib.auth.authenticate()</span></code></a> を呼び出したとき（<a class="reference internal" href="default.html#how-to-log-a-user-in"><span class="std std-ref">ユーザーをログインさせる方法</span></a> に記載されているように）、Djangoはすべての認証バックエンドを通じて認証を試みます。最初の認証方法が失敗した場合、Djangoは次のものを試し、すべてのバックエンドが試行されるまで続けます。</p>
<p>認証バックエンドとして利用するリストは <a class="reference internal" href="../../ref/settings.html#std-setting-AUTHENTICATION_BACKENDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTHENTICATION_BACKENDS</span></code></a> に定義されています。この設定値は認証方法を定義している Python クラスを指定する Python パスのリスト型変数でなければなりません。これらのクラスはあなたの環境で有効な Python パスのどこにでも配置可能です。</p>
<p>初期状態では、<a class="reference internal" href="../../ref/settings.html#std-setting-AUTHENTICATION_BACKENDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTHENTICATION_BACKENDS</span></code></a> は以下の値として定義されています。:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s2">&quot;django.contrib.auth.backends.ModelBackend&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>これは Django のユーザーデータベースを確認してビルトインの権限を照会する基本的な認証バックエンドです。このバックエンドにはログイン試行を制限することでブルートフォース攻撃を防御する仕組みは提供していません。独自に試行制限を実装した認証バックエンドを利用するか、多くのウェブサーバーで提供されている各種防御機構が利用可能です。</p>
<p><a class="reference internal" href="../../ref/settings.html#std-setting-AUTHENTICATION_BACKENDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTHENTICATION_BACKENDS</span></code></a> への順番は処理に影響し、同じユーザー名とパスワードによって複数のバックエンドで有効な認証と判定されれば、Django は最初に有効と判定した時点で処理を終了します。</p>
<p>ある認証バックエンドにおいて <a class="reference internal" href="../../ref/exceptions.html#django.core.exceptions.PermissionDenied" title="django.core.exceptions.PermissionDenied"><code class="xref py py-class docutils literal notranslate"><span class="pre">PermissionDenied</span></code></a> 例外が発生した場合、認証処理は直ちに終了し、Django は続く認証バックエンドに対する認証判定を行いません。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>一度ユーザーが認証されると、Django はユーザーの認証に使われたバックエンドの種類をユーザーのセッションに保存し、現在認証されているユーザーへのアクセスが必要なときはいつでも、そのセッションの間は同じバックエンドを再利用します。これは事実上、認証元がセッションごとにキャッシュされることを意味するため、<a class="reference internal" href="../../ref/settings.html#std-setting-AUTHENTICATION_BACKENDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTHENTICATION_BACKENDS</span></code></a> を変更したとき、ユーザーに別の方法を使用した再認証を強制する必要がある場合、セッションデータを消去する必要があります。そのための簡単な方法は、<code class="docutils literal notranslate"><span class="pre">Session.objects.all().delete()</span></code> の実行です。</p>
</div>
</section>
<section id="s-writing-an-authentication-backend">
<span id="writing-an-authentication-backend"></span><h3>認証バックエンドの実装<a class="headerlink" href="#writing-an-authentication-backend" title="Link to this heading">¶</a></h3>
<p>認証 (authentication) バックエンドは、2つの必須メソッド: <code class="docutils literal notranslate"><span class="pre">get_user(user_id)</span></code> と <code class="docutils literal notranslate"><span class="pre">authenticate(request,</span> <span class="pre">**credentials)</span></code> を実装したクラスであり、パーミッションに関連した省略可能な <a class="reference internal" href="#authorization-methods"><span class="std std-ref">認可 (authorization) メソッド</span></a> もあります。</p>
<p><code class="docutils literal notranslate"><span class="pre">get_user</span></code> メソッドは <code class="docutils literal notranslate"><span class="pre">user_id</span></code> 引数を取ります。これはユーザーネーム、データベースID、またはその他何でもかまいませんが、ユーザーオブジェクトのプライマリキーである必要があります。そして、ユーザーオブジェクトまたは <code class="docutils literal notranslate"><span class="pre">None</span></code> を返します。</p>
<p><code class="docutils literal notranslate"><span class="pre">authenticate</span></code> メソッドは <code class="docutils literal notranslate"><span class="pre">request</span></code> 引数と credentials キーワード引数を取ります。殆どの場合、これは次のようになります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseBackend</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyBackend</span><span class="p">(</span><span class="n">BaseBackend</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check the username/password and return a user.</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>一方、次のように認証トークンでも表せます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseBackend</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyBackend</span><span class="p">(</span><span class="n">BaseBackend</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check the token and return a user.</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>いずれの場合にせよ、 <code class="docutils literal notranslate"><span class="pre">authenticate()</span></code> は与えられた認証情報を確認し、それが有効であれば、認証情報とマッチしたユーザーオブジェクトを返すべきです。それが有効でなければ <code class="docutils literal notranslate"><span class="pre">None</span></code> を返すべきです。</p>
<p><code class="docutils literal notranslate"><span class="pre">request</span></code> は <a class="reference internal" href="../../ref/request-response.html#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a> で、  <a class="reference internal" href="default.html#django.contrib.auth.authenticate" title="django.contrib.auth.authenticate"><code class="xref py py-func docutils literal notranslate"><span class="pre">authenticate()</span></code></a> が提供されていない場合は <code class="docutils literal notranslate"><span class="pre">None</span></code>  となる可能性があります (バックエンドでこれを通過するため)。</p>
<p>Djangoの管理サイトはDjangoの <a class="reference internal" href="default.html#user-objects"><span class="std std-ref">Userオブジェクト</span></a> と密接に連携しています。たとえば、ユーザーが管理サイトにアクセスするには、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_staff" title="django.contrib.auth.models.User.is_staff"><code class="xref py py-attr docutils literal notranslate"><span class="pre">User.is_staff</span></code></a> および <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_active" title="django.contrib.auth.models.User.is_active"><code class="xref py py-attr docutils literal notranslate"><span class="pre">User.is_active</span></code></a> が <code class="docutils literal notranslate"><span class="pre">True</span></code> である必要があります（詳細は <a class="reference internal" href="../../ref/contrib/admin/index.html#django.contrib.admin.AdminSite.has_permission" title="django.contrib.admin.AdminSite.has_permission"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AdminSite.has_permission()</span></code></a> を参照してください）。</p>
<p>これを実現する最善の方法は、バックエンド（例：LDAPディレクトリ、外部SQLデータベースなど）に存在する各ユーザーに対してDjangoの <code class="docutils literal notranslate"><span class="pre">User</span></code> オブジェクトを作成することです。事前にスクリプトを書いて作成するか、ユーザーが初めてログインした際に <code class="docutils literal notranslate"><span class="pre">authenticate</span></code> メソッドで自動的に作成する方法もあります。</p>
<p>以下は、<code class="docutils literal notranslate"><span class="pre">settings.py</span></code> ファイル内で定義されたユーザー名とパスワード変数を使って認証を行い、ユーザーが初めて認証した際にDjangoの <code class="docutils literal notranslate"><span class="pre">User</span></code> オブジェクトを作成するバックエンドの例です。この例では、作成されたDjango <code class="docutils literal notranslate"><span class="pre">User</span></code> オブジェクトはスーパーユーザーとして設定され、管理サイトへの完全なアクセス権を持ちます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseBackend</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.hashers</span><span class="w"> </span><span class="kn">import</span> <span class="n">check_password</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SettingsBackend</span><span class="p">(</span><span class="n">BaseBackend</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Authenticate against the settings ADMIN_LOGIN and ADMIN_PASSWORD.</span>

<span class="sd">    Use the login name and a hash of the password. For example:</span>

<span class="sd">    ADMIN_LOGIN = &#39;admin&#39;</span>
<span class="sd">    ADMIN_PASSWORD = &#39;pbkdf2_sha256$30000$Vo0VlMnkR4Bk$qEvtdyZRWTcOsCnI/oQ7fVOu1XAURIZYoOZ3iq8Dr4M=&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">authenticate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">login_valid</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ADMIN_LOGIN</span> <span class="o">==</span> <span class="n">username</span>
        <span class="n">pwd_valid</span> <span class="o">=</span> <span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ADMIN_PASSWORD</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">login_valid</span> <span class="ow">and</span> <span class="n">pwd_valid</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="c1"># Create a new user. There&#39;s no need to set a password</span>
                <span class="c1"># because only the password from settings.py is checked.</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">)</span>  <span class="c1"># is_active defaults to True.</span>
                <span class="n">user</span><span class="o">.</span><span class="n">is_staff</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">user</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
</section>
<section id="s-handling-authorization-in-custom-backends">
<span id="s-authorization-methods"></span><span id="handling-authorization-in-custom-backends"></span><span id="authorization-methods"></span><h3>カスタムバックエンドによる認可の扱い<a class="headerlink" href="#handling-authorization-in-custom-backends" title="Link to this heading">¶</a></h3>
<p>カスタム認証バックエンドはそれら独自のパーミッションを提供できます。</p>
<p>ユーザーモデルとそのマネージャは、ルックアップ関数を実装している認証バックエンドが何であっても、ルックアップ関数 (<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.get_user_permissions" title="django.contrib.auth.models.User.get_user_permissions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_user_permissions()</span></code></a>、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.get_group_permissions" title="django.contrib.auth.models.User.get_group_permissions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_group_permissions()</span></code></a>、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.get_all_permissions" title="django.contrib.auth.models.User.get_all_permissions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_all_permissions()</span></code></a>、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.has_perm" title="django.contrib.auth.models.User.has_perm"><code class="xref py py-meth docutils literal notranslate"><span class="pre">has_perm()</span></code></a>、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.has_module_perms" title="django.contrib.auth.models.User.has_module_perms"><code class="xref py py-meth docutils literal notranslate"><span class="pre">has_module_perms()</span></code></a>、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.UserManager.with_perm" title="django.contrib.auth.models.UserManager.with_perm"><code class="xref py py-meth docutils literal notranslate"><span class="pre">with_perm()</span></code></a>) に権限を移譲します。</p>
<p>これによりユーザーに与えられたパーミッションは全てのバックエンドが返すすべてのパーミッションの上位セットになります。つまり、Django はユーザーに、任意のバックエンドが付与するパーミッションを与えます。</p>
<p>もし例外 <a class="reference internal" href="../../ref/exceptions.html#django.core.exceptions.PermissionDenied" title="django.core.exceptions.PermissionDenied"><code class="xref py py-class docutils literal notranslate"><span class="pre">PermissionDenied</span></code></a>  を <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.has_perm" title="django.contrib.auth.models.User.has_perm"><code class="xref py py-meth docutils literal notranslate"><span class="pre">has_perm()</span></code></a> か <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.has_module_perms" title="django.contrib.auth.models.User.has_module_perms"><code class="xref py py-meth docutils literal notranslate"><span class="pre">has_module_perms()</span></code></a> の中でバックエンドが出した場合、認可は直ちに失敗し、 Django はそこから続くバックエンドを確認しません。</p>
<p>バックエンドは、魔法のような admin のパーミッションを次のように実装できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.backends</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseBackend</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MagicAdminBackend</span><span class="p">(</span><span class="n">BaseBackend</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_perm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_obj</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">user_obj</span><span class="o">.</span><span class="n">username</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">ADMIN_LOGIN</span>
</pre></div>
</div>
<p>上記の例では、アクセスしたユーザーに全てのパーミッションを付与します。注意すべき点として、関数 <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">django.contrib.auth.models.User</span></code></a> から関連して得られた同じ引数は、バックエンド認証関数は、匿名のユーザーを表すものも含んでいるかもしれない、全てのユーザーオブジェクトを引数として取る点があります。</p>
<p>認可の実装の完全なものは <a class="extlink-source reference external" href="https://github.com/django/django/blob/main/django/contrib/auth/backends.py">django/contrib/auth/backends.py</a> の <code class="docutils literal notranslate"><span class="pre">ModelBackend</span></code> クラスにあり、これはデフォルトのバックエンドであり、ほとんどの場合 <code class="docutils literal notranslate"><span class="pre">auth_permission</span></code> テーブルを照会します。</p>
<section id="s-authorization-for-anonymous-users">
<span id="s-anonymous-auth"></span><span id="authorization-for-anonymous-users"></span><span id="anonymous-auth"></span><h4>匿名ユーザーに対する認可<a class="headerlink" href="#authorization-for-anonymous-users" title="Link to this heading">¶</a></h4>
<p>匿名ユーザーは認証されていないユーザー、すなわち、有効な認証の詳細を何も提供しないユーザーです。しかし、それは必ずしも匿名ユーザーが何かを行うことを認可されないことを意味するわけではありません。最も基本的な基準として、ほとんどのウェブサイトは匿名ユーザーにサイトの大部分を閲覧する権限を与え、その多くは匿名ユーザーにコメント投稿などを許可しています。</p>
<p>Django の認証フレームワークには、匿名ユーザーのアクセス許可を格納する場所はありません。しかし、認証バックエンドに渡されたユーザーオブジェクトは <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.AnonymousUser" title="django.contrib.auth.models.AnonymousUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">django.contrib.auth.models.AnonymousUser</span></code></a> オブジェクトとなることがあります。これにより、バックエンドは匿名ユーザー向けのカスタムの認可動作を指定できます。この仕組みで特に便利なのは、再利用可能なアプリの作者が、たとえば匿名アクセスの制御の設定をする必要がなくなり、認可に関するすべての質問を認証バックエンドに移譲できるようになるような場合です。</p>
</section>
<section id="s-authorization-for-inactive-users">
<span id="s-inactive-auth"></span><span id="authorization-for-inactive-users"></span><span id="inactive-auth"></span><h4>アクティブでないユーザーに対する認可<a class="headerlink" href="#authorization-for-inactive-users" title="Link to this heading">¶</a></h4>
<p><a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_active" title="django.contrib.auth.models.User.is_active"><code class="xref py py-attr docutils literal notranslate"><span class="pre">is_active</span></code></a> フィールドが <code class="docutils literal notranslate"><span class="pre">False</span></code> となっているユーザーを、アクティブでないユーザーと呼びます。認証バックエンド <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.backends.ModelBackend" title="django.contrib.auth.backends.ModelBackend"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelBackend</span></code></a> と <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.backends.RemoteUserBackend" title="django.contrib.auth.backends.RemoteUserBackend"><code class="xref py py-class docutils literal notranslate"><span class="pre">RemoteUserBackend</span></code></a> はこれらのユーザーの認証行為を禁止します。カスタムユーザーモデルが <a class="reference internal" href="#django.contrib.auth.models.CustomUser.is_active" title="django.contrib.auth.models.CustomUser.is_active"><code class="xref py py-attr docutils literal notranslate"><span class="pre">is_active</span></code></a> を持っていない場合、すべてのユーザーの認証行為が許可されます。</p>
<p>もし、アクティブでないユーザーの認証行為を許可したい場合は、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.backends.AllowAllUsersModelBackend" title="django.contrib.auth.backends.AllowAllUsersModelBackend"><code class="xref py py-class docutils literal notranslate"><span class="pre">AllowAllUsersModelBackend</span></code></a> や <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.backends.AllowAllUsersRemoteUserBackend" title="django.contrib.auth.backends.AllowAllUsersRemoteUserBackend"><code class="xref py py-class docutils literal notranslate"><span class="pre">AllowAllUsersRemoteUserBackend</span></code></a> を使用できます。</p>
<p>パーミッションシステムが匿名ユーザーをサポートしている場合、匿名ユーザーがパーミッションを持つ操作であっても、アクティブでないユーザーにはそれができないということが起こりえます。</p>
<p>バックエンドで独自のパーミッションメソッド持つときは、ユーザーの <code class="docutils literal notranslate"><span class="pre">is_active</span></code> 属性のテストを忘れずに行ってください。</p>
</section>
<section id="s-handling-object-permissions">
<span id="handling-object-permissions"></span><h4>オブジェクトのパーミッションの取扱い<a class="headerlink" href="#handling-object-permissions" title="Link to this heading">¶</a></h4>
<p>Django のパーミッションフレームワークはオブジェクトパーミッション基盤を持っていますが、コアには実装されていません。これにより、オブジェクトパーミッションのチェックは常に <code class="docutils literal notranslate"><span class="pre">False</span></code> または空のリスト（実行されたチェックに応じていずれか）が返されます。認証バックエンドは、オブジェクトに関連した認可メソッドごとに <code class="docutils literal notranslate"><span class="pre">obj</span></code> および <code class="docutils literal notranslate"><span class="pre">user_obj</span></code> のキーワードパラメータを受け取り、必要に応じてオブジェクトレベルのパーミッションを返します。</p>
</section>
</section>
</section>
<section id="s-custom-permissions">
<span id="s-id1"></span><span id="custom-permissions"></span><span id="id1"></span><h2>カスタムパーミッション<a class="headerlink" href="#custom-permissions" title="Link to this heading">¶</a></h2>
<p>モデルオブジェクトに対してカスタムパーミッションを作成したい場合は <a class="reference internal" href="../db/models.html#meta-options"><span class="std std-ref">モデルの Meta 属性</span></a> <code class="docutils literal notranslate"><span class="pre">permissions</span></code> を使用してください。</p>
<p>この例の <code class="docutils literal notranslate"><span class="pre">Task</span></code> モデルは、2つのカスタムパーミッションを作成します。すなわち、このアプリケーションにおいて、ユーザーが <code class="docutils literal notranslate"><span class="pre">Task</span></code> インスタンスに関係して、できることとできないことを規定します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;change_task_status&quot;</span><span class="p">,</span> <span class="s2">&quot;Can change the status of tasks&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;close_task&quot;</span><span class="p">,</span> <span class="s2">&quot;Can remove a task by setting its status as closed&quot;</span><span class="p">),</span>
        <span class="p">]</span>
</pre></div>
</div>
<p>これは <a class="reference internal" href="../../ref/django-admin.html#django-admin-migrate"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">migrate</span></code></a> を実行したときに、追加のパーミッションを作成するだけです (パーミッションを作成する関数は <a class="reference internal" href="../../ref/signals.html#django.db.models.signals.post_migrate" title="django.db.models.signals.post_migrate"><code class="xref py py-data docutils literal notranslate"><span class="pre">post_migrate</span></code></a> シグナルに接続されています)。あなたがコード内でやることは、ユーザがアプリケーションの提供する機能(タスクのステータスを変更したり、タスクを閉じたり)にアクセスしようとしたときに、これらのパーミッションの値をチェックすることです。上記の例の続きで、次のコードはユーザーがタスクを閉じることができるかどうかをチェックします:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;app.close_task&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="s-extending-the-existing-user-model">
<span id="s-extending-user"></span><span id="extending-the-existing-user-model"></span><span id="extending-user"></span><h2>既存の <code class="docutils literal notranslate"><span class="pre">User</span></code> モデルを拡張する<a class="headerlink" href="#extending-the-existing-user-model" title="Link to this heading">¶</a></h2>
<p>独自のモデルを使用することなく、デフォルトのモデル <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> を拡張する方法が2つあります。振る舞いのみを変更し、データベースに格納されている内容を変更する必要がない場合は <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> に基づいて <a class="reference internal" href="../db/models.html#proxy-models"><span class="std std-ref">プロキシモデル</span></a> を作成できます。これにより、デフォルトの並び順、カスタムマネージャ、カスタムモデルメソッドなど、プロキシモデルによって提供される機能を利用可能です。</p>
<p><code class="docutils literal notranslate"><span class="pre">User</span></code> に関連した情報を格納したい場合は、 <a class="reference internal" href="../../ref/models/fields.html#django.db.models.OneToOneField" title="django.db.models.OneToOneField"><code class="xref py py-class docutils literal notranslate"><span class="pre">OneToOneField</span></code></a> を追加する情報のフィールドを持ったモデルに使用します。この一対一モデルはサイトユーザーに関する、認証には関連しない情報を格納することがあるため、しばしばプロファイルモデルと呼ばれます。たとえば、次のような Employee モデルを作ります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Employee</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">department</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>User モデルと Employee モデルの両方を持つ既存の Employee Fred Smith を想定すると、 Django の標準的なリレーション先モデルの規約を使って、関連情報にアクセスできます:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s2">&quot;fsmith&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">freds_department</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">employee</span><span class="o">.</span><span class="n">department</span>
</pre></div>
</div>
<p>admin のユーザーページにプロファイルモデルのフィールドを追加する場合は、<a class="reference internal" href="../../ref/contrib/admin/index.html#django.contrib.admin.InlineModelAdmin" title="django.contrib.admin.InlineModelAdmin"><code class="xref py py-class docutils literal notranslate"><span class="pre">InlineModelAdmin</span></code></a> (この例では、<a class="reference internal" href="../../ref/contrib/admin/index.html#django.contrib.admin.StackedInline" title="django.contrib.admin.StackedInline"><code class="xref py py-class docutils literal notranslate"><span class="pre">StackedInline</span></code></a> を使用しています) をあなたの <code class="docutils literal notranslate"><span class="pre">admin.py</span></code> に定義し、それを <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> クラスで追加した <code class="docutils literal notranslate"><span class="pre">UserAdmin</span></code> クラスに追加します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.admin</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAdmin</span> <span class="k">as</span> <span class="n">BaseUserAdmin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">my_user_profile_app.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Employee</span>


<span class="c1"># Define an inline admin descriptor for Employee model</span>
<span class="c1"># which acts a bit like a singleton</span>
<span class="k">class</span><span class="w"> </span><span class="nc">EmployeeInline</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">StackedInline</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Employee</span>
    <span class="n">can_delete</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;employee&quot;</span>


<span class="c1"># Define a new User admin</span>
<span class="k">class</span><span class="w"> </span><span class="nc">UserAdmin</span><span class="p">(</span><span class="n">BaseUserAdmin</span><span class="p">):</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">EmployeeInline</span><span class="p">]</span>


<span class="c1"># Re-register UserAdmin</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">UserAdmin</span><span class="p">)</span>
</pre></div>
</div>
<p>これらのプロファイルモデルは、特別な方法で処理される Django モデルではありません。ユーザーモデルと一対一のリンクを持っているだけです。したがって、ユーザーが作成されたときに自動的に作成されることはありませんが、<a class="reference internal" href="../../ref/signals.html#django.db.models.signals.post_save" title="django.db.models.signals.post_save"><code class="xref py py-attr docutils literal notranslate"><span class="pre">django.db.models.signals.post_save</span></code></a> を使って、適切にリレーション先モデルを作成または更新できます。</p>
<p>関連づけされたモデルを使用した場合、関連するデータを検索するための追加のクエリ実行や結合が行われます。あなたの必要性に応じて、関連づけされたフィールドをカスタムユーザーモデルにインクルードすることは適した選択肢となるでしょう。しかしながら、デフォルトのユーザーモデルとプロジェクトのアプリケーションに組み込み済みの連携は追加のデータベース負荷を正当化するでしょう。</p>
</section>
<section id="s-substituting-a-custom-user-model">
<span id="s-auth-custom-user"></span><span id="substituting-a-custom-user-model"></span><span id="auth-custom-user"></span><h2>カスタムの <code class="docutils literal notranslate"><span class="pre">User</span></code> モデルを置き換える<a class="headerlink" href="#substituting-a-custom-user-model" title="Link to this heading">¶</a></h2>
<p>Django にビルトインされている <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> モデルは、必ずしもプロジェクトが必要とする認証のモデルと合致するわけではありません。たとえば、サイトによってはユーザー名の代わりにメールアドレスを識別トークンとして使用する方が適した場合があります。</p>
<p>Django では、カスタムモデルを参照するように  <a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> の値を設定することにより、デフォルトのユーザーモデルをオーバーライドできます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AUTH_USER_MODEL</span> <span class="o">=</span> <span class="s2">&quot;myapp.MyUser&quot;</span>
</pre></div>
</div>
<p>このドットで区切られたペアは、Django app の <a class="reference internal" href="../../ref/applications.html#django.apps.AppConfig.label" title="django.apps.AppConfig.label"><code class="xref py py-attr docutils literal notranslate"><span class="pre">label</span></code></a> (<a class="reference internal" href="../../ref/settings.html#std-setting-INSTALLED_APPS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code></a> に含まれている必要があります) と、ユーザーモデルとして使用したい Django モデルの名前です。</p>
<section id="s-using-a-custom-user-model-when-starting-a-project">
<span id="using-a-custom-user-model-when-starting-a-project"></span><h3>プロジェクトの開始時にカスタムのユーザーモデルを使用する<a class="headerlink" href="#using-a-custom-user-model-when-starting-a-project" title="Link to this heading">¶</a></h3>
<p>新しいプロジェクトを開始する場合、<a class="reference internal" href="#django.contrib.auth.models.AbstractUser" title="django.contrib.auth.models.AbstractUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractUser</span></code></a> をサブクラス化することで、デフォルトのユーザーモデルと同じように動作するカスタムユーザーモデルを設定できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractUser</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">AbstractUser</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p><a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> に指定することを忘れないでください。任意のマイグレーションの作成、また、最初に実行する <code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">migrate</span></code> の前に行ってください。</p>
<p>そして、モデルをアプリの <code class="docutils literal notranslate"><span class="pre">admin.py</span></code> に登録してください:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.admin</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAdmin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">User</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">UserAdmin</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="s-changing-to-a-custom-user-model-mid-project">
<span id="changing-to-a-custom-user-model-mid-project"></span><h3>プロジェクト途中からのカスタムユーザーモデルへの変更<a class="headerlink" href="#changing-to-a-custom-user-model-mid-project" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> をデータベーステーブルを作成した後に変更することも可能ですが、外部キーや多対多の関係などに影響を与えることがあるため、変更作業は複雑になるかもしれません。</p>
<p>この変更は自動的には行うことができません。手動でのスキーマ修正、古いユーザーテーブルからのデータ移動、一部のマイグレーションの手動による再適用をする必要があります。ステップの概要は <a class="extlink-ticket reference external" href="https://code.djangoproject.com/ticket/25313">#25313</a> を参照してください。</p>
<p>スワップ可能なモデルという Django の動的依存性により、 <a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> によって参照されるモデルはアプリの初回のマイグレーションで作成されなければなりません（通常は <code class="docutils literal notranslate"><span class="pre">0001_initial</span></code> と呼ばれます）。そうしない場合、依存関係の問題が発生します。</p>
<p>マイグレーション中に <code class="docutils literal notranslate"><span class="pre">CircularDependencyError</span></code> に遭遇するかもしれません。依存関係の動的な性質のため、Django は依存関係のループを自動的に断ち切ることができないためです。もしこのエラーを見た場合、ユーザーモデルが依存しているモデルを2回目のマイグレーションに移動することで、依存関係のループがなくなるようにしてください。(お互いに <code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code> を持つ2つの通常のモデルを作ることで、<code class="docutils literal notranslate"><span class="pre">makemigrations</span></code> が循環依存関係を通常と同じように解決させることもできます。)</p>
</section>
<section id="s-reusable-apps-and-auth-user-model">
<span id="reusable-apps-and-auth-user-model"></span><h3>再利用可能なアプリと <code class="docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code><a class="headerlink" href="#reusable-apps-and-auth-user-model" title="Link to this heading">¶</a></h3>
<p>再利用可能アプリはカスタムのユーザーモデルを実装するべきではありません。多数のアプリを使用するプロジェクトの場合、それぞれカスタムのユーザーモデルを実装した再利用可能アプリが2つあると、同時に使うことができなくなってしまいます。もしユーザー情報をアプリ度とに保存したい場合は、以下のように <code class="docutils literal notranslate"><span class="pre">settings.AUTH_USER_MODEL</span></code> に対して <a class="reference internal" href="../../ref/models/fields.html#django.db.models.ForeignKey" title="django.db.models.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a> または <a class="reference internal" href="../../ref/models/fields.html#django.db.models.OneToOneField" title="django.db.models.OneToOneField"><code class="xref py py-class docutils literal notranslate"><span class="pre">OneToOneField</span></code></a> を使用してください。</p>
</section>
<section id="s-referencing-the-user-model">
<span id="referencing-the-user-model"></span><h3><code class="docutils literal notranslate"><span class="pre">User</span></code> モデルを参照する<a class="headerlink" href="#referencing-the-user-model" title="Link to this heading">¶</a></h3>
<p><a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> を直接参照する場合 (たとえば外部キーで参照する場合)、<a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> 設定が異なるユーザモデルに変更されたプロジェクトでは正しく動作しません。</p>
<dl class="py function">
<dt class="sig sig-object py" id="django.contrib.auth.get_user_model">
<span class="sig-name descname"><span class="pre">get_user_model</span></span>()<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/contrib/auth/__init__.py#L183"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.contrib.auth.get_user_model" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> を直接参照する代わりに、<code class="docutils literal notranslate"><span class="pre">django.contrib.auth.get_user_model()</span></code> を使ってユーザモデルを参照すべきです。このメソッドは現在アクティブなユーザモデルを返します -- 指定されている場合はカスタムのユーザモデル、指定されていない場合は <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> です。</p>
<p>ユーザモデルに対して外部キーや多対多の関係を定義するときは、<a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> 設定を使ってカスタムのモデルを指定してください。例えば:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>ユーザモデルによって送信されたシグナルと接続するときは、<a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> 設定を使ってカスタムのユーザモデルを指定してください。例えば:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.signals</span><span class="w"> </span><span class="kn">import</span> <span class="n">post_save</span>


<span class="k">def</span><span class="w"> </span><span class="nf">post_save_receiver</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">post_save_receiver</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">)</span>
</pre></div>
</div>
<p>一般的に言って、最も簡単な方法は、インポート時に実行されるコードの中で <a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> 設定を用いてユーザーモデルを参照することです。しかし、Django がモデルをインポートするときに <code class="docutils literal notranslate"><span class="pre">get_user_model()</span></code> を呼ぶという方法もあります。こうすると、<code class="docutils literal notranslate"><span class="pre">models.ForeignKey(get_user_model(),</span> <span class="pre">...)</span></code> という表記が可能です。</p>
<p>たとえば、<code class="docutils literal notranslate"><span class="pre">&#64;override_settings(AUTH_USER_MODEL=...)</span></code> などを使用して、アプリが複数のユーザーモデルでテストされていて、<code class="docutils literal notranslate"><span class="pre">get_user_model()</span></code> の結果をモジュールレベルの変数にキャッシュしている場合、<a class="reference internal" href="../../ref/signals.html#django.test.signals.setting_changed" title="django.test.signals.setting_changed"><code class="xref py py-data docutils literal notranslate"><span class="pre">setting_changed</span></code></a> シグナルを listen してキャッシュをクリアする必要があるかもしれません。そのためには、次のように書きます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.apps</span><span class="w"> </span><span class="kn">import</span> <span class="n">apps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.signals</span><span class="w"> </span><span class="kn">import</span> <span class="n">setting_changed</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.dispatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">receiver</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">setting_changed</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">user_model_swapped</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">setting</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">setting</span> <span class="o">==</span> <span class="s2">&quot;AUTH_USER_MODEL&quot;</span><span class="p">:</span>
        <span class="n">apps</span><span class="o">.</span><span class="n">clear_cache</span><span class="p">()</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">myapp</span><span class="w"> </span><span class="kn">import</span> <span class="n">some_module</span>

        <span class="n">some_module</span><span class="o">.</span><span class="n">UserModel</span> <span class="o">=</span> <span class="n">get_user_model</span><span class="p">()</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="s-specifying-a-custom-user-model">
<span id="s-specifying-custom-user-model"></span><span id="specifying-a-custom-user-model"></span><span id="specifying-custom-user-model"></span><h3>カスタムのユーザーモデルを指定する<a class="headerlink" href="#specifying-a-custom-user-model" title="Link to this heading">¶</a></h3>
<p>プロジェクトの開始時にカスタムのユーザーモデルを使おうとしている場合、自分のプロジェクトにとってこの選択は本当に正しいのだろうか、と立ち止まってよく考えてください。</p>
<p>ユーザーに関連するすべての情報を1つのモデルに記録すれば、関連モデルを取得するために、追加のより複雑なデータベースクエリを書く必要がなくなります。しかし一方で、アプリ固有のユーザー情報は、カスタムのユーザーモデルに関連するモデルに記録した方がより適切かもしれません。そうすることにより、各アプリは、他のアプリと競合したりデータを破壊されたりする可能性を考えずに、自分のアプリに必要なユーザーデータのみを指定できます。また、ユーザーモデルを、認証に焦点を絞った、可能な限りシンプルなものに保ち続けられるようになります。それはまた、Django がカスタムのユーザーモデルに期待する最小限の要求を満たすことにもなります。</p>
<p>デフォルトの認証バックエンドを使用している場合、モデルは必ず、認証のために使用できるユニークなフィールドを1つ持たなければなりません。このフィールドとしては、ユーザー名やメールアドレスなど、ユニークな属性ならば使用できます。ユニークでないユーザー名などのフィールドが使用できるのは、そのようなフィールドを扱えるカスタムの認証バックエンドだけです。</p>
<p>準拠したカスタムユーザーモデルを構築する最も簡単な方法は、<a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser" title="django.contrib.auth.models.AbstractBaseUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code></a> を継承することです。<a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser" title="django.contrib.auth.models.AbstractBaseUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code></a> はユーザーモデルのコアとなる実装を提供しており、その中には、ハッシュ化パスワードやトークン化されたパスワードリセットなどの機能が含まれます。このクラスの継承後、以下のように、キー実装の詳細を自分で記述する必要があります。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUser">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">models.</span></span><span class="sig-name descname"><span class="pre">CustomUser</span></span><a class="headerlink" href="#django.contrib.auth.models.CustomUser" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUser.USERNAME_FIELD">
<span class="sig-name descname"><span class="pre">USERNAME_FIELD</span></span><a class="headerlink" href="#django.contrib.auth.models.CustomUser.USERNAME_FIELD" title="Link to this definition">¶</a></dt>
<dd><p>ユニークな ID として使用される、ユーザーモデルのフィールド名を説明する文字列。これは通常、ある種のユーザー名になりますが、メールアドレスや他のユニークな ID にすることもできます。非ユニークなユーザー名をサポートできるカスタムの認証バックエンドを使っていない限り、このフィールドは <em>必ず</em> ユニークである (たとえば、<code class="docutils literal notranslate"><span class="pre">unique=True</span></code> を定義内で設定する) 必要があります。</p>
<p>以下の例では、フィールドを一意に指定するために、<code class="docutils literal notranslate"><span class="pre">identifier</span></code> フィールドが使われています。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyUser</span><span class="p">(</span><span class="n">AbstractBaseUser</span><span class="p">):</span>
    <span class="n">identifier</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="n">USERNAME_FIELD</span> <span class="o">=</span> <span class="s2">&quot;identifier&quot;</span>
</pre></div>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUser.EMAIL_FIELD">
<span class="sig-name descname"><span class="pre">EMAIL_FIELD</span></span><a class="headerlink" href="#django.contrib.auth.models.CustomUser.EMAIL_FIELD" title="Link to this definition">¶</a></dt>
<dd><p>ユーザーモデルにあるメールのフィールド名を文字列で記述します。この値は <a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser.get_email_field_name" title="django.contrib.auth.models.AbstractBaseUser.get_email_field_name"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_email_field_name()</span></code></a> で返されます。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUser.REQUIRED_FIELDS">
<span class="sig-name descname"><span class="pre">REQUIRED_FIELDS</span></span><a class="headerlink" href="#django.contrib.auth.models.CustomUser.REQUIRED_FIELDS" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="../../ref/django-admin.html#django-admin-createsuperuser"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">createsuperuser</span></code></a> 管理コマンド経由でユーザーを作成するときにプロンプトが表示されるフィールド名のリスト。ユーザーはこれらの各フィールドごとに値を入力するようにプロンプトが表示されます。<a class="reference internal" href="../../ref/models/fields.html#django.db.models.Field.blank" title="django.db.models.Field.blank"><code class="xref py py-attr docutils literal notranslate"><span class="pre">blank</span></code></a> が <code class="docutils literal notranslate"><span class="pre">False</span></code> または未定義のフィールドを含む必要があり、ユーザーが対話的に作成されるときにプロンプトを表示したい追加のフィールドを含むことができます。<code class="docutils literal notranslate"><span class="pre">REQUIRED_FIELDS</span></code> は、たとえば admin 上のユーザーの作成などの Django の他の部分では何も効果がありません。</p>
<p>たとえば、これは誕生日と身長の2つの必須フィールドを定義しているユーザーモデルの部分的な定義です。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyUser</span><span class="p">(</span><span class="n">AbstractBaseUser</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">date_of_birth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">()</span>
    <span class="o">...</span>
    <span class="n">REQUIRED_FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date_of_birth&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p><code class="docutils literal notranslate"><span class="pre">REQUIRED_FIELDS</span></code> はユーザーモデルのすべての必須フィールドを含む必要がありますが、<code class="docutils literal notranslate"><span class="pre">USERNAME_FIELD</span></code> や <code class="docutils literal notranslate"><span class="pre">password</span></code> を含んでは <em>いけません</em> 。これらのフィールドは常に入力を求められるためです。</p>
</div>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUser.is_active">
<span class="sig-name descname"><span class="pre">is_active</span></span><a class="headerlink" href="#django.contrib.auth.models.CustomUser.is_active" title="Link to this definition">¶</a></dt>
<dd><p>ユーザーが &quot;active&quot; かどうかを示すブール属性。この属性は、デフォルトが <code class="docutils literal notranslate"><span class="pre">True</span></code> の <code class="docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code> 上の属性として与えられます。実装時にどのような選択をするかは、選択した認証バックエンドの詳細によって変わります。詳細については、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_active" title="django.contrib.auth.models.User.is_active"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ビルトインのユーザーモデル上の</span> <span class="pre">is_active</span></code></a> のドキュメントを読んでください。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUser.get_full_name">
<span class="sig-name descname"><span class="pre">get_full_name</span></span>()<a class="headerlink" href="#django.contrib.auth.models.CustomUser.get_full_name" title="Link to this definition">¶</a></dt>
<dd><p>オプション。フルネームなどのユーザーに対するより長い正式の ID です。実装した場合、<a class="reference internal" href="../../ref/contrib/admin/index.html#module-django.contrib.admin" title="django.contrib.admin: Django's admin site."><code class="xref py py-mod docutils literal notranslate"><span class="pre">django.contrib.admin</span></code></a> のオブジェクト履歴内でユーザー名とともに表示されます。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUser.get_short_name">
<span class="sig-name descname"><span class="pre">get_short_name</span></span>()<a class="headerlink" href="#django.contrib.auth.models.CustomUser.get_short_name" title="Link to this definition">¶</a></dt>
<dd><p>オプション。ファーストネームなどのユーザーに対するより短い正式ではない ID です。実装した場合、<a class="reference internal" href="../../ref/contrib/admin/index.html#module-django.contrib.admin" title="django.contrib.admin: Django's admin site."><code class="xref py py-mod docutils literal notranslate"><span class="pre">django.contrib.admin</span></code></a> のヘッダー内のユーザーへの挨拶内でユーザー名の代わりに使われます。</p>
</dd></dl>

<div class="admonition-importing-abstractbaseuser admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code> のインポート</p>
<p><code class="docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code> と <code class="docutils literal notranslate"><span class="pre">BaseUserManager</span></code> は <code class="docutils literal notranslate"><span class="pre">django.contrib.auth.base_user</span></code> からインポートでき、 <a class="reference internal" href="../../ref/settings.html#std-setting-INSTALLED_APPS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code></a> の中に <code class="docutils literal notranslate"><span class="pre">django.contrib.auth</span></code> をインクルードすることなくインポートできます。</p>
</div>
</dd></dl>

<p>次の属性とメソッドは  <a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser" title="django.contrib.auth.models.AbstractBaseUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code></a>: の任意のサブクラスで利用可能です。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">models.</span></span><span class="sig-name descname"><span class="pre">AbstractBaseUser</span></span><a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser" title="Link to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.get_username">
<span class="sig-name descname"><span class="pre">get_username</span></span>()<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.get_username" title="Link to this definition">¶</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">USERNAME_FIELD</span></code> で指定されたフィールドの値を返します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.clean">
<span class="sig-name descname"><span class="pre">clean</span></span>()<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.clean" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser.normalize_username" title="django.contrib.auth.models.AbstractBaseUser.normalize_username"><code class="xref py py-meth docutils literal notranslate"><span class="pre">normalize_username()</span></code></a> を呼び出し、username を正規化します。このメソッドをオーバーライドした場合、正規化を保持するために <code class="docutils literal notranslate"><span class="pre">super()</span></code> を呼び出すようにしてください。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.get_email_field_name">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">get_email_field_name</span></span>()<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.get_email_field_name" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="#django.contrib.auth.models.CustomUser.EMAIL_FIELD" title="django.contrib.auth.models.CustomUser.EMAIL_FIELD"><code class="xref py py-attr docutils literal notranslate"><span class="pre">EMAIL_FIELD</span></code></a> 属性で指定されたメールフィールドの名前を返します。<code class="docutils literal notranslate"><span class="pre">EMAIL_FIELD</span></code> の指定が無いとき、デフォルトは <code class="docutils literal notranslate"><span class="pre">'email'</span></code> です。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.normalize_username">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">normalize_username</span></span>(<em class="sig-param"><span class="n"><span class="pre">username</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.normalize_username" title="Link to this definition">¶</a></dt>
<dd><p>視覚的に同一であるが異なる Unicode の符号位置を持つ文字について、それらが同一とみなされるように、username に NFKC Unicode正規化を適用します。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.is_authenticated">
<span class="sig-name descname"><span class="pre">is_authenticated</span></span><a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.is_authenticated" title="Link to this definition">¶</a></dt>
<dd><p>(<code class="docutils literal notranslate"><span class="pre">AnonymousUser.is_authenticated</span></code> が常に <code class="docutils literal notranslate"><span class="pre">False</span></code> なのとは対照的に) 常に <code class="docutils literal notranslate"><span class="pre">True</span></code> の読み取り専用属性です。ユーザが認証済みかどうかを知らせる方法です。これはパーミッションという意味ではなく、ユーザーがアクティブかどうか、また有効なセッションがあるかどうかをチェックするわけでもありません。 通常、<code class="docutils literal notranslate"><span class="pre">request.user</span></code> のこの属性をチェックして <a class="reference internal" href="../../ref/middleware.html#django.contrib.auth.middleware.AuthenticationMiddleware" title="django.contrib.auth.middleware.AuthenticationMiddleware"><code class="xref py py-class docutils literal notranslate"><span class="pre">AuthenticationMiddleware</span></code></a> (現在ログイン中のユーザを表します) によって格納されているかどうかを調べます。<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> のインスタンスの場合、この属性は <code class="docutils literal notranslate"><span class="pre">True</span></code> となります。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.is_anonymous">
<span class="sig-name descname"><span class="pre">is_anonymous</span></span><a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.is_anonymous" title="Link to this definition">¶</a></dt>
<dd><p>常に <code class="docutils literal notranslate"><span class="pre">False</span></code> の読み取り専用属性です。<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> オブジェクトと <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.AnonymousUser" title="django.contrib.auth.models.AnonymousUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AnonymousUser</span></code></a> オブジェクトを区別する方法です。一般的に、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_authenticated" title="django.contrib.auth.models.User.is_authenticated"><code class="xref py py-attr docutils literal notranslate"><span class="pre">is_authenticated</span></code></a> を使う方が好ましいと言えます。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.set_password">
<span class="sig-name descname"><span class="pre">set_password</span></span>(<em class="sig-param"><span class="n"><span class="pre">raw_password</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.set_password" title="Link to this definition">¶</a></dt>
<dd><p>指定された生の文字列に、ユーザのパスワードをセットし、パスワードのハッシュ処理を行います。<a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser" title="django.contrib.auth.models.AbstractBaseUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code></a> は保存しません。</p>
<p>raw_password が <code class="docutils literal notranslate"><span class="pre">None</span></code> のとき、<a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser.set_unusable_password" title="django.contrib.auth.models.AbstractBaseUser.set_unusable_password"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_unusable_password()</span></code></a> が使われるのと同じように、パスワードは使用に適さないパスワードになります。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.check_password">
<span class="sig-name descname"><span class="pre">check_password</span></span>(<em class="sig-param"><span class="n"><span class="pre">raw_password</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.check_password" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.acheck_password">
<span class="sig-name descname"><span class="pre">acheck_password</span></span>(<em class="sig-param"><span class="n"><span class="pre">raw_password</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.acheck_password" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">acheck_password()</span></code></p>
<p>与えられた生の文字列が、ユーザに対して正しいパスワードであれば <code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。 (比較する際にはパスワードハッシュを処理します。)</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.0:</span> <p><code class="docutils literal notranslate"><span class="pre">acheck_password()</span></code> メソッドが追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.set_unusable_password">
<span class="sig-name descname"><span class="pre">set_unusable_password</span></span>()<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.set_unusable_password" title="Link to this definition">¶</a></dt>
<dd><p>ユーザにパスワードが設定されていないものとしてマークします。これは、空の文字列のパスワードを設定することとは違います。このユーザに対する <a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser.check_password" title="django.contrib.auth.models.AbstractBaseUser.check_password"><code class="xref py py-meth docutils literal notranslate"><span class="pre">check_password()</span></code></a> は <code class="docutils literal notranslate"><span class="pre">True</span></code> を返しません。<a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser" title="django.contrib.auth.models.AbstractBaseUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code></a> オブジェクトを保存しません。</p>
<p>アプリケーションの認証が LDAP ディレクトリなどの既存の外部ソースに対して行われている場合は、これが必要になることがあります。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.has_usable_password">
<span class="sig-name descname"><span class="pre">has_usable_password</span></span>()<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.has_usable_password" title="Link to this definition">¶</a></dt>
<dd><p>ユーザに対して <a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser.set_unusable_password" title="django.contrib.auth.models.AbstractBaseUser.set_unusable_password"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_unusable_password()</span></code></a> が呼ばれている場合、<code class="docutils literal notranslate"><span class="pre">False</span></code> を返します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.get_session_auth_hash">
<span class="sig-name descname"><span class="pre">get_session_auth_hash</span></span>()<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.get_session_auth_hash" title="Link to this definition">¶</a></dt>
<dd><p>パスワードフィールドの HAMC を返します。<a class="reference internal" href="default.html#session-invalidation-on-password-change"><span class="std std-ref">パスワード変更時にセッションを無効化する</span></a> ために利用されます。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractBaseUser.get_session_auth_fallback_hash">
<span class="sig-name descname"><span class="pre">get_session_auth_fallback_hash</span></span>()<a class="headerlink" href="#django.contrib.auth.models.AbstractBaseUser.get_session_auth_fallback_hash" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="../../ref/settings.html#std-setting-SECRET_KEY_FALLBACKS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SECRET_KEY_FALLBACKS</span></code></a> を使用しているパスワードフィールドの HMAC を yield します。<code class="docutils literal notranslate"><span class="pre">get_user()</span></code> で使用されます。</p>
</dd></dl>

</dd></dl>

<p><a class="reference internal" href="#django.contrib.auth.models.AbstractUser" title="django.contrib.auth.models.AbstractUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractUser</span></code></a> は <a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser" title="django.contrib.auth.models.AbstractBaseUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code></a> をサブクラス化します。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractUser">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">models.</span></span><span class="sig-name descname"><span class="pre">AbstractUser</span></span><a class="headerlink" href="#django.contrib.auth.models.AbstractUser" title="Link to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.AbstractUser.clean">
<span class="sig-name descname"><span class="pre">clean</span></span>()<a class="headerlink" href="#django.contrib.auth.models.AbstractUser.clean" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="#django.contrib.auth.models.BaseUserManager.normalize_email" title="django.contrib.auth.models.BaseUserManager.normalize_email"><code class="xref py py-meth docutils literal notranslate"><span class="pre">BaseUserManager.normalize_email()</span></code></a> を呼び出し、メールを正規化します。このメソッドをオーバーライドした場合、正規化を保持するために必ず <code class="docutils literal notranslate"><span class="pre">super()</span></code> を呼び出すようにしてください。</p>
</dd></dl>

</dd></dl>

</section>
<section id="s-writing-a-manager-for-a-custom-user-model">
<span id="writing-a-manager-for-a-custom-user-model"></span><h3>カスタムユーザーモデルのためのマネージャーを書く<a class="headerlink" href="#writing-a-manager-for-a-custom-user-model" title="Link to this heading">¶</a></h3>
<p>また、ユーザモデルに対してカスタムマネージャを定義する必要があります。ユーザモデルが <code class="docutils literal notranslate"><span class="pre">username</span></code>, <code class="docutils literal notranslate"><span class="pre">email</span></code>, <code class="docutils literal notranslate"><span class="pre">is_staff</span></code>, <code class="docutils literal notranslate"><span class="pre">is_active</span></code>, <code class="docutils literal notranslate"><span class="pre">is_superuser</span></code>, <code class="docutils literal notranslate"><span class="pre">last_login</span></code>, <code class="docutils literal notranslate"><span class="pre">date_joined</span></code> フィールドを Django のデフォルトユーザと同じように定義している場合、 Django の <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.UserManager" title="django.contrib.auth.models.UserManager"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserManager</span></code></a> をインストールできます。しかし、ユーザモデルが異なるフィールドを定義している場合は、 <a class="reference internal" href="#django.contrib.auth.models.BaseUserManager" title="django.contrib.auth.models.BaseUserManager"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseUserManager</span></code></a> を継承して、さらに 2 つのメソッドを提供するカスタムマネージャを定義する必要があります:</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUserManager">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">models.</span></span><span class="sig-name descname"><span class="pre">CustomUserManager</span></span><a class="headerlink" href="#django.contrib.auth.models.CustomUserManager" title="Link to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUserManager.create_user">
<span class="sig-name descname"><span class="pre">create_user</span></span>(<em class="sig-param"><span class="n"><span class="pre">username_field</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">password</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">other_fields</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.CustomUserManager.create_user" title="Link to this definition">¶</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">create_user()</span></code> のプロトタイプは、ユーザ名フィールドとすべての必須フィールドを引数として受け取る必要があります。たとえば、ユーザーモデルがユーザー名フィールドとして <code class="docutils literal notranslate"><span class="pre">email</span></code> を使用し、必須フィールドとして <code class="docutils literal notranslate"><span class="pre">date_of_birth</span></code> を持つ場合、 <code class="docutils literal notranslate"><span class="pre">create_user</span></code> は次のように定義します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">date_of_birth</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># create user here</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.CustomUserManager.create_superuser">
<span class="sig-name descname"><span class="pre">create_superuser</span></span>(<em class="sig-param"><span class="n"><span class="pre">username_field</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">password</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">other_fields</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.CustomUserManager.create_superuser" title="Link to this definition">¶</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">create_superuser()</span></code> のプロトタイプは、ユーザ名フィールドとすべての必須フィールドを引数として受け取る必要があります。たとえば、ユーザーモデルがユーザー名フィールドとして <code class="docutils literal notranslate"><span class="pre">email</span></code> を使用し、必須フィールドとして <code class="docutils literal notranslate"><span class="pre">date_of_birth</span></code> を持つ場合、 <code class="docutils literal notranslate"><span class="pre">create_superuser</span></code> は次のように定義します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">create_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">date_of_birth</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># create superuser here</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd></dl>

</dd></dl>

<p><a class="reference internal" href="../../ref/models/fields.html#django.db.models.ForeignKey" title="django.db.models.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a> の <a class="reference internal" href="#django.contrib.auth.models.CustomUser.USERNAME_FIELD" title="django.contrib.auth.models.CustomUser.USERNAME_FIELD"><code class="xref py py-attr docutils literal notranslate"><span class="pre">USERNAME_FIELD</span></code></a> または <a class="reference internal" href="#django.contrib.auth.models.CustomUser.REQUIRED_FIELDS" title="django.contrib.auth.models.CustomUser.REQUIRED_FIELDS"><code class="xref py py-attr docutils literal notranslate"><span class="pre">REQUIRED_FIELDS</span></code></a> の場合、これらのメソッドは既存のインスタンスの <a class="reference internal" href="../../ref/models/fields.html#django.db.models.ForeignKey.to_field" title="django.db.models.ForeignKey.to_field"><code class="xref py py-attr docutils literal notranslate"><span class="pre">to_field</span></code></a> (デフォルトでは <a class="reference internal" href="../../ref/models/fields.html#django.db.models.Field.primary_key" title="django.db.models.Field.primary_key"><code class="xref py py-attr docutils literal notranslate"><span class="pre">primary_key</span></code></a>) の値を受け取ります。</p>
<p><a class="reference internal" href="#django.contrib.auth.models.BaseUserManager" title="django.contrib.auth.models.BaseUserManager"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseUserManager</span></code></a> は以下のユーティリティメソッドを提供します:</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.auth.models.BaseUserManager">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">models.</span></span><span class="sig-name descname"><span class="pre">BaseUserManager</span></span><a class="headerlink" href="#django.contrib.auth.models.BaseUserManager" title="Link to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.BaseUserManager.normalize_email">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">normalize_email</span></span>(<em class="sig-param"><span class="n"><span class="pre">email</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.BaseUserManager.normalize_email" title="Link to this definition">¶</a></dt>
<dd><p>メールアドレスのドメイン部分を小文字にすることで、メールアドレスを正規化します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.BaseUserManager.get_by_natural_key">
<span class="sig-name descname"><span class="pre">get_by_natural_key</span></span>(<em class="sig-param"><span class="n"><span class="pre">username</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.BaseUserManager.get_by_natural_key" title="Link to this definition">¶</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">USERNAME_FIELD</span></code> で指定されたフィールドの内容を使用してユーザーインスタンスを取得します。</p>
</dd></dl>

</dd></dl>

</section>
<section id="s-extending-django-s-default-user">
<span id="extending-django-s-default-user"></span><h3>Django 標準の <code class="docutils literal notranslate"><span class="pre">User</span></code> を拡張する<a class="headerlink" href="#extending-django-s-default-user" title="Link to this heading">¶</a></h3>
<p>Django の <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> モデルに完全に満足しているものの、追加のプロフィール情報をいくつか追加したい場合、<a class="reference internal" href="#django.contrib.auth.models.AbstractUser" title="django.contrib.auth.models.AbstractUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">django.contrib.auth.models.AbstractUser</span></code></a> をサブクラス化して、カスタムのプロフィールフィールドを追加することも可能ですが、<a class="reference internal" href="#specifying-custom-user-model"><span class="std std-ref">カスタムのユーザーモデルを指定する</span></a> で説明されているように、独立したモデルを作ることをおすすめします。<code class="docutils literal notranslate"><span class="pre">AbstractUser</span></code> は、デフォルトの <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> の完全な実装を <a class="reference internal" href="../db/models.html#abstract-base-classes"><span class="std std-ref">抽象モデル</span></a> として提供します。</p>
</section>
<section id="s-custom-users-and-the-built-in-auth-forms">
<span id="s-id2"></span><span id="custom-users-and-the-built-in-auth-forms"></span><span id="id2"></span><h3>カスタムのユーザーとビルトインの認証フォーム<a class="headerlink" href="#custom-users-and-the-built-in-auth-forms" title="Link to this heading">¶</a></h3>
<p>Django のビルトインの <a class="reference internal" href="default.html#built-in-auth-forms"><span class="std std-ref">フォーム</span></a> と <a class="reference internal" href="default.html#built-in-auth-views"><span class="std std-ref">ビュー</span></a> は、協調して動作するユーザーモデルに対して、いくつかの前提を置いています。</p>
<p>以下のフォームは <a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser" title="django.contrib.auth.models.AbstractBaseUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code></a> のあらゆるサブクラスに互換性があります。</p>
<ul class="simple">
<li><p><a class="reference internal" href="default.html#django.contrib.auth.forms.AuthenticationForm" title="django.contrib.auth.forms.AuthenticationForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">AuthenticationForm</span></code></a>: <a class="reference internal" href="#django.contrib.auth.models.CustomUser.USERNAME_FIELD" title="django.contrib.auth.models.CustomUser.USERNAME_FIELD"><code class="xref py py-attr docutils literal notranslate"><span class="pre">USERNAME_FIELD</span></code></a> で指定したユーザー名フィールドを使用する。</p></li>
<li><p><a class="reference internal" href="default.html#django.contrib.auth.forms.SetPasswordForm" title="django.contrib.auth.forms.SetPasswordForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">SetPasswordForm</span></code></a></p></li>
<li><p><a class="reference internal" href="default.html#django.contrib.auth.forms.PasswordChangeForm" title="django.contrib.auth.forms.PasswordChangeForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">PasswordChangeForm</span></code></a></p></li>
<li><p><a class="reference internal" href="default.html#django.contrib.auth.forms.AdminPasswordChangeForm" title="django.contrib.auth.forms.AdminPasswordChangeForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">AdminPasswordChangeForm</span></code></a></p></li>
</ul>
<p>以下のフォームは、ユーザーモデルについて以下のようないくつか前提を置いています。これらの前提を満たしている場合、同じユーザーモデルとみなして使用できます。</p>
<ul class="simple">
<li><p><a class="reference internal" href="default.html#django.contrib.auth.forms.PasswordResetForm" title="django.contrib.auth.forms.PasswordResetForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">PasswordResetForm</span></code></a>: ユーザモデルには、ユーザのメールアドレスを格納するフィールドがあり、 <a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser.get_email_field_name" title="django.contrib.auth.models.AbstractBaseUser.get_email_field_name"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_email_field_name()</span></code></a> (デフォルトでは <code class="docutils literal notranslate"><span class="pre">email</span></code>) によって返される名前がユーザを識別するために使用され、 <code class="docutils literal notranslate"><span class="pre">is_active</span></code> という真偽値フィールドがアクティブでないユーザのパスワードリセットを防ぐために使用されると仮定します。</p></li>
</ul>
<p>最後に、以下のフォームは、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> と固く結びついているため、カスタムのユーザーモデルとともに使用するには、書き換えや拡張が必要になります。</p>
<ul class="simple">
<li><p><a class="reference internal" href="default.html#django.contrib.auth.forms.UserCreationForm" title="django.contrib.auth.forms.UserCreationForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserCreationForm</span></code></a></p></li>
<li><p><a class="reference internal" href="default.html#django.contrib.auth.forms.UserChangeForm" title="django.contrib.auth.forms.UserChangeForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">UserChangeForm</span></code></a></p></li>
</ul>
<p>カスタムユーザモデルが <code class="docutils literal notranslate"><span class="pre">AbstractUser</span></code> のサブクラスであれば、次ようにフォームを拡張できます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserCreationForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">myapp.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">CustomUser</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CustomUserCreationForm</span><span class="p">(</span><span class="n">UserCreationForm</span><span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">(</span><span class="n">UserCreationForm</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">CustomUser</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">UserCreationForm</span><span class="o">.</span><span class="n">Meta</span><span class="o">.</span><span class="n">fields</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot;custom_field&quot;</span><span class="p">,)</span>
</pre></div>
</div>
</section>
<section id="s-custom-users-and-django-contrib-admin">
<span id="custom-users-and-django-contrib-admin"></span><h3>カスタムのユーザーと <a class="reference internal" href="../../ref/contrib/admin/index.html#module-django.contrib.admin" title="django.contrib.admin: Django's admin site."><code class="xref py py-mod docutils literal notranslate"><span class="pre">django.contrib.admin</span></code></a><a class="headerlink" href="#custom-users-and-django-contrib-admin" title="Link to this heading">¶</a></h3>
<p>カスタムのユーザーモデルを admin で動作させたい場合、ユーザーモデルにいくつかの追加の属性とメソッドを定義しなければなりません。これらのメソッドを定義することで、admin はユーザーへアクセスを制御して admin のコンテンツに合わせることができます。</p>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">models.</span></span><span class="sig-name descname"><span class="pre">CustomUser</span></span></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.is_staff">
<span class="sig-name descname"><span class="pre">is_staff</span></span><a class="headerlink" href="#django.contrib.auth.is_staff" title="Link to this definition">¶</a></dt>
<dd><p>ユーザーが admin サイトへのアクセス権を持っている時、<code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.is_active">
<span class="sig-name descname"><span class="pre">is_active</span></span><a class="headerlink" href="#django.contrib.auth.is_active" title="Link to this definition">¶</a></dt>
<dd><p>ユーザーアカウントが現在アクティブな時、<code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">has_perm(perm,</span> <span class="pre">obj=None):</span></span></dt>
<dd><p>ユーザーが名前付きの権限を持っている時、<code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。<code class="docutils literal notranslate"><span class="pre">obj</span></code> が提供された場合、特定のオブジェクトのインスタンスに対して権限をチェックする必要があります。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-name descname"><span class="pre">has_module_perms(app_label):</span></span></dt>
<dd><p>ユーザーが与えられたアプリ内のモデルへのアクセス権を持っている場合、<code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。</p>
</dd></dl>

<p>また、カスタムユーザークラスを admin に登録する必要もあります。もしカスタムユーザーモデルが <code class="docutils literal notranslate"><span class="pre">django.contrib.auth.models.AbstractUser</span></code> を継承したものである場合、Django の既存の <code class="docutils literal notranslate"><span class="pre">django.contrib.auth.admin.UserAdmin</span></code> クラスがそのまま利用できます。しかし、ユーザーモデルが <a class="reference internal" href="#django.contrib.auth.models.AbstractBaseUser" title="django.contrib.auth.models.AbstractBaseUser"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseUser</span></code></a> を継承したものである場合には、カスタムの <code class="docutils literal notranslate"><span class="pre">ModelAdmin</span></code> クラスを定義する必要があります。デフォルトの <code class="docutils literal notranslate"><span class="pre">django.contrib.auth.admin.UserAdmin</span></code> をサブクラス化することも可能ですが、その場合には <code class="docutils literal notranslate"><span class="pre">django.contrib.auth.models.AbstractUser</span></code> 上のフィールドを参照する定義のうち、カスタムユーザークラス上にはない定義をすべてオーバーライドする必要があるでしょう。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p><code class="docutils literal notranslate"><span class="pre">django.contrib.auth.admin.UserAdmin</span></code> のサブクラスである <code class="docutils literal notranslate"><span class="pre">ModelAdmin</span></code> を使用する場合、<code class="docutils literal notranslate"><span class="pre">fieldsets</span></code> (ユーザーの変更時に使われるフィールド) および <code class="docutils literal notranslate"><span class="pre">add_fieldsets</span></code> (ユーザーの作成時に使われるフィールド) に自分のカスタムフィールドを追加する必要があります。たとえば、次のように書くことができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.admin</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAdmin</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CustomUserAdmin</span><span class="p">(</span><span class="n">UserAdmin</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">fieldsets</span> <span class="o">=</span> <span class="n">UserAdmin</span><span class="o">.</span><span class="n">fieldsets</span> <span class="o">+</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;custom_field&quot;</span><span class="p">]}),)</span>
    <span class="n">add_fieldsets</span> <span class="o">=</span> <span class="n">UserAdmin</span><span class="o">.</span><span class="n">add_fieldsets</span> <span class="o">+</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;custom_field&quot;</span><span class="p">]}),)</span>
</pre></div>
</div>
<p>詳細は、<a class="reference internal" href="#custom-users-admin-full-example"><span class="std std-ref">完全な例</span></a> のページを参照してください。</p>
</div>
</section>
<section id="s-custom-users-and-permissions">
<span id="custom-users-and-permissions"></span><h3>カスタムのユーザーとパーミッション<a class="headerlink" href="#custom-users-and-permissions" title="Link to this heading">¶</a></h3>
<p>Django のパーミッションフレームワークをカスタムのユーザーモデルに簡単に取り入れられるように用意されているのが、Django の <a class="reference internal" href="#django.contrib.auth.models.PermissionsMixin" title="django.contrib.auth.models.PermissionsMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">PermissionsMixin</span></code></a> です。これはユーザーモデルの階層に取り入れることができる抽象モデルで、Django のパーミッションモデルをサポートするのに必要なすべてのメソッドとデーターベースのフィールドを使えるようにしてくれます。</p>
<p><a class="reference internal" href="#django.contrib.auth.models.PermissionsMixin" title="django.contrib.auth.models.PermissionsMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">PermissionsMixin</span></code></a> は、以下のメソッドと属性を提供します。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.auth.models.PermissionsMixin">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">models.</span></span><span class="sig-name descname"><span class="pre">PermissionsMixin</span></span><a class="headerlink" href="#django.contrib.auth.models.PermissionsMixin" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.auth.models.PermissionsMixin.is_superuser">
<span class="sig-name descname"><span class="pre">is_superuser</span></span><a class="headerlink" href="#django.contrib.auth.models.PermissionsMixin.is_superuser" title="Link to this definition">¶</a></dt>
<dd><p>真偽値です。明示的に与えられない場合でも、ユーザーがが全てのパーミッションを持っているかどうかを示します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.PermissionsMixin.get_user_permissions">
<span class="sig-name descname"><span class="pre">get_user_permissions</span></span>(<em class="sig-param"><span class="n"><span class="pre">obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.PermissionsMixin.get_user_permissions" title="Link to this definition">¶</a></dt>
<dd><p>ユーザーが直接持っているパーミッション文字列のセットを返します。</p>
<p>もし <code class="docutils literal notranslate"><span class="pre">obj</span></code> が渡された場合、この特定のオブジェクトのユーザパーミッションのみを返します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.PermissionsMixin.get_group_permissions">
<span class="sig-name descname"><span class="pre">get_group_permissions</span></span>(<em class="sig-param"><span class="n"><span class="pre">obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.PermissionsMixin.get_group_permissions" title="Link to this definition">¶</a></dt>
<dd><p>ユーザがグループを通して持つパーミッションの文字列のセットを返します。</p>
<p><code class="docutils literal notranslate"><span class="pre">obj</span></code> が渡されたとき、指定されたオブジェクトに対するグループパーミッションのみを返します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.PermissionsMixin.get_all_permissions">
<span class="sig-name descname"><span class="pre">get_all_permissions</span></span>(<em class="sig-param"><span class="n"><span class="pre">obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.PermissionsMixin.get_all_permissions" title="Link to this definition">¶</a></dt>
<dd><p>ユーザがグループおよびユーザパーミッションを通して持つパーミッションの文字列のセットを返します。</p>
<p><code class="docutils literal notranslate"><span class="pre">obj</span></code> が渡された場合、指定されたオブジェクトに対するパーミッションのみを返します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.PermissionsMixin.has_perm">
<span class="sig-name descname"><span class="pre">has_perm</span></span>(<em class="sig-param"><span class="n"><span class="pre">perm</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.PermissionsMixin.has_perm" title="Link to this definition">¶</a></dt>
<dd><p>ユーザーが指定したパーミッションを持っている場合、<code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。ここで、<code class="docutils literal notranslate"><span class="pre">perm</span></code> は <code class="docutils literal notranslate"><span class="pre">&quot;&lt;app</span> <span class="pre">label&gt;.&lt;permission</span> <span class="pre">codename&gt;&quot;</span></code> という形式で指定します (<a class="reference internal" href="default.html#topic-authorization"><span class="std std-ref">パーミッション</span></a> を参照)。もし、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_active" title="django.contrib.auth.models.User.is_active"><code class="xref py py-attr docutils literal notranslate"><span class="pre">User.is_active</span></code></a> と <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_superuser" title="django.contrib.auth.models.User.is_superuser"><code class="xref py py-attr docutils literal notranslate"><span class="pre">is_superuser</span></code></a> が両方とも <code class="docutils literal notranslate"><span class="pre">True</span></code> だった場合、このメソッドは常に <code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。</p>
<p><code class="docutils literal notranslate"><span class="pre">obj</span></code> が渡された場合、このメソッドはモデルに対するパーミッションのチェックを行わず、指定されたオブジェクトに対して行います。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.PermissionsMixin.has_perms">
<span class="sig-name descname"><span class="pre">has_perms</span></span>(<em class="sig-param"><span class="n"><span class="pre">perm_list</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">obj</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.PermissionsMixin.has_perms" title="Link to this definition">¶</a></dt>
<dd><p>ユーザーが指定したパーミッションを持っている場合、<code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。ここで、<code class="docutils literal notranslate"><span class="pre">perm</span></code> は <code class="docutils literal notranslate"><span class="pre">&quot;&lt;app</span> <span class="pre">label&gt;.&lt;permission</span> <span class="pre">codename&gt;&quot;</span></code> という形式で指定します。もし、<a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_active" title="django.contrib.auth.models.User.is_active"><code class="xref py py-attr docutils literal notranslate"><span class="pre">User.is_active</span></code></a> と <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_superuser" title="django.contrib.auth.models.User.is_superuser"><code class="xref py py-attr docutils literal notranslate"><span class="pre">is_superuser</span></code></a> が両方とも <code class="docutils literal notranslate"><span class="pre">True</span></code> だった場合、このメソッドは常に <code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。</p>
<p><code class="docutils literal notranslate"><span class="pre">obj</span></code> が渡された場合、このメソッドは指定されたオブジェクトに対してパーミッションのチェックを行い、モデルに対しては行いません。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.auth.models.PermissionsMixin.has_module_perms">
<span class="sig-name descname"><span class="pre">has_module_perms</span></span>(<em class="sig-param"><span class="n"><span class="pre">package_name</span></span></em>)<a class="headerlink" href="#django.contrib.auth.models.PermissionsMixin.has_module_perms" title="Link to this definition">¶</a></dt>
<dd><p>ユーザが指定されたパッケージ（Django アプリのラベル）に何らかのパーミッションを持っている場合、 <code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。 <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_active" title="django.contrib.auth.models.User.is_active"><code class="xref py py-attr docutils literal notranslate"><span class="pre">User.is_active</span></code></a> と <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User.is_superuser" title="django.contrib.auth.models.User.is_superuser"><code class="xref py py-attr docutils literal notranslate"><span class="pre">is_superuser</span></code></a> が両方 <code class="docutils literal notranslate"><span class="pre">True</span></code> なら、このメソッドは常に <code class="docutils literal notranslate"><span class="pre">True</span></code> を返します。</p>
</dd></dl>

</dd></dl>

<div class="admonition-permissionsmixin-and-modelbackend admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">PermissionsMixin</span></code> と <code class="docutils literal notranslate"><span class="pre">ModelBackend</span></code></p>
<p><a class="reference internal" href="#django.contrib.auth.models.PermissionsMixin" title="django.contrib.auth.models.PermissionsMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">PermissionsMixin</span></code></a> をインクルードしていない場合、 <code class="docutils literal notranslate"><span class="pre">ModelBackend</span></code> のパーミッションメソッドを呼び出してはいけません。 <code class="docutils literal notranslate"><span class="pre">ModelBackend</span></code> は、ユーザモデルで特定のフィールドが利用可能であることを想定しています。ユーザモデルがこれらのフィールドを提供していない場合、パーミッションをチェックするとデータベースエラーになります。</p>
</div>
</section>
<section id="s-custom-users-and-proxy-models">
<span id="custom-users-and-proxy-models"></span><h3>カスタムのユーザーと proxy モデル<a class="headerlink" href="#custom-users-and-proxy-models" title="Link to this heading">¶</a></h3>
<p>カスタムユーザモデルの制限の一つは、カスタムユーザモデルをインストールすると、 <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> を拡張するプロキシモデルが壊れてしまうことです。プロキシモデルは具象基底クラスを継承している必要があります。カスタムユーザモデルを定義すると、 Django が基底クラスを確実に識別する方法を奪ってしまいます。</p>
<p>プロジェクトでプロキシモデルを使用している場合、プロキシを変更してプロジェクトで使用しているユーザーモデルを拡張するか、プロキシの動作を <a class="reference internal" href="../../ref/contrib/auth.html#django.contrib.auth.models.User" title="django.contrib.auth.models.User"><code class="xref py py-class docutils literal notranslate"><span class="pre">User</span></code></a> サブクラスにマージする必要があります。</p>
</section>
<section id="s-a-full-example">
<span id="s-custom-users-admin-full-example"></span><span id="a-full-example"></span><span id="custom-users-admin-full-example"></span><h3>完全な具体例<a class="headerlink" href="#a-full-example" title="Link to this heading">¶</a></h3>
<p>以下は admin に準拠したカスタムユーザーアプリの例です。このユーザモデルはユーザ名としてメールアドレスを使用し、生年月日を必須とします。ユーザーアカウントに <code class="docutils literal notranslate"><span class="pre">admin</span></code> フラグを立てるだけで、権限のチェックは行いません。このモデルはユーザー作成フォームを除く、すべての組み込みの認証フォームとビューと互換性があります。このサンプルはほとんどのコンポーネントがどう連携して動作するかの例であり、実運用のためのプロジェクトに直接コピーされることを想定したものではありません。</p>
<p>このコードはすべてカスタム認証アプリの <code class="docutils literal notranslate"><span class="pre">models.py</span></code> ファイルに格納されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseUserManager</span><span class="p">,</span> <span class="n">AbstractBaseUser</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyUserManager</span><span class="p">(</span><span class="n">BaseUserManager</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">date_of_birth</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and saves a User with the given email, date of</span>
<span class="sd">        birth and password.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">email</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Users must have an email address&quot;</span><span class="p">)</span>

        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">normalize_email</span><span class="p">(</span><span class="n">email</span><span class="p">),</span>
            <span class="n">date_of_birth</span><span class="o">=</span><span class="n">date_of_birth</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_superuser</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">date_of_birth</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates and saves a superuser with the given email, date of</span>
<span class="sd">        birth and password.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
            <span class="n">email</span><span class="p">,</span>
            <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span>
            <span class="n">date_of_birth</span><span class="o">=</span><span class="n">date_of_birth</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">user</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyUser</span><span class="p">(</span><span class="n">AbstractBaseUser</span><span class="p">):</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">EmailField</span><span class="p">(</span>
        <span class="n">verbose_name</span><span class="o">=</span><span class="s2">&quot;email address&quot;</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">date_of_birth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateField</span><span class="p">()</span>
    <span class="n">is_active</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">is_admin</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">MyUserManager</span><span class="p">()</span>

    <span class="n">USERNAME_FIELD</span> <span class="o">=</span> <span class="s2">&quot;email&quot;</span>
    <span class="n">REQUIRED_FIELDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date_of_birth&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_perm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Does the user have a specific permission?&quot;</span>
        <span class="c1"># Simplest possible answer: Yes, always</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_module_perms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">):</span>
        <span class="s2">&quot;Does the user have permissions to view the app `app_label`?&quot;</span>
        <span class="c1"># Simplest possible answer: Yes, always</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_staff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Is the user a member of staff?&quot;</span>
        <span class="c1"># Simplest possible answer: All admins are staff</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_admin</span>
</pre></div>
</div>
<p>そして、このカスタムユーザモデルを Django の admin に登録するには、アプリの <code class="docutils literal notranslate"><span class="pre">admin.py</span></code> ファイルに以下のコードが必要になります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django</span><span class="w"> </span><span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib</span><span class="w"> </span><span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Group</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.admin</span><span class="w"> </span><span class="kn">import</span> <span class="n">UserAdmin</span> <span class="k">as</span> <span class="n">BaseUserAdmin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">ReadOnlyPasswordHashField</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">customauth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">MyUser</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserCreationForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A form for creating new users. Includes all the required</span>
<span class="sd">    fields, plus a repeated password.&quot;&quot;&quot;</span>

    <span class="n">password1</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;Password&quot;</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">PasswordInput</span><span class="p">)</span>
    <span class="n">password2</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Password confirmation&quot;</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">PasswordInput</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyUser</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;date_of_birth&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clean_password2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Check that the two password entries match</span>
        <span class="n">password1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password1&quot;</span><span class="p">)</span>
        <span class="n">password2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;password2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">password1</span> <span class="ow">and</span> <span class="n">password2</span> <span class="ow">and</span> <span class="n">password1</span> <span class="o">!=</span> <span class="n">password2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Passwords don&#39;t match&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">password2</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">commit</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># Save the provided password in hashed format</span>
        <span class="n">user</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s2">&quot;password1&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">commit</span><span class="p">:</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">user</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserChangeForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A form for updating users. Includes all the fields on</span>
<span class="sd">    the user, but replaces the password field with admin&#39;s</span>
<span class="sd">    disabled password hash display field.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">password</span> <span class="o">=</span> <span class="n">ReadOnlyPasswordHashField</span><span class="p">()</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MyUser</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">,</span> <span class="s2">&quot;date_of_birth&quot;</span><span class="p">,</span> <span class="s2">&quot;is_active&quot;</span><span class="p">,</span> <span class="s2">&quot;is_admin&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserAdmin</span><span class="p">(</span><span class="n">BaseUserAdmin</span><span class="p">):</span>
    <span class="c1"># The forms to add and change user instances</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">UserChangeForm</span>
    <span class="n">add_form</span> <span class="o">=</span> <span class="n">UserCreationForm</span>

    <span class="c1"># The fields to be used in displaying the User model.</span>
    <span class="c1"># These override the definitions on the base UserAdmin</span>
    <span class="c1"># that reference specific fields on auth.User.</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;date_of_birth&quot;</span><span class="p">,</span> <span class="s2">&quot;is_admin&quot;</span><span class="p">]</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;is_admin&quot;</span><span class="p">]</span>
    <span class="n">fieldsets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">]}),</span>
        <span class="p">(</span><span class="s2">&quot;Personal info&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;date_of_birth&quot;</span><span class="p">]}),</span>
        <span class="p">(</span><span class="s2">&quot;Permissions&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;is_admin&quot;</span><span class="p">]}),</span>
    <span class="p">]</span>
    <span class="c1"># add_fieldsets is not a standard ModelAdmin attribute. UserAdmin</span>
    <span class="c1"># overrides get_fieldsets to use this attribute when creating a user.</span>
    <span class="n">add_fieldsets</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="s2">&quot;classes&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;wide&quot;</span><span class="p">],</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">,</span> <span class="s2">&quot;date_of_birth&quot;</span><span class="p">,</span> <span class="s2">&quot;password1&quot;</span><span class="p">,</span> <span class="s2">&quot;password2&quot;</span><span class="p">],</span>
            <span class="p">},</span>
        <span class="p">),</span>
    <span class="p">]</span>
    <span class="n">search_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;email&quot;</span><span class="p">]</span>
    <span class="n">filter_horizontal</span> <span class="o">=</span> <span class="p">[]</span>


<span class="c1"># Now register the new UserAdmin...</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">MyUser</span><span class="p">,</span> <span class="n">UserAdmin</span><span class="p">)</span>
<span class="c1"># ... and, since we&#39;re not using Django&#39;s built-in permissions,</span>
<span class="c1"># unregister the Group model from admin.</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">Group</span><span class="p">)</span>
</pre></div>
</div>
<p>最後に、 <code class="docutils literal notranslate"><span class="pre">settings.py</span></code>: の <a class="reference internal" href="../../ref/settings.html#std-setting-AUTH_USER_MODEL"><code class="xref std std-setting docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a> 設定を使用して、カスタムモデルをプロジェクトのデフォルトのユーザーモデルとして指定します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AUTH_USER_MODEL</span> <span class="o">=</span> <span class="s2">&quot;customauth.MyUser&quot;</span>
</pre></div>
</div>
</section>
</section>
</section>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../contents.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">Django の認証方法のカスタマイズ</a><ul>
<li><a class="reference internal" href="#other-authentication-sources">他の認証ソースを利用する</a><ul>
<li><a class="reference internal" href="#specifying-authentication-backends">認証バックエンドを指定する</a></li>
<li><a class="reference internal" href="#writing-an-authentication-backend">認証バックエンドの実装</a></li>
<li><a class="reference internal" href="#handling-authorization-in-custom-backends">カスタムバックエンドによる認可の扱い</a><ul>
<li><a class="reference internal" href="#authorization-for-anonymous-users">匿名ユーザーに対する認可</a></li>
<li><a class="reference internal" href="#authorization-for-inactive-users">アクティブでないユーザーに対する認可</a></li>
<li><a class="reference internal" href="#handling-object-permissions">オブジェクトのパーミッションの取扱い</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#custom-permissions">カスタムパーミッション</a></li>
<li><a class="reference internal" href="#extending-the-existing-user-model">既存の <code class="docutils literal notranslate"><span class="pre">User</span></code> モデルを拡張する</a></li>
<li><a class="reference internal" href="#substituting-a-custom-user-model">カスタムの <code class="docutils literal notranslate"><span class="pre">User</span></code> モデルを置き換える</a><ul>
<li><a class="reference internal" href="#using-a-custom-user-model-when-starting-a-project">プロジェクトの開始時にカスタムのユーザーモデルを使用する</a></li>
<li><a class="reference internal" href="#changing-to-a-custom-user-model-mid-project">プロジェクト途中からのカスタムユーザーモデルへの変更</a></li>
<li><a class="reference internal" href="#reusable-apps-and-auth-user-model">再利用可能なアプリと <code class="docutils literal notranslate"><span class="pre">AUTH_USER_MODEL</span></code></a></li>
<li><a class="reference internal" href="#referencing-the-user-model"><code class="docutils literal notranslate"><span class="pre">User</span></code> モデルを参照する</a></li>
<li><a class="reference internal" href="#specifying-a-custom-user-model">カスタムのユーザーモデルを指定する</a></li>
<li><a class="reference internal" href="#writing-a-manager-for-a-custom-user-model">カスタムユーザーモデルのためのマネージャーを書く</a></li>
<li><a class="reference internal" href="#extending-django-s-default-user">Django 標準の <code class="docutils literal notranslate"><span class="pre">User</span></code> を拡張する</a></li>
<li><a class="reference internal" href="#custom-users-and-the-built-in-auth-forms">カスタムのユーザーとビルトインの認証フォーム</a></li>
<li><a class="reference internal" href="#custom-users-and-django-contrib-admin">カスタムのユーザーと <code class="xref py py-mod docutils literal notranslate"><span class="pre">django.contrib.admin</span></code></a></li>
<li><a class="reference internal" href="#custom-users-and-permissions">カスタムのユーザーとパーミッション</a></li>
<li><a class="reference internal" href="#custom-users-and-proxy-models">カスタムのユーザーと proxy モデル</a></li>
<li><a class="reference internal" href="#a-full-example">完全な具体例</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="passwords.html"
                          title="前の章へ">Djangoにおけるパスワード管理</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="../cache.html"
                          title="次の章へ">Django のキャッシュフレームワーク</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/topics/auth/customizing.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">1月 22, 2025</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="passwords.html" title="Djangoにおけるパスワード管理">previous</a>
     |
    <a href="../index.html" title="Django を使う" accesskey="U">up</a>
   |
    <a href="../cache.html" title="Django のキャッシュフレームワーク">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>