<!DOCTYPE html>

<html lang="ja" data-content_root="../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Django のキャッシュフレームワーク &#8212; Django 5.1.6.dev20250122212402 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=34bb78ad" />
    <link rel="stylesheet" type="text/css" href="../_static/default.css?v=bf4d74af" />
    <script src="../_static/documentation_options.js?v=d2885b0a"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/translations.js?v=4755f45a"></script>
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="検索" href="../search.html" />
    <link rel="next" title="条件付きのビュー処理" href="conditional-view-processing.html" />
    <link rel="prev" title="Django の認証方法のカスタマイズ" href="auth/customizing.html" />



 
<script src="../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../index.html">Django 5.1.6.dev20250122212402 ドキュメント</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../index.html">Home</a>  |
        <a title="Table of contents" href="../contents.html">Table of contents</a>  |
        <a title="Global index" href="../genindex.html">Index</a>  |
        <a title="Module index" href="../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="auth/customizing.html" title="Django の認証方法のカスタマイズ">previous</a>
     |
    <a href="index.html" title="Django を使う" accesskey="U">up</a>
   |
    <a href="conditional-view-processing.html" title="条件付きのビュー処理">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="topics-cache">
            
  <section id="s-django-s-cache-framework">
<span id="django-s-cache-framework"></span><h1>Django のキャッシュフレームワーク<a class="headerlink" href="#django-s-cache-framework" title="Link to this heading">¶</a></h1>
<p>動的なウェブサイトの基本的なトレードオフは、ええと、それが動的であるということです。ユーザーがページをリクエストするたびに、ウェブサーバーはあらゆる種類の計算を行い (データベースのクエリから、テンプレートのレンダリングやビジネスロジックの実行まで)、サイトの訪問者が目にするページを作成します。これは、処理オーバーヘッドの観点から、ファイルシステムからファイルを読み取る標準的なサーバー構成よりもはるかに高コストです。</p>
<p>ほとんどの Web アプリケーションでは、このオーバーヘッドは大した問題ではありません。ほとんどの Web アプリケーションは <code class="docutils literal notranslate"><span class="pre">washingtonpost.com</span></code> や <code class="docutils literal notranslate"><span class="pre">slashdot.org</span></code> ではなく、そこそこのトラフィックがある小規模から中規模のサイトです。ただし、中トラフィックから高トラフィックのサイトでは、オーバーヘッドをできる限り削減することが不可欠です。</p>
<p>そこで登場するのがキャッシュです。</p>
<p>何かをキャッシュすることは、次回に計算を実行する必要がないように、高価な計算の結果を保存することです。以下に示すのは、動的に生成された Web ページでキャッシュがどのように機能するかを説明する疑似コードです。</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>given a URL, try finding that page in the cache
if the page is in the cache:
    return the cached page
else:
    generate the page
    save the generated page in the cache (for next time)
    return the generated page
</pre></div>
</div>
<p>Django には、動的ページを保存できるロバストなキャッシュ システムが付属しているため、各リクエストごとに動的ページを計算する必要はありません。便宜上、Django は異なるレベルのキャッシュ粒度を提供しています。特定のビューの出力をキャッシュしたり、生成が難しい部分のみをキャッシュしたり、サイト全体をキャッシュできます。</p>
<p>Django は、 <a class="reference external" href="http://www.squid-cache.org/">Squid</a> やブラウザベースのキャッシュなどの「ダウンストリーム」キャッシュでもうまく機能します。これらは、直接コントロールできないタイプのキャッシュですが、サイトのどの部分をどのようにキャッシュする必要があるかというヒントを (HTTP ヘッダー経由で) 提供できます。</p>
<div class="admonition seealso">
<p class="admonition-title">参考</p>
<p><a class="reference internal" href="../misc/design-philosophies.html#cache-design-philosophy"><span class="std std-ref">キャッシュフレームワークの設計思想</span></a> では、フレームワークの設計上の決定のいくつかについて説明します。</p>
</div>
<section id="s-setting-up-the-cache">
<span id="s-id1"></span><span id="setting-up-the-cache"></span><span id="id1"></span><h2>キャッシュのセットアップ<a class="headerlink" href="#setting-up-the-cache" title="Link to this heading">¶</a></h2>
<p>キャッシュシステムにはちょっとした設定が必要です。つまり、キャッシュされたデータをどこに置くか、データベースか、ファイルシステムか、メモリに直接置くかを指定しなければなりません。これはキャッシュのパフォーマンスに影響する重要な決定です。</p>
<p>キャッシュの設定は設定ファイルの <a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> 設定にあります。ここでは、 <a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> で使用可能なすべての値について説明します。</p>
<section id="s-memcached">
<span id="s-id2"></span><span id="memcached"></span><span id="id2"></span><h3>Memcached<a class="headerlink" href="#memcached" title="Link to this heading">¶</a></h3>
<p><a class="reference external" href="https://memcached.org/">Memcached</a> は完全にメモリベースのキャッシュ・サーバで、元々はLiveJournal.comの高負荷を処理するために開発され、その後Danga Interactiveによってオープンソース化されました。FacebookやWikipediaなどのサイトで使用され、データベースへのアクセスを減らし、サイトのパフォーマンスを劇的に向上させます。</p>
<p>Memcached はデーモンとして動作し、指定された量の RAM が割り当てられます。キャッシュにデータを追加、取得、削除するための高速なインターフェイスを提供するだけです。すべてのデータはメモリに直接保存されるので、データベースやファイルシステムの使用によるオーバーヘッドはありません。</p>
<p>Memcached 自体をインストールした後、Memcached バインディングをインストールする 必要があります。Python の Memcached バインディングはいくつかありますが、 Django がサポートしているのは <a class="extlink-pypi reference external" href="https://pypi.org/project/pylibmc/">pylibmc</a> と <a class="extlink-pypi reference external" href="https://pypi.org/project/pymemcache/">pymemcache</a> です。</p>
<p>Django で Memcached を使用する</p>
<ul class="simple">
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-BACKEND"><code class="xref std std-setting docutils literal notranslate"><span class="pre">BACKEND</span></code></a> を <code class="docutils literal notranslate"><span class="pre">django.core.cache.backends.memcached.PyMemcacheCache</span></code> または <code class="docutils literal notranslate"><span class="pre">django.core.cache.backends.memcached.PyLibMCCache</span></code> (選択した memcached バインディングによる) に設定する</p></li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> を <code class="docutils literal notranslate"><span class="pre">ip:port</span></code> の値 (ここで、<code class="docutils literal notranslate"><span class="pre">ip</span></code> は Memcached デーモンの IP アドレス、<code class="docutils literal notranslate"><span class="pre">port</span></code> は Memcached が起動しているポート)、または、<code class="docutils literal notranslate"><span class="pre">unix:path</span></code> の値に設定する (ここで、<code class="docutils literal notranslate"><span class="pre">path</span></code> は Memcached Unix socket ファイルへのパス)。</p></li>
</ul>
<p>次の例では、Memcached は localhost (127.0.0.1) port 11211 で起動していて、<code class="docutils literal notranslate"><span class="pre">pymemcache</span></code> バインディングを使用しています。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.memcached.PyMemcacheCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1:11211&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>次の例では、Memcached はローカルの Unix socket ファイル <code class="file docutils literal notranslate"><span class="pre">/tmp/memcached.sock</span></code> 経由で利用可能であり、<code class="docutils literal notranslate"><span class="pre">pymemcache</span></code> バインディングを使用しています。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.memcached.PyMemcacheCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;unix:/tmp/memcached.sock&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Memcached の優れた機能の一つは、複数のサーバでキャッシュを共有できることです。つまり、複数のマシンで Memcached デーモンを実行することができ、各マシンでキャッシュの値を重複させることなく、 <em>単一の</em> キャッシュとして扱うことができます。この機能を利用するには、全てのサーバのアドレスを <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> に、セミコロンまたはカンマ区切りの文字列、あるいはリストとして記述します。</p>
<p>このインスタンスでは、IP アドレス 172.19.26.240 と 172.19.26.242 で動作する Memcached インスタンスをポート 11211 で共有します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.memcached.PyMemcacheCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;172.19.26.240:11211&quot;</span><span class="p">,</span>
            <span class="s2">&quot;172.19.26.242:11211&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>以下の例では、172.19.26.240 (port 11211)、172.19.26.242 (port 11212)、172.19.26.244 (port 11213) の IP アドレスで動作する Memcached インスタンスでキャッシュを共有しています:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.memcached.PyMemcacheCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;172.19.26.240:11211&quot;</span><span class="p">,</span>
            <span class="s2">&quot;172.19.26.242:11212&quot;</span><span class="p">,</span>
            <span class="s2">&quot;172.19.26.244:11213&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>デフォルトでは、 <code class="docutils literal notranslate"><span class="pre">PyMemcacheCache</span></code> バックエンドは以下のオプションを設定します( <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-OPTIONS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">OPTIONS</span></code></a> で上書きできます):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;allow_unicode_keys&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;default_noreply&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;serde&quot;</span><span class="p">:</span> <span class="n">pymemcache</span><span class="o">.</span><span class="n">serde</span><span class="o">.</span><span class="n">pickle_serde</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Memcachedについての最後のポイントは、メモリベースのキャッシュには欠点があるということです。キャッシュされたデータはメモリに保存されるので、サーバーがクラッシュするとデータは失われます。メモリは永続的なデータ保存用ではないので、メモリベースのキャッシュを唯一のデータ保存用として使わないようにしましょう。明らかに、 Django のキャッシュバックエンドはどれも、永続的な保存には使うべきではありません。これらは全てキャッシュのためのソリューションであって、ストレージではありません。しかし、メモリベースのキャッシュは特に一時的なものであるため、 ここでに記載しておきます。</p>
</section>
<section id="s-redis">
<span id="s-id4"></span><span id="redis"></span><span id="id4"></span><h3>Redis<a class="headerlink" href="#redis" title="Link to this heading">¶</a></h3>
<p><a class="reference external" href="https://redis.io/">Redis</a> は、キャッシュに利用できるインメモリ データベースです。はじめに、Redis サーバーがローカルまたはリモートマシン上で起動している必要があります。</p>
<p>Redis サーバを設定した後、Redis の Python バインディングをインストールする必要があります。 <a class="extlink-pypi reference external" href="https://pypi.org/project/redis/">redis-py</a> は Django によってネイティブにサポートされているバインディングです。 <a class="extlink-pypi reference external" href="https://pypi.org/project/hiredis/">hiredis-py</a> パッケージも推奨のひとつです。</p>
<p>Redis をキャッシュ バックエンドとして Django で使用するには、次のようにします。</p>
<ul class="simple">
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-BACKEND"><code class="xref std std-setting docutils literal notranslate"><span class="pre">BACKEND</span></code></a> を <code class="docutils literal notranslate"><span class="pre">django.core.cache.backends.redis.RedisCache</span></code> に設定する。</p></li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> を、適切なスキーマを使用して Redis インスタンスを指す URL に設定する。<a class="reference external" href="https://redis-py.readthedocs.io/en/stable/connections.html#redis.connection.ConnectionPool.from_url">利用可能なスキーマの詳細</a> については、<code class="docutils literal notranslate"><span class="pre">redis-py</span></code> のドキュメントを参照してください。</p></li>
</ul>
<p>たとえば、Redis が localhost (127.0.0.1) port 6379 で起動している場合は、次のように設定します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.redis.RedisCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;redis://127.0.0.1:6379&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Redis サーバーは認証で保護されていることがよくあります。ユーザー名とパスワードを提供するには、<code class="docutils literal notranslate"><span class="pre">LOCATION</span></code> 内に URL とともに追加します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.redis.RedisCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;redis://username:password@127.0.0.1:6379&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>レプリケーション・モードで複数のRedisサーバーを設定している場合は、セミコロンまたはカンマ区切りの文字列、あるいはリストとしてサーバーを指定できます。複数のサーバーを使用している場合、書き込み操作は最初のサーバー（リーダー）で実行されます。読み取り操作は、ランダムに選ばれた他のサーバ（レプリカ）で実行されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.redis.RedisCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;redis://127.0.0.1:6379&quot;</span><span class="p">,</span>  <span class="c1"># leader</span>
            <span class="s2">&quot;redis://127.0.0.1:6378&quot;</span><span class="p">,</span>  <span class="c1"># read-replica 1</span>
            <span class="s2">&quot;redis://127.0.0.1:6377&quot;</span><span class="p">,</span>  <span class="c1"># read-replica 2</span>
        <span class="p">],</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="s-database-caching">
<span id="s-id6"></span><span id="database-caching"></span><span id="id6"></span><h3>データベースのキャッシュ<a class="headerlink" href="#database-caching" title="Link to this heading">¶</a></h3>
<p>Django はキャッシュデータをデータベース中に保存できます。この仕組みは、高速で適切にインデックス付けされたデータベースサーバーがある場合に、有効に機能します。</p>
<p>データベースのテーブルをキャッシュのバックエンドに使用する場合には、以下のように設定します。</p>
<ul class="simple">
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-BACKEND"><code class="xref std std-setting docutils literal notranslate"><span class="pre">BACKEND</span></code></a> を <code class="docutils literal notranslate"><span class="pre">django.core.cache.backends.db.DatabaseCache</span></code> に設定する</p></li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> の <code class="docutils literal notranslate"><span class="pre">tablename</span></code> にデータベーステーブルの名前を設定します。この名前は、データベースで未使用かつ有効な名前であれば、自分が好きな名前で構いません。</p></li>
</ul>
<p>この例では、キャッシュテーブルの名前を <code class="docutils literal notranslate"><span class="pre">my_cache_table</span></code> と設定しています。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.db.DatabaseCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;my_cache_table&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>他のキャッシュバックエンドとは異なり、データベースキャッシュはデータベースレベルでの期限切れエントリの自動間引き (culling) をサポートしていません。その代わり、 <code class="docutils literal notranslate"><span class="pre">add()</span></code> や <code class="docutils literal notranslate"><span class="pre">set()</span></code> 、 <code class="docutils literal notranslate"><span class="pre">touch()</span></code> が呼び出されるたびに、期限切れのキャッシュエントリが「間引き」されます。</p>
<section id="s-creating-the-cache-table">
<span id="creating-the-cache-table"></span><h4>キャッシュテーブルを作成する<a class="headerlink" href="#creating-the-cache-table" title="Link to this heading">¶</a></h4>
<p>データベース キャッシュを使用する前に、次のコマンドでキャッシュテーブルを必ず作成する必要があります。</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python<span class="w"> </span>manage.py<span class="w"> </span>createcachetable
</pre></div>
</div>
<p>このコマンドにより、データベース内に1つのテーブルが作成され、Django のデータベースキャッシュシステムに必要な適切なフォーマットが生成されます。テーブルの名前は <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> が使用されます。</p>
<p>複数のデータベースキャッシュが使用される場合、<a class="reference internal" href="../ref/django-admin.html#django-admin-createcachetable"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">createcachetable</span></code></a> は1つのキャッシュごとに、対応する1つのテーブルを作成します。</p>
<p>複数のデータベースを使用する場合、<a class="reference internal" href="../ref/django-admin.html#django-admin-createcachetable"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">createcachetable</span></code></a> は、データベースのルートの <code class="docutils literal notranslate"><span class="pre">allow_migrate()</span></code> メソッド (以下を参照) を監視します。</p>
<p><a class="reference internal" href="../ref/django-admin.html#django-admin-migrate"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">migrate</span></code></a> と同様に、<a class="reference internal" href="../ref/django-admin.html#django-admin-createcachetable"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">createcachetable</span></code></a> は既に存在する既存のテーブルにたいしては手を触れません。存在しないテーブルのみを生成します。</p>
<p>実行される予定の SQL を実行せずに表示するためには、<a class="reference internal" href="../ref/django-admin.html#cmdoption-createcachetable-dry-run"><code class="xref std std-option docutils literal notranslate"><span class="pre">createcachetable</span> <span class="pre">--dry-run</span></code></a> オプションを使用します。</p>
</section>
<section id="s-multiple-databases">
<span id="multiple-databases"></span><h4>複数のデータベース<a class="headerlink" href="#multiple-databases" title="Link to this heading">¶</a></h4>
<p>複数のデータベースでデータベースキャッシュを使用する場合、データベースキャッシュテーブルのためにルーティングの指示も設定する必要があります。ルーティングの目的で、データベースキャッシュテーブルは、<code class="docutils literal notranslate"><span class="pre">django_cache</span></code> という名前のアプリケーションに <code class="docutils literal notranslate"><span class="pre">CacheEntry</span></code> という名前のモデルとして表示されます。このモデルはモデルキャッシュには表示されませんが、ルーティングの目的でモデルの詳細情報を使用できます。</p>
<p>たとえば、以下のルーターはすべてのキャッシュの読み込み操作を <code class="docutils literal notranslate"><span class="pre">cache_replica</span></code> に転送し、すべての書き込み操作を <code class="docutils literal notranslate"><span class="pre">cache_primary</span></code> に転送します。キャッシュテーブルは <code class="docutils literal notranslate"><span class="pre">cache_primary</span></code> にだけ同期されます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CacheRouter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A router to control all database cache operations&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="s2">&quot;All cache read operations go to the replica&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s2">&quot;django_cache&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;cache_replica&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="s2">&quot;All cache write operations go to primary&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s2">&quot;django_cache&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;cache_primary&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">allow_migrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="s2">&quot;Only install the cache model on primary&quot;</span>
        <span class="k">if</span> <span class="n">app_label</span> <span class="o">==</span> <span class="s2">&quot;django_cache&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">db</span> <span class="o">==</span> <span class="s2">&quot;cache_primary&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>データベースキャッシュモデルに対してルーティングの方向を指定しなかった場合、キャッシュバックエンドは <code class="docutils literal notranslate"><span class="pre">default</span></code> データベースを使用します。</p>
<p>そして、データベースキャッシュバックエンドを使用しなかった場合には、データベースキャッシュモデルに対してデータベースルーティングの指示を提供することについて心配する必要はありません。</p>
</section>
</section>
<section id="s-filesystem-caching">
<span id="filesystem-caching"></span><h3>ファイルシステムのキャッシュ<a class="headerlink" href="#filesystem-caching" title="Link to this heading">¶</a></h3>
<p>ファイルベースのバックエンドは、各キャッシュの値を独立したファイルとしてシリアライズして保存します。このバックエンドを使用するには、<a class="reference internal" href="../ref/settings.html#std-setting-CACHES-BACKEND"><code class="xref std std-setting docutils literal notranslate"><span class="pre">BACKEND</span></code></a> を <code class="docutils literal notranslate"><span class="pre">&quot;django.core.cache.backends.filebased.FileBasedCache&quot;</span></code> に設定して、<a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> を適切なディレクトリに設定します。たとえば、キャッシュデータを <code class="docutils literal notranslate"><span class="pre">/var/tmp/django_cache</span></code> に保存するには、次の設定を使ってください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.filebased.FileBasedCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/tmp/django_cache&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Windows では、次のようにドライブ文字をパスの最初に付けてください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.filebased.FileBasedCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;c:/foo/bar&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>ディレクトリのパスは絶対パスである必要があります。つまり、ファイルシステムのルートから始まる必要があります。設定の最後にスラッシュを置くかどうかは関係ありません。</p>
<p>この設定が指すディレクトリは、存在して読み込みと書き込みが可能であるか、または、ウェブサーバーを実行しているシステムユーザーによって作成可能であることを確認してください。上の例を続けると、もしサーバーが <code class="docutils literal notranslate"><span class="pre">apache</span></code> ユーザーで実行されているなら、<code class="docutils literal notranslate"><span class="pre">/var/tmp/django_cache</span></code> が存在して <code class="docutils literal notranslate"><span class="pre">apache</span></code> ユーザーにより読み書き可能であるか、このディレクトリを <code class="docutils literal notranslate"><span class="pre">apache</span></code> ユーザーが作成できることを確認してください。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>キャッシュの <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> が、<a class="reference internal" href="../ref/settings.html#std-setting-MEDIA_ROOT"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MEDIA_ROOT</span></code></a>、<a class="reference internal" href="../ref/settings.html#std-setting-STATIC_ROOT"><code class="xref std std-setting docutils literal notranslate"><span class="pre">STATIC_ROOT</span></code></a>、<a class="reference internal" href="../ref/settings.html#std-setting-STATICFILES_FINDERS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">STATICFILES_FINDERS</span></code></a> のいずれかの配下に含まれていると、機密データが漏洩してしまう可能性があります。</p>
<p>キャッシュファイルへのアクセスを獲得した攻撃者は、HTML コンテンツを改竄できるだけでなく、データが <a class="reference external" href="https://docs.python.org/3/library/pickle.html#module-pickle" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pickle</span></code></a> を使用してシリアライズされているため、任意のコードのリモート実行までできてしまいます。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>ファイルシステムキャッシュは、大量のファイルを保存すると低速になってしまう可能性があります。この問題に遭遇したときは、別のキャッシュメカニズムの使用を検討してください。<a class="extlink-source reference external" href="https://github.com/django/django/blob/main/django/core/cache/backends/filebased.py">FileBasedCache</a> をサブクラス化して、淘汰戦略を改善することもできます。</p>
</div>
</section>
<section id="s-local-memory-caching">
<span id="s-id7"></span><span id="local-memory-caching"></span><span id="id7"></span><h3>ローカルメモリのキャッシュ<a class="headerlink" href="#local-memory-caching" title="Link to this heading">¶</a></h3>
<p>設定ファイルに他のキャッシュが指定されていない場合、これがデフォルトのキャッシュとなります。インメモリキャッシュの速度の利点が欲しいが、Memcached を扱うのが難しい場合は、 ローカルメモリキャッシュバックエンドを検討してください。このキャッシュはプロセス単位 (後述) で、スレッドセーフです。これを使うには、 <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-BACKEND"><code class="xref std std-setting docutils literal notranslate"><span class="pre">BACKEND</span></code></a> を <code class="docutils literal notranslate"><span class="pre">&quot;django.core.cache.backends.locmem.LocMemCache&quot;</span></code> に設定します。たとえば</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.locmem.LocMemCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;unique-snowflake&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>キャッシュの <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> は個々のメモリストアを識別するために使用されます。もし <code class="docutils literal notranslate"><span class="pre">locmem</span></code> キャッシュが1つしかない場合は <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-LOCATION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">LOCATION</span></code></a> を省略できます。しかし、複数のローカルメモリーキャッシュがある場合は、それらを区別するために少なくとも1つに名前を割り当てる必要があります。</p>
<p>キャッシュは LRU (least-recently-used) 淘汰戦略 (culling strategy) を使用します。</p>
<p>各プロセスはそれ自身のプライベートキャッシュインスタンスを持つことに注意してください。このことは、ローカル・メモリ・キャッシュが特にメモリ効率に優れているわけではないことを意味します。そのため、おそらく本番環境には良い選択ではありません。開発環境には適しています。</p>
</section>
<section id="s-dummy-caching-for-development">
<span id="dummy-caching-for-development"></span><h3>ダミーキャッシュ（開発用）<a class="headerlink" href="#dummy-caching-for-development" title="Link to this heading">¶</a></h3>
<p>最後に、 Django には実際にはキャッシュしない「ダミー」キャッシュが付属しています。何もせずにキャッシュインターフェースを実装しているだけです。</p>
<p>これは、様々な場所で重量級のキャッシュを使用する本番サイトと、開発/テスト用に、キャッシュを行わず、コード変更も最小限に留めたい環境がある場合に便利です。ダミーキャッシュをアクティブにするには、<a class="reference internal" href="../ref/settings.html#std-setting-CACHES-BACKEND"><code class="xref std std-setting docutils literal notranslate"><span class="pre">BACKEND</span></code></a> を以下のように設定します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.dummy.DummyCache&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="s-using-a-custom-cache-backend">
<span id="using-a-custom-cache-backend"></span><h3>独自のキャッシュバックエンドを使う<a class="headerlink" href="#using-a-custom-cache-backend" title="Link to this heading">¶</a></h3>
<p>Django は「箱から出してすぐに」多くのキャッシュバックエンドをサポートしていますが、カスタマイズ したキャッシュバックエンドを使いたいこともあるでしょう。Django で外部のキャッシュバックエンドを使用するには、下記のように、 <a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> 設定の <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-BACKEND"><code class="xref std std-setting docutils literal notranslate"><span class="pre">BACKEND</span></code></a> に Python のインポートパスを使用します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;path.to.backend&quot;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>独自のバックエンドを構築する場合は、標準のキャッシュバックエンドをリファレンス実装として使うことができます。コードは Django ソースの <a class="extlink-source reference external" href="https://github.com/django/django/blob/main/django/core/cache/backends/">django/core/cache/backends/</a> ディレクトリにあります。</p>
<p>注記：ホストがサポートしていないなど、やむを得ない理由がない限り、Django に付属しているキャッシュバックエンドを使用するべきです。それらは十分にテストされており、よくドキュメント化されています。</p>
</section>
<section id="s-cache-arguments">
<span id="s-id8"></span><span id="cache-arguments"></span><span id="id8"></span><h3>キャッシュ引数<a class="headerlink" href="#cache-arguments" title="Link to this heading">¶</a></h3>
<p>それぞれのキャッシュバックエンドはキャッシュの動作を制御するために追加の引数を指定できます。これらの引数は <a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> 設定の追加キーとして提供されます。有効な引数は以下の通りです:</p>
<ul>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-TIMEOUT"><code class="xref std std-setting docutils literal notranslate"><span class="pre">TIMEOUT</span></code></a>: キャッシュに使用するデフォルトのタイムアウトを秒単位で指定します。この引数のデフォルトは <code class="docutils literal notranslate"><span class="pre">300</span></code> 秒（5分）です。 <code class="docutils literal notranslate"><span class="pre">TIMEOUT</span></code> に <code class="docutils literal notranslate"><span class="pre">None</span></code> を指定することで、デフォルトではキャッシュキーの有効期限が切れません。値を <code class="docutils literal notranslate"><span class="pre">0</span></code> にすると、キーはすぐに期限切れになります（事実上 &quot;キャッシュしない&quot;）。</p></li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-OPTIONS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">OPTIONS</span></code></a>: キャッシュバックエンドに渡すオプション。有効なオプションのリストはバックエンドによって異なり、サードパーティライブラリにバックされたキャッシュバックエンドはそのオプションを直接キャッシュライブラリに渡します。</p>
<p>独自の淘汰戦略 (culling strategy) を実装しているキャッシュバックエンド (<code class="docutils literal notranslate"><span class="pre">locmem</span></code>、<code class="docutils literal notranslate"><span class="pre">filesystem</span></code>、<code class="docutils literal notranslate"><span class="pre">database</span></code> バックエンド) では、以下のオプションが有効です:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_ENTRIES</span></code>: 古い値が削除されるまでにキャッシュに保存できる最大エントリ数。この引数のデフォルトは <code class="docutils literal notranslate"><span class="pre">300</span></code> です。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">CULL_FREQUENCY</span></code>: <code class="docutils literal notranslate"><span class="pre">MAX_ENTRIES</span></code> に達したときに間引き (cull) されるエントリの割合。実際の割合は <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">/</span> <span class="pre">CULL_FREQUENCY</span></code> なので、 <code class="docutils literal notranslate"><span class="pre">CULL_FREQUENCY</span></code> を <code class="docutils literal notranslate"><span class="pre">2</span></code> に設定すると、 <code class="docutils literal notranslate"><span class="pre">MAX_ENTRIES</span></code> に達したときにエントリの半分をカリングします。この引数は整数で、デフォルトは <code class="docutils literal notranslate"><span class="pre">3</span></code> です。</p>
<p><code class="docutils literal notranslate"><span class="pre">CULL_FREQUENCY</span></code> に <code class="docutils literal notranslate"><span class="pre">0</span></code> という値を指定すると、 <code class="docutils literal notranslate"><span class="pre">MAX_ENTRIES</span></code> に達したときにキャッシュ全体がダンプされます。一部のバックエンド (特に <code class="docutils literal notranslate"><span class="pre">database</span></code>) では、キャッシュミスが増える代わりにカリング（間引き）が非常に速くなります。</p>
</li>
</ul>
<p>Memcached と Redis のバックエンドは、クライアントの動作をより高度に制御できるように、クライアントのコンストラクタにキーワード引数として <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-OPTIONS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">OPTIONS</span></code></a> の内容を渡します。使用例は以下を参照してください。</p>
</li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-KEY_PREFIX"><code class="xref std std-setting docutils literal notranslate"><span class="pre">KEY_PREFIX</span></code></a>: Django サーバが使用する全てのキャッシュキーに自動的に含まれる文字列です（デフォルトでは先頭に付加されます）。</p>
<p>詳細は <a class="reference internal" href="#cache-key-prefixing"><span class="std std-ref">キャッシュのドキュメント</span></a> を参照してください。</p>
</li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-VERSION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">VERSION</span></code></a>: Django サーバが生成するキャッシュキーのデフォルトのバージョン番号。</p>
<p>詳細は <a class="reference internal" href="#cache-versioning"><span class="std std-ref">キャッシュのドキュメント</span></a> を参照してください。</p>
</li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-KEY_FUNCTION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">KEY_FUNCTION</span></code></a> プレフィックス、バージョン、およびキーを最終的なキャッシュ・キーに合成する方法を定義する関数へのドット区切りパスを含む文字列。</p>
<p>詳細は <a class="reference internal" href="#cache-key-transformation"><span class="std std-ref">キャッシュのドキュメント</span></a> を参照してください。</p>
</li>
</ul>
<p>この例では、ファイルシステム・バックエンドをタイムアウト60秒、最大容量1000アイテムで設定しています。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.filebased.FileBasedCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;/var/tmp/django_cache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;TIMEOUT&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
        <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;MAX_ENTRIES&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>以下は、<code class="docutils literal notranslate"><span class="pre">pylibmc</span></code> ベースのバックエンドをバイナリプロトコル、SASL認証、および <code class="docutils literal notranslate"><span class="pre">ketama</span></code> 挙動モードを有効に設定する例です。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.memcached.PyLibMCCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1:11211&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;binary&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="s2">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;pass&quot;</span><span class="p">,</span>
            <span class="s2">&quot;behaviors&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;ketama&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>以下は <code class="docutils literal notranslate"><span class="pre">pymemcache</span></code> ベースのバックエンドの設定例です。クライアントのプーリングを有効にし (クライアントの接続を維持することでパフォーマンスを向上させることができます)、memcache/ネットワークのエラーをキャッシュミスとして扱い、接続ソケットに <code class="docutils literal notranslate"><span class="pre">TCP_NODELAY</span></code> フラグを設定します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.memcached.PyMemcacheCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1:11211&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;no_delay&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;ignore_exc&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;max_pool_size&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
            <span class="s2">&quot;use_pooling&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>以下は、<code class="docutils literal notranslate"><span class="pre">redis</span></code> を使用したバックエンドの設定例です。この設定では、データベース <code class="docutils literal notranslate"><span class="pre">10</span></code> を選択し（デフォルトでは Redis は16個の論理データベースを提供しています）、カスタムの <a class="reference external" href="https://github.com/redis/redis-py#connection-pools">connection pool class</a> を設定します（デフォルトでは <code class="docutils literal notranslate"><span class="pre">redis.ConnectionPool</span></code> が使用されます）。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CACHES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;BACKEND&quot;</span><span class="p">:</span> <span class="s2">&quot;django.core.cache.backends.redis.RedisCache&quot;</span><span class="p">,</span>
        <span class="s2">&quot;LOCATION&quot;</span><span class="p">:</span> <span class="s2">&quot;redis://127.0.0.1:6379&quot;</span><span class="p">,</span>
        <span class="s2">&quot;OPTIONS&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;db&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pool_class&quot;</span><span class="p">:</span> <span class="s2">&quot;redis.BlockingConnectionPool&quot;</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="s-the-per-site-cache">
<span id="s-id9"></span><span id="the-per-site-cache"></span><span id="id9"></span><h2>サイトごとのキャッシュ<a class="headerlink" href="#the-per-site-cache" title="Link to this heading">¶</a></h2>
<p>キャッシュを設定したら、キャッシュを使う最も簡単な方法はサイト全体をキャッシュすることです。この例のように、 <code class="docutils literal notranslate"><span class="pre">'django.middleware.cache.UpdateCacheMiddleware'</span></code> と <code class="docutils literal notranslate"><span class="pre">'django.middleware.cache.FetchFromCacheMiddleware'</span></code> を <a class="reference internal" href="../ref/settings.html#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> 設定に追加する必要があります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;django.middleware.cache.UpdateCacheMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;django.middleware.common.CommonMiddleware&quot;</span><span class="p">,</span>
    <span class="s2">&quot;django.middleware.cache.FetchFromCacheMiddleware&quot;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>いいえ、これは typo ではありません。&quot;update&quot; ミドルウェアはリストの最初に、&quot;fetch&quot; ミドルウェアはリストの最後になければなりません。詳細は少し曖昧ですが、全容を知りたい方は下記の <a class="reference internal" href="#order-of-middleware">Order of MIDDLEWARE</a> を参照してください。</p>
</div>
<p>次に、以下の必要な設定を Django 設定ファイルに追加します:</p>
<ul class="simple">
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHE_MIDDLEWARE_ALIAS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHE_MIDDLEWARE_ALIAS</span></code></a> -- ストレージに使用するキャッシュのエイリアス。</p></li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHE_MIDDLEWARE_SECONDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHE_MIDDLEWARE_SECONDS</span></code></a> -- 各ページがキャッシュされるべき秒数を整数で指定します。</p></li>
<li><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHE_MIDDLEWARE_KEY_PREFIX"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHE_MIDDLEWARE_KEY_PREFIX</span></code></a> -- キャッシュが同じ Django インストールを使っている複数のサイトで共有され ている場合、キーの衝突を防ぐために、サイトの名前か、この Django インスタンスに固有な文字列を指定します。気にしないなら空文字列を使いましょう。</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">FetchFromCacheMiddleware</span></code> はリクエストヘッダとレスポンスヘッダが許す限り、ステータス 200 の GET と HEAD レスポンスをキャッシュします。異なるクエリパラメータを持つ同じURLへのリクエストに対するレスポンスはユニークなページとみなされ、別々にキャッシュされます。このミドルウェアは、HEADリクエストが、対応するGETリクエストと同じレスポンスヘッダーで応答されることを期待します。その場合、HEADリクエストに対してキャッシュされたGETレスポンスを返すことができます。</p>
<p>さらに、<code class="docutils literal notranslate"><span class="pre">UpdateCacheMiddleware</span></code> は <a class="reference internal" href="#downstream-caches"><span class="std std-ref">ダウンストリームキャッシュ</span></a> に影響を与えるいくつかのヘッダを <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a> に自動的に設定します:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Expires</span></code> ヘッダーに現在の日時と定義された <a class="reference internal" href="../ref/settings.html#std-setting-CACHE_MIDDLEWARE_SECONDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHE_MIDDLEWARE_SECONDS</span></code></a> をセットします。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Cache-Control</span></code> ヘッダにページの最大寿命をセットします -- ここでも <a class="reference internal" href="../ref/settings.html#std-setting-CACHE_MIDDLEWARE_SECONDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHE_MIDDLEWARE_SECONDS</span></code></a> 設定を使用します。</p></li>
</ul>
<p>ミドルウェアについては <a class="reference internal" href="http/middleware.html"><span class="doc">ミドルウェア (Middleware)</span></a> を参照してください。</p>
<p>ビューがキャッシュの有効期限を設定している場合 (つまり、ヘッダの <code class="docutils literal notranslate"><span class="pre">Cache-Control</span></code> に <code class="docutils literal notranslate"><span class="pre">max-age</span></code> セクションがある場合) は、 <a class="reference internal" href="../ref/settings.html#std-setting-CACHE_MIDDLEWARE_SECONDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHE_MIDDLEWARE_SECONDS</span></code></a> ではなく、有効期限までページがキャッシュされます。<code class="docutils literal notranslate"><span class="pre">django.views.decorators.cache</span></code> のデコレータを使用すると、ビューの有効期限を簡単に設定 (<a class="reference internal" href="http/decorators.html#django.views.decorators.cache.cache_control" title="django.views.decorators.cache.cache_control"><code class="xref py py-func docutils literal notranslate"><span class="pre">cache_control()</span></code></a> デコレータを使用) したり、ビューのキャッシュを無効にしたり (<a class="reference internal" href="http/decorators.html#django.views.decorators.cache.never_cache" title="django.views.decorators.cache.never_cache"><code class="xref py py-func docutils literal notranslate"><span class="pre">never_cache()</span></code></a> デコレータを使用) することができます。これらのデコレータについての詳細は、 <a class="reference internal" href="#controlling-cache-using-other-headers">他のヘッダを使用する</a> セクションを参照してください。</p>
<p id="i18n-cache-key"><a class="reference internal" href="../ref/settings.html#std-setting-USE_I18N"><code class="xref std std-setting docutils literal notranslate"><span class="pre">USE_I18N</span></code></a> が <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定されている場合、生成されたキャッシュキーにアクティブな <a class="reference internal" href="i18n/index.html#term-language-code"><span class="xref std std-term">言語</span></a> の名前が含まれるようになります。 <a class="reference internal" href="i18n/translation.html#how-django-discovers-language-preference"><span class="std std-ref">Django はどうやって言語の優先順位を検出するのか？</span></a> も参照してください。これにより、自分でキャッシュキーを作成する必要なく、複数言語のサイトを簡単にキャッシュできるようになります。</p>
<p><a class="reference internal" href="../ref/settings.html#std-setting-USE_TZ"><code class="xref std std-setting docutils literal notranslate"><span class="pre">USE_TZ</span></code></a> が <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定されている場合、キャッシュキーには <a class="reference internal" href="i18n/timezones.html#default-current-time-zone"><span class="std std-ref">カレントタイムゾーン</span></a> も含まれます。</p>
</section>
<section id="s-the-per-view-cache">
<span id="the-per-view-cache"></span><h2>ビューごとのキャッシュ<a class="headerlink" href="#the-per-view-cache" title="Link to this heading">¶</a></h2>
<dl class="py function">
<dt class="sig sig-object py" id="django.views.decorators.cache.cache_page">
<span class="sig-prename descclassname"><span class="pre">django.views.decorators.cache.</span></span><span class="sig-name descname"><span class="pre">cache_page</span></span>(<em class="sig-param"><span class="n"><span class="pre">timeout</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cache</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">key_prefix</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.views.decorators.cache.cache_page" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>キャッシュフレームワークをより細かい単位で使用するには、個別のビューの出力をキャッシュする方法があります。<code class="docutils literal notranslate"><span class="pre">django.views.decorators.cache</span></code> は <code class="docutils literal notranslate"><span class="pre">cache_page</span></code> デコレーターを定義しており、これを使うとビューのレスポンスが自動的にキャッシュされるようになります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache_page</span>


<span class="nd">@cache_page</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cache_page</span></code> はキャッシュのタイムアウトを秒数で指定する1つの引数を取ります。上の例では、<code class="docutils literal notranslate"><span class="pre">my_view()</span></code>  ビューの結果が15分間キャッシュされます。(ここでリーダビリティのために <code class="docutils literal notranslate"><span class="pre">60</span> <span class="pre">*</span> <span class="pre">15</span></code> と書いていることに注意してください。<code class="docutils literal notranslate"><span class="pre">60</span> <span class="pre">*</span> <span class="pre">15</span></code> は <code class="docutils literal notranslate"><span class="pre">900</span></code> つまり15分×60秒と評価されます。)</p>
<p><code class="docutils literal notranslate"><span class="pre">cache_page</span></code> で設定されたキャッシュのタイムアウトは、<code class="docutils literal notranslate"><span class="pre">Cache-Control</span></code> ヘッダの <code class="docutils literal notranslate"><span class="pre">max-age</span></code> ディレクティブよりも優先されます。</p>
<p>サイトごとのキャッシュと同様に、ビューごとのキャッシュは URL でキーが区別されます。もし複数の URL が同じビューを指した場合、各 URL が別にキャッシュされます。<code class="docutils literal notranslate"><span class="pre">my_view</span></code> の例を続けて、URLconf が次のようになっているとします。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">&quot;foo/&lt;int:code&gt;/&quot;</span><span class="p">,</span> <span class="n">my_view</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>このとき、<code class="docutils literal notranslate"><span class="pre">/foo/1/</span></code> と <code class="docutils literal notranslate"><span class="pre">/foo/23/</span></code> へのリクエストは別々にキャッシュされます。しかし、特定の URL (たとえば、<code class="docutils literal notranslate"><span class="pre">/foo/23/</span></code>) が一度リクエストされると、その URL への続くリクエストにはキャッシュが使われます。</p>
<p><code class="docutils literal notranslate"><span class="pre">cache_page</span></code> はオプション引数の <code class="docutils literal notranslate"><span class="pre">cache</span></code> を取ることもできます。これを使うと、ビューの結果をキャッシュするときに、デコレータに (<a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> 設定から) 特定のキャッシュを使うように指示できます。デフォルトでは、<code class="docutils literal notranslate"><span class="pre">default</span></code> キャッシュが使われますが、使いたいキャッシュはどれでも指定できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@cache_page</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="s2">&quot;special_cache&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p>また、ビューごとにキャッシュプレフィックスを上書きすることもできます。 <code class="docutils literal notranslate"><span class="pre">cache_page</span></code> はオプションのキーワード引数 <code class="docutils literal notranslate"><span class="pre">key_prefix</span></code> を取ります。これはミドルウェアの <a class="reference internal" href="../ref/settings.html#std-setting-CACHE_MIDDLEWARE_KEY_PREFIX"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHE_MIDDLEWARE_KEY_PREFIX</span></code></a> 設定と同じように動作します。 次のように使用します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@cache_page</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">15</span><span class="p">,</span> <span class="n">key_prefix</span><span class="o">=</span><span class="s2">&quot;site1&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">key_prefix</span></code> 引数と <code class="docutils literal notranslate"><span class="pre">cache</span></code> 引数は同時に指定できます。 <code class="docutils literal notranslate"><span class="pre">key_prefix</span></code> 引数と <a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> で指定した <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-KEY_PREFIX"><code class="xref std std-setting docutils literal notranslate"><span class="pre">KEY_PREFIX</span></code></a> は連結されます。</p>
<p>さらに、 <code class="docutils literal notranslate"><span class="pre">cache_page</span></code> は自動的にレスポンスに <code class="docutils literal notranslate"><span class="pre">Cache-Control</span></code> と <code class="docutils literal notranslate"><span class="pre">Expires</span></code> ヘッダを設定します。このヘッダは <a class="reference internal" href="#downstream-caches"><span class="std std-ref">ダウンストリームキャッシュ</span></a> に影響を与えます。</p>
<section id="s-specifying-per-view-cache-in-the-urlconf">
<span id="specifying-per-view-cache-in-the-urlconf"></span><h3>ビューごとのキャッシュを URLconf で指定する<a class="headerlink" href="#specifying-per-view-cache-in-the-urlconf" title="Link to this heading">¶</a></h3>
<p>前のセクションの例では、 <code class="docutils literal notranslate"><span class="pre">cache_page</span></code> が <code class="docutils literal notranslate"><span class="pre">my_view</span></code> 関数を変更するため、ビューがキャッシュされることをハードコードしていました。この方法では、ビューをキャッシュシステムに結合することになり、いくつかの理由から理想的ではありません。例えば、キャッシュのない別のサイトでビュー関数を再利用したい場合や、キャッシュされずにビューを使いたい人にビューを配布したい場合などです。このような問題の解決策は、ビュー関数そのものではなく URLconf でビューごとのキャッシュを指定することです。</p>
<p>URLconf でビュー関数を参照するときに <code class="docutils literal notranslate"><span class="pre">cache_page</span></code> でラップすることで、これを実現できます。以下は以前の古い URLconf です。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">&quot;foo/&lt;int:code&gt;/&quot;</span><span class="p">,</span> <span class="n">my_view</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
</div>
<p>以下は <code class="docutils literal notranslate"><span class="pre">my_view</span></code> を <code class="docutils literal notranslate"><span class="pre">cache_page</span></code> でラップしたものです。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache_page</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s2">&quot;foo/&lt;int:code&gt;/&quot;</span><span class="p">,</span> <span class="n">cache_page</span><span class="p">(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">15</span><span class="p">)(</span><span class="n">my_view</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="s-template-fragment-caching">
<span id="s-std-templatetag-cache"></span><span id="template-fragment-caching"></span><span id="std-templatetag-cache"></span><h2>テンプレートフラグメントのキャッシュ<a class="headerlink" href="#template-fragment-caching" title="Link to this heading">¶</a></h2>
<p>さらにコントロールしたい場合は、 <code class="docutils literal notranslate"><span class="pre">cache</span></code> テンプレートタグを使ってテンプレートの断片をキャッシュすることもできます。テンプレートからこのタグにアクセスするには、テンプレートの先頭付近に <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">load</span> <span class="pre">cache</span> <span class="pre">%}</span></code> を記述します。</p>
<p>テンプレートタグ <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">cache</span> <span class="pre">%}</span></code> は指定した時間だけブロックの内容をキャッシュします。少なくとも2つの引数を取ります。秒単位のキャッシュタイムアウトと、キャッシュフラグメントに与える名前です。timeout が <code class="docutils literal notranslate"><span class="pre">None</span></code> の場合、フラグメントは永遠にキャッシュされます。名前はそのまま使用されるので、変数は使えません。次に例を示します。</p>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">cache</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">cache</span> <span class="m">500</span> <span class="nv">sidebar</span> <span class="cp">%}</span>
    .. sidebar ..
<span class="cp">{%</span> <span class="k">endcache</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>フラグメントの内部に現れる動的なデータに応じて、フラグメントの複数のコピーをキャッシュしたい場合があります。たとえば、先ほどの例で使用したサイドバーを、サイトのすべてのユーザーに対して個別にキャッシュしたいとします。これを行うには、キャッシュフラグメントを一意に識別するために、フィルタの有無にかかわらず、1つ以上の追加の引数を <code class="docutils literal notranslate"><span class="pre">{%</span> <span class="pre">cache</span> <span class="pre">%}</span></code> テンプレートタグに渡します。</p>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">cache</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">cache</span> <span class="m">500</span> <span class="nv">sidebar</span> <span class="nv">request.user.username</span> <span class="cp">%}</span>
    .. sidebar for logged in user ..
<span class="cp">{%</span> <span class="k">endcache</span> <span class="cp">%}</span>
</pre></div>
</div>
<p><a class="reference internal" href="../ref/settings.html#std-setting-USE_I18N"><code class="xref std std-setting docutils literal notranslate"><span class="pre">USE_I18N</span></code></a> が <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定されている場合、サイトごとのミドルウェアキャッシュは <a class="reference internal" href="#i18n-cache-key"><span class="std std-ref">アクティブな言語</span></a> を尊重します。テンプレートタグの <code class="docutils literal notranslate"><span class="pre">cache</span></code> では <a class="reference internal" href="i18n/translation.html#template-translation-vars"><span class="std std-ref">翻訳固有の変数</span></a> を使えば同じ結果が得られます:</p>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">load</span> <span class="nv">i18n</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">cache</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">get_current_language</span> <span class="k">as</span> <span class="nv">LANGUAGE_CODE</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">cache</span> <span class="m">600</span> <span class="nv">welcome</span> <span class="nv">LANGUAGE_CODE</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">translate</span> <span class="s2">&quot;Welcome to example.com&quot;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endcache</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>テンプレート変数が整数値に解決されるなら、キャッシュタイムアウトにはテンプレート変数が使えます。例えば、テンプレート変数 <code class="docutils literal notranslate"><span class="pre">my_timeout</span></code> が値 <code class="docutils literal notranslate"><span class="pre">600</span></code> に指定されている場合、以下の2つの例は等価です:</p>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">cache</span> <span class="m">600</span> <span class="nv">sidebar</span> <span class="cp">%}</span> ... <span class="cp">{%</span> <span class="k">endcache</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">cache</span> <span class="nv">my_timeout</span> <span class="nv">sidebar</span> <span class="cp">%}</span> ... <span class="cp">{%</span> <span class="k">endcache</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>この機能はテンプレート内での繰り返しを避けるのに便利です。1つの変数にタイムアウトを指定し、その値を再利用できます。</p>
<p>デフォルトでは、キャッシュタグは &quot;template_fragments&quot; というキャッシュを使用しようとします。そのようなキャッシュが存在しない場合は、デフォルトのキャッシュを使用します。キーワード引数 <code class="docutils literal notranslate"><span class="pre">using</span></code> で、使用する別のキャッシュバックエンドを選択できます。</p>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">cache</span> <span class="m">300</span> <span class="nv">local-thing</span> <span class="p">...</span>  <span class="nv">using</span><span class="o">=</span><span class="s2">&quot;localcache&quot;</span> <span class="cp">%}</span>
</pre></div>
</div>
<p>設定されていないキャッシュ名を指定することはエラーとみなされます。</p>
<dl class="py function">
<dt class="sig sig-object py" id="django.core.cache.utils.make_template_fragment_key">
<span class="sig-prename descclassname"><span class="pre">django.core.cache.utils.</span></span><span class="sig-name descname"><span class="pre">make_template_fragment_key</span></span>(<em class="sig-param"><span class="n"><span class="pre">fragment_name</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vary_on</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.utils.make_template_fragment_key" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>キャッシュされたフラグメントに使用されるキャッシュキーを取得したい場合は、 <code class="docutils literal notranslate"><span class="pre">make_template_fragment_key</span></code> を使用します。フラグメント名 <code class="docutils literal notranslate"><span class="pre">fragment_name</span></code> は <code class="docutils literal notranslate"><span class="pre">cache</span></code> テンプレートタグの2番目の引数と同じです。この関数は、キャッシュされたアイテムを無効にしたり上書きしたりする場合などに便利です:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.cache.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_template_fragment_key</span>
<span class="go"># cache key for {% cache 500 sidebar username %}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">key</span> <span class="o">=</span> <span class="n">make_template_fragment_key</span><span class="p">(</span><span class="s2">&quot;sidebar&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">username</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># invalidates cached template fragment</span>
<span class="go">True</span>
</pre></div>
</div>
</section>
<section id="s-the-low-level-cache-api">
<span id="s-low-level-cache-api"></span><span id="the-low-level-cache-api"></span><span id="low-level-cache-api"></span><h2>低レベルキャッシュ API<a class="headerlink" href="#the-low-level-cache-api" title="Link to this heading">¶</a></h2>
<p>レンダリングされたページ全体をキャッシュしてもあまりメリットがないこともありますし、実際、過剰なキャッシュはかえって不便です。</p>
<p>たとえば、あなたのサイトには、結果が複数の高コストなクエリに依存し、その結果が異なる間隔で変化するビューが含まれているとします。この場合、サイト単位やビュー単位のキャッシュ戦略が提供するフルページキャッシュを使うのは理想的ではありません。なぜなら、結果全体をキャッシュしたいとは思わないでしょうが(データの一部が頻繁に変更されるからです)、めったに変更されない結果はキャッシュしたいからです。</p>
<p>このような場合のために、 Django は低レベルのキャッシュ API を公開しています。この API を使えば、好きなレベルでオブジェクトをキャッシュに保存できます。 安全に pickle 化できる Python オブジェクトなら何でもキャッシュできます: 文字列、辞書、モデルオブジェクトのリストなど。(ほとんどの一般的なPythonオブジェクトはpickle化できます。pickle化についての詳細はPythonのドキュメントを参照してください)。</p>
<section id="s-accessing-the-cache">
<span id="accessing-the-cache"></span><h3>キャッシュへのアクセス<a class="headerlink" href="#accessing-the-cache" title="Link to this heading">¶</a></h3>
<dl class="py data">
<dt class="sig sig-object py" id="django.core.cache.caches">
<span class="sig-prename descclassname"><span class="pre">django.core.cache.</span></span><span class="sig-name descname"><span class="pre">caches</span></span><a class="headerlink" href="#django.core.cache.caches" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> 設定で設定したキャッシュには、 <code class="docutils literal notranslate"><span class="pre">django.core.cache.caches</span></code> という Dict のようなオブジェクトでアクセスできます。同じスレッドで同じエイリアスを繰り返しリクエストすると、同じオブジェクトが返されます。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">caches</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache1</span> <span class="o">=</span> <span class="n">caches</span><span class="p">[</span><span class="s2">&quot;myalias&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache2</span> <span class="o">=</span> <span class="n">caches</span><span class="p">[</span><span class="s2">&quot;myalias&quot;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache1</span> <span class="ow">is</span> <span class="n">cache2</span>
<span class="go">True</span>
</pre></div>
</div>
<p>指定したキーが存在しない場合、 <code class="docutils literal notranslate"><span class="pre">InvalidCacheBackendError</span></code> が発生します。</p>
<p>スレッドセーフを実現するために、キャッシュバックエンドの異なるインスタンスがスレッドごとに返されます。</p>
</dd></dl>

<dl class="py data">
<dt class="sig sig-object py" id="django.core.cache.cache">
<span class="sig-prename descclassname"><span class="pre">django.core.cache.</span></span><span class="sig-name descname"><span class="pre">cache</span></span><a class="headerlink" href="#django.core.cache.cache" title="Link to this definition">¶</a></dt>
<dd><p>ショートカットとして、デフォルトのキャッシュは <code class="docutils literal notranslate"><span class="pre">django.core.cache.cache</span></code> で利用できます:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache</span>
</pre></div>
</div>
<p>このオブジェクトは <code class="docutils literal notranslate"><span class="pre">caches['default']</span></code> と等価です。</p>
</dd></dl>

</section>
<section id="s-basic-usage">
<span id="s-cache-basic-interface"></span><span id="basic-usage"></span><span id="cache-basic-interface"></span><h3>基本的な使用法<a class="headerlink" href="#basic-usage" title="Link to this heading">¶</a></h3>
<p>基本的なインターフェイスは、次のようになります。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.set">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">set</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timeout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">DEFAULT_TIMEOUT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.set" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">,</span> <span class="s2">&quot;hello, world!&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.get">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">get</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.get" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">)</span>
<span class="go">&#39;hello, world!&#39;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">key</span></code> には <code class="docutils literal notranslate"><span class="pre">str</span></code> を指定し、 <code class="docutils literal notranslate"><span class="pre">value</span></code> には任意の Python オブジェクトを指定します。</p>
<p>引数の <code class="docutils literal notranslate"><span class="pre">timeout</span></code> はオプションで、デフォルトは <a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> 設定 (上記で説明) にある適切なバックエンドの <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 引数です。これはキャッシュに保存される秒数です。 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> に <code class="docutils literal notranslate"><span class="pre">None</span></code> を渡すと、値は永遠にキャッシュされます。 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> に <code class="docutils literal notranslate"><span class="pre">0</span></code> を渡すと、値はキャッシュされません。</p>
<p>オブジェクトがキャッシュに存在しない場合、 <code class="docutils literal notranslate"><span class="pre">cache.get()</span></code> は <code class="docutils literal notranslate"><span class="pre">None</span></code> を返します:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Wait 30 seconds for &#39;my_key&#39; to expire...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">)</span>
<span class="go">None</span>
</pre></div>
</div>
<p>オブジェクトがキャッシュに存在するかどうかを判断する必要があり、リテラル値 <code class="docutils literal notranslate"><span class="pre">None</span></code> を保存した場合は、デフォルトとして sentinel オブジェクトを使用します:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">sentinel</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="n">sentinel</span>
<span class="go">False</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Wait 30 seconds for &#39;my_key&#39; to expire...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">,</span> <span class="n">sentinel</span><span class="p">)</span> <span class="ow">is</span> <span class="n">sentinel</span>
<span class="go">True</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cache.get()</span></code> は <code class="docutils literal notranslate"><span class="pre">default</span></code> 引数を取ることができます。これは、オブジェクトがキャッシュに存在しない場合に返す値を指定します:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">,</span> <span class="s2">&quot;has expired&quot;</span><span class="p">)</span>
<span class="go">&#39;has expired&#39;</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.add">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">add</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timeout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">DEFAULT_TIMEOUT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.add" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>キーがまだ存在しない場合にのみキーを追加するには、 <code class="docutils literal notranslate"><span class="pre">add()</span></code> メソッドを使用します。このメソッドは <code class="docutils literal notranslate"><span class="pre">set()</span></code> と同じパラメータを受け取りますが、指定したキーがすでに存在する場合はキャッシュを更新しようとしません:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;add_key&quot;</span><span class="p">,</span> <span class="s2">&quot;Initial value&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s2">&quot;add_key&quot;</span><span class="p">,</span> <span class="s2">&quot;New value&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_key&quot;</span><span class="p">)</span>
<span class="go">&#39;Initial value&#39;</span>
</pre></div>
</div>
<p>もし <code class="docutils literal notranslate"><span class="pre">add()</span></code> が値をキャッシュに保存したかどうかを知りたい場合は、戻り値をチェックできます。値が保存されていれば <code class="docutils literal notranslate"><span class="pre">True</span></code> を返し、そうでなければ <code class="docutils literal notranslate"><span class="pre">False</span></code> を返します。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.get_or_set">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">get_or_set</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timeout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">DEFAULT_TIMEOUT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.get_or_set" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>キーの値を取得したり、そのキーがキャッシュにない場合に値を設定したい場合は、 <code class="docutils literal notranslate"><span class="pre">get_or_set()</span></code> メソッドが使えます。これは <code class="docutils literal notranslate"><span class="pre">get()</span></code> と同じパラメータを受け取りますが、そのキーのデフォルトの戻り値が設定されます:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_new_key&quot;</span><span class="p">)</span>  <span class="c1"># returns None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get_or_set</span><span class="p">(</span><span class="s2">&quot;my_new_key&quot;</span><span class="p">,</span> <span class="s2">&quot;my new value&quot;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="go">&#39;my new value&#39;</span>
</pre></div>
</div>
<p>また、任意の呼び出し可能オブジェクトを <em>デフォルト</em> 値として渡すこともできます:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get_or_set</span><span class="p">(</span><span class="s2">&quot;some-timestamp-key&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">)</span>
<span class="go">datetime.datetime(2014, 12, 11, 0, 15, 49, 457920)</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.get_many">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">get_many</span></span>(<em class="sig-param"><span class="n"><span class="pre">keys</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.get_many" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>一度だけキャッシュをヒットする <code class="docutils literal notranslate"><span class="pre">get_many()</span></code> インターフェースもあります。 <code class="docutils literal notranslate"><span class="pre">get_many()</span></code> は、キャッシュに実際に存在する (そして有効期限が切れていない) キーをすべて含む辞書を返します:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get_many</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span>
<span class="go">{&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: 3}</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.set_many">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">set_many</span></span>(<em class="sig-param"><span class="n"><span class="pre">dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timeout</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.set_many" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>より効率的に複数の値を指定するには、 <code class="docutils literal notranslate"><span class="pre">set_many()</span></code> を使用してキーと値のペアの辞書を渡します:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">set_many</span><span class="p">({</span><span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get_many</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span>
<span class="go">{&#39;a&#39;: 1, &#39;b&#39;: 2, &#39;c&#39;: 3}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cache.set()</span></code> と同様に、 <code class="docutils literal notranslate"><span class="pre">set_many()</span></code> はオプションの <code class="docutils literal notranslate"><span class="pre">timeout</span></code> パラメータを受け取ります。</p>
<p>サポートされているバックエンド (memcached) では、 <code class="docutils literal notranslate"><span class="pre">set_many()</span></code> は挿入に失敗したキーのリストを返します。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.delete">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">delete</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.delete" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">delete()</span></code> で明示的にキーを削除することで、特定のオブジェクトのキャッシュをクリアできます:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">delete()</span></code> はキーの削除に成功すると <code class="docutils literal notranslate"><span class="pre">True</span></code> を返し、失敗すると <code class="docutils literal notranslate"><span class="pre">False</span></code> を返します。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.delete_many">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">delete_many</span></span>(<em class="sig-param"><span class="n"><span class="pre">keys</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.delete_many" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>一度にたくさんのキーをクリアしたい場合は、 <code class="docutils literal notranslate"><span class="pre">delete_many()</span></code> にクリアしたいキーのリストを渡します:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">delete_many</span><span class="p">([</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">])</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.clear">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">clear</span></span>()<a class="headerlink" href="#django.core.cache.cache.clear" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>最後に、キャッシュ内のすべてのキーを削除したい場合は、<code class="docutils literal notranslate"><span class="pre">cache.clear()</span></code> を使用してください。ただし、この操作には注意が必要です。<code class="docutils literal notranslate"><span class="pre">clear()</span></code> はアプリケーションによって設定されたキーだけでなく、 <strong>キャッシュ内のすべて</strong> を削除します。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.touch">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">touch</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timeout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">DEFAULT_TIMEOUT</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.touch" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">cache.touch()</span></code> はキーの有効期限を設定します。例えば、キーの有効期限を10秒後に更新する場合:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">touch</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
<p>他のメソッドと同様に、 <code class="docutils literal notranslate"><span class="pre">timeout</span></code> 引数はオプションで、デフォルトは <a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> 設定の適切なバックエンドの <code class="docutils literal notranslate"><span class="pre">TIMEOUT</span></code> オプションです。</p>
<p><code class="docutils literal notranslate"><span class="pre">touch()</span></code> はキーが正しく touch された場合は <code class="docutils literal notranslate"><span class="pre">True</span></code> を返し、そうでない場合は <code class="docutils literal notranslate"><span class="pre">False</span></code> を返します。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.incr">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">incr</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">delta</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.incr" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.decr">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">decr</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">delta</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">version</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.core.cache.cache.decr" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">incr()</span></code> メソッドまたは <code class="docutils literal notranslate"><span class="pre">decr()</span></code> メソッドを使用して、既に存在するキーをインクリメント/デクリメントすることもできます。デフォルトでは、既存のキャッシュの値が 1 だけインクリメント/デクリメントされます。インクリメント/デクリメントの呼び出しに引数を指定することで、1以外のインクリメント/デクリメント値を指定できます。存在しないキャッシュ・キーをインクリメントまたはデクリメントしようとすると、ValueError が発生します:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">)</span>
<span class="go">2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">incr</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="go">12</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">decr</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">)</span>
<span class="go">11</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">decr</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="go">6</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p><code class="docutils literal notranslate"><span class="pre">incr()</span></code>/<code class="docutils literal notranslate"><span class="pre">decr()</span></code> メソッドはアトミックであることは保証されていません。アトミックなインクリメント/デクリメントをサポートしているバックエンド (特に memcached バックエンド) では、インクリメントとデクリメントの操作はアトミックに行われます。しかし、バックエンドがネイティブにインクリメント/デクリメント操作を提供していない場合は、取得/更新の2段階を使って実装されます。</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.core.cache.cache.close">
<span class="sig-prename descclassname"><span class="pre">cache.</span></span><span class="sig-name descname"><span class="pre">close</span></span>()<a class="headerlink" href="#django.core.cache.cache.close" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>キャッシュバックエンドに実装されていれば、 <code class="docutils literal notranslate"><span class="pre">close()</span></code> でキャッシュへの接続を閉じることができます。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p><code class="docutils literal notranslate"><span class="pre">close</span></code> メソッドを実装していないキャッシュでは、このメソッドは何もしません。</p>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>メソッドの非同期バージョンは、ベースとなるメソッドに <code class="docutils literal notranslate"><span class="pre">a</span></code> で始まるプレフィックスが付けられています。例えば、 <code class="docutils literal notranslate"><span class="pre">cache.aadd()</span></code> や <code class="docutils literal notranslate"><span class="pre">cache.adelete_many()</span></code> です。詳細については <a class="reference internal" href="#id14">Asynchronous support</a> を参照してください。</p>
</div>
</section>
<section id="s-cache-key-prefixing">
<span id="s-id11"></span><span id="cache-key-prefixing"></span><span id="id11"></span><h3>キャッシュ キーにプレフィックスを付ける<a class="headerlink" href="#cache-key-prefixing" title="Link to this heading">¶</a></h3>
<p>サーバ間でキャッシュインスタンスを共有している場合、あるいは本番環境と開発環境の間でキャッシュインスタンスを共有している場合、あるサーバでキャッシュされたデータが別のサーバで使用される可能性があります。キャッシュされたデータのフォーマットがサーバ間で異なる場合、非常に診断が難しい問題につながる可能性があります。</p>
<p>これを防ぐために、 Django はサーバが使う全てのキャッシュキーの前にプレフィックスを付ける機能を提供します。特定のキャッシュキーが保存または取得されると、 Django は自動的に <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-KEY_PREFIX"><code class="xref std std-setting docutils literal notranslate"><span class="pre">KEY_PREFIX</span></code></a> キャッシュ設定の値をキャッシュキーの先頭に付加します。</p>
<p>各 Django インスタンスに異なる <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-KEY_PREFIX"><code class="xref std std-setting docutils literal notranslate"><span class="pre">KEY_PREFIX</span></code></a> を持たせることで、キャッシュ値が衝突しないようにできます。</p>
</section>
<section id="s-cache-versioning">
<span id="s-id12"></span><span id="cache-versioning"></span><span id="id12"></span><h3>キャッシュのバージョン管理<a class="headerlink" href="#cache-versioning" title="Link to this heading">¶</a></h3>
<p>キャッシュされた値を使用する実行中のコードを変更する場合、既存のキャッシュされた値を消去する必要があるかもしれません。これを行う最も簡単な方法はキャッシュ全体を削除することですが、まだ有効で有用なキャッシュ値を失うことになります。</p>
<p>Django は個々のキャッシュ値をターゲットにする、より良い方法を提供します。Django のキャッシュフレームワークには、 <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-VERSION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">VERSION</span></code></a> キャッシュ設定で指定できる、システム全体のバージョン識別子があります。この設定の値は、自動的にキャッシュ・プレフィックスとユーザが指定したキャッシュ・キーと組み合わされ、最終的なキャッシュ・キーが得られます。</p>
<p>デフォルトでは、どのようなキャッシュキーのリクエストも自動的にサイトのデフォルトのキャッシュキーのバージョンを含みます。しかし、基本的なキャッシュ関数には <code class="docutils literal notranslate"><span class="pre">version</span></code> 引数が含まれているので、特定のキャッシュキーのバージョンを指定できます。たとえば:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Set version 2 of a cache key</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">,</span> <span class="s2">&quot;hello world!&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Get the default version (assuming version=1)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">)</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Get version 2 of the same key</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">&#39;hello world!&#39;</span>
</pre></div>
</div>
<p>特定のキーのバージョンは <code class="docutils literal notranslate"><span class="pre">incr_version()</span></code> メソッドと <code class="docutils literal notranslate"><span class="pre">decr_version()</span></code> メソッドで増減できます。これにより、特定のキーのバージョンを新しいものに変更できます。先ほどの例の続きで、下記のようにします:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Increment the version of &#39;my_key&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">incr_version</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># The default version still isn&#39;t available</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">)</span>
<span class="go">None</span>
<span class="go"># Version 2 isn&#39;t available, either</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="go">None</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># But version 3 *is* available</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;my_key&quot;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="go">&#39;hello world!&#39;</span>
</pre></div>
</div>
</section>
<section id="s-cache-key-transformation">
<span id="s-id13"></span><span id="cache-key-transformation"></span><span id="id13"></span><h3>キャッシュキーの変換<a class="headerlink" href="#cache-key-transformation" title="Link to this heading">¶</a></h3>
<p>前の2つのセクションで説明したように、ユーザから提供されたキャッシュ・キーはそのまま使用されるわけではありません。このキーは、キャッシュ・プレフィックスおよびキーバージョンと組み合わされて最終的なキャッシュ・キーとなります。デフォルトでは、3 つの部分はコロンで結合されて最終的な文字列となります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">make_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_prefix</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key_prefix</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
<p>各部分をさまざまな方法で組み合わせたり、最終的なキーに他の処理を施したりしたい場合は（例えば、キーの部品のハッシュダイジェストを取るなど）、独自のキー関数を作成できます。</p>
<p><a class="reference internal" href="../ref/settings.html#std-setting-CACHES-KEY_FUNCTION"><code class="xref std std-setting docutils literal notranslate"><span class="pre">KEY_FUNCTION</span></code></a> キャッシュ設定では、上記の <code class="docutils literal notranslate"><span class="pre">make_key()</span></code> のプロトタイプにマッチする関数へのドット区切りパスを指定します。指定された場合、デフォルトのキー結合関数の代わりにこのカスタムキー関数が使用されます。</p>
</section>
<section id="s-cache-key-warnings">
<span id="cache-key-warnings"></span><h3>キャッシュキーの警告<a class="headerlink" href="#cache-key-warnings" title="Link to this heading">¶</a></h3>
<p>最も一般的に使用されているキャッシュバックエンドである Memcached は、 250 文字より長いキャッシュキーや、空白文字や制御文字を含むキャッシュキーを許可しておらず、そのようなキーを使用すると例外が発生します。キャッシュ移植可能なコードを推奨し、不快な驚きを最小化するために、他の組み込みキャッシュバックエンドは、 memcached でエラーを引き起こすようなキーが使用された場合、警告 (<code class="docutils literal notranslate"><span class="pre">django.core.cache.backends.base.CacheKeyWarning</span></code>) を出します。</p>
<p>より広い範囲のキーを使用できるバックエンド (カスタムバックエンド、または非emcachedの組み込みバックエンド) を使用していて、警告を出さずにより広い範囲のキーを使用したい場合は、 <a class="reference internal" href="../ref/settings.html#std-setting-INSTALLED_APPS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code></a> の <code class="docutils literal notranslate"><span class="pre">management</span></code> モジュールにあるこのコードで <code class="docutils literal notranslate"><span class="pre">CacheKeyWarning</span></code> を無効にできます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">CacheKeyWarning</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">CacheKeyWarning</span><span class="p">)</span>
</pre></div>
</div>
<p>組み込みのバックエンドに対してカスタムキーバリデーションのロジックを提供したい場合は、そのバックエンドをサブクラス化して <code class="docutils literal notranslate"><span class="pre">validate_key</span></code> メソッドだけをオーバーライドし、 <a class="reference internal" href="#using-a-custom-cache-backend">using a custom cache backend</a> の説明に従ってください。たとえば、 <code class="docutils literal notranslate"><span class="pre">locmem</span></code> バックエンドに対してこの処理を行うには、次のコードをモジュールに記述します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.cache.backends.locmem</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocMemCache</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CustomLocMemCache</span><span class="p">(</span><span class="n">LocMemCache</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom validation, raising exceptions or warnings as needed.&quot;&quot;&quot;</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>...そして、このクラスへのドット区切りパスを <a class="reference internal" href="../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> 設定の <a class="reference internal" href="../ref/settings.html#std-setting-CACHES-BACKEND"><code class="xref std std-setting docutils literal notranslate"><span class="pre">BACKEND</span></code></a> 部分で使用します。</p>
</section>
</section>
<section id="s-asynchronous-support">
<span id="s-id14"></span><span id="asynchronous-support"></span><span id="id14"></span><h2>非同期サポート<a class="headerlink" href="#asynchronous-support" title="Link to this heading">¶</a></h2>
<p>Django は非同期キャッシュバックエンドのサポートを開発中ですが、非同期キャッシュはまだサポートしていません。将来のリリースで対応する予定です。</p>
<p><code class="docutils literal notranslate"><span class="pre">django.core.cache.backends.base.BaseCache</span></code> には <a class="reference internal" href="#cache-basic-interface"><span class="std std-ref">全ての基本メソッド</span></a> の非同期バージョンがあります。慣習として、すべてのメソッドの非同期バージョンのプレフィックスは <code class="docutils literal notranslate"><span class="pre">a</span></code> です。デフォルトでは、両方の引数は同じです:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">aset</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">await</span> <span class="n">cache</span><span class="o">.</span><span class="n">ahas_key</span><span class="p">(</span><span class="s2">&quot;num&quot;</span><span class="p">)</span>
<span class="go">True</span>
</pre></div>
</div>
</section>
<section id="s-downstream-caches">
<span id="s-id15"></span><span id="downstream-caches"></span><span id="id15"></span><h2>ダウンストリームキャッシュ<a class="headerlink" href="#downstream-caches" title="Link to this heading">¶</a></h2>
<p>これまで、このドキュメントは自分自身が <em>持つ</em> データに焦点を当ててきました。しかし、ウェブ開発では別の種類のキャッシュも関係があります。それは、「ダウンストリーム」のキャッシュによって実行されるキャッシングです。ユーザーのために、リクエストがウェブサイトに到達する前にもページをキャッシュするシステムが存在します。</p>
<p>ダウンストリーム キャッシュの例をいくつか挙げます。</p>
<ul class="simple">
<li><p>HTTPを使用する場合、あなたの <abbr title="Internet Service Provider">ISP</abbr> は特定のページをキャッシュすることがあります。そのため、もしあなたが <code class="docutils literal notranslate"><span class="pre">http://example.com/</span></code> からページをリクエストした場合、あなたのISPはexample.comに直接アクセスすることなく、あなたにそのページを送信します。example.comの管理者はこのようなキャッシュを知りません。ISPはexample.comとあなたのウェブブラウザの間に位置し、透過的にすべてのキャッシュを処理します。このようなキャッシュは、中間者攻撃（man-in-the-middle attack）となるため、HTTPSでは不可能です。</p></li>
<li><p>あなたの Django ウェブサイトは、Squid Web Proxy Cache (<a class="reference external" href="http://www.squid-cache.org/">http://www.squid-cache.org/</a>) のような <em>プロキシキャッシュ</em> の背後にあるかもしれません。この場合、各リクエストはまずプロキシによって処理され、必要なときだけアプリケーションに渡されます。</p></li>
<li><p>ウェブブラウザもページをキャッシュします。ウェブページが適切なヘッダーを送信すると、ブラウザはそのページへのその後のリクエストに、変更されたかどうかを確認するためにウェブページに再度問い合わせることなく、ローカルにキャッシュされたコピーを使用します。</p></li>
</ul>
<p>ダウンストリーム・キャッシュは効率性を高めてくれますが、危険性もあります。 多くのウェブページのコンテンツは、認証や他の変数のホストに基づいて異なっており、純粋にURLに基づいてやみくもにページを保存するキャッシュシステムは、それらのページにあとから訪問する人に不正確なデータや機密データを公開する可能性があります。</p>
<p>たとえば、ウェブメールシステムを運営している場合、「受信トレイ」ページの内容は、どのユーザーがログインしているかによって異なります。もしISPがやみくもにあなたのサイトをキャッシュしていたら、そのISP経由で最初にログインしたユーザーは、そのユーザー固有の受信トレイページを、それ以降のサイト訪問者のためにキャッシュすることになります。 それはクールではありません。</p>
<p>幸い、HTTP はこの問題の解決方法を提供しています。さまざまな HTTP ヘッダを使用することで、指定した変数に応じてキャッシュ コンテンツを変えるようにダウンストリーム キャッシュに支持したり、特定のページをキャッシュしないようにキャッシュメカニズムに伝えることができます。以下のセクションでは、こうしたヘッダの一部を見ていきます。</p>
</section>
<section id="s-using-vary-headers">
<span id="s-id16"></span><span id="using-vary-headers"></span><span id="id16"></span><h2><code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダーを使う<a class="headerlink" href="#using-vary-headers" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダは、キャッシュメカニズムがキャッシュキーを作る際に、どのリクエストヘッダを考慮するべきかを定義します。たとえば、ウェブサイトのコンテンツがユーザーの言語設定に依存する場合、ページは「言語によって異なる (vary)」と言うことができます。</p>
<p>デフォルトでは、Django のキャッシュシステムは、リクエストされた完全修飾 URL (たとえば <code class="docutils literal notranslate"><span class="pre">&quot;https://www.example.com/stories/2005/?order_by=author&quot;</span></code>) を使ってキャッシュキーを作成します。つまり、クッキーや 言語設定などのユーザエージェントの違いに関係なく、その URL へのリクエストはすべて同じキャッシュバージョンを使うことになります。しかし、もしこのページがリクエストヘッダの違い、例えばクッキーや言語、ユーザーエージェントの違いによって異なるコンテンツを生成するのであれば、 <code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダを使ってキャッシュ機構にページの出力がそれらに依存していることを伝える必要があります。</p>
<p>これを Django で行うには、便利な <a class="reference internal" href="http/decorators.html#django.views.decorators.vary.vary_on_headers" title="django.views.decorators.vary.vary_on_headers"><code class="xref py py-func docutils literal notranslate"><span class="pre">django.views.decorators.vary.vary_on_headers()</span></code></a> ビューデコレータを次のように使います:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.vary</span><span class="w"> </span><span class="kn">import</span> <span class="n">vary_on_headers</span>


<span class="nd">@vary_on_headers</span><span class="p">(</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p>この場合、(Django 自身のキャッシュミドルウェアのような) キャッシュ機構は、それぞれのユニークなユーザエージェントに対して、別バージョンのページをキャッシュします。</p>
<p><code class="docutils literal notranslate"><span class="pre">vary_on_headers</span></code> デコレータを使用する利点は、手動で <code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダーを設定する (<code class="docutils literal notranslate"><span class="pre">response.headers['Vary']</span> <span class="pre">=</span> <span class="pre">'user-agent'</span></code> のように使用する) のではなく、デコレータが <code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダーに <em>追加</em> をする点にあります（これは既に存在するかもしれません）。それにより、最初から設定され、既にそこにあったものを上書きすることを避けることができます。</p>
<p>複数のヘッダを <code class="docutils literal notranslate"><span class="pre">vary_on_headers()</span></code> に渡すこともできます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@vary_on_headers</span><span class="p">(</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">,</span> <span class="s2">&quot;Cookie&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p>これは、下流のキャッシュに対して <em>両方</em> の vary に応じるように指示します。これは、user-agent と cookie の各組み合わせがそれぞれ独自のキャッシュ値を持つことを意味します。例えば、user-agent が <code class="docutils literal notranslate"><span class="pre">Mozilla</span></code> で cookie の値が <code class="docutils literal notranslate"><span class="pre">foo=bar</span></code> のリクエストは、user-agent が <code class="docutils literal notranslate"><span class="pre">Mozilla</span></code> で cookie の値が <code class="docutils literal notranslate"><span class="pre">foo=ham</span></code> のリクエストとは異なるものとみなされます。</p>
<p>クッキーで変化することはとても一般的なので、 <a class="reference internal" href="http/decorators.html#django.views.decorators.vary.vary_on_cookie" title="django.views.decorators.vary.vary_on_cookie"><code class="xref py py-func docutils literal notranslate"><span class="pre">django.views.decorators.vary.vary_on_cookie()</span></code></a> デコレータがあります。これら2つのビューは等価です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@vary_on_cookie</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>


<span class="nd">@vary_on_headers</span><span class="p">(</span><span class="s2">&quot;Cookie&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">vary_on_headers</span></code> に渡すヘッダは大文字小文字を区別しません。 <code class="docutils literal notranslate"><span class="pre">&quot;User-Agent&quot;</span></code> は <code class="docutils literal notranslate"><span class="pre">&quot;user-agent&quot;</span></code> と同じ意味です。</p>
<p><a class="reference internal" href="../ref/utils.html#django.utils.cache.patch_vary_headers" title="django.utils.cache.patch_vary_headers"><code class="xref py py-func docutils literal notranslate"><span class="pre">django.utils.cache.patch_vary_headers()</span></code></a> というヘルパー関数を直接使うこともできます。この関数は <code class="docutils literal notranslate"><span class="pre">Vary</span> <span class="pre">ヘッダ</span></code> を設定、または追加します。たとえば次のようにします:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">render</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch_vary_headers</span>


<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;template_name&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="n">patch_vary_headers</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;Cookie&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">patch_vary_headers</span></code> は <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpResponse</span></code></a> インスタンスを第 1 引数に、大文字小文字を区別しないヘッダ名のリスト/タプルを第 2 引数にとります。</p>
<p>Vary ヘッダについての詳細は <span class="target" id="index-6"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9110.html#section-12.5.5"><strong>公式な Vary の仕様</strong></a> を参照してください。</p>
</section>
<section id="s-controlling-cache-using-other-headers">
<span id="controlling-cache-using-other-headers"></span><h2>キャッシュの制御: 他のヘッダを使用する<a class="headerlink" href="#controlling-cache-using-other-headers" title="Link to this heading">¶</a></h2>
<p>キャッシュに関するその他の問題点としては、データのプライバシーや、キャッシュの階層構造のどこにデータを保存すべきかという問題があります。</p>
<p>ユーザーは通常2種類のキャッシュに直面します。自分のブラウザのキャッシュ（プライベートキャッシュ）とプロバイダのキャッシュ（パブリックキャッシュ）です。パブリックキャッシュは、複数のユーザーによって使用され、他の誰かによって制御されます。これは、機密データに関する問題を引き起こします。例えば、銀行の口座番号がパブリックキャッシュに保存されることは避けたいものです。そのため、ウェブアプリケーションには、どのデータがプライベートで、どのデータがパブリックであるかをキャッシュに伝える方法が必要です。</p>
<p>解決策は、ページのキャッシュを &quot;private&quot; にすることです。これを Django で行うには、 <a class="reference internal" href="http/decorators.html#django.views.decorators.cache.cache_control" title="django.views.decorators.cache.cache_control"><code class="xref py py-func docutils literal notranslate"><span class="pre">cache_control()</span></code></a> ビューデコレータを使います。例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache_control</span>


<span class="nd">@cache_control</span><span class="p">(</span><span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p>このデコレータは、適切な HTTP ヘッダーを背後で送信します。</p>
<p>キャッシュ制御の設定 &quot;private&quot; と &quot;public&quot; は互いに排他的であることに注意しましょう。デコレータは、&quot;private&quot; が設定されているときは &quot;public&quot; ディレクティブを削除します (逆も同様です)。2つのディレクティブの使用例は、プライベートとパブリックのエントリを提供するブログサイトです。公開エントリは共有キャッシュにキャッシュされます。以下のコードでは <a class="reference internal" href="../ref/utils.html#django.utils.cache.patch_cache_control" title="django.utils.cache.patch_cache_control"><code class="xref py py-func docutils literal notranslate"><span class="pre">patch_cache_control()</span></code></a> を使っています。これはキャッシュコントロールヘッダを手動で変更する方法です (内部的には <a class="reference internal" href="http/decorators.html#django.views.decorators.cache.cache_control" title="django.views.decorators.cache.cache_control"><code class="xref py py-func docutils literal notranslate"><span class="pre">cache_control()</span></code></a> デコレータから呼び出されます):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">patch_cache_control</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.vary</span><span class="w"> </span><span class="kn">import</span> <span class="n">vary_on_cookie</span>


<span class="nd">@vary_on_cookie</span>
<span class="k">def</span><span class="w"> </span><span class="nf">list_blog_entries_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_anonymous</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_only_public_entries</span><span class="p">()</span>
        <span class="n">patch_cache_control</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">render_private_and_public_entries</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
        <span class="n">patch_cache_control</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">private</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p>ダウンストリームのキャッシュは他の方法でも制御できます (HTTP キャッシュの詳細については <span class="target" id="index-7"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9111.html"><strong>RFC 9111</strong></a> を参照してください)。たとえば、 Django のサーバーサイドキャッシュフレームワークを使わない場合でも、 <span class="target" id="index-8"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc9111.html#section-5.2.2.1"><strong>max-age</strong></a> ディレクティブを使って、ビューを一定時間キャッシュするようにクライアントに指示できます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">cache_control</span>


<span class="nd">@cache_control</span><span class="p">(</span><span class="n">max_age</span><span class="o">=</span><span class="mi">3600</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">my_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
<p>(キャッシュミドルウェアを使用 <em>する</em> 場合、 <a class="reference internal" href="../ref/settings.html#std-setting-CACHE_MIDDLEWARE_SECONDS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHE_MIDDLEWARE_SECONDS</span></code></a> 設定の値で <code class="docutils literal notranslate"><span class="pre">max-age</span></code> が既に設定されています。その場合、 <a class="reference internal" href="http/decorators.html#django.views.decorators.cache.cache_control" title="django.views.decorators.cache.cache_control"><code class="xref py py-func docutils literal notranslate"><span class="pre">cache_control()</span></code></a> デコレータで指定した <code class="docutils literal notranslate"><span class="pre">max_age</span></code> が優先され、ヘッダ値は正しくマージされます)。</p>
<p>有効な <code class="docutils literal notranslate"><span class="pre">Cache-Control</span></code> レスポンスディレクティブはすべて <code class="docutils literal notranslate"><span class="pre">cache_control()</span></code> で有効です。以下はその例です:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">no_transform=True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">must_revalidate=True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stale_while_revalidate=num_seconds</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">no_cache=True</span></code></p></li>
</ul>
<p>既知のディレクティブの全リストは <a class="reference external" href="https://www.iana.org/assignments/http-cache-directives/http-cache-directives.xhtml">IANA registry</a> にあります (すべてのディレクティブがレスポンスに適用されるわけではないことに注意してください)。</p>
<p>ヘッダーを使用してキャッシュを完全に無効にしたい場合は、 <a class="reference internal" href="http/decorators.html#django.views.decorators.cache.never_cache" title="django.views.decorators.cache.never_cache"><code class="xref py py-func docutils literal notranslate"><span class="pre">never_cache()</span></code></a> が使えます。これはビューのデコレータであり、レスポンスがブラウザーや他のキャッシュによってキャッシュされないようにするヘッダーを追加します。例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.views.decorators.cache</span><span class="w"> </span><span class="kn">import</span> <span class="n">never_cache</span>


<span class="nd">@never_cache</span>
<span class="k">def</span><span class="w"> </span><span class="nf">myview</span><span class="p">(</span><span class="n">request</span><span class="p">):</span> <span class="o">...</span>
</pre></div>
</div>
</section>
<section id="s-order-of-middleware">
<span id="order-of-middleware"></span><h2><code class="docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code> の順序<a class="headerlink" href="#order-of-middleware" title="Link to this heading">¶</a></h2>
<p>キャッシュミドルウェアを使用する場合、下記の2つを <a class="reference internal" href="../ref/settings.html#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> 設定の適切な場所に配置することが重要です。キャッシュミドルウェアはどのヘッダによってキャッシュストレージを変化させるかを知る必要があるからです。ミドルウェアは常に <code class="docutils literal notranslate"><span class="pre">Vary</span></code> レスポンスヘッダに何かを追加します。</p>
<p><code class="docutils literal notranslate"><span class="pre">UpdateCacheMiddleware</span></code> はレスポンスフェーズの間に実行され、ミドルウェアは逆順に実行されるため、リストの先頭にある項目はレスポンスフェーズの間、 <em>最後に</em> 実行されます。したがって、 <code class="docutils literal notranslate"><span class="pre">UpdateCacheMiddleware</span></code> が <code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダに何かを追加する可能性のある他のミドルウェアの <em>前に</em> 配置されていることを確認する必要があります。以下のミドルウェアモジュールは <code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダに何らかのものを追加します:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SessionMiddleware</span></code> は <code class="docutils literal notranslate"><span class="pre">Cookie</span></code> を追加します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GZipMiddleware</span></code> は <code class="docutils literal notranslate"><span class="pre">Accept-Encoding</span></code> を追加します</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">LocaleMiddleware</span></code> は <code class="docutils literal notranslate"><span class="pre">Accept-Language</span></code> を追加します</p></li>
</ul>
<p>一方、<code class="docutils literal notranslate"><span class="pre">FetchFromCacheMiddleware</span></code> はリクエストフェーズで実行され、このフェーズではミドルウェアが先頭から最後にかけて適用されるため、リストの上部にあるアイテムはリクエストフェーズの <em>最初</em> に実行されます。 <code class="docutils literal notranslate"><span class="pre">FetchFromCacheMiddleware</span></code> もまた、他のミドルウェアが <code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダーを更新した後に実行する必要があるので、 <code class="docutils literal notranslate"><span class="pre">FetchFromCacheMiddleware</span></code> は <code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダーを更新するようなアイテムの <em>後</em> になければなりません。</p>
</section>
</section>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../contents.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">Django のキャッシュフレームワーク</a><ul>
<li><a class="reference internal" href="#setting-up-the-cache">キャッシュのセットアップ</a><ul>
<li><a class="reference internal" href="#memcached">Memcached</a></li>
<li><a class="reference internal" href="#redis">Redis</a></li>
<li><a class="reference internal" href="#database-caching">データベースのキャッシュ</a><ul>
<li><a class="reference internal" href="#creating-the-cache-table">キャッシュテーブルを作成する</a></li>
<li><a class="reference internal" href="#multiple-databases">複数のデータベース</a></li>
</ul>
</li>
<li><a class="reference internal" href="#filesystem-caching">ファイルシステムのキャッシュ</a></li>
<li><a class="reference internal" href="#local-memory-caching">ローカルメモリのキャッシュ</a></li>
<li><a class="reference internal" href="#dummy-caching-for-development">ダミーキャッシュ（開発用）</a></li>
<li><a class="reference internal" href="#using-a-custom-cache-backend">独自のキャッシュバックエンドを使う</a></li>
<li><a class="reference internal" href="#cache-arguments">キャッシュ引数</a></li>
</ul>
</li>
<li><a class="reference internal" href="#the-per-site-cache">サイトごとのキャッシュ</a></li>
<li><a class="reference internal" href="#the-per-view-cache">ビューごとのキャッシュ</a><ul>
<li><a class="reference internal" href="#specifying-per-view-cache-in-the-urlconf">ビューごとのキャッシュを URLconf で指定する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#template-fragment-caching">テンプレートフラグメントのキャッシュ</a></li>
<li><a class="reference internal" href="#the-low-level-cache-api">低レベルキャッシュ API</a><ul>
<li><a class="reference internal" href="#accessing-the-cache">キャッシュへのアクセス</a></li>
<li><a class="reference internal" href="#basic-usage">基本的な使用法</a></li>
<li><a class="reference internal" href="#cache-key-prefixing">キャッシュ キーにプレフィックスを付ける</a></li>
<li><a class="reference internal" href="#cache-versioning">キャッシュのバージョン管理</a></li>
<li><a class="reference internal" href="#cache-key-transformation">キャッシュキーの変換</a></li>
<li><a class="reference internal" href="#cache-key-warnings">キャッシュキーの警告</a></li>
</ul>
</li>
<li><a class="reference internal" href="#asynchronous-support">非同期サポート</a></li>
<li><a class="reference internal" href="#downstream-caches">ダウンストリームキャッシュ</a></li>
<li><a class="reference internal" href="#using-vary-headers"><code class="docutils literal notranslate"><span class="pre">Vary</span></code> ヘッダーを使う</a></li>
<li><a class="reference internal" href="#controlling-cache-using-other-headers">キャッシュの制御: 他のヘッダを使用する</a></li>
<li><a class="reference internal" href="#order-of-middleware"><code class="docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code> の順序</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="auth/customizing.html"
                          title="前の章へ">Django の認証方法のカスタマイズ</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="conditional-view-processing.html"
                          title="次の章へ">条件付きのビュー処理</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/topics/cache.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">1月 22, 2025</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="auth/customizing.html" title="Django の認証方法のカスタマイズ">previous</a>
     |
    <a href="index.html" title="Django を使う" accesskey="U">up</a>
   |
    <a href="conditional-view-processing.html" title="条件付きのビュー処理">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>