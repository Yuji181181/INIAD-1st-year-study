<!DOCTYPE html>

<html lang="ja" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>セッションの使いかた &#8212; Django 5.1.6.dev20250122212402 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=34bb78ad" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css?v=bf4d74af" />
    <script src="../../_static/documentation_options.js?v=d2885b0a"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=4755f45a"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="フォームを使う" href="../forms/index.html" />
    <link rel="prev" title="ミドルウェア (Middleware)" href="middleware.html" />



 
<script src="../../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../../ref/templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../../index.html">Django 5.1.6.dev20250122212402 ドキュメント</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../../index.html">Home</a>  |
        <a title="Table of contents" href="../../contents.html">Table of contents</a>  |
        <a title="Global index" href="../../genindex.html">Index</a>  |
        <a title="Module index" href="../../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="middleware.html" title="ミドルウェア (Middleware)">previous</a>
     |
    <a href="../index.html" title="Django を使う" accesskey="U">up</a>
   |
    <a href="../forms/index.html" title="フォームを使う">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="topics-http-sessions">
            
  <section id="s-module-django.contrib.sessions">
<span id="s-how-to-use-sessions"></span><span id="module-django.contrib.sessions"></span><span id="how-to-use-sessions"></span><h1>セッションの使いかた<a class="headerlink" href="#module-django.contrib.sessions" title="Link to this heading">¶</a></h1>
<p>Django は、匿名のセッションをフルサポートしています。このセッションフレームワークを使えば、任意のデータを、サイトの訪問者ごとに保存し、取得できます。データはサーバー側に保存され、クッキーの送受信によって抽象化します。クッキーには、データそのものではなくセッション ID が書かれています ( <a class="reference internal" href="#cookie-session-backend"><span class="std std-ref">クッキーベースのバックエンド</span></a> を使用しない限り)。</p>
<section id="s-enabling-sessions">
<span id="enabling-sessions"></span><h2>セッションを有効にする<a class="headerlink" href="#enabling-sessions" title="Link to this heading">¶</a></h2>
<p>セッションは、 <a class="reference internal" href="../../ref/middleware.html"><span class="doc">ミドルウェア</span></a> の1つを使って実装されています。</p>
<p>セッションの機能を有効にするには、次のように設定を行います。</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> 設定を編集し <code class="docutils literal notranslate"><span class="pre">'django.contrib.sessions.middleware.SessionMiddleware'</span></code> を含むようにする。 <code class="docutils literal notranslate"><span class="pre">django-admin</span> <span class="pre">startproject</span></code> で作られるデフォルトの <code class="docutils literal notranslate"><span class="pre">settings.py</span></code> は <code class="docutils literal notranslate"><span class="pre">SessionMiddleware</span></code> が有効化されています。</p></li>
</ul>
<p>セッションを使いたくない場合は、 <a class="reference internal" href="../../ref/settings.html#std-setting-MIDDLEWARE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">MIDDLEWARE</span></code></a> 内の <code class="docutils literal notranslate"><span class="pre">SessionMiddleware</span></code> 行と <a class="reference internal" href="../../ref/settings.html#std-setting-INSTALLED_APPS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code></a> 内の <code class="docutils literal notranslate"><span class="pre">'django.contrib.sessions'</span></code> を削除しても構いません。これで、オーバーヘッドが少しだけ短縮されます。</p>
</section>
<section id="s-configuring-the-session-engine">
<span id="s-configuring-sessions"></span><span id="configuring-the-session-engine"></span><span id="configuring-sessions"></span><h2>セッションエンジンを設定する<a class="headerlink" href="#configuring-the-session-engine" title="Link to this heading">¶</a></h2>
<p>デフォルトでは、Django はセッションを、(<code class="docutils literal notranslate"><span class="pre">django.contrib.sessions.models.Session</span></code> モデルを用いて) データベースに保存します。これは便利ですが、セットアップによってはセッションのデータを他の場所においたほうが高速化できる場合があります。そのため、Django はセッションデータをファイルシステムやキャッシュに保存するように設定できます。</p>
<section id="s-using-database-backed-sessions">
<span id="using-database-backed-sessions"></span><h3>データベースを使ったセッション<a class="headerlink" href="#using-database-backed-sessions" title="Link to this heading">¶</a></h3>
<p>データベースを使った (database-backed) セッションを使いたい場合には、設定ファイルの <a class="reference internal" href="../../ref/settings.html#std-setting-INSTALLED_APPS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code></a>  に <code class="docutils literal notranslate"><span class="pre">'django.contrib.sessions'</span></code> を追加する必要があります。</p>
<p>一度インストールの設定をすれば、<code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">migrate</span></code> を実行することで、セッションデータを保存する1つのデータベーステーブルをインストールできます。</p>
</section>
<section id="s-using-cached-sessions">
<span id="s-cached-sessions-backend"></span><span id="using-cached-sessions"></span><span id="cached-sessions-backend"></span><h3>キャッシュを使ったセッション<a class="headerlink" href="#using-cached-sessions" title="Link to this heading">¶</a></h3>
<p>よいパフォーマンスを発揮するには、キャッシュを使ったセッションバックエンドを利用した方が良いかもしれません。</p>
<p>Django のキャッシュシステムを使ってセッションデータを保存するには、まず初めに、キャッシュの設定を済ませておく必要があります。詳しくは、 <a class="reference internal" href="../cache.html"><span class="doc">キャッシュのドキュメンテーション</span></a> を読んでください。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>キャッシュを使ったセッションを用いるのは、Memcached または Redis キャッシュバックエンドを使用している場合だけにするべきです。ローカルなメモリキャッシュバックエンドを使用している場合、長時間データをメモリ上に保持しておくのは良い考えではありませんし、全てのデータをファイルやデータベースキャッシュバックエンドを通して送信するよりも、ファイルやデータベースに保存されたセッションから直接送信した方が高速だからです。加えて、ローカルなメモリキャッシュバックエンドは、マルチプロセスに対して安全「ではありません」。したがって、実環境ではあまり良い選択とは言えないでしょう。</p>
</div>
<p>設定ファイルの <a class="reference internal" href="../../ref/settings.html#std-setting-CACHES"><code class="xref std std-setting docutils literal notranslate"><span class="pre">CACHES</span></code></a> で複数のキャッシュを定義している場合、Django はデフォルトのキャッシュを使用します。他のキャッシュを使用するには、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_CACHE_ALIAS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_CACHE_ALIAS</span></code></a> を使用したいキャッシュの名前に変更します。</p>
<p>一度キャッシュが設定されると、データベース ベースのキャッシュ(database-backed cache) か非永続キャッシュ (non-persistent cache) のどちらかを選択する必要があります。</p>
<p>キャッシュ付きデータベースバックエンド（<code class="docutils literal notranslate"><span class="pre">cached_db</span></code>）は、ライトスルーキャッシュを使用します。セッションの書き込みは、データベースとキャッシュの両方に、順番に適用されます。キャッシュへの書き込みが失敗した場合、例外処理が行われ、<a class="reference internal" href="../../ref/logging.html#django-contrib-sessions-logger"><span class="std std-ref">sessions logger</span></a> を通じて記録されます。これにより、片方だけで成功した書き込み操作が失敗することを防ぎます。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p>キャッシュへの書き込み時に発生する例外の処理およびログ記録機能が追加されました。</p>
</div>
<p>セッションの読み取りは、まずキャッシュを使用し、データがキャッシュから削除されている場合にはデータベースを使用します。このバックエンドを使用するには、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_ENGINE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_ENGINE</span></code></a> を <code class="docutils literal notranslate"><span class="pre">&quot;django.contrib.sessions.backends.cached_db&quot;</span></code> に設定し、<a class="reference internal" href="#using-database-backed-sessions">using database-backed sessions</a> の構成手順に従ってください。</p>
<p>キャッシュバックエンド (<code class="docutils literal notranslate"><span class="pre">cache</span></code>) はセッションデータをキャッシュにのみ保存します。これはデータベースの永続化を避けることができるので高速ですが、キャッシュデータが削除されたときのことを考慮しなければなりません。キャッシュが一杯になったりキャッシュサーバーが再起動したりしたときにキャッシュが削除される可能性があり、ユーザーのログアウトを含めてセッションデータが失われることになります。このバックエンドを使うには、 <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_ENGINE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_ENGINE</span></code></a> を <code class="docutils literal notranslate"><span class="pre">&quot;django.contrib.sessions.backends.cache&quot;</span></code> に設定してください。</p>
<p>キャッシュバックエンドを永続化するには、Redis などの永続キャッシュを適切な設定で使用します。しかし、キャッシュが十分に永続化できるように確実に設定されていない限り、キャッシュデータベースバックエンドを選びましょう。これにより、運用時に信頼性の低いデータストレージによって引き起こされるエッジケースを避けることができます。</p>
</section>
<section id="s-using-file-based-sessions">
<span id="using-file-based-sessions"></span><h3>ファイルを使ったセッション<a class="headerlink" href="#using-file-based-sessions" title="Link to this heading">¶</a></h3>
<p>ファイルを使ったセッションを使用するには、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_ENGINE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_ENGINE</span></code></a> を <code class="docutils literal notranslate"><span class="pre">&quot;django.contrib.sessions.backends.file&quot;</span></code> に設定します。</p>
<p>Django がセッションファイルを保存する場所を設定したい場合には、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_FILE_PATH"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_FILE_PATH</span></code></a> を設定します (出力先のデフォルト値は、<code class="docutils literal notranslate"><span class="pre">tempfile.gettempdir()</span></code>、普通は <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> になっています)。ウェブサーバが設定した場所の読み書きの権限を持っていることを確認しておいてください。</p>
</section>
<section id="s-using-cookie-based-sessions">
<span id="s-cookie-session-backend"></span><span id="using-cookie-based-sessions"></span><span id="cookie-session-backend"></span><h3>クッキーを使ったセッション<a class="headerlink" href="#using-cookie-based-sessions" title="Link to this heading">¶</a></h3>
<p>クッキーを使ったセッションを使用するには、 <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_ENGINE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_ENGINE</span></code></a> を <code class="docutils literal notranslate"><span class="pre">&quot;django.contrib.sessions.backends.signed_cookies&quot;</span></code> に設定します。セッションデータは、 <a class="reference internal" href="../signing.html"><span class="doc">暗号化署名</span></a> のための Django のツールと <a class="reference internal" href="../../ref/settings.html#std-setting-SECRET_KEY"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SECRET_KEY</span></code></a> を使って保存されます。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>保存されたデータに JavaScript からアクセスできないように、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_HTTPONLY"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_HTTPONLY</span></code></a> を <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定しておくことをおすすめします。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p><strong>このセッションデータは、署名はされていますが、暗号化はされていません。</strong></p>
<p>クッキーバックエンドを使う時には、セッションデータはクライアントが自由に読むことができます。</p>
<p>MAC (Message Authentication Code; メッセージ認証コード) を使っているので、たとえクライアントがデータを勝手に書き変えてしまったとしても、書き換えられたセッションデータは無効と判定されます。しかし、たとえばミューザのブラウザが保存しているクッキーを保存できたとしても、セッションクッキーのデータがすべて保存できず、データの一部が失われることがあり、この場合にもセッションデータは無効となってしまいます。Django はデータを圧縮しますが、それでもデータのサイズが1クッキーごとの  <span class="target" id="index-2"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc2965.html#section-5.3"><strong>一般的な制限の 4096 バイト</strong></a> を超えてしまうことは十分に考えられることです。</p>
<p><strong>情報が最新であることは保証されません</strong></p>
<p>MAC のおかげで、データの認証性 (データが他のサイトではなく、確実に自分のサイトで作られたものであること) と、完全性 (データが存在し、データが正しいこと) は保証されますが、そのデータが最新のものであることは保証することができません。つまり、クライアントからデータを受け取ったとしても、そのデータがユーザに最後に送った最新のデータであることは保証できないのです。ということは、セッションデータの使い方によっては、クッキーバックエンドでは  <a class="reference external" href="https://en.wikipedia.org/wiki/Replay_attack">replay attacks</a> ができてしまうことになります。他のセッションバックエンドでは、サーバー側に各セッションの記録が残るので、ユーザがログアウトした時にそれを無効化できますが、クッキーを使ったセッションの場合には、ユーザがログアウトしてもセッションは無効化されません。したがって、攻撃者がユーザのクッキーを盗めば、たとえユーザがログアウトしていたとしても、そのクッキーを使ってユーザになりすますことができてしまいます。クッキーが「古くなった」と判断できるのは、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_AGE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_AGE</span></code></a> を過ぎた場合だけだからです。</p>
<p><strong>パフォーマンス</strong></p>
<p>最後に、クッキーのサイズが大きくなると、サイトの速度にも大きな影響があります。</p>
</div>
</section>
</section>
<section id="s-using-sessions-in-views">
<span id="using-sessions-in-views"></span><h2>ビューでセッションを使う<a class="headerlink" href="#using-sessions-in-views" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">SessionMiddleware</span></code> を有効にすれば、それぞれの <a class="reference internal" href="../../ref/request-response.html#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal notranslate"><span class="pre">HttpRequest</span></code></a> オブジェクト（Django のビュー関数に渡される最初の引数）は、辞書ライクなオブジェクトの <code class="docutils literal notranslate"><span class="pre">session</span></code> 属性を持つようになります。</p>
<p>この <code class="docutils literal notranslate"><span class="pre">request.session</span></code> には、ビューの好きな場所で、何度でも、読み書きを行うことができます。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">backends.base.</span></span><span class="sig-name descname"><span class="pre">SessionBase</span></span><a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase" title="Link to this definition">¶</a></dt>
<dd><p>このオブジェクトは、すべてのセッションオブジェクトのベースクラスとなっているので、以下に挙げるような基本的なディクショナリのメソッドを持っています。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.__getitem__">
<span class="sig-name descname"><span class="pre">__getitem__</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.__getitem__" title="Link to this definition">¶</a></dt>
<dd><p>例: <code class="docutils literal notranslate"><span class="pre">fav_color</span> <span class="pre">=</span> <span class="pre">request.session['fav_color']</span></code></p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.__setitem__">
<span class="sig-name descname"><span class="pre">__setitem__</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.__setitem__" title="Link to this definition">¶</a></dt>
<dd><p>例: <code class="docutils literal notranslate"><span class="pre">request.session['fav_color']</span> <span class="pre">=</span> <span class="pre">'blue'</span></code></p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.__delitem__">
<span class="sig-name descname"><span class="pre">__delitem__</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.__delitem__" title="Link to this definition">¶</a></dt>
<dd><p>例: <code class="docutils literal notranslate"><span class="pre">del</span> <span class="pre">request.session['fav_color']</span></code> 与えられた <code class="docutils literal notranslate"><span class="pre">key</span></code> がセッション内にない場合には、<code class="docutils literal notranslate"><span class="pre">KeyError</span></code> 例外を起こします。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.__contains__">
<span class="sig-name descname"><span class="pre">__contains__</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.__contains__" title="Link to this definition">¶</a></dt>
<dd><p>例: <code class="docutils literal notranslate"><span class="pre">'fav_color'</span> <span class="pre">in</span> <span class="pre">request.session</span></code></p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.get">
<span class="sig-name descname"><span class="pre">get</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.get" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aget">
<span class="sig-name descname"><span class="pre">aget</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aget" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aget()</span></code></p>
<p>例: <code class="docutils literal notranslate"><span class="pre">fav_color</span> <span class="pre">=</span> <span class="pre">request.session.get('fav_color',</span> <span class="pre">'red')</span></code></p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aget()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aset">
<span class="sig-name descname"><span class="pre">aset</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">value</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aset" title="Link to this definition">¶</a></dt>
<dd><div class="versionadded">
<span class="title">New in Django 5.1.</span> </div>
<p>例: <code class="docutils literal notranslate"><span class="pre">await</span> <span class="pre">request.session.aset('fav_color',</span> <span class="pre">'red')</span></code></p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.update">
<span class="sig-name descname"><span class="pre">update</span></span>(<em class="sig-param"><span class="n"><span class="pre">dict</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.update" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aupdate">
<span class="sig-name descname"><span class="pre">aupdate</span></span>(<em class="sig-param"><span class="n"><span class="pre">dict</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aupdate" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aupdate()</span></code></p>
<p>例: <code class="docutils literal notranslate"><span class="pre">request.session.update({'fav_color':</span> <span class="pre">'red'})</span></code></p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aupdate()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.pop">
<span class="sig-name descname"><span class="pre">pop</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">__not_given</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.pop" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.apop">
<span class="sig-name descname"><span class="pre">apop</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">__not_given</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.apop" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">apop()</span></code></p>
<p>例: <code class="docutils literal notranslate"><span class="pre">fav_color</span> <span class="pre">=</span> <span class="pre">request.session.pop('fav_color',</span> <span class="pre">'blue')</span></code></p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">apop()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.keys">
<span class="sig-name descname"><span class="pre">keys</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.keys" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.akeys">
<span class="sig-name descname"><span class="pre">akeys</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.akeys" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">akeys()</span></code></p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">akeys()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.values">
<span class="sig-name descname"><span class="pre">values</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.values" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.avalues">
<span class="sig-name descname"><span class="pre">avalues</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.avalues" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">avalues()</span></code></p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">avalues()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.has_key">
<span class="sig-name descname"><span class="pre">has_key</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.has_key" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.ahas_key">
<span class="sig-name descname"><span class="pre">ahas_key</span></span>(<em class="sig-param"><span class="n"><span class="pre">key</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.ahas_key" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">ahas_key()</span></code></p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">ahas_key()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.items">
<span class="sig-name descname"><span class="pre">items</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.items" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aitems">
<span class="sig-name descname"><span class="pre">aitems</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aitems" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aitems()</span></code></p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aitems()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.setdefault">
<span class="sig-name descname"><span class="pre">setdefault</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.setdefault" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.asetdefault">
<span class="sig-name descname"><span class="pre">asetdefault</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.asetdefault" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">asetdefault()</span></code></p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">asetdefault()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.clear">
<span class="sig-name descname"><span class="pre">clear</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.clear" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>また、次のようなメソッドも利用できます。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.flush">
<span class="sig-name descname"><span class="pre">flush</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.flush" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aflush">
<span class="sig-name descname"><span class="pre">aflush</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aflush" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aflush()</span></code></p>
<p>セッションから現在のセッションデータを削除し、セッションクッキーを削除します。このメソッドは、前回のセッションデータがユーザのブラウザから再びアクセスされないようにするためなどに使います (たとえば、<a class="reference internal" href="../auth/default.html#django.contrib.auth.logout" title="django.contrib.auth.logout"><code class="xref py py-func docutils literal notranslate"><span class="pre">django.contrib.auth.logout()</span></code></a> がこの関数を呼びます)。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aflush()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.set_test_cookie">
<span class="sig-name descname"><span class="pre">set_test_cookie</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.set_test_cookie" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aset_test_cookie">
<span class="sig-name descname"><span class="pre">aset_test_cookie</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aset_test_cookie" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aset_test_cookie()</span></code></p>
<p>ユーザのブラウザがクッキーをサポートしているかどうか判定するために、テスト用のクッキーをセットします。クッキーの動作原理により、ユーザが次のページへのリクエストを行わないとこのテストは行えません。詳しい情報については、下の <a class="reference internal" href="#setting-test-cookies">Setting test cookies</a> を読んでください。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aset_test_cookie()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.test_cookie_worked">
<span class="sig-name descname"><span class="pre">test_cookie_worked</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.test_cookie_worked" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.atest_cookie_worked">
<span class="sig-name descname"><span class="pre">atest_cookie_worked</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.atest_cookie_worked" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">atest_cookie_worked()</span></code></p>
<p>ユーザーのブラウザがテストクッキーを受け入れたかどうかに応じて、<code class="docutils literal notranslate"><span class="pre">True</span></code> または <code class="docutils literal notranslate"><span class="pre">False</span></code> を返します。クッキーの仕組み上、別のページリクエストで事前に <code class="docutils literal notranslate"><span class="pre">set_test_cookie()</span></code> または <code class="docutils literal notranslate"><span class="pre">aset_test_cookie()</span></code> を呼び出す必要があります。詳細は、以下の <a class="reference internal" href="#setting-test-cookies">Setting test cookies</a> を参照してください。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">atest_cookie_worked()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.delete_test_cookie">
<span class="sig-name descname"><span class="pre">delete_test_cookie</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.delete_test_cookie" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.adelete_test_cookie">
<span class="sig-name descname"><span class="pre">adelete_test_cookie</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.adelete_test_cookie" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">adelete_test_cookie()</span></code></p>
<p>テストクッキーを削除します。クッキーをきれいにしておくために使ってください。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">adelete_test_cookie()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.get_session_cookie_age">
<span class="sig-name descname"><span class="pre">get_session_cookie_age</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.get_session_cookie_age" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_AGE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_AGE</span></code></a> の設定値を返します。これはカスタム セッション バックエンドで上書きできます。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.set_expiry">
<span class="sig-name descname"><span class="pre">set_expiry</span></span>(<em class="sig-param"><span class="n"><span class="pre">value</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.set_expiry" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aset_expiry">
<span class="sig-name descname"><span class="pre">aset_expiry</span></span>(<em class="sig-param"><span class="n"><span class="pre">value</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aset_expiry" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aset_expiry()</span></code></p>
<p>セッションの有効期限を設定します。以下に挙げるようなさまざまな値を与えることができます。</p>
<ul class="simple">
<li><p>もし <code class="docutils literal notranslate"><span class="pre">value</span></code> が整数なら、与えられた秒数だけ活動がなかった時にセッションを破棄します。たとえば、<code class="docutils literal notranslate"><span class="pre">request.session.set_expiry(300)</span></code> と呼び出せば、5分後にセッションを破棄するように設定できます。</p></li>
<li><p>もし <code class="docutils literal notranslate"><span class="pre">value</span></code> が <code class="docutils literal notranslate"><span class="pre">datetime</span></code> または <code class="docutils literal notranslate"><span class="pre">timedelta</span></code> オブジェクトであれば、セッションはその日時で終了します。</p></li>
<li><p>もし <code class="docutils literal notranslate"><span class="pre">value</span></code> が <code class="docutils literal notranslate"><span class="pre">0</span></code> ならば、ユーザのセッションクッキーは、ユーザがウェブブラウザを閉じた時に破棄されます。</p></li>
<li><p>もし <code class="docutils literal notranslate"><span class="pre">value</span></code> が <code class="docutils literal notranslate"><span class="pre">None</span></code> ならば、セッションはグローバルなセッション有効期限ポリシーにしたがって扱われます。</p></li>
</ul>
<p>セッションの読み込みを行っても、有効期限は延長されません。セッションの有効期限は、セッションが最後に <em>修正された</em> 時点を基に計算されます。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aset_expiry()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.get_expiry_age">
<span class="sig-name descname"><span class="pre">get_expiry_age</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.get_expiry_age" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aget_expiry_age">
<span class="sig-name descname"><span class="pre">aget_expiry_age</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aget_expiry_age" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aget_expiry_age()</span></code></p>
<p>このセッションの有効期限までの残りの秒数を返します。カスタムの有効期限を持たない (または、ブラウザを閉じた時とセットした) セッションの場合、この値は <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_AGE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_AGE</span></code></a> と等しいです。</p>
<p>この関数は 2 つの省略可能なキーワード引数を取ることができます。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">modification</span></code>: セッションを最後に修正した時刻を <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.datetime" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">datetime</span></code></a> オブジェクトとして与える。デフォルトは現在の時刻。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">expiry</span></code>: セッションの有効期限情報を指定します。<a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.datetime" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">datetime</span></code></a> オブジェクト、<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">int</span></code></a> （秒単位）、または <code class="docutils literal notranslate"><span class="pre">None</span></code> を使用できます。デフォルトでは、<a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.set_expiry" title="django.contrib.sessions.backends.base.SessionBase.set_expiry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_expiry()</span></code></a> / <a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.aset_expiry" title="django.contrib.sessions.backends.base.SessionBase.aset_expiry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">aset_expiry()</span></code></a> によってセッションに保存された値（存在する場合）か、<code class="docutils literal notranslate"><span class="pre">None</span></code> になります。</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>このメソッドは、セッションを保存する際にセッションの有効期限を秒単位で決定するためにセッションバックエンドで使用されます。このようなコンテキスト以外での使用は想定していません。</p>
<p>特に、正しい <code class="docutils literal notranslate"><span class="pre">modification</span></code> 値があり、 <strong>かつ</strong> <code class="docutils literal notranslate"><span class="pre">expiry</span></code> が <code class="docutils literal notranslate"><span class="pre">datetime</span></code> オブジェクトとしてセットされている場合にのみ、セッションの残り寿命を決定することが <strong>可能</strong> ですが、 <code class="docutils literal notranslate"><span class="pre">modification</span></code> 値を持っている場合、有効期限を手動で計算する方がより直接的です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expires_at</span> <span class="o">=</span> <span class="n">modification</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">SESSION_COOKIE_AGE</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aget_expiry_age()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.get_expiry_date">
<span class="sig-name descname"><span class="pre">get_expiry_date</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.get_expiry_date" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aget_expiry_date">
<span class="sig-name descname"><span class="pre">aget_expiry_date</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aget_expiry_date" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aget_expiry_date()</span></code></p>
<p>このセッションが破棄される日付を返します。カスタムの有効期限を持たない (または、ブラウザを閉じた時とセットした) セッションに対しては、現在時刻から <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_AGE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_AGE</span></code></a> の秒数までの日付に等しいです。</p>
<p>この関数は、<a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.get_expiry_age" title="django.contrib.sessions.backends.base.SessionBase.get_expiry_age"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_expiry_age()</span></code></a> と同じキーワード引数を取ることができ、使用の際の注意点も同じです。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aget_expiry_date()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.get_expire_at_browser_close">
<span class="sig-name descname"><span class="pre">get_expire_at_browser_close</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.get_expire_at_browser_close" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aget_expire_at_browser_close">
<span class="sig-name descname"><span class="pre">aget_expire_at_browser_close</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aget_expire_at_browser_close" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aget_expire_at_browser_close()</span></code></p>
<p>ユーザのセッションクッキーがユーザのブラウザが閉じた時に破棄されるかどうかに応じて、<code class="docutils literal notranslate"><span class="pre">True</span></code> または <code class="docutils literal notranslate"><span class="pre">False</span></code> を返します。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aget_expire_at_browser_close()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.clear_expired">
<span class="sig-name descname"><span class="pre">clear_expired</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.clear_expired" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.aclear_expired">
<span class="sig-name descname"><span class="pre">aclear_expired</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.aclear_expired" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">aclear_expired()</span></code></p>
<p>保存されているセッションから、有効期限が切れているものを削除します。このクラスメソッドは、<a class="reference internal" href="../../ref/django-admin.html#django-admin-clearsessions"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">clearsessions</span></code></a> から呼び出されます。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aclear_expired()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.cycle_key">
<span class="sig-name descname"><span class="pre">cycle_key</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.cycle_key" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.base.SessionBase.acycle_key">
<span class="sig-name descname"><span class="pre">acycle_key</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.base.SessionBase.acycle_key" title="Link to this definition">¶</a></dt>
<dd><p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">acycle_key()</span></code></p>
<p>現在のセッションデータを保持したまま、新しいセッションキーを作成します。<a class="reference internal" href="../auth/default.html#django.contrib.auth.login" title="django.contrib.auth.login"><code class="xref py py-func docutils literal notranslate"><span class="pre">django.contrib.auth.login()</span></code></a> は、このメソッドを呼び出すことで、過去のセッションを継続できるようにしています。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">acycle_key()</span></code> 関数が追加されました。</p>
</div>
</dd></dl>

</dd></dl>

<section id="s-session-serialization">
<span id="s-id1"></span><span id="session-serialization"></span><span id="id1"></span><h3>セッションのシリアライズ<a class="headerlink" href="#session-serialization" title="Link to this heading">¶</a></h3>
<p>デフォルトでは、Django はセッションデータを JSON を用いてシリアライズします。設定ファイルの <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_SERIALIZER"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_SERIALIZER</span></code></a> に設定すれば、セッションをシリアライズするフォーマットをカスカムできます。 <a class="reference internal" href="#custom-serializers"><span class="std std-ref">自作のシリアライザを書く</span></a> に書いた注意書きの通り、JSON によるシリアライズを強く推奨します。 <em>クッキーバックエンドを利用している場合は特に</em> です。</p>
<p>たとえば、セッションデータをシリアライズするために <a class="reference external" href="https://docs.python.org/3/library/pickle.html#module-pickle" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pickle</span></code></a> を使用していた場合の、こんな攻撃のシナリオを考えてみましょう。あなたは <a class="reference internal" href="#cookie-session-backend"><span class="std std-ref">署名したクッキーセッションバックエンド</span></a> を使用していて、<a class="reference internal" href="../../ref/settings.html#std-setting-SECRET_KEY"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SECRET_KEY</span></code></a> (または <a class="reference internal" href="../../ref/settings.html#std-setting-SECRET_KEY_FALLBACKS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SECRET_KEY_FALLBACKS</span></code></a> の任意のキー) が攻撃者に知られてしまっていたとします (もちろん、これは Django にキーが流出する脆弱性が内在しているというわけではありません)。この時、攻撃者は、セッションに任意の文字列を挿入することができてしまい、このセッションを unpickle すると、サーバ上で任意のコードが実行されてしまいます。このような攻撃は、インターネット上のどこからでも簡単にできてしまいます。クッキーセッションストレージは、クッキーに保存されているデータが勝手に書き換えられないようにクッキーに署名をしていますが、 <a class="reference internal" href="../../ref/settings.html#std-setting-SECRET_KEY"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SECRET_KEY</span></code></a> が流出するだけで、リモートからコードを実行されてしまう脆弱性が生まれてしまうのです。</p>
<section id="s-bundled-serializers">
<span id="bundled-serializers"></span><h4>バンドルされているシリアライザ<a class="headerlink" href="#bundled-serializers" title="Link to this heading">¶</a></h4>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.sessions.serializers.JSONSerializer">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">serializers.</span></span><span class="sig-name descname"><span class="pre">JSONSerializer</span></span><a class="headerlink" href="#django.contrib.sessions.serializers.JSONSerializer" title="Link to this definition">¶</a></dt>
<dd><p><a class="reference internal" href="../signing.html#module-django.core.signing" title="django.core.signing: Django's signing framework."><code class="xref py py-mod docutils literal notranslate"><span class="pre">django.core.signing</span></code></a> の JSON シリアライザのラッパーです。基本的なデータ型だけがシリアライズ可能です。</p>
<p>また、JSON は文字列のキーしかサポートしていないので、<code class="docutils literal notranslate"><span class="pre">request.session</span></code> に文字列以外のキーを使用してしまうと、次のように期待通りに動いてくれません。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># initial assignment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># subsequent requests following serialization &amp; deserialization</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># of session data</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># KeyError</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;0&quot;</span><span class="p">]</span>
<span class="go">&#39;bar&#39;</span>
</pre></div>
</div>
<p>同様に、 <code class="docutils literal notranslate"><span class="pre">'\xd9'</span></code> のような UTF-8 以外のバイトなど、JSONでエンコードできないデータは保存できません（これは <a class="reference external" href="https://docs.python.org/3/library/exceptions.html#UnicodeDecodeError" title="(in Python v3.13)"><code class="xref py py-exc docutils literal notranslate"><span class="pre">UnicodeDecodeError</span></code></a> を発生させます）。</p>
<p>JSON によるシリアライズの制限について詳しくは、<a class="reference internal" href="#custom-serializers"><span class="std std-ref">自作のシリアライザを書く</span></a> セクションを読んでください。</p>
</dd></dl>

</section>
<section id="s-write-your-own-serializer">
<span id="s-custom-serializers"></span><span id="write-your-own-serializer"></span><span id="custom-serializers"></span><h4>自作のシリアライザを書く<a class="headerlink" href="#write-your-own-serializer" title="Link to this heading">¶</a></h4>
<p><a class="reference internal" href="#django.contrib.sessions.serializers.JSONSerializer" title="django.contrib.sessions.serializers.JSONSerializer"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSONSerializer</span></code></a> では、任意の Python データ型を扱うことができません。よくあることですが、利便性とセキュリティはトレード・オフの関係にあります。JSON を使ったセッション内に <code class="docutils literal notranslate"><span class="pre">datetime</span></code> や <code class="docutils literal notranslate"><span class="pre">Decimal</span></code> といった、より高度なデータ型を保存したければ、カスタムのシリアライザを書く (か、<code class="docutils literal notranslate"><span class="pre">request.session</span></code> に保存する前に、あらかじめその値を JSON でシリアライズ可能なオブジェクトに変換しておく) 必要があります。これらの値をシリアライズするのは全然難しくありません (<a class="reference internal" href="../serialization.html#django.core.serializers.json.DjangoJSONEncoder" title="django.core.serializers.json.DjangoJSONEncoder"><code class="xref py py-class docutils literal notranslate"><span class="pre">DjangoJSONEncoder</span></code></a> が役に立つかも知れません) が、シリアライズしたオブジェクトと全く同じデータを再取得できる信頼性の高いデコーダを書く方は、もう少し難しい仕事になります。たとえば、本当は文字列であるにも関わらず、たまたま <code class="docutils literal notranslate"><span class="pre">datetime</span></code> を表現するのと全く同じフォーマットの文字列に出会うという可能性があります。</p>
<p>シリアライザのクラスは、必ず次の2つのメソッドを実装しなければなりません。セッションデータのディクショナリをシリアライズする <code class="docutils literal notranslate"><span class="pre">dumps(self,</span> <span class="pre">obj)</span></code> と、それをデシリアライズする <code class="docutils literal notranslate"><span class="pre">loads(self,</span> <span class="pre">data)</span></code> の2つです。</p>
</section>
</section>
<section id="s-session-object-guidelines">
<span id="session-object-guidelines"></span><h3>セッションオブジェクトのガイドライン<a class="headerlink" href="#session-object-guidelines" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p>Python の普通の文字列を、<code class="docutils literal notranslate"><span class="pre">request.session</span></code> におけるディクショナリのキーとして使うこと。これは慣習のためというよりも、確実で高速にするためのルールです。</p></li>
<li><p>セッションのディクショナリのキーで、アンダースコアで始まるキーは、Django が内部で使用するために予約されているものと考えること。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">request.session</span></code> を新しいオブジェクトで上書きせず、その属性にアクセスしたり、値をセットしたりしないこと。Python のディクショナリのように扱うこと。</p></li>
</ul>
</section>
<section id="s-examples">
<span id="examples"></span><h3>例<a class="headerlink" href="#examples" title="Link to this heading">¶</a></h3>
<p>次の簡単なビューは、ユーザがコメントを投稿した後で、<code class="docutils literal notranslate"><span class="pre">has_commented</span></code> 変数を <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定します。こうすることで、同じユーザが2回以上コメントできないようにすることができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">post_comment</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">new_comment</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;has_commented&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You&#39;ve already commented.&quot;</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">Comment</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="n">new_comment</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;has_commented&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Thanks for your comment!&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>次の次の簡単なビューでは、サイトの「メンバー (member)」にログインする手続きを行います。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s2">&quot;username&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">check_password</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]):</span>
        <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;member_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You&#39;re logged in.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Your username and password didn&#39;t match.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>そして、次の例では、上の <code class="docutils literal notranslate"><span class="pre">login()</span></code> に対応するメンバーのログアウト処理を行います。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">logout</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;member_id&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You&#39;re logged out.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>ふつう実際に使われる <a class="reference internal" href="../auth/default.html#django.contrib.auth.logout" title="django.contrib.auth.logout"><code class="xref py py-meth docutils literal notranslate"><span class="pre">django.contrib.auth.logout()</span></code></a> 関数では、データの意図しない漏洩を防ぐために、この例より少し複雑な処理、<code class="docutils literal notranslate"><span class="pre">request.session</span></code> の <a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.flush" title="django.contrib.sessions.backends.base.SessionBase.flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">flush()</span></code></a> メソッドを呼び出すなどの処理を行っています。ここで挙げた例は、単にセッションオブジェクトの振る舞いをデモンストレーションすることが目的なので、完全ではない <code class="docutils literal notranslate"><span class="pre">logout()</span></code> を実装しました。</p>
</section>
</section>
<section id="s-setting-test-cookies">
<span id="setting-test-cookies"></span><h2>テストクッキーを設定する<a class="headerlink" href="#setting-test-cookies" title="Link to this heading">¶</a></h2>
<p>利便性のため、Django はユーザのブラウザがクッキーを受け入れることができるかどうかをテストするための方法を提供しています。テストをするには、一度ビューの中で <code class="docutils literal notranslate"><span class="pre">request.session</span></code> の <a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.set_test_cookie" title="django.contrib.sessions.backends.base.SessionBase.set_test_cookie"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_test_cookie()</span></code></a> メソッドを呼び出してから、同じビューではなく、次に呼び出されるビューの中で、 <a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.test_cookie_worked" title="django.contrib.sessions.backends.base.SessionBase.test_cookie_worked"><code class="xref py py-meth docutils literal notranslate"><span class="pre">test_cookie_worked()</span></code></a> メソッドを呼び出します。</p>
<p>このように <code class="docutils literal notranslate"><span class="pre">set_test_cookie()</span></code> と <code class="docutils literal notranslate"><span class="pre">test_cookie_worked()</span></code> を分離しなければならないのはちょっと気持ち悪いですが、クッキーの動作原理により、こうするより仕方がないのです。一度ブラウザにクッキーを設定しても、そのクッキーがブラウザに保存されたかどうかを確認するには、ブラウザがもう一度リクエストを行わなければならないからです。</p>
<p>テストクッキーがちゃんと機能していることを確認できたら、<a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.delete_test_cookie" title="django.contrib.sessions.backends.base.SessionBase.delete_test_cookie"><code class="xref py py-meth docutils literal notranslate"><span class="pre">delete_test_cookie()</span></code></a> を使ってセッションをきれいにしておくことにしましょう。</p>
<p>以下に、テストクッキーの典型的な使用例を挙げます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">render</span>


<span class="k">def</span><span class="w"> </span><span class="nf">login</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;POST&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">test_cookie_worked</span><span class="p">():</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete_test_cookie</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;You&#39;re logged in.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;Please enable cookies and try again.&quot;</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_test_cookie</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;foo/login_form.html&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p>非同期ビュー関数でテストクッキーを設定する機能が追加されました。</p>
</div>
</section>
<section id="s-using-sessions-out-of-views">
<span id="using-sessions-out-of-views"></span><h2>ビューの外でセッションを使う<a class="headerlink" href="#using-sessions-out-of-views" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>このセクションの例では、<code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> オブジェクトを直接 <code class="docutils literal notranslate"><span class="pre">django.contrib.sessions.backends.db</span></code> バックエンドからインポートしています。しかし、実際に自分でコートを書く場合には、以下のようにして、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_ENGINE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_ENGINE</span></code></a> が指すセッションエンジンから <code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> をインポートすることを考えるべきです。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">importlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">import_module</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">SessionStore</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SESSION_ENGINE</span><span class="p">)</span><span class="o">.</span><span class="n">SessionStore</span>
</pre></div>
</div>
</div>
<p>次のようにして、ビューの外からセッションデータを操作する API が利用可能です。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.sessions.backends.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">SessionStore</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">SessionStore</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># stored as seconds since epoch since datetimes are not serializable in JSON.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;last_login&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1376587691</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">session_key</span>
<span class="go">&#39;2b1189a188b44ad18c35e113ac6ceead&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">SessionStore</span><span class="p">(</span><span class="n">session_key</span><span class="o">=</span><span class="s2">&quot;2b1189a188b44ad18c35e113ac6ceead&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="p">[</span><span class="s2">&quot;last_login&quot;</span><span class="p">]</span>
<span class="go">1376587691</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">SessionStore.create()</span></code> は新しいセッション(つまりセッションストアから読み込まれていない、<code class="docutils literal notranslate"><span class="pre">session_key=None</span></code> のセッション)を作成するためのものです。<code class="docutils literal notranslate"><span class="pre">save()</span></code> は既存のセッションを保存するために設計されています（つまり、セッションストアから読み込まれたもの）。新しいセッションに対して <code class="docutils literal notranslate"><span class="pre">save()</span></code> を呼び出すこともできますが、既存のセッションと <code class="docutils literal notranslate"><span class="pre">session_key</span></code> が衝突する可能性があります。 <code class="docutils literal notranslate"><span class="pre">create()</span></code> は <code class="docutils literal notranslate"><span class="pre">save()</span></code> を呼び出し、使用されていない <code class="docutils literal notranslate"><span class="pre">session_key</span></code> が生成されるまでループします。</p>
<p><code class="docutils literal notranslate"><span class="pre">django.contrib.sessions.backends.db</span></code> バックエンドを使用している場合、各セッションは単なる Django のモデルになっていて、<code class="docutils literal notranslate"><span class="pre">Session</span></code> モデルは <a class="extlink-source reference external" href="https://github.com/django/django/blob/main/django/contrib/sessions/models.py">django/contrib/sessions/models.py</a> で定義されています。普通のモデルにすぎないので、普通の Django データベース API からセッションにアクセスできます。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.sessions.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="s2">&quot;2b1189a188b44ad18c35e113ac6ceead&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">expire_date</span>
<span class="go">datetime.datetime(2005, 8, 20, 13, 35, 12)</span>
</pre></div>
</div>
<p>セッションのディクショナリを取得するには、<a class="reference internal" href="#django.contrib.sessions.base_session.AbstractBaseSession.get_decoded" title="django.contrib.sessions.base_session.AbstractBaseSession.get_decoded"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_decoded()</span></code></a> を呼ばなければならないことに注意してください。これが必要なのは、ディクショナリがエンコードされたフォーマットで保存されているためです。</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">session_data</span>
<span class="go">&#39;KGRwMQpTJ19hdXRoX3VzZXJfaWQnCnAyCkkxCnMuMTExY2ZjODI2Yj...&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">get_decoded</span><span class="p">()</span>
<span class="go">{&#39;user_id&#39;: 42}</span>
</pre></div>
</div>
</section>
<section id="s-when-sessions-are-saved">
<span id="when-sessions-are-saved"></span><h2>セッションが保存されるタイミング<a class="headerlink" href="#when-sessions-are-saved" title="Link to this heading">¶</a></h2>
<p>デフォルトでは、Django がセッションデータベースへデータを保存するのは、セッションが修正された時だけ、つまり、ディクショナリ直下の値が代入または削除された時だけです。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Session is modified.</span>
<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>

<span class="c1"># Session is modified.</span>
<span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span>

<span class="c1"># Session is modified.</span>
<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1"># Gotcha: Session is NOT modified, because this alters</span>
<span class="c1"># request.session[&#39;foo&#39;] instead of request.session.</span>
<span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s2">&quot;foo&quot;</span><span class="p">][</span><span class="s2">&quot;bar&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;baz&quot;</span>
</pre></div>
</div>
<p>上の例の場合、セッションオブジェクトに修正したことを明示的に伝えるためには、<code class="docutils literal notranslate"><span class="pre">modified</span></code> 属性を設定すれば良いです。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">modified</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>このデフォルトの動作を変更するには、設定ファイルの <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_SAVE_EVERY_REQUEST"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_SAVE_EVERY_REQUEST</span></code></a> を <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定します。<code class="docutils literal notranslate"><span class="pre">True</span></code> に設定すると、Django は1リクエストごとに、セッションをデータベースに保存してくれるようになります。</p>
<p>セッションクッキーが送信されるのは、セッションの作成及び修正時のみであることに注意してください。<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_SAVE_EVERY_REQUEST"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_SAVE_EVERY_REQUEST</span></code></a> を <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定すると、各リクエストごとにセッションクッキーが送信されるようになります。</p>
<p>同時に、セッションクッキーの <code class="docutils literal notranslate"><span class="pre">expires</span></code> 部分も、セッションクッキーが送信されるごとに更新されます。</p>
<p>レスポンスステータスコードが 500 の時には、セッションは保存されません。</p>
</section>
<section id="s-browser-length-sessions-vs-persistent-sessions">
<span id="s-browser-length-vs-persistent-sessions"></span><span id="browser-length-sessions-vs-persistent-sessions"></span><span id="browser-length-vs-persistent-sessions"></span><h2>ブラウザ起動中のみ有効なセッション vs. 永続的なセッション<a class="headerlink" href="#browser-length-sessions-vs-persistent-sessions" title="Link to this heading">¶</a></h2>
<p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_EXPIRE_AT_BROWSER_CLOSE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code></a> 設定を使うと、セッションフレームワークが、ブラウザ起動中のみ有効なセッションと永続的なセッションのどちらを使うか設定できます。</p>
<p>デフォルトでは、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_EXPIRE_AT_BROWSER_CLOSE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code></a> は <code class="docutils literal notranslate"><span class="pre">False</span></code> にセットされていて、セッションクッキーは <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_AGE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_AGE</span></code></a> の期間ユーザのブラウザに保持されます。これにより、ユーザはブラウザを開くたびにログインし直さずに済みます。</p>
<p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_EXPIRE_AT_BROWSER_CLOSE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code></a> を <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定すると、Django はブラウザ起動中のみ有効なクッキーを使用します。このクッキーは、ブラウザを閉じた瞬間に破棄されます。ユーザがブラウザを開くたびにログインするようにしたい場合には、この設定を利用してください。</p>
<p>この設定はグローバルなデフォルトですが、1セッションごとのレベルで設定を上書きできます。その場合には、上の <a class="reference internal" href="#using-sessions-in-views">using sessions in views</a> で書いたようにして、<code class="docutils literal notranslate"><span class="pre">request.session</span></code> の <a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.set_expiry" title="django.contrib.sessions.backends.base.SessionBase.set_expiry"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_expiry()</span></code></a> メソッドを呼び出してください。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>一部のブラウザ (たとえば Chrome) では、ブラウザを閉じて再度開いてもセッションを継続できるようにする設定が提供されています。場合によっては、この設定が <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_EXPIRE_AT_BROWSER_CLOSE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code></a> 設定を妨げて、ブラウザが閉じてもセションが破棄されないことがあります。<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_EXPIRE_AT_BROWSER_CLOSE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code></a> を有効にした Django アプリケーションのテストをする時には、この点に注意してください。</p>
</div>
</section>
<section id="s-clearing-the-session-store">
<span id="s-id2"></span><span id="clearing-the-session-store"></span><span id="id2"></span><h2>セッションストアのクリア<a class="headerlink" href="#clearing-the-session-store" title="Link to this heading">¶</a></h2>
<p>ユーザがウェブサイトで新しいセッションを作成した時、セッションデータはセッションストアに溜め込まれます。データベースのバックエンドを使っている場合には、<code class="docutils literal notranslate"><span class="pre">django_session</span></code> データベーステーブルが増大し、ファイルバックエンドを使っている場合には、一時ディレクトリのファイル数が増えてゆくでしょう。</p>
<p>この問題を理解するには、データベースバックエンドで起きていることを考えてみてください。ユーザがログインすると、Django は <code class="docutils literal notranslate"><span class="pre">django_session</span></code> データベースのテーブルに1行を追加します。Django はセッションのデータが変更されるたびに、この行を更新します。ユーザが手動でログアウトすると、Django はこの行を削除します。しかし、ユーザがログアウト <em>しなかった</em> 場合には、この行は決して削除されません。同様のプロセスが、ファイルバックエンドの場合にも発生します。</p>
<p>Django は、有効期限の切れたセッションを自動的に削除する機能を提供 <em>しません</em> 。したがって、定期的に有効期限の切れたセッションを削除する仕事は、開発者の手に委ねられています。Django はこの目的のために、クリーンナップ用の管理コマンド <a class="reference internal" href="../../ref/django-admin.html#django-admin-clearsessions"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">clearsessions</span></code></a> を用意しています。たとえば、cron の毎日のジョブに追加するなどの方法で、定期的にこのコマンドを実行することが推奨されています。</p>
<p>キャッシュバックエンドの場合はこの問題が発生しないことに注意してください。キャッシュの場合、不要なデータは自動的に削除されるようになっているからです。しかし、クッキーバックエンドの場合はそうではありません。セッションデータはユーザのブラウザに保存されるからです。</p>
</section>
<section id="s-settings">
<span id="settings"></span><h2>設定<a class="headerlink" href="#settings" title="Link to this heading">¶</a></h2>
<p>以下の <a class="reference internal" href="../../ref/settings.html#settings-sessions"><span class="std std-ref">Django の設定</span></a> を使うと、セッションの動作をコントロールできます。</p>
<ul class="simple">
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_CACHE_ALIAS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_CACHE_ALIAS</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_AGE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_AGE</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_DOMAIN"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_DOMAIN</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_HTTPONLY"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_HTTPONLY</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_NAME"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_NAME</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_PATH"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_PATH</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_SAMESITE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_SAMESITE</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_SECURE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_SECURE</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_ENGINE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_ENGINE</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_EXPIRE_AT_BROWSER_CLOSE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_EXPIRE_AT_BROWSER_CLOSE</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_FILE_PATH"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_FILE_PATH</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_SAVE_EVERY_REQUEST"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_SAVE_EVERY_REQUEST</span></code></a></p></li>
<li><p><a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_SERIALIZER"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_SERIALIZER</span></code></a></p></li>
</ul>
</section>
<section id="s-session-security">
<span id="s-topics-session-security"></span><span id="session-security"></span><span id="topics-session-security"></span><h2>セッションのセキュリティ<a class="headerlink" href="#session-security" title="Link to this heading">¶</a></h2>
<p>サイトのサブドメインからは、クライアントに対して、ドメイン全体に対するクッキーを設定できます。信頼できるユーザに管理されていないサブドメインから送られたクッキーを許可している場合、この方法でセッションの固定化 (session fixation) 攻撃が可能になってしまいます。</p>
<p>たとえば、攻撃者が <code class="docutils literal notranslate"><span class="pre">good.example.com</span></code> にログインして、攻撃者のアカウントに対する有効なセッションを取得したとしましょう。この攻撃者が <code class="docutils literal notranslate"><span class="pre">bad.example.com</span></code> を自由に使えた場合、サブドメインからは <code class="docutils literal notranslate"><span class="pre">*.example.com</span></code> に対してクッキーを設定できるので、先ほど取得したセッションを利用して、攻撃者のセッションキーをターゲットの利用者に送信できてしまいます。次にこの利用者が <code class="docutils literal notranslate"><span class="pre">good.example.com</span></code> を訪問すると、この利用者は攻撃者のアカウントにログインすることになり、そのことに気付かずに大切な個人のデータ (たとえば、クレジットカード情報など) を攻撃者のアカウントに入力してしまう恐れがあります。</p>
<p>もう一つ考えられる攻撃は、<code class="docutils literal notranslate"><span class="pre">good.example.com</span></code> というサイトが <a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_COOKIE_DOMAIN"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_COOKIE_DOMAIN</span></code></a> を <code class="docutils literal notranslate"><span class="pre">&quot;example.com&quot;</span></code> に設定していた場合に、そのサイトのセッションクッキーが <code class="docutils literal notranslate"><span class="pre">bad.example.com</span></code> に送信されてしまう、というものです。</p>
</section>
<section id="s-technical-details">
<span id="technical-details"></span><h2>技術的な詳細<a class="headerlink" href="#technical-details" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>セッション辞書は、<a class="reference internal" href="#django.contrib.sessions.serializers.JSONSerializer" title="django.contrib.sessions.serializers.JSONSerializer"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSONSerializer</span></code></a> を使用する場合、任意の <a class="reference external" href="https://docs.python.org/3/library/json.html#module-json" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">json</span></code></a> シリアライズ可能な値を受け入れます。</p></li>
<li><p>セッションデータは、データベースの <code class="docutils literal notranslate"><span class="pre">django_session</span></code> という名前のテーブルに保存されます。</p></li>
<li><p>Django は必要なときにだけクッキーを送信します。新しくセッションデータを設定しなければ、Django はセッションクッキーを送信しません。</p></li>
</ul>
<section id="s-the-sessionstore-object">
<span id="the-sessionstore-object"></span><h3><code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> オブジェクト<a class="headerlink" href="#the-sessionstore-object" title="Link to this heading">¶</a></h3>
<p>Django が内部でセッションを操作する時は、対応するセッションエンジンの session store オブジェクトを使用します。慣習により、session store オブジェクトは <code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> と名付けられていて、<a class="reference internal" href="../../ref/settings.html#std-setting-SESSION_ENGINE"><code class="xref std std-setting docutils literal notranslate"><span class="pre">SESSION_ENGINE</span></code></a> で指定したモジュール内に置かれています。</p>
<p>Django で利用可能なすべての <code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> のサブクラスは、以下のデータ操作メソッドを実装しています。</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">exists()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">create()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">save()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">delete()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">load()</span></code></p></li>
<li><p><a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.clear_expired" title="django.contrib.sessions.backends.base.SessionBase.clear_expired"><code class="xref py py-meth docutils literal notranslate"><span class="pre">clear_expired()</span></code></a></p></li>
</ul>
<p>これらのメソッドに対する非同期インターフェースは、<code class="docutils literal notranslate"><span class="pre">sync_to_async()</span></code> でラップすることで提供されます。また、非同期ネイティブな実装が利用可能な場合は、以下の関数をダイレクトに使えます:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">aexists()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">acreate()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">asave()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">adelete()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aload()</span></code></p></li>
<li><p><a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase.aclear_expired" title="django.contrib.sessions.backends.base.SessionBase.aclear_expired"><code class="xref py py-meth docutils literal notranslate"><span class="pre">aclear_expired()</span></code></a></p></li>
</ul>
<p>独自のセッションエンジンを作ったり、既存のものをカスタマイズするには、<a class="reference internal" href="#django.contrib.sessions.backends.base.SessionBase" title="django.contrib.sessions.backends.base.SessionBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">SessionBase</span></code></a> か既存の <code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> クラスを継承した新しいクラスを作る必要があるでしょう。</p>
<p>セッションエンジンを拡張することもできますが、データベースをバックエンドとするセッションエンジンを拡張するには通常、追加の労力が必要です（詳しくは次のセクションを参照してください）。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">aexists()</span></code>, <code class="docutils literal notranslate"><span class="pre">acreate()</span></code>, <code class="docutils literal notranslate"><span class="pre">asave()</span></code>, <code class="docutils literal notranslate"><span class="pre">adelete()</span></code>, <code class="docutils literal notranslate"><span class="pre">aload()</span></code>, <code class="docutils literal notranslate"><span class="pre">aclear_expired()</span></code> メソッドが追加されました。</p>
</div>
</section>
</section>
<section id="s-extending-database-backed-session-engines">
<span id="s-id3"></span><span id="extending-database-backed-session-engines"></span><span id="id3"></span><h2>データベースを使ったセッションを拡張する<a class="headerlink" href="#extending-database-backed-session-engines" title="Link to this heading">¶</a></h2>
<p>Django に含まれるデータベースを使ったセッションエンジン (具体的に言えば、<code class="docutils literal notranslate"><span class="pre">db</span></code> と <code class="docutils literal notranslate"><span class="pre">cached_db</span></code>) をカスタマイズするには、<a class="reference internal" href="#django.contrib.sessions.base_session.AbstractBaseSession" title="django.contrib.sessions.base_session.AbstractBaseSession"><code class="xref py py-class docutils literal notranslate"><span class="pre">AbstractBaseSession</span></code></a> とともに <code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> クラスを継承する必要があるかもしれません。</p>
<p><code class="docutils literal notranslate"><span class="pre">AbstractBaseSession</span></code> と <code class="docutils literal notranslate"><span class="pre">BaseSessionManager</span></code> は、<a class="reference internal" href="../../ref/settings.html#std-setting-INSTALLED_APPS"><code class="xref std std-setting docutils literal notranslate"><span class="pre">INSTALLED_APPS</span></code></a> に <code class="docutils literal notranslate"><span class="pre">django.contrib.sessions</span></code> を追加しなくても、<code class="docutils literal notranslate"><span class="pre">django.contrib.sessions.base_session</span></code> からインポートできます。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.AbstractBaseSession">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">base_session.</span></span><span class="sig-name descname"><span class="pre">AbstractBaseSession</span></span><a class="headerlink" href="#django.contrib.sessions.base_session.AbstractBaseSession" title="Link to this definition">¶</a></dt>
<dd><p>ベースとなる抽象的なセッションのモデルです。</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.AbstractBaseSession.session_key">
<span class="sig-name descname"><span class="pre">session_key</span></span><a class="headerlink" href="#django.contrib.sessions.base_session.AbstractBaseSession.session_key" title="Link to this definition">¶</a></dt>
<dd><p>プライマリーキーです。フィールド自体は40文字までの文字列を格納できますが、現在の実装では、32文字の文字列 (数字と小文字のASCII文字のランダムな列) を生成します。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.AbstractBaseSession.session_data">
<span class="sig-name descname"><span class="pre">session_data</span></span><a class="headerlink" href="#django.contrib.sessions.base_session.AbstractBaseSession.session_data" title="Link to this definition">¶</a></dt>
<dd><p>エンコード・シリアライズされた、セッションディクショナリーを含む文字列です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.AbstractBaseSession.expire_date">
<span class="sig-name descname"><span class="pre">expire_date</span></span><a class="headerlink" href="#django.contrib.sessions.base_session.AbstractBaseSession.expire_date" title="Link to this definition">¶</a></dt>
<dd><p>セッションの有効期限を表す datetime オブジェクトです。</p>
<p>有効期限が切れたセッションをユーザが利用することはできませんが、<a class="reference internal" href="../../ref/django-admin.html#django-admin-clearsessions"><code class="xref std std-djadmin docutils literal notranslate"><span class="pre">clearsessions</span></code></a> 管理コマンドを実行するまでは、ふつうはデータベースに保存されています。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.AbstractBaseSession.get_session_store_class">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">get_session_store_class</span></span>()<a class="headerlink" href="#django.contrib.sessions.base_session.AbstractBaseSession.get_session_store_class" title="Link to this definition">¶</a></dt>
<dd><p>セッションモデルで使用するセッションストアクラスを返します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.AbstractBaseSession.get_decoded">
<span class="sig-name descname"><span class="pre">get_decoded</span></span>()<a class="headerlink" href="#django.contrib.sessions.base_session.AbstractBaseSession.get_decoded" title="Link to this definition">¶</a></dt>
<dd><p>デコードしたセッションデータを返します。</p>
<p>デコードは、セッションストアのクラスで実行されます。</p>
</dd></dl>

</dd></dl>

<p><a class="reference internal" href="#django.contrib.sessions.base_session.BaseSessionManager" title="django.contrib.sessions.base_session.BaseSessionManager"><code class="xref py py-class docutils literal notranslate"><span class="pre">BaseSessionManager</span></code></a> のサブクラスを作ることで、モデルマネージャをカスタマイズすることもできます。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.BaseSessionManager">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">base_session.</span></span><span class="sig-name descname"><span class="pre">BaseSessionManager</span></span><a class="headerlink" href="#django.contrib.sessions.base_session.BaseSessionManager" title="Link to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.BaseSessionManager.encode">
<span class="sig-name descname"><span class="pre">encode</span></span>(<em class="sig-param"><span class="n"><span class="pre">session_dict</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.base_session.BaseSessionManager.encode" title="Link to this definition">¶</a></dt>
<dd><p>与えられたセッションディクショナリを、シリアライズ・エンコードした文字列として返します。</p>
<p>エンコードは、モデルクラスに関連付けられたセッションストアのクラスで実行されます。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.base_session.BaseSessionManager.save">
<span class="sig-name descname"><span class="pre">save</span></span>(<em class="sig-param"><span class="n"><span class="pre">session_key</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">session_dict</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expire_date</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.base_session.BaseSessionManager.save" title="Link to this definition">¶</a></dt>
<dd><p>与えられたセッションキーに対するセッションデータを保存します。データが空の場合には、セッションを削除します。</p>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> クラスのカスタマイズは、以下に挙げるメソッドやプロパティをオーバーライドすることで行えます。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.db.SessionStore">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">backends.db.</span></span><span class="sig-name descname"><span class="pre">SessionStore</span></span><a class="headerlink" href="#django.contrib.sessions.backends.db.SessionStore" title="Link to this definition">¶</a></dt>
<dd><p>データベースを使ったセッションストアを実装しています。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.db.SessionStore.get_model_class">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">get_model_class</span></span>()<a class="headerlink" href="#django.contrib.sessions.backends.db.SessionStore.get_model_class" title="Link to this definition">¶</a></dt>
<dd><p>カスタマイズしたセッションモデルを返す必要がある場合には、このメソッドをオーバーライドします。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.db.SessionStore.create_model_instance">
<span class="sig-name descname"><span class="pre">create_model_instance</span></span>(<em class="sig-param"><span class="n"><span class="pre">data</span></span></em>)<a class="headerlink" href="#django.contrib.sessions.backends.db.SessionStore.create_model_instance" title="Link to this definition">¶</a></dt>
<dd><p>現在のセッションの状態を表す、セッションモデルオブジェクトの新しいインスタンスを返します。</p>
<p>このメソッドをオーバーライドすると、セッションモデルのデータをデータベースへ保存する前に修正できます。</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.cached_db.SessionStore">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">backends.cached_db.</span></span><span class="sig-name descname"><span class="pre">SessionStore</span></span><a class="headerlink" href="#django.contrib.sessions.backends.cached_db.SessionStore" title="Link to this definition">¶</a></dt>
<dd><p>キャッシュデータベースを使ったセッションストアを実装しています。</p>
<dl class="py attribute">
<dt class="sig sig-object py" id="django.contrib.sessions.backends.cached_db.SessionStore.cache_key_prefix">
<span class="sig-name descname"><span class="pre">cache_key_prefix</span></span><a class="headerlink" href="#django.contrib.sessions.backends.cached_db.SessionStore.cache_key_prefix" title="Link to this definition">¶</a></dt>
<dd><p>キャッシュのキー文字列を作るためにセッションキーに追加するプリフィックスです。</p>
</dd></dl>

</dd></dl>

<section id="s-example">
<span id="example"></span><h3>カスタマイズ例<a class="headerlink" href="#example" title="Link to this heading">¶</a></h3>
<p>以下の例は、アカウントIDを格納するための追加のデータベース列を含むカスタムのデータベースバックのセッションエンジンを示しており、アカウントのすべてのアクティブセッションに対してデータベースをクエリするオプションを提供します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.sessions.backends.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">SessionStore</span> <span class="k">as</span> <span class="n">DBStore</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.sessions.base_session</span><span class="w"> </span><span class="kn">import</span> <span class="n">AbstractBaseSession</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CustomSession</span><span class="p">(</span><span class="n">AbstractBaseSession</span><span class="p">):</span>
    <span class="n">account_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_session_store_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">SessionStore</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SessionStore</span><span class="p">(</span><span class="n">DBStore</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_model_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">CustomSession</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_model_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">create_model_instance</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">account_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_auth_user_id&quot;</span><span class="p">))</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">account_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">account_id</span> <span class="o">=</span> <span class="n">account_id</span>
        <span class="k">return</span> <span class="n">obj</span>
</pre></div>
</div>
<p>Django の組み込みの <code class="docutils literal notranslate"><span class="pre">cached_db</span></code> セッションストアから、<code class="docutils literal notranslate"><span class="pre">cached_db</span></code> をベースにしたカスタムのものにマイグレーションする場合は、名前空間の衝突を防ぐためにキャッシュキーのプレフィックスをオーバーライドするべきです:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SessionStore</span><span class="p">(</span><span class="n">CachedDBStore</span><span class="p">):</span>
    <span class="n">cache_key_prefix</span> <span class="o">=</span> <span class="s2">&quot;mysessions.custom_cached_db_backend&quot;</span>

    <span class="c1"># ...</span>
</pre></div>
</div>
</section>
</section>
<section id="s-session-ids-in-urls">
<span id="session-ids-in-urls"></span><h2>URL 内のセッション ID<a class="headerlink" href="#session-ids-in-urls" title="Link to this heading">¶</a></h2>
<p>Django のセッションフレームワークは、完全かつ単独でクッキーをベースにしています。PHP のように最後の手段として URL にセッション ID を入れるようなことはありません。これは、意図的な設計上の決定です。そのような振る舞いは、URL を醜くしてしまうだけではなく、&quot;Referer&quot; ヘッダを介したセッション ID の盗難に対してサイトを脆弱にしてしまいます。</p>
</section>
</section>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../contents.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">セッションの使いかた</a><ul>
<li><a class="reference internal" href="#enabling-sessions">セッションを有効にする</a></li>
<li><a class="reference internal" href="#configuring-the-session-engine">セッションエンジンを設定する</a><ul>
<li><a class="reference internal" href="#using-database-backed-sessions">データベースを使ったセッション</a></li>
<li><a class="reference internal" href="#using-cached-sessions">キャッシュを使ったセッション</a></li>
<li><a class="reference internal" href="#using-file-based-sessions">ファイルを使ったセッション</a></li>
<li><a class="reference internal" href="#using-cookie-based-sessions">クッキーを使ったセッション</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-sessions-in-views">ビューでセッションを使う</a><ul>
<li><a class="reference internal" href="#session-serialization">セッションのシリアライズ</a><ul>
<li><a class="reference internal" href="#bundled-serializers">バンドルされているシリアライザ</a></li>
<li><a class="reference internal" href="#write-your-own-serializer">自作のシリアライザを書く</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-object-guidelines">セッションオブジェクトのガイドライン</a></li>
<li><a class="reference internal" href="#examples">例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#setting-test-cookies">テストクッキーを設定する</a></li>
<li><a class="reference internal" href="#using-sessions-out-of-views">ビューの外でセッションを使う</a></li>
<li><a class="reference internal" href="#when-sessions-are-saved">セッションが保存されるタイミング</a></li>
<li><a class="reference internal" href="#browser-length-sessions-vs-persistent-sessions">ブラウザ起動中のみ有効なセッション vs. 永続的なセッション</a></li>
<li><a class="reference internal" href="#clearing-the-session-store">セッションストアのクリア</a></li>
<li><a class="reference internal" href="#settings">設定</a></li>
<li><a class="reference internal" href="#session-security">セッションのセキュリティ</a></li>
<li><a class="reference internal" href="#technical-details">技術的な詳細</a><ul>
<li><a class="reference internal" href="#the-sessionstore-object"><code class="docutils literal notranslate"><span class="pre">SessionStore</span></code> オブジェクト</a></li>
</ul>
</li>
<li><a class="reference internal" href="#extending-database-backed-session-engines">データベースを使ったセッションを拡張する</a><ul>
<li><a class="reference internal" href="#example">カスタマイズ例</a></li>
</ul>
</li>
<li><a class="reference internal" href="#session-ids-in-urls">URL 内のセッション ID</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="middleware.html"
                          title="前の章へ">ミドルウェア (Middleware)</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="../forms/index.html"
                          title="次の章へ">フォームを使う</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/topics/http/sessions.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">1月 22, 2025</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="middleware.html" title="ミドルウェア (Middleware)">previous</a>
     |
    <a href="../index.html" title="Django を使う" accesskey="U">up</a>
   |
    <a href="../forms/index.html" title="フォームを使う">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>