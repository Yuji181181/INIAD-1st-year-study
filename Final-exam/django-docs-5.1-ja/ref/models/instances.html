<!DOCTYPE html>

<html lang="ja" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>モデルインスタンスリファレンス &#8212; Django 5.1.6.dev20250122212402 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=34bb78ad" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css?v=bf4d74af" />
    <script src="../../_static/documentation_options.js?v=d2885b0a"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=4755f45a"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="QuerySet API リファレンス" href="querysets.html" />
    <link rel="prev" title="モデルの Meta オプション" href="options.html" />



 
<script src="../../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../../index.html">Django 5.1.6.dev20250122212402 ドキュメント</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../../index.html">Home</a>  |
        <a title="Table of contents" href="../../contents.html">Table of contents</a>  |
        <a title="Global index" href="../../genindex.html">Index</a>  |
        <a title="Module index" href="../../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="options.html" title="モデルの &lt;code class=&#34;docutils literal notranslate&#34;&gt;&lt;span class=&#34;pre&#34;&gt;Meta&lt;/span&gt;&lt;/code&gt; オプション">previous</a>
     |
    <a href="../index.html" title="API リファレンス" accesskey="U">up</a>
   |
    <a href="querysets.html" title="&lt;code class=&#34;docutils literal notranslate&#34;&gt;&lt;span class=&#34;pre&#34;&gt;QuerySet&lt;/span&gt;&lt;/code&gt; API リファレンス">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="ref-models-instances">
            
  <section id="s-model-instance-reference">
<span id="model-instance-reference"></span><h1>モデルインスタンスリファレンス<a class="headerlink" href="#model-instance-reference" title="Link to this heading">¶</a></h1>
<p>このドキュメントでは、<code class="docutils literal notranslate"><span class="pre">Model</span></code> API の詳細を説明しています。<a class="reference internal" href="../../topics/db/models.html"><span class="doc">モデル</span></a> と <a class="reference internal" href="../../topics/db/queries.html"><span class="doc">データベースクエリ</span></a> ガイドにある説明を前提としていますので、このドキュメントを読む前にこの 2 つを読んでおいた方がよいでしょう。</p>
<p>このリファレンスでは、 <a class="reference internal" href="../../topics/db/queries.html"><span class="doc">データベースクエリガイド</span></a> で提供された <a class="reference internal" href="../../topics/db/aggregation.html#queryset-model-example"><span class="std std-ref">Blogモデルの例</span></a> を使用します。</p>
<section id="s-creating-objects">
<span id="creating-objects"></span><h2>オブジェクトを作成する<a class="headerlink" href="#creating-objects" title="Link to this heading">¶</a></h2>
<p>モデルの新しいインスタンスを作成するには、他の Python クラスと同様にインスタンス化してください:</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Model">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Model</span></span>(<em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L459"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>キーワード引数は、モデル内で定義したフィールドの名前です。モデルをインスタンス化しても、データベースには何もしないことに注意してください。データベースとやり取りするには <a class="reference internal" href="#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> を使う必要があります。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p><code class="docutils literal notranslate"><span class="pre">__init__</span></code> メソッドをオーバーライドしてモデルをカスタマイズする誘惑に駆られるかもしれません。しかしその場合は、あらゆる変更がモデルインスタンスを保存しないように、呼び出しシグネチャを変更しないように配慮してください。さらに、 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> 内でモデルのフィールドを参照すると、状況によっては無限再帰エラーが発生する可能性があります。 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> をオーバーライドするのではなく、以下のいずれかのアプローチを試してみてください:</p>
<ol class="arabic">
<li><p>モデルクラスにクラスメソッドを追加する:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Book</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="n">book</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="c1"># do something with the book</span>
        <span class="k">return</span> <span class="n">book</span>


<span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s2">&quot;Pride and Prejudice&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>独自のマネジャーにメソッドを追加する (通常推奨される方法です):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BookManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_book</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="n">book</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="c1"># do something with the book</span>
        <span class="k">return</span> <span class="n">book</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Book</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">BookManager</span><span class="p">()</span>


<span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_book</span><span class="p">(</span><span class="s2">&quot;Pride and Prejudice&quot;</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
<section id="s-customizing-model-loading">
<span id="customizing-model-loading"></span><h3>モデルの読み込みをカスタマイズする<a class="headerlink" href="#customizing-model-loading" title="Link to this heading">¶</a></h3>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.from_db">
<em class="property"><span class="pre">classmethod</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">from_db</span></span>(<em class="sig-param"><span class="n"><span class="pre">db</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">field_names</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">values</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L575"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.from_db" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">from_db()</span></code> メソッドを使うと、データベースから読み込むときのモデルインスタンス作成をカスタマイズできます。</p>
<p>引数 <code class="docutils literal notranslate"><span class="pre">db</span></code> はモデルを読み込む対象となるデータベースへのエイリアスになります。 <code class="docutils literal notranslate"><span class="pre">field_names</span></code> は読み込まれるすべてのフィールドの名前を持ち、そして <code class="docutils literal notranslate"><span class="pre">values</span></code> は <code class="docutils literal notranslate"><span class="pre">field_names</span></code> 内各フィールドに対応した値を持ちます。 <code class="docutils literal notranslate"><span class="pre">field_names</span></code> は <code class="docutils literal notranslate"><span class="pre">values</span></code> と同じ並び順になります。モデルのフィールドが全て存在する場合、 <code class="docutils literal notranslate"><span class="pre">values</span></code> はその順番が <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> が期待する順番である事が保障されます。つまり、そのインスタンスは <code class="docutils literal notranslate"><span class="pre">cls(*values)</span></code> によって生成されます。いずれかのフィールドが遅延評価されている場合、そのフィールドは <code class="docutils literal notranslate"><span class="pre">field_names</span></code> 内には現れません。その場合、存在しない各フィールドには <code class="docutils literal notranslate"><span class="pre">django.db.models.DEFERRED</span></code> の値が設定されています。</p>
<p>新しいモデルを作成するだけでなく、<code class="docutils literal notranslate"><span class="pre">from_db()</span></code> メソッドは新しいインスタンスの <a class="reference internal" href="#django.db.models.Model._state" title="django.db.models.Model._state"><code class="xref py py-attr docutils literal notranslate"><span class="pre">_state</span></code></a> 属性に <code class="docutils literal notranslate"><span class="pre">adding</span></code> と <code class="docutils literal notranslate"><span class="pre">db</span></code> のフラグを設定する必要があります。</p>
<p>以下はデータベースから読み出されたフィールドの初期値をどのように保存しているのかについてを示した例です:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">DEFERRED</span>


<span class="nd">@classmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">from_db</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">field_names</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
    <span class="c1"># Default implementation of from_db() (subject to change and could</span>
    <span class="c1"># be replaced with super()).</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_fields</span><span class="p">):</span>
        <span class="n">values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">values</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">values</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">attname</span> <span class="ow">in</span> <span class="n">field_names</span> <span class="k">else</span> <span class="n">DEFERRED</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">concrete_fields</span>
        <span class="p">]</span>
    <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">values</span><span class="p">)</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>
    <span class="c1"># customization to store the original field values on the instance</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">_loaded_values</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">zip</span><span class="p">(</span><span class="n">field_names</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">DEFERRED</span><span class="p">))</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">instance</span>


<span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># Check how the current values differ from ._loaded_values. For example,</span>
    <span class="c1"># prevent changing the creator_id of the model. (This example doesn&#39;t</span>
    <span class="c1"># support cases where &#39;creator_id&#39; is deferred).</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span> <span class="ow">and</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creator_id</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loaded_values</span><span class="p">[</span><span class="s2">&quot;creator_id&quot;</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Updating the value of creator isn&#39;t allowed&quot;</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>上の例ではその機能を明らかにするため <code class="docutils literal notranslate"><span class="pre">from_db()</span></code> の実装を全て行いました。この実装を行う場合では <code class="docutils literal notranslate"><span class="pre">from_db()</span></code> メソッドから <code class="docutils literal notranslate"><span class="pre">super()</span></code> を呼び出してもかまいません。</p>
</section>
</section>
<section id="s-refreshing-objects-from-database">
<span id="refreshing-objects-from-database"></span><h2>データベースからオブジェクトを再読み込みする<a class="headerlink" href="#refreshing-objects-from-database" title="Link to this heading">¶</a></h2>
<p>モデルのインスタンスからあるフィールドを削除した場合、再度アクセスする事でその値をデータベースから再読み込みします:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">obj</span><span class="o">.</span><span class="n">field</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">obj</span><span class="o">.</span><span class="n">field</span>  <span class="c1"># Loads the field from the database</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.refresh_from_db">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">refresh_from_db</span></span>(<em class="sig-param"><span class="n"><span class="pre">using</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fields</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">from_queryset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L675"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.refresh_from_db" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.arefresh_from_db">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">arefresh_from_db</span></span>(<em class="sig-param"><span class="n"><span class="pre">using</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fields</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">from_queryset</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.db.models.Model.arefresh_from_db" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">arefresh_from_db()</span></code></p>
<p>データベースからモデルの値を再読み込みする必要がある場合は、 <code class="docutils literal notranslate"><span class="pre">refresh_from_db()</span></code> メソッドを利用できます。引数なしでこのメソッドを呼び出した場合は以下の処理が行われます:</p>
<ol class="arabic simple">
<li><p>モデル上の遅延評価されない全てのフィールドはその時点でデータベース上に存在する値に更新されます。</p></li>
<li><p>キャッシュされたリレーションは、リロードされたインスタンスから消去されます。</p></li>
</ol>
<p>データベースからはフィールドのみが再読み込みされます。それ以外のアノテーションのようなデータベース依存の値は更新されません。同様に <a class="reference internal" href="../utils.html#django.utils.functional.cached_property" title="django.utils.functional.cached_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">&#64;cached_property</span></code></a> 属性などはどれもクリアされません。</p>
<p>再読み込みはインスタンスを読み込むデータベースから、もしくはインスタンスがデータベースから読み込まれない場合はデフォルトのデータベースから行われます。 <code class="docutils literal notranslate"><span class="pre">using</span></code> 引数は再読み込みを行うデータベースを強制的に設定する際に使用できます。</p>
<p>読み込むフィールドのセットを強制的に設定するには <code class="docutils literal notranslate"><span class="pre">fields</span></code> 引数を使用できます。</p>
<p>たとえば、<code class="docutils literal notranslate"><span class="pre">update()</span></code> の呼び出しによって期待する更新が行われたかをテストするため、以下のようなテストを書くことができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test_update_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;val&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># At this point obj.val is still 1, but the value in the database</span>
    <span class="c1"># was updated to 2. The object&#39;s updated value needs to be reloaded</span>
    <span class="c1"># from the database.</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>遅延評価されているフィールドにアクセスした場合、その遅延評価されるフィールドの読み込みはこのメソッドを経由する事に注意してください。そのため遅延評価の読み込みがどのように行われるかを独自に設定できます。以下の例は遅延評価するフィールドが再読み込みされた時どのようにしてインスタンス上のフィールド全てを再読み込みできるかを示しています:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExampleModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">refresh_from_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># fields contains the name of the deferred field to be</span>
        <span class="c1"># loaded.</span>
        <span class="k">if</span> <span class="n">fields</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
            <span class="n">deferred_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_deferred_fields</span><span class="p">()</span>
            <span class="c1"># If any deferred field is going to be loaded</span>
            <span class="k">if</span> <span class="n">fields</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">deferred_fields</span><span class="p">):</span>
                <span class="c1"># then load all of them</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">deferred_fields</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">using</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">from_queryset</span></code> 引数を使用すると、<a class="reference internal" href="../../topics/db/managers.html#django.db.models.Model._base_manager" title="django.db.models.Model._base_manager"><code class="xref py py-attr docutils literal notranslate"><span class="pre">_base_manager</span></code></a> から作成されたクエリセットとは異なるクエリセットを使用できます。これにより、モデルの再読み込み方法をより細かく制御できるようになります。例えば、モデルで論理削除を使用している場合、<code class="docutils literal notranslate"><span class="pre">refresh_from_db()</span></code> を呼び出す際にこれを考慮することができます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">from_queryset</span><span class="o">=</span><span class="n">MyModel</span><span class="o">.</span><span class="n">active_objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
</pre></div>
</div>
<p>再読み込みされたインスタンスから通常クリアされる関連オブジェクトをキャッシュすることができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">from_queryset</span><span class="o">=</span><span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;related_field&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>モデルの値を再読み込みする前に、トランザクションの終了まで行をロックすることができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">(</span><span class="n">from_queryset</span><span class="o">=</span><span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_for_update</span><span class="p">())</span>
</pre></div>
</div>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">from_queryset</span></code> 引数が追加されました。</p>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.get_deferred_fields">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">get_deferred_fields</span></span>()<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L665"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.get_deferred_fields" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>対象となるモデルにおいて現在評価を遅延している全てのフィールドの属性名を持った集合を返すヘルパーメソッドです。</p>
</section>
<section id="s-validating-objects">
<span id="s-id1"></span><span id="validating-objects"></span><span id="id1"></span><h2>オブジェクトを検証 (バリデーション) する<a class="headerlink" href="#validating-objects" title="Link to this heading">¶</a></h2>
<p>モデルのバリデーションには 4 つのステップがあります:</p>
<ol class="arabic simple">
<li><p>モデルフィールドを検証する - <a class="reference internal" href="#django.db.models.Model.clean_fields" title="django.db.models.Model.clean_fields"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.clean_fields()</span></code></a></p></li>
<li><p>モデル全体を検証する - <a class="reference internal" href="#django.db.models.Model.clean" title="django.db.models.Model.clean"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.clean()</span></code></a></p></li>
<li><p>フィールドの一意性を検証する - <a class="reference internal" href="#django.db.models.Model.validate_unique" title="django.db.models.Model.validate_unique"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.validate_unique()</span></code></a></p></li>
<li><p>制約を検証する - <a class="reference internal" href="#django.db.models.Model.validate_constraints" title="django.db.models.Model.validate_constraints"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.validate_constraints()</span></code></a></p></li>
</ol>
<p>モデルの <a class="reference internal" href="#django.db.models.Model.full_clean" title="django.db.models.Model.full_clean"><code class="xref py py-meth docutils literal notranslate"><span class="pre">full_clean()</span></code></a> メソッドを使うと、4 つ全てのステップが実行されます。</p>
<p><a class="reference internal" href="../../topics/forms/modelforms.html#django.forms.ModelForm" title="django.forms.ModelForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelForm</span></code></a> を使っているとき、<a class="reference internal" href="../forms/api.html#django.forms.Form.is_valid" title="django.forms.Form.is_valid"><code class="xref py py-meth docutils literal notranslate"><span class="pre">is_valid()</span></code></a> の呼び出しは、フォーム上に含まれる全てのフィールドに対して、これらの検証ステップを実行します。詳しくは <a class="reference internal" href="../../topics/forms/modelforms.html"><span class="doc">ModelForm ドキュメント</span></a> を参照してください。検証エラーを自分でコントロールしたい場合、もしくは <a class="reference internal" href="../../topics/forms/modelforms.html#django.forms.ModelForm" title="django.forms.ModelForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelForm</span></code></a> から検証を必要とするフィールドを除外した場合は、モデルの <a class="reference internal" href="#django.db.models.Model.full_clean" title="django.db.models.Model.full_clean"><code class="xref py py-meth docutils literal notranslate"><span class="pre">full_clean()</span></code></a> メソッドだけを呼び出す必要があります。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.full_clean">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">full_clean</span></span>(<em class="sig-param"><span class="n"><span class="pre">exclude</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validate_unique</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">validate_constraints</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L1606"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.full_clean" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>このメソッドは、<a class="reference internal" href="#django.db.models.Model.clean_fields" title="django.db.models.Model.clean_fields"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.clean_fields()</span></code></a>、<a class="reference internal" href="#django.db.models.Model.clean" title="django.db.models.Model.clean"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.clean()</span></code></a>、 <a class="reference internal" href="#django.db.models.Model.validate_unique" title="django.db.models.Model.validate_unique"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.validate_unique()</span></code></a> (<code class="docutils literal notranslate"><span class="pre">validate_unique</span></code> が <code class="docutils literal notranslate"><span class="pre">True</span></code> の場合)、そして <a class="reference internal" href="#django.db.models.Model.validate_constraints" title="django.db.models.Model.validate_constraints"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.validate_constraints()</span></code></a> (<code class="docutils literal notranslate"><span class="pre">validate_constraints</span></code> が <code class="docutils literal notranslate"><span class="pre">True</span></code> の場合) をこの順序で呼び出し、4 つ全てのステージでのエラーを含む <code class="docutils literal notranslate"><span class="pre">message_dict</span></code> 属性を持つ <a class="reference internal" href="../exceptions.html#django.core.exceptions.ValidationError" title="django.core.exceptions.ValidationError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ValidationError</span></code></a> を発生させます。</p>
<p>オプションの <code class="docutils literal notranslate"><span class="pre">exclude</span></code> 引数を指定することで、検証とクリーニングから除外するフィールド名の <code class="docutils literal notranslate"><span class="pre">set</span></code> を指定できます。<a class="reference internal" href="../../topics/forms/modelforms.html#django.forms.ModelForm" title="django.forms.ModelForm"><code class="xref py py-class docutils literal notranslate"><span class="pre">ModelForm</span></code></a> は、この引数をフォーム上に存在しないフィールドを検証対象から除外するために使います。これは、エラーが発生してもユーザーによって修正できないからです。</p>
<p>モデルの <a class="reference internal" href="#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> メソッドを呼んだときでも <code class="docutils literal notranslate"><span class="pre">full_clean()</span></code> は自動的に <em>呼ばれない</em> ことに注意してください。手動で作ったモデルに対して 1 ステップでモデル検証をしたいときには、手動で呼び出す必要があります。次に例を示します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">article</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
<span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Do something based on the errors contained in e.message_dict.</span>
    <span class="c1"># Display them to a user, or handle them programmatically.</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">full_clean()</span></code> が行う最初のステップは、個々のフィールドをそれぞれクリーニングすることです。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.clean_fields">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">clean_fields</span></span>(<em class="sig-param"><span class="n"><span class="pre">exclude</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L1653"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.clean_fields" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>このメソッドはモデル上の全てのフィールドをバリデーションします。オプションの <code class="docutils literal notranslate"><span class="pre">exclude</span></code> 引数にはバリデーションの対象から除外したいフィールド名の <code class="docutils literal notranslate"><span class="pre">set</span></code> を渡すことができます。いずれかのフィールドでバリデーションに失敗した場合は <a class="reference internal" href="../exceptions.html#django.core.exceptions.ValidationError" title="django.core.exceptions.ValidationError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ValidationError</span></code></a> が送出されます。</p>
<p><code class="docutils literal notranslate"><span class="pre">full_clean()</span></code> の第二段階では <a class="reference internal" href="#django.db.models.Model.clean" title="django.db.models.Model.clean"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.clean()</span></code></a> を呼び出します。このメソッドはモデル独自のバリデーションにオーバーライドされます。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.clean">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">clean</span></span>()<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L1362"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.clean" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>このメソッドは、独自のモデルバリデーションを提供するために使い、必要な場合はモデルの属性を修正できます。たとえば、フィールドに対して自動的に値を提供したり、複数のフィールドにアクセスする必要のあるバリデーションを実施できます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.translation</span><span class="w"> </span><span class="kn">import</span> <span class="n">gettext_lazy</span> <span class="k">as</span> <span class="n">_</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Don&#39;t allow draft entries to have a pub_date.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;draft&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Draft entries may not have a publication date.&quot;</span><span class="p">))</span>
        <span class="c1"># Set the pub_date for published items if it hasn&#39;t been set already.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;published&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span>
</pre></div>
</div>
<p>ただし、<a class="reference internal" href="#django.db.models.Model.full_clean" title="django.db.models.Model.full_clean"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.full_clean()</span></code></a> と同様に、モデルの <code class="docutils literal notranslate"><span class="pre">clean()</span></code> メソッドは、<a class="reference internal" href="#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> メソッドが呼ばれたときには実行されないことに注意してください。</p>
<p>上の例では、<code class="docutils literal notranslate"><span class="pre">Model.clean()</span></code> により発生した <a class="reference internal" href="../exceptions.html#django.core.exceptions.ValidationError" title="django.core.exceptions.ValidationError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ValidationError</span></code></a> 例外は文字列によりインスタンス化されていたので、特別なエラーディクショナリのキー  <a class="reference internal" href="../exceptions.html#django.core.exceptions.NON_FIELD_ERRORS" title="django.core.exceptions.NON_FIELD_ERRORS"><code class="xref py py-data docutils literal notranslate"><span class="pre">NON_FIELD_ERRORS</span></code></a> に保存されます。このキーは、特定のフィールドではなくモデル全体に関連付けられたエラーに使用します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">NON_FIELD_ERRORS</span><span class="p">,</span> <span class="n">ValidationError</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">article</span><span class="o">.</span><span class="n">full_clean</span><span class="p">()</span>
<span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">non_field_errors</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">message_dict</span><span class="p">[</span><span class="n">NON_FIELD_ERRORS</span><span class="p">]</span>
</pre></div>
</div>
<p>例外を特定のフィールドにアサインするには、ディクショナリで <a class="reference internal" href="../exceptions.html#django.core.exceptions.ValidationError" title="django.core.exceptions.ValidationError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ValidationError</span></code></a> をインスタンス化し、キーにフィールド名を指定してください。上記の例を変更して、<code class="docutils literal notranslate"><span class="pre">pub_date</span></code> フィールドにエラーをアサインします:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Don&#39;t allow draft entries to have a pub_date.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;draft&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;pub_date&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Draft entries may not have a publication date.&quot;</span><span class="p">)}</span>
            <span class="p">)</span>
        <span class="o">...</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Model.clean()</span></code> 実施中に複数フィールドでエラーを発見した場合、ディクショナリを渡してエラーにフィールド名をマップすることもできます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Missing title.&quot;</span><span class="p">),</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;required&quot;</span><span class="p">),</span>
        <span class="s2">&quot;pub_date&quot;</span><span class="p">:</span> <span class="n">ValidationError</span><span class="p">(</span><span class="n">_</span><span class="p">(</span><span class="s2">&quot;Invalid date.&quot;</span><span class="p">),</span> <span class="n">code</span><span class="o">=</span><span class="s2">&quot;invalid&quot;</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<p>そして、<code class="docutils literal notranslate"><span class="pre">full_clean()</span></code> でモデル上のユニーク制約をチェックします。</p>
<div class="admonition-how-to-raise-field-specific-validation-errors-if-those-fields-don-t-appear-in-a-modelform admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">ModelForm</span></code> 内に表示されないフィールドに対してフィールド特有のバリデーションエラーを発生させる方法</p>
<p>(<code class="docutils literal notranslate"><span class="pre">Meta.fields</span></code> や <code class="docutils literal notranslate"><span class="pre">Meta.exclude</span></code> で制限されて) モデルフォームに表示されないフィールドに対して <code class="docutils literal notranslate"><span class="pre">Model.clean()</span></code> 内でバリデーションエラーを発生させることはできません。やろうとしても、<code class="docutils literal notranslate"><span class="pre">ValueError</span></code> が発生します。これは、バリデーションエラーが除外されたフィールドと関連付けることができないからです。</p>
<p>このジレンマに対応するには、<a class="reference internal" href="#django.db.models.Model.clean_fields" title="django.db.models.Model.clean_fields"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.clean_fields()</span></code></a> をオーバーライドすることです。これはバリデーションから除外されたフィールドのリストを受け取ります。次に例を示します。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clean_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean_fields</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;draft&quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pub_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exclude</span> <span class="ow">and</span> <span class="s2">&quot;status&quot;</span> <span class="ow">in</span> <span class="n">exclude</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Draft entries may not have a publication date.&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span>
                            <span class="s2">&quot;Set status to draft if there is not a publication date.&quot;</span>
                        <span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
</pre></div>
</div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.validate_unique">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">validate_unique</span></span>(<em class="sig-param"><span class="n"><span class="pre">exclude</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L1371"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.validate_unique" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>このメソッドは <a class="reference internal" href="#django.db.models.Model.clean_fields" title="django.db.models.Model.clean_fields"><code class="xref py py-meth docutils literal notranslate"><span class="pre">clean_fields()</span></code></a> と似ていますが、個別のフィールドの値ではなく <a class="reference internal" href="fields.html#django.db.models.Field.unique" title="django.db.models.Field.unique"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Field.unique</span></code></a>, <a class="reference internal" href="fields.html#django.db.models.Field.unique_for_date" title="django.db.models.Field.unique_for_date"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Field.unique_for_date</span></code></a>, <a class="reference internal" href="fields.html#django.db.models.Field.unique_for_month" title="django.db.models.Field.unique_for_month"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Field.unique_for_month</span></code></a>, <a class="reference internal" href="fields.html#django.db.models.Field.unique_for_year" title="django.db.models.Field.unique_for_year"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Field.unique_for_year</span></code></a>, <a class="reference internal" href="options.html#django.db.models.Options.unique_together" title="django.db.models.Options.unique_together"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Meta.unique_together</span></code></a> によって定義されたユニーク制約を検証します。オプションの <code class="docutils literal notranslate"><span class="pre">exclude</span></code> 引数により、バリデーションから除外するフィールド名の <code class="docutils literal notranslate"><span class="pre">set</span></code> を指定できます。いずれかのフィールドがバリデーションに失敗した場合、<a class="reference internal" href="../exceptions.html#django.core.exceptions.ValidationError" title="django.core.exceptions.ValidationError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ValidationError</span></code></a> を発生させます。</p>
<p><a class="reference internal" href="options.html#django.db.models.Options.constraints" title="django.db.models.Options.constraints"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Meta.constraints</span></code></a> で定義された <a class="reference internal" href="constraints.html#django.db.models.UniqueConstraint" title="django.db.models.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a> は <a class="reference internal" href="#django.db.models.Model.validate_constraints" title="django.db.models.Model.validate_constraints"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Model.validate_constraints()</span></code></a> によって検証されます。</p>
<p><code class="docutils literal notranslate"><span class="pre">validate_unique()</span></code> で <code class="docutils literal notranslate"><span class="pre">exclude</span></code> 引数を指定した場合、そのうちの 1 つでも含む <a class="reference internal" href="options.html#django.db.models.Options.unique_together" title="django.db.models.Options.unique_together"><code class="xref py py-attr docutils literal notranslate"><span class="pre">unique_together</span></code></a> 制限はチェックされません。</p>
<p>最後に、<code class="docutils literal notranslate"><span class="pre">full_clean()</span></code> でモデル上の他の制約をチェックします。</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.validate_constraints">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">validate_constraints</span></span>(<em class="sig-param"><span class="n"><span class="pre">exclude</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L1586"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.validate_constraints" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>このメソッドは <a class="reference internal" href="options.html#django.db.models.Options.constraints" title="django.db.models.Options.constraints"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Meta.constraints</span></code></a> で定義された全ての制約を検証します。オプションの <code class="docutils literal notranslate"><span class="pre">exclude</span></code> 引数で、検証から除外するフィールド名の <code class="docutils literal notranslate"><span class="pre">set</span></code> を指定できます。制約の検証に失敗した場合、 <a class="reference internal" href="../exceptions.html#django.core.exceptions.ValidationError" title="django.core.exceptions.ValidationError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ValidationError</span></code></a> を発生させます。</p>
</section>
<section id="s-saving-objects">
<span id="saving-objects"></span><h2>オブジェクトを保存する<a class="headerlink" href="#saving-objects" title="Link to this heading">¶</a></h2>
<p>データベースにオブジェクトを保存し直すには、<code class="docutils literal notranslate"><span class="pre">save()</span></code> を呼び出します:</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.save">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">save</span></span>(<em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">force_insert</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">force_update</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">using</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">DEFAULT_DB_ALIAS</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">update_fields</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L821"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.save" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.asave">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">asave</span></span>(<em class="sig-param"><span class="o"><span class="pre">*</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">force_insert</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">force_update</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">using</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">DEFAULT_DB_ALIAS</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">update_fields</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.db.models.Model.asave" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">asave()</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">force_insert</span></code> と <code class="docutils literal notranslate"><span class="pre">force_update</span></code> 引数の詳細については <a class="reference internal" href="#ref-models-force-insert"><span class="std std-ref">INSERT や UPDATE を強制する</span></a> を参照してください。引数 <code class="docutils literal notranslate"><span class="pre">update_fields</span></code> の詳細については <a class="reference internal" href="#ref-models-update-fields"><span class="std std-ref">どのフィールドを保存するか指定する</span></a> セクションを参照してください。</p>
<p>保存の動作をカスタマイズしたい場合は、<code class="docutils literal notranslate"><span class="pre">save()</span></code> メソッドをオーバーライドできます。詳しくは <a class="reference internal" href="../../topics/db/models.html#overriding-model-methods"><span class="std std-ref">定義済みのモデルメソッドをオーバーライドする</span></a> を参照してください。</p>
<p>モデル保存のプロセスには、いくつかの細かな注意点もあります; 以下の各セクションを参照してください。</p>
<div class="deprecated">
<p><span class="versionmodified deprecated">バージョン 5.1 で非推奨: </span>位置引数のサポートは非推奨になりました。</p>
</div>
<section id="s-auto-incrementing-primary-keys">
<span id="auto-incrementing-primary-keys"></span><h3>自動インクリメントのプライマリキー<a class="headerlink" href="#auto-incrementing-primary-keys" title="Link to this heading">¶</a></h3>
<p>モデルに <a class="reference internal" href="fields.html#django.db.models.AutoField" title="django.db.models.AutoField"><code class="xref py py-class docutils literal notranslate"><span class="pre">AutoField</span></code></a> (自動インクリメントのプライマリキー) がある場合、最初に <code class="docutils literal notranslate"><span class="pre">save()</span></code> を呼び出すと、自動インクリメントの値が計算され、オブジェクトの属性として保存されます:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span> <span class="o">=</span> <span class="n">Blog</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Cheddar Talk&quot;</span><span class="p">,</span> <span class="n">tagline</span><span class="o">=</span><span class="s2">&quot;Thoughts on cheese.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># Returns None, because b2 doesn&#39;t have an ID yet.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b2</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># Returns the ID of your new object.</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">save()</span></code> を呼び出す前に、ID の値がどうなるかを知る方法はありません。 なぜなら、その値は Django ではなくデータベースが計算するからです。</p>
<p>利便性のために、各モデルには <code class="docutils literal notranslate"><span class="pre">id</span></code> という <a class="reference internal" href="fields.html#django.db.models.AutoField" title="django.db.models.AutoField"><code class="xref py py-class docutils literal notranslate"><span class="pre">AutoField</span></code></a> がデフォルトで用意されていますが、モデル内のフィールドに <code class="docutils literal notranslate"><span class="pre">primary_key=True</span></code> を明示的に指定しない限り、 <code class="docutils literal notranslate"><span class="pre">id</span></code> という名前のフィールドは用意されません。詳しくは <a class="reference internal" href="fields.html#django.db.models.AutoField" title="django.db.models.AutoField"><code class="xref py py-class docutils literal notranslate"><span class="pre">AutoField</span></code></a> のドキュメントを参照してください。</p>
<section id="s-the-pk-property">
<span id="the-pk-property"></span><h4><code class="docutils literal notranslate"><span class="pre">pk</span></code> プロパティ<a class="headerlink" href="#the-pk-property" title="Link to this heading">¶</a></h4>
<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Model.pk">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">pk</span></span><a class="headerlink" href="#django.db.models.Model.pk" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>プライマリキーフィールドを自分で定義するか、 Django が用意してくれるかに関わらず、各モデルには <code class="docutils literal notranslate"><span class="pre">pk</span></code> というプロパティがあります。このプロパティはモデル上では普通の属性のように振る舞いますが、実際にはモデルのプライマリキーフィールドの属性のエイリアスです。他の属性と同じように、この値を読み込んだり指定したりすることができ、モデルの正しいフィールドを更新します。</p>
</section>
<section id="s-explicitly-specifying-auto-primary-key-values">
<span id="explicitly-specifying-auto-primary-key-values"></span><h4>自動プライマリキー値の明示的な指定<a class="headerlink" href="#explicitly-specifying-auto-primary-key-values" title="Link to this heading">¶</a></h4>
<p>モデルが <a class="reference internal" href="fields.html#django.db.models.AutoField" title="django.db.models.AutoField"><code class="xref py py-class docutils literal notranslate"><span class="pre">AutoField</span></code></a> を持っていて、保存時に新しいオブジェクトの ID を明示的に定義したい場合は、ID の自動割り当てに頼るのではなく、保存前に明示的に定義してください:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">b3</span> <span class="o">=</span> <span class="n">Blog</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Cheddar Talk&quot;</span><span class="p">,</span> <span class="n">tagline</span><span class="o">=</span><span class="s2">&quot;Thoughts on cheese.&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b3</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># Returns 3.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b3</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b3</span><span class="o">.</span><span class="n">id</span>  <span class="c1"># Returns 3.</span>
</pre></div>
</div>
<p>自動プライマリキー値を手動で割り当てる場合は、既に存在するプライマリキー 値を使わないようにしてください！すでにデータベースに存在する明示的なプライマリキー値を使って新しいオブジェクトを作成すると、 Django は新しいレコードを作成するのではなく、既存のレコードを変更するものとみなし ます。</p>
<p>上記の <code class="docutils literal notranslate"><span class="pre">'Cheddar</span> <span class="pre">Talk'</span></code> ブログの例を考えると、この例はデータベースの以前のレコードを上書きします:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">b4</span> <span class="o">=</span> <span class="n">Blog</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Not Cheddar&quot;</span><span class="p">,</span> <span class="n">tagline</span><span class="o">=</span><span class="s2">&quot;Anything but cheese.&quot;</span><span class="p">)</span>
<span class="n">b4</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>  <span class="c1"># Overrides the previous blog with ID=3!</span>
</pre></div>
</div>
<p>このようなことが起こる理由については、後述の <a class="reference internal" href="#how-django-knows-to-update-vs-insert">How Django knows to UPDATE vs. INSERT</a> を参照してください。</p>
<p>自動プライマリキーの値を明示的に指定することは、プライマリキーの衝突が起きないと確信が持てる場合に、オブジェクトを一括保存するときに便利です。</p>
<p>PostgreSQLを使用している場合、プライマリキーに関連付けられたシーケンスを更新する必要があるかもしれません。 <a class="reference internal" href="../databases.html#manually-specified-autoincrement-pk"><span class="std std-ref">自動インクリメントのプライマリキーの値を手動で指定する</span></a> を参照してください。</p>
</section>
</section>
<section id="s-what-happens-when-you-save">
<span id="what-happens-when-you-save"></span><h3>save すると何が起きるか？<a class="headerlink" href="#what-happens-when-you-save" title="Link to this heading">¶</a></h3>
<p>オブジェクトを保存するとき、Django は以下のステップを実行します:</p>
<ol class="arabic">
<li><p><strong>pre-save シグナルを発信します。</strong> <a class="reference internal" href="../signals.html#django.db.models.signals.pre_save" title="django.db.models.signals.pre_save"><code class="xref py py-data docutils literal notranslate"><span class="pre">pre_save</span></code></a> シグナルが送られ、そのシグナルを待ち受ける関数が何かできるようになります。</p></li>
<li><p><strong>データの前処理。</strong> 各フィールドの <a class="reference internal" href="fields.html#django.db.models.Field.pre_save" title="django.db.models.Field.pre_save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pre_save()</span></code></a> メソッドが呼び出され、必要な自動データ修正を行います。たとえば、日付/時刻フィールドは <code class="docutils literal notranslate"><span class="pre">pre_save()</span></code> をオーバーライドして <a class="reference internal" href="fields.html#django.db.models.DateField.auto_now_add" title="django.db.models.DateField.auto_now_add"><code class="xref py py-attr docutils literal notranslate"><span class="pre">auto_now_add</span></code></a> と <a class="reference internal" href="fields.html#django.db.models.DateField.auto_now" title="django.db.models.DateField.auto_now"><code class="xref py py-attr docutils literal notranslate"><span class="pre">auto_now</span></code></a> を実装しています。</p></li>
<li><p><strong>データベース用のデータを準備します。</strong> 各フィールドの <a class="reference internal" href="fields.html#django.db.models.Field.get_db_prep_save" title="django.db.models.Field.get_db_prep_save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_db_prep_save()</span></code></a> メソッドは、データベースに書き込めるデータ型で現在の値を提供するように要求されます。</p>
<p>ほとんどのフィールドではデータの準備は不要です。整数や文字列のような単純なデータ型は Python オブジェクトとして 'すぐに書けます' 。しかし、より複雑なデータ型はしばしば何らかの変更を必要とします。</p>
<p>たとえば、 <a class="reference internal" href="fields.html#django.db.models.DateField" title="django.db.models.DateField"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateField</span></code></a> フィールドは Python の <code class="docutils literal notranslate"><span class="pre">datetime</span></code> オブジェクトを使ってデータを格納します。データベースは <code class="docutils literal notranslate"><span class="pre">datetime</span></code> オブジェクトを保存しないので、フィールドの値を ISO 準拠の日付文字列に変換してデータベースに挿入する必要があります。</p>
</li>
<li><p><strong>データベースにデータを挿入します。</strong> 前処理され準備されたデータは、データベースに挿入するためのSQL文に構成されます。</p></li>
<li><p><strong>post-save シグナルを発信します。</strong> <a class="reference internal" href="../signals.html#django.db.models.signals.post_save" title="django.db.models.signals.post_save"><code class="xref py py-data docutils literal notranslate"><span class="pre">post_save</span></code></a> シグナルが送られ、 そのシグナルを待ち受ける関数が何かできるようになります。</p></li>
</ol>
</section>
<section id="s-how-django-knows-to-update-vs-insert">
<span id="how-django-knows-to-update-vs-insert"></span><h3>Django が UPDATE と INSERT を見分ける方法<a class="headerlink" href="#how-django-knows-to-update-vs-insert" title="Link to this heading">¶</a></h3>
<p>Django データベースオブジェクトが、オブジェクトの作成と変更に同じ <code class="docutils literal notranslate"><span class="pre">save()</span></code> メソッドを使うことにお気づきかもしれません。Django は <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> や <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> といった SQL ステートメントを抽象化しています。具体的には、 <code class="docutils literal notranslate"><span class="pre">save()</span></code> を呼び出し、オブジェクトのプライマリキー属性に <a class="reference internal" href="fields.html#django.db.models.Field.default" title="django.db.models.Field.default"><code class="xref py py-attr docutils literal notranslate"><span class="pre">default</span></code></a> や <a class="reference internal" href="fields.html#django.db.models.Field.db_default" title="django.db.models.Field.db_default"><code class="xref py py-attr docutils literal notranslate"><span class="pre">db_default</span></code></a> が <strong>定義されていない場合</strong> 、Django はこのアルゴリズムに従います：</p>
<ul class="simple">
<li><p>If the object's primary key attribute is set to anything except <code class="docutils literal notranslate"><span class="pre">None</span></code>,
Django executes an <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code>.</p></li>
<li><p>オブジェクトのプライマリキー属性がセット <em>されていない</em>、もしくは <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> が何もアップデートしなかった場合 (プライマリキーがデータベースに存在しない値に指定されている場合など) 、Django は <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> を実行します。</p></li>
</ul>
<p>オブジェクトのプライマリキー属性に <a class="reference internal" href="fields.html#django.db.models.Field.default" title="django.db.models.Field.default"><code class="xref py py-attr docutils literal notranslate"><span class="pre">default</span></code></a> や <a class="reference internal" href="fields.html#django.db.models.Field.db_default" title="django.db.models.Field.db_default"><code class="xref py py-attr docutils literal notranslate"><span class="pre">db_default</span></code></a> が定義されている場合は既存のモデルインスタンスで、プライマリキーにデータベースに存在する値が指定されていれば、Django は <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> を実行します。そうでない場合、 Django は <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> を実行します。</p>
<p>ここで重要なのは、そのプライマリキーが使われていないことが保証できない場合、新しいオブジェクトを保存するときに明示的にプライマリキーの値を指定しないように気をつけることです。このニュアンスについては、上述の <a class="reference internal" href="#forcing-an-insert-or-update">自動プライマリキーの値を明示的に指定する</a> と下記の <a class="reference internal" href="#forcing-an-insert-or-update">INSERT や UPDATE を強制する</a> を参照してください。</p>
<p>Django 1.5 以前のバージョンでは、Django はプライマリキー属性が指定されると <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> を行いました。 <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> で行が見つかれば <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> を行い、見つからなければ <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> を行いました。古いアルゴリズムでは、 <code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> の場合にクエリが 1 つ増えます。まれに、データベースにオブジェクトのプライマリキー値の行があっても、その行が更新されたことを報告しない場合があります。たとえば、PostgreSQLの <code class="docutils literal notranslate"><span class="pre">ON</span> <span class="pre">UPDATE</span></code> トリガは <code class="docutils literal notranslate"><span class="pre">NULL</span></code> を返します。このような場合、 <a class="reference internal" href="options.html#django.db.models.Options.select_on_save" title="django.db.models.Options.select_on_save"><code class="xref py py-attr docutils literal notranslate"><span class="pre">select_on_save</span></code></a> オプションを <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定することで、古いアルゴリズムに戻すことができます。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.0:</span> <p><code class="docutils literal notranslate"><span class="pre">Field.db_default</span></code> パラメータが追加されました。</p>
</div>
<section id="s-forcing-an-insert-or-update">
<span id="s-ref-models-force-insert"></span><span id="forcing-an-insert-or-update"></span><span id="ref-models-force-insert"></span><h4>INSERT や UPDATE を強制する<a class="headerlink" href="#forcing-an-insert-or-update" title="Link to this heading">¶</a></h4>
<p>まれに、<a class="reference internal" href="#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> メソッドにSQLの <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> を強制的に実行させ、<code class="docutils literal notranslate"><span class="pre">UPDATE</span></code> にフォールバックさせないようにする必要がある場合があります。またはその逆で、可能であれば更新を行い、新しい行を挿入しないようにする必要がある場合もあります。これらの場合には、<a class="reference internal" href="#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> メソッドに <code class="docutils literal notranslate"><span class="pre">force_insert=True</span></code> または <code class="docutils literal notranslate"><span class="pre">force_update=True</span></code> パラメータを渡すことができます。両方のパラメータを渡すとエラーになります。挿入と更新を <em>同時に</em> 行うことはできません！</p>
<p><a class="reference internal" href="../../topics/db/models.html#multi-table-inheritance"><span class="std std-ref">マルチテーブル継承</span></a> を使用する場合、<code class="docutils literal notranslate"><span class="pre">force_insert</span></code> に親クラスのタプルを渡すことで、各ベースに対して <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> ステートメントを強制的に挿入できます。たとえば次のようになります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Restaurant</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&#39;s Cafe&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force_insert</span><span class="o">=</span><span class="p">(</span><span class="n">Place</span><span class="p">,))</span>

<span class="n">Restaurant</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Bob&#39;s Cafe&quot;</span><span class="p">,</span> <span class="n">rating</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">force_insert</span><span class="o">=</span><span class="p">(</span><span class="n">Place</span><span class="p">,</span> <span class="n">Rating</span><span class="p">))</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">force_insert=(models.Model,)</span></code> を渡すことで、すべての親モデルに対して <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> ステートメントを強制的に挿入できます。デフォルトでは、 <code class="docutils literal notranslate"><span class="pre">force_insert=True</span></code> は現在のモデルに対してのみ新しい行の挿入を強制します。</p>
<p>これらのパラメータを必要とするのは、まれであるべきです。Django は、ほとんどの場合で正しく処理を行い、オーバーライドしようとすると追跡が難しいエラーの原因となります。この機能は応用的な場合のみに使用してください。</p>
<p><code class="docutils literal notranslate"><span class="pre">update_fields</span></code> を使うと <code class="docutils literal notranslate"><span class="pre">force_update</span></code> と同じように更新を強制します。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.0:</span> <p><code class="docutils literal notranslate"><span class="pre">force_insert</span></code> に親クラスのタプルを渡せるようになりました。</p>
</div>
</section>
</section>
<section id="s-updating-attributes-based-on-existing-fields">
<span id="s-ref-models-field-updates-using-f-expressions"></span><span id="updating-attributes-based-on-existing-fields"></span><span id="ref-models-field-updates-using-f-expressions"></span><h3>既存のフィールドに基づいて属性を更新する<a class="headerlink" href="#updating-attributes-based-on-existing-fields" title="Link to this heading">¶</a></h3>
<p>フィールドに対して、現在の値をインクリメントしたりデクリメントしたりするような単純な計算が必要になることがあります。これを実現する1つの方法は、Pythonで次のように計算を行うことです:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Venezuelan Beaver Cheese&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span><span class="o">.</span><span class="n">number_sold</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>データベースから取得した古い <code class="docutils literal notranslate"><span class="pre">number_sold</span></code> の値は 10 でした。そして、11 という値がデータベースに書き直されます。</p>
<p>この処理は、 <a class="reference internal" href="expressions.html#avoiding-race-conditions-using-f"><span class="std std-ref">競合状態</span></a> を回避し、堅牢性を向上させます。また、新しい値を明示的に代入するのではなく、元のフィールド値からの相対的な更新を表現することで、若干高速になります。 Djangoには、このような相対的な更新を行うための <a class="reference internal" href="expressions.html#django.db.models.F" title="django.db.models.F"><code class="xref py py-class docutils literal notranslate"><span class="pre">F</span> <span class="pre">式</span></code></a> があります。 <a class="reference internal" href="expressions.html#django.db.models.F" title="django.db.models.F"><code class="xref py py-class docutils literal notranslate"><span class="pre">F</span> <span class="pre">式</span></code></a> を使うと、上の例は以下のように表されます:</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span> <span class="o">=</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Venezuelan Beaver Cheese&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span><span class="o">.</span><span class="n">number_sold</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;number_sold&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">product</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>詳しくは、<a class="reference internal" href="expressions.html#django.db.models.F" title="django.db.models.F"><code class="xref py py-class docutils literal notranslate"><span class="pre">F</span> <span class="pre">式</span></code></a> とこれに対する <a class="reference internal" href="../../topics/db/queries.html#topics-db-queries-update"><span class="std std-ref">更新クエリ内で使う</span></a> を参照してください。</p>
</section>
<section id="s-specifying-which-fields-to-save">
<span id="s-ref-models-update-fields"></span><span id="specifying-which-fields-to-save"></span><span id="ref-models-update-fields"></span><h3>どのフィールドを保存するか指定する<a class="headerlink" href="#specifying-which-fields-to-save" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">save()</span></code> にキーワード引数 <code class="docutils literal notranslate"><span class="pre">update_fields</span></code> 内でフィールドリストの名前が渡された場合、このリスト内で指定されたフィールドだけが更新されます。これは、オブジェクトの 1 つないし少数のフィールドだけを更新したい場合に望ましいでしょう。データベースで全てのモデルフィールドを更新しないようにすると、実行速度が少し向上します。例えば:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">product</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Name changed again&quot;</span>
<span class="n">product</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">update_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">update_fields</span></code> 引数は文字列を含む任意のイテラブルです。空の <code class="docutils literal notranslate"><span class="pre">update_fields</span></code> イテラブルは保存をスキップします。 <code class="docutils literal notranslate"><span class="pre">None</span></code> という値は全てのフィールドを更新します。</p>
<p><code class="docutils literal notranslate"><span class="pre">update_fields</span></code> を指定すると更新を強制します。</p>
<p>遅延モデルローディング (<a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.only" title="django.db.models.query.QuerySet.only"><code class="xref py py-meth docutils literal notranslate"><span class="pre">only()</span></code></a> や <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.defer" title="django.db.models.query.QuerySet.defer"><code class="xref py py-meth docutils literal notranslate"><span class="pre">defer()</span></code></a>) を通してフェッチされたモデルを保存するとき、DB からロードされたフィールドだけが更新されます。実際には、このケースでは自動的な <code class="docutils literal notranslate"><span class="pre">update_fields</span></code> が存在します。遅延フィールドの値を追加もしくは変更した場合、フィールドは更新されたフィールドに追加されます。</p>
<div class="admonition-field-pre-save-and-update-fields admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">Field.pre_save()</span></code> と <code class="docutils literal notranslate"><span class="pre">update_fields</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">update_fields</span></code> が渡された場合、 <code class="docutils literal notranslate"><span class="pre">update_fields</span></code> の <a class="reference internal" href="fields.html#django.db.models.Field.pre_save" title="django.db.models.Field.pre_save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pre_save()</span></code></a> メソッドのみが呼び出されます。たとえば、これは <code class="docutils literal notranslate"><span class="pre">auto_now=True</span></code> の日付/時刻フィールドが <code class="docutils literal notranslate"><span class="pre">update_fields</span></code> に含まれない限り更新されないことを意味します。</p>
</div>
</section>
</section>
<section id="s-deleting-objects">
<span id="deleting-objects"></span><h2>オブジェクトを削除する<a class="headerlink" href="#deleting-objects" title="Link to this heading">¶</a></h2>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.delete">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">delete</span></span>(<em class="sig-param"><span class="n"><span class="pre">using</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">DEFAULT_DB_ALIAS</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">keep_parents</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L1264"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.delete" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.adelete">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">adelete</span></span>(<em class="sig-param"><span class="n"><span class="pre">using</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">DEFAULT_DB_ALIAS</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">keep_parents</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>)<a class="headerlink" href="#django.db.models.Model.adelete" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><em>非同期バージョン</em>: <code class="docutils literal notranslate"><span class="pre">adelete()</span></code></p>
<p>オブジェクトに対して SQL の <code class="docutils literal notranslate"><span class="pre">DELETE</span></code> を発行します。Python のインスタンスはまだ存在し、プライマリキーが <code class="docutils literal notranslate"><span class="pre">None</span></code> に設定されている以外は、そのフィールドにデータが残っています。このメソッドは削除されたオブジェクトの数と、オブジェクトの種類ごとの削除数を辞書として返します。</p>
<p>より詳しく (まとめてオブジェクトを削除する方法を含む) については、<a class="reference internal" href="../../topics/db/queries.html#topics-db-queries-delete"><span class="std std-ref">オブジェクトを削除する</span></a> を参照してください。</p>
<p>独自の削除動作がほしいときは、<code class="docutils literal notranslate"><span class="pre">delete()</span></code> メソッドをオーバーライドできます。詳しくは <a class="reference internal" href="../../topics/db/models.html#overriding-model-methods"><span class="std std-ref">定義済みのモデルメソッドをオーバーライドする</span></a> を参照してください。</p>
<p><a class="reference internal" href="../../topics/db/models.html#multi-table-inheritance"><span class="std std-ref">マルチテーブル継承</span></a> では、子モデルのデータだけを削除したい場合があります。<code class="docutils literal notranslate"><span class="pre">keep_parents=True</span></code> を指定すると、親モデルのデータを保持します。</p>
</section>
<section id="s-pickling-objects">
<span id="pickling-objects"></span><h2>オブジェクトの Pickle 化<a class="headerlink" href="#pickling-objects" title="Link to this heading">¶</a></h2>
<p>モデルを <a class="reference external" href="https://docs.python.org/3/library/pickle.html#module-pickle" title="(in Python v3.13)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">pickle</span></code></a> 化した時、現在の状態はpickle化された状態です。pickle化を解除すると、現在データベースにあるデータではなく、pickle化した時点のモデルインスタンスが格納されます。</p>
<div class="admonition-you-can-t-share-pickles-between-versions admonition">
<p class="admonition-title">バージョン間でpickle化されたデータを共有することはできません</p>
<p>モデルの pickle は、生成に使われた Django のバージョンでのみ有効です。Django バージョン N を使って pickle を生成した場合、その pickle が Django バージョン N+1 で読める保証はありません。pickle を長期的なアーカイブ戦略の一部として使うべきではありません。</p>
<p>pickle の互換性エラーは、静的に衝突したオブジェクトのように判定が難しいことがあるので、モデルをpickle化したデータを別のバージョンで復元しようとすると <code class="docutils literal notranslate"><span class="pre">RuntimeWarning</span></code> が送出されます。</p>
</div>
</section>
<section id="s-other-model-instance-methods">
<span id="s-model-instance-methods"></span><span id="other-model-instance-methods"></span><span id="model-instance-methods"></span><h2>その他のモデルインスタンスメソッド<a class="headerlink" href="#other-model-instance-methods" title="Link to this heading">¶</a></h2>
<p>いくつかのオブジェクトメソッドには特別な目的があります。</p>
<section id="s-str">
<span id="str"></span><h3><code class="docutils literal notranslate"><span class="pre">__str__()</span></code><a class="headerlink" href="#str" title="Link to this heading">¶</a></h3>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.__str__">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">__str__</span></span>()<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L590"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.__str__" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>オブジェクトに対して <code class="docutils literal notranslate"><span class="pre">str()</span></code> を呼び出すと、 <code class="docutils literal notranslate"><span class="pre">__str__()</span></code> メソッドが呼び出されます。Django は多くの場所で <code class="docutils literal notranslate"><span class="pre">str(obj)</span></code> を使います。特に、 Django の管理サイトでオブジェクトを表示するときや、テンプレートでオブジェクトを表示するときに挿入される値として使われます。したがって、 <code class="docutils literal notranslate"><span class="pre">__str__()</span></code> メソッドからは、常に人間が読めるようなモデルの表現を返さなければなりません。</p>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">first_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</section>
<section id="s-eq">
<span id="eq"></span><h3><code class="docutils literal notranslate"><span class="pre">__eq__()</span></code><a class="headerlink" href="#eq" title="Link to this heading">¶</a></h3>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.__eq__">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">__eq__</span></span>()<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L593"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.__eq__" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>等式メソッドは次のように定義されています: 同じプライマリキー値と具体的なクラスを持つインスタンスは等しいと見なされますが、プライマリキー値が <code class="docutils literal notranslate"><span class="pre">None</span></code> のインスタンスはそれ自身以外のものと等しくありません。プロキシモデルの場合、具体的なクラスはモデルの最初の非プロキシ親として定義されます。他のモデルについては、単純にモデルのクラス自体です。</p>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyProxyModel</span><span class="p">(</span><span class="n">MyModel</span><span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MultitableInherited</span><span class="p">(</span><span class="n">MyModel</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># Primary keys compared</span>
<span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># Primary keys are None</span>
<span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="c1"># Same instance</span>
<span class="n">instance</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">instance</span> <span class="o">==</span> <span class="n">instance</span>
<span class="c1"># Proxy model</span>
<span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">MyProxyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Multi-table inheritance</span>
<span class="n">MyModel</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MultitableInherited</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="s-hash">
<span id="hash"></span><h3><code class="docutils literal notranslate"><span class="pre">__hash__()</span></code><a class="headerlink" href="#hash" title="Link to this heading">¶</a></h3>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.__hash__">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">__hash__</span></span>()<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/base.py#L603"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Model.__hash__" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">__hash__()</span></code> メソッドはインスタンスのプライマリキー値に基づいています。実質的には <code class="docutils literal notranslate"><span class="pre">hash(obj.pk)</span></code> です。インスタンスにプライマリキー値がない場合は <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> が発生します（そうでないと、インスタンスが保存される前後で <code class="docutils literal notranslate"><span class="pre">__hash__()</span></code> メソッドが異なる値を返すことになりますが、Pythonではインスタンスの <a class="reference external" href="https://docs.python.org/3/reference/datamodel.html#object.__hash__" title="(in Python v3.13)"><code class="xref py py-meth docutils literal notranslate"><span class="pre">__hash__()</span></code></a> 値を変更することは禁止されています）。</p>
</section>
<section id="s-get-absolute-url">
<span id="get-absolute-url"></span><h3><code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code><a class="headerlink" href="#get-absolute-url" title="Link to this heading">¶</a></h3>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.get_absolute_url">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">get_absolute_url</span></span>()<a class="headerlink" href="#django.db.models.Model.get_absolute_url" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>オブジェクトに対する正式な URL を計算する方法は、<code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> で定義します。呼び出し元に対して、このメソッドは文字列を返します。この文字列は HTTP を通じてオブジェクトを参照するために使えるものです。</p>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;/people/</span><span class="si">%i</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>
<p>このコードは正しくかつシンプルですが、この種のメソッドを記述するのに最も適した方法です。<a class="reference internal" href="../urlresolvers.html#django.urls.reverse" title="django.urls.reverse"><code class="xref py py-func docutils literal notranslate"><span class="pre">reverse()</span></code></a> 関数が一般的にベストアプローチとなります。</p>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>

    <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;people-detail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span>
</pre></div>
</div>
<p>Django が <code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> を使う場所の一つが、admin アプリです。オブジェクトにこのメソッドが定義されている場合、オブジェクト編集のページは &quot;View on site&quot; リンクを持つようになり、<code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> で定義された通りオブジェクトの公開用ビューに直接飛べるようになります。</p>
<p>同様に、Django の他にもいくつか、<code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> が定義されている場合に使用するものがあります (<a class="reference internal" href="../contrib/syndication.html"><span class="doc">配信フィードフレームワーク</span></a> など)。 各モデルインスタンスがユニークな URL を持つことが適切な場合、<code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> を定義すべきです。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>リダイレクトポイズニングの可能性を減らすため、検証されていないユーザーの入力を利用した URL の生成は避けてください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;/</span><span class="si">%s</span><span class="s2">/&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">self.name</span></code> が <code class="docutils literal notranslate"><span class="pre">'/example.com'</span></code> の場合、上記は <code class="docutils literal notranslate"><span class="pre">'//example.com/'</span></code> を返します。これは有効な schema relative URL ですが、期待されていた <code class="docutils literal notranslate"><span class="pre">'/%2Fexample.com/'</span></code> ではありません。</p>
</div>
<p>テンプレート内で、ハードコーディングしたオブジェクトの URL ではなく <code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> を使うのは良い実装方法です。以下のテンプレートコードは悪い例です:</p>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="cm">&lt;!-- BAD template code. Avoid! --&gt;</span>
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;/people/</span><span class="cp">{{</span> <span class="nv">object.id</span> <span class="cp">}}</span><span class="s">/&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">object.name</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>以下のテンプレートコードは改善例です:</p>
<div class="highlight-html+django notranslate"><div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">object.get_absolute_url</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="p">&gt;</span><span class="cp">{{</span> <span class="nv">object.name</span> <span class="cp">}}</span><span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
</div>
<p>このロジックのポイントは、オブジェクトのURL構造を変更する場合、スペルミス修正のような些細な変更であっても、URLが生成される場所すべてを修正する必要がないようにすることです。 <code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> メソッドでURLを一度定義しておけば、コード全体でそのメソッドを呼び出すだけで済みます。</p>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p><code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> メソッドから返される文字列は、<strong>必ず</strong> ASCII 文字のみを含み (URI 仕様 <span class="target" id="index-2"></span><a class="rfc reference external" href="https://datatracker.ietf.org/doc/html/rfc3986.html#section-2"><strong>RFC 3986 Section 2</strong></a> で必須)、必要に応じてURLエンコードする必要があります。</p>
<p><code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code> メソッドを呼び出すコードやテンプレートは、結果をそのまま使用でき、 <strong>さらに処理する必要はありません</strong> 。ASCII 文字以外の文字を含む文字列を使用している場合は、<code class="docutils literal notranslate"><span class="pre">django.utils.encoding.iri_to_uri()</span></code> 関数を使用して変換すると便利です。</p>
</div>
</section>
</section>
<section id="s-extra-instance-methods">
<span id="extra-instance-methods"></span><h2>追加のインスタンスメソッド<a class="headerlink" href="#extra-instance-methods" title="Link to this heading">¶</a></h2>
<p>モデルオブジェクトは <a class="reference internal" href="#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a>, <a class="reference internal" href="#django.db.models.Model.delete" title="django.db.models.Model.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">delete()</span></code></a> に加えて、以下のメソッドを持つことがあります:</p>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.get_FOO_display">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">get_FOO_display</span></span>()<a class="headerlink" href="#django.db.models.Model.get_FOO_display" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><a class="reference internal" href="fields.html#django.db.models.Field.choices" title="django.db.models.Field.choices"><code class="xref py py-attr docutils literal notranslate"><span class="pre">choices</span></code></a> が設定されている全てのフィールドに対して、オブジェクトは <code class="docutils literal notranslate"><span class="pre">get_FOO_display()</span></code> メソッドを持ちます。このメソッドはフィールドの &quot;人間が読める&quot; 値を返します。</p>
<p>例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Person</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">SHIRT_SIZES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="s2">&quot;Small&quot;</span><span class="p">,</span>
        <span class="s2">&quot;M&quot;</span><span class="p">:</span> <span class="s2">&quot;Medium&quot;</span><span class="p">,</span>
        <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="s2">&quot;Large&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">shirt_size</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">SHIRT_SIZES</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Fred Flintstone&quot;</span><span class="p">,</span> <span class="n">shirt_size</span><span class="o">=</span><span class="s2">&quot;L&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">shirt_size</span>
<span class="go">&#39;L&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">p</span><span class="o">.</span><span class="n">get_shirt_size_display</span><span class="p">()</span>
<span class="go">&#39;Large&#39;</span>
</pre></div>
</div>
<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.get_next_by_FOO">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">get_next_by_FOO</span></span>(<em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em>)<a class="headerlink" href="#django.db.models.Model.get_next_by_FOO" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Model.get_previous_by_FOO">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">get_previous_by_FOO</span></span>(<em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em>)<a class="headerlink" href="#django.db.models.Model.get_previous_by_FOO" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><a class="reference internal" href="fields.html#django.db.models.Field.null" title="django.db.models.Field.null"><code class="xref py py-attr docutils literal notranslate"><span class="pre">null=True</span></code></a> を持たない <a class="reference internal" href="fields.html#django.db.models.DateField" title="django.db.models.DateField"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateField</span></code></a> と <a class="reference internal" href="fields.html#django.db.models.DateTimeField" title="django.db.models.DateTimeField"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTimeField</span></code></a> に対して、オブジェクトは <code class="docutils literal notranslate"><span class="pre">get_next_by_FOO()</span></code> と <code class="docutils literal notranslate"><span class="pre">get_previous_by_FOO()</span></code> メソッドを持ちます。このメソッドは日付フィールドに関する次のオブジェクトと前のオブジェクトを返し、適切な場合には <a class="reference internal" href="class.html#django.db.models.Model.DoesNotExist" title="django.db.models.Model.DoesNotExist"><code class="xref py py-exc docutils literal notranslate"><span class="pre">DoesNotExist</span></code></a> 例外を発生させます。</p>
<p>これらのメソッドはどちらもモデルのデフォルトマネージャを使用してクエリを実行します。カスタムマネージャによるフィルタリングをエミュレートする必要がある場合、あるいは単発のカスタムフィルタリングを実行したい場合、どちらのメソッドもオプションのキーワード引数を受け付けます。キーワード引数は <a class="reference internal" href="querysets.html#field-lookups"><span class="std std-ref">フィールドルックアップ</span></a> で説明されている形式でなければなりません。</p>
<p>同じ日付の値の場合、これらのメソッドはプライマリ・キーを同値の判定に使用することに注意してください。これにより、レコードがスキップされたり重複したりしないことが保証されます。つまり、これらのメソッドを未保存のオブジェクトで使用することはできないということです。</p>
<div class="admonition-overriding-extra-instance-methods admonition">
<p class="admonition-title">追加のインスタンスメソッドのオーバーライド</p>
<p>ほとんどの場合、 <code class="docutils literal notranslate"><span class="pre">get_FOO_display()</span></code>, <code class="docutils literal notranslate"><span class="pre">get_next_by_FOO()</span></code>, <code class="docutils literal notranslate"><span class="pre">get_previous_by_FOO()</span></code> をオーバーライドまたは継承すると、期待通りに動作するはずです。しかし、これらはメタクラスによって追加されるので、すべての継承構造を考慮することは現実的ではありません。より複雑なケースでは、 <code class="docutils literal notranslate"><span class="pre">Field.contribute_to_class()</span></code> をオーバーライドして、必要なメソッドを設定する必要があります。</p>
</div>
</section>
<section id="s-other-attributes">
<span id="other-attributes"></span><h2>その他の属性<a class="headerlink" href="#other-attributes" title="Link to this heading">¶</a></h2>
<section id="s-state">
<span id="state"></span><h3><code class="docutils literal notranslate"><span class="pre">_state</span></code><a class="headerlink" href="#state" title="Link to this heading">¶</a></h3>
<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Model._state">
<span class="sig-prename descclassname"><span class="pre">Model.</span></span><span class="sig-name descname"><span class="pre">_state</span></span><a class="headerlink" href="#django.db.models.Model._state" title="Link to this definition">¶</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">_state</span></code> 属性はモデルインスタンスのライフサイクルを追跡する <code class="docutils literal notranslate"><span class="pre">ModelState</span></code> オブジェクトを参照します。</p>
<p><code class="docutils literal notranslate"><span class="pre">ModelState</span></code> オブジェクトには 2 つの属性があります： モデルがまだデータベースに保存されていない場合に <code class="docutils literal notranslate"><span class="pre">True</span></code> となるフラグ <code class="docutils literal notranslate"><span class="pre">adding</span></code> と、インスタンスが読み込まれた、または保存されたデータベースのエイリアスを指す文字列 <code class="docutils literal notranslate"><span class="pre">db</span></code> です。</p>
<p>新しくインスタンス化されたインスタンスには <code class="docutils literal notranslate"><span class="pre">adding=True</span></code> と <code class="docutils literal notranslate"><span class="pre">db=None</span></code> がセットされます。 <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> から取得したインスタンスには <code class="docutils literal notranslate"><span class="pre">adding=False</span></code> と <code class="docutils literal notranslate"><span class="pre">db</span></code> がセットされ、関連するデータベースのエイリアスが設定されます。</p>
</dd></dl>

</section>
</section>
</section>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../contents.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">モデルインスタンスリファレンス</a><ul>
<li><a class="reference internal" href="#creating-objects">オブジェクトを作成する</a><ul>
<li><a class="reference internal" href="#customizing-model-loading">モデルの読み込みをカスタマイズする</a></li>
</ul>
</li>
<li><a class="reference internal" href="#refreshing-objects-from-database">データベースからオブジェクトを再読み込みする</a></li>
<li><a class="reference internal" href="#validating-objects">オブジェクトを検証 (バリデーション) する</a></li>
<li><a class="reference internal" href="#saving-objects">オブジェクトを保存する</a><ul>
<li><a class="reference internal" href="#auto-incrementing-primary-keys">自動インクリメントのプライマリキー</a><ul>
<li><a class="reference internal" href="#the-pk-property"><code class="docutils literal notranslate"><span class="pre">pk</span></code> プロパティ</a></li>
<li><a class="reference internal" href="#explicitly-specifying-auto-primary-key-values">自動プライマリキー値の明示的な指定</a></li>
</ul>
</li>
<li><a class="reference internal" href="#what-happens-when-you-save">save すると何が起きるか？</a></li>
<li><a class="reference internal" href="#how-django-knows-to-update-vs-insert">Django が UPDATE と INSERT を見分ける方法</a><ul>
<li><a class="reference internal" href="#forcing-an-insert-or-update">INSERT や UPDATE を強制する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#updating-attributes-based-on-existing-fields">既存のフィールドに基づいて属性を更新する</a></li>
<li><a class="reference internal" href="#specifying-which-fields-to-save">どのフィールドを保存するか指定する</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deleting-objects">オブジェクトを削除する</a></li>
<li><a class="reference internal" href="#pickling-objects">オブジェクトの Pickle 化</a></li>
<li><a class="reference internal" href="#other-model-instance-methods">その他のモデルインスタンスメソッド</a><ul>
<li><a class="reference internal" href="#str"><code class="docutils literal notranslate"><span class="pre">__str__()</span></code></a></li>
<li><a class="reference internal" href="#eq"><code class="docutils literal notranslate"><span class="pre">__eq__()</span></code></a></li>
<li><a class="reference internal" href="#hash"><code class="docutils literal notranslate"><span class="pre">__hash__()</span></code></a></li>
<li><a class="reference internal" href="#get-absolute-url"><code class="docutils literal notranslate"><span class="pre">get_absolute_url()</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#extra-instance-methods">追加のインスタンスメソッド</a></li>
<li><a class="reference internal" href="#other-attributes">その他の属性</a><ul>
<li><a class="reference internal" href="#state"><code class="docutils literal notranslate"><span class="pre">_state</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="options.html"
                          title="前の章へ">モデルの <code class="docutils literal notranslate"><span class="pre">Meta</span></code> オプション</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="querysets.html"
                          title="次の章へ"><code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> API リファレンス</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ref/models/instances.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">1月 22, 2025</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="options.html" title="モデルの &lt;code class=&#34;docutils literal notranslate&#34;&gt;&lt;span class=&#34;pre&#34;&gt;Meta&lt;/span&gt;&lt;/code&gt; オプション">previous</a>
     |
    <a href="../index.html" title="API リファレンス" accesskey="U">up</a>
   |
    <a href="querysets.html" title="&lt;code class=&#34;docutils literal notranslate&#34;&gt;&lt;span class=&#34;pre&#34;&gt;QuerySet&lt;/span&gt;&lt;/code&gt; API リファレンス">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>