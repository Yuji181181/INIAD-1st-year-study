<!DOCTYPE html>

<html lang="ja" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>クエリ式 (Query Expression) &#8212; Django 5.1.6.dev20250122212402 ドキュメント</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=34bb78ad" />
    <link rel="stylesheet" type="text/css" href="../../_static/default.css?v=bf4d74af" />
    <script src="../../_static/documentation_options.js?v=d2885b0a"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/translations.js?v=4755f45a"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="条件式" href="conditional-expressions.html" />
    <link rel="prev" title="ルックアップ API リファレンス" href="lookups.html" />



 
<script src="../../templatebuiltins.js"></script>
<script>
(function($) {
    if (!django_template_builtins) {
       // templatebuiltins.js missing, do nothing.
       return;
    }
    $(document).ready(function() {
        // Hyperlink Django template tags and filters
        var base = "../templates/builtins.html";
        if (base == "#") {
            // Special case for builtins.html itself
            base = "";
        }
        // Tags are keywords, class '.k'
        $("div.highlight\\-html\\+django span.k").each(function(i, elem) {
             var tagname = $(elem).text();
             if ($.inArray(tagname, django_template_builtins.ttags) != -1) {
                 var fragment = tagname.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + tagname + "</a>");
             }
        });
        // Filters are functions, class '.nf'
        $("div.highlight\\-html\\+django span.nf").each(function(i, elem) {
             var filtername = $(elem).text();
             if ($.inArray(filtername, django_template_builtins.tfilters) != -1) {
                 var fragment = filtername.replace(/_/, '-');
                 $(elem).html("<a href='" + base + "#" + fragment + "'>" + filtername + "</a>");
             }
        });
    });
})(jQuery);</script>

  </head><body>

    <div class="document">
  <div id="custom-doc" class="yui-t6">
    <div id="hd">
      <h1><a href="../../index.html">Django 5.1.6.dev20250122212402 ドキュメント</a></h1>
      <div id="global-nav">
        <a title="Home page" href="../../index.html">Home</a>  |
        <a title="Table of contents" href="../../contents.html">Table of contents</a>  |
        <a title="Global index" href="../../genindex.html">Index</a>  |
        <a title="Module index" href="../../py-modindex.html">Modules</a>
      </div>
      <div class="nav">
    &laquo; <a href="lookups.html" title="ルックアップ API リファレンス">previous</a>
     |
    <a href="../index.html" title="API リファレンス" accesskey="U">up</a>
   |
    <a href="conditional-expressions.html" title="条件式">next</a> &raquo;</div>
    </div>

    <div id="bd">
      <div id="yui-main">
        <div class="yui-b">
          <div class="yui-g" id="ref-models-expressions">
            
  <section id="s-query-expressions">
<span id="query-expressions"></span><h1>クエリ式 (Query Expression)<a class="headerlink" href="#query-expressions" title="Link to this heading">¶</a></h1>
<p>クエリ式 (query expression) は、update、create、filter、order by、annotation、またはaggregateの一部として使用できる値または計算を記述します。式が真偽値を出力する場合、フィルタで直接使用できます。クエリの記述に使用できる組み込みの式 (expression) は多数あります (以下で説明します)。式を組み合わせたり、場合によっては入れ子にしてより複雑な計算を行うこともできます。</p>
<section id="s-supported-arithmetic">
<span id="supported-arithmetic"></span><h2>サポートされている算術演算<a class="headerlink" href="#supported-arithmetic" title="Link to this heading">¶</a></h2>
<p>Django は Python の定数や変数、そして他の式を使って、クエリ式での否定、 加算、減算、乗算、除算、モジュロ演算、そしてべき乗演算をサポートします。</p>
</section>
<section id="s-output-field">
<span id="s-id1"></span><span id="output-field"></span><span id="id1"></span><h2>出力フィールド (<code class="docutils literal notranslate"><span class="pre">output_field</span></code>)<a class="headerlink" href="#output-field" title="Link to this heading">¶</a></h2>
<p>このセクションで説明する式の多くは、オプションの <code class="docutils literal notranslate"><span class="pre">output_field</span></code> パラメータをサポートしています。指定された場合、 Django はデータベースから値を取得した後、そのフィールドに値を読み込みます。</p>
<p><code class="docutils literal notranslate"><span class="pre">output_field</span></code> は <code class="docutils literal notranslate"><span class="pre">IntegerField()</span></code> や <code class="docutils literal notranslate"><span class="pre">BooleanField()</span></code> のようなモデルフィールドのインスタンスを取ります。通常、フィールドには <code class="docutils literal notranslate"><span class="pre">max_length</span></code> のような引数は不要です。フィールドの引数はデータの検証に関連しており、その検証は式の出力値に対して実行されないからです。</p>
<p><code class="docutils literal notranslate"><span class="pre">output_field</span></code> が必要なのは、フィールド型が混在する複雑な式のように、 Django が結果のフィールド型を自動的に判断できない場合だけです。例えば、 <code class="docutils literal notranslate"><span class="pre">DecimalField()</span></code> と <code class="docutils literal notranslate"><span class="pre">FloatField()</span></code> を足す場合、 <code class="docutils literal notranslate"><span class="pre">output_field=FloatField()</span></code> のように出力フィールドが必要になります。</p>
</section>
<section id="s-some-examples">
<span id="some-examples"></span><h2>例<a class="headerlink" href="#some-examples" title="Link to this heading">¶</a></h2>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Count</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Value</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Length</span><span class="p">,</span> <span class="n">Upper</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.lookups</span><span class="w"> </span><span class="kn">import</span> <span class="n">GreaterThan</span>

<span class="go"># Find companies that have more employees than chairs.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_employees__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>

<span class="go"># Find companies that have at least twice as many employees</span>
<span class="go"># as chairs. Both the querysets below are equivalent.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_employees__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_employees__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>

<span class="go"># How many chairs are needed for each company to seat all employees?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span> <span class="o">=</span> <span class="p">(</span>
<span class="gp">... </span>    <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_employees__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">chairs_needed</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">num_employees</span>
<span class="go">120</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">num_chairs</span>
<span class="go">50</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">chairs_needed</span>
<span class="go">70</span>

<span class="go"># Create a new company using expressions.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Google&quot;</span><span class="p">,</span> <span class="n">ticker</span><span class="o">=</span><span class="n">Upper</span><span class="p">(</span><span class="n">Value</span><span class="p">(</span><span class="s2">&quot;goog&quot;</span><span class="p">)))</span>
<span class="go"># Be sure to refresh it if you need to access the field.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">company</span><span class="o">.</span><span class="n">ticker</span>
<span class="go">&#39;GOOG&#39;</span>

<span class="go"># Annotate models with an aggregated value. Both forms</span>
<span class="go"># below are equivalent.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_products</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_products</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">)))</span>

<span class="go"># Aggregates can contain complex computations also</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_offerings</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;products&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;services&quot;</span><span class="p">)))</span>

<span class="go"># Expressions can also be used in order_by(), either directly</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Length</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Length</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
<span class="go"># or using the double underscore lookup syntax.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">CharField</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Length</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">CharField</span><span class="o">.</span><span class="n">register_lookup</span><span class="p">(</span><span class="n">Length</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;name__length&quot;</span><span class="p">)</span>

<span class="go"># Boolean expression can be used directly in filters.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Exists</span><span class="p">,</span> <span class="n">OuterRef</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">Exists</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">company</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">),</span> <span class="n">salary__gt</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
<span class="gp">... </span><span class="p">)</span>

<span class="go"># Lookup expressions can also be used directly in filters</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">GreaterThan</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">)))</span>
<span class="go"># or annotations.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">need_chairs</span><span class="o">=</span><span class="n">GreaterThan</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">)),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="s-built-in-expressions">
<span id="built-in-expressions"></span><h2>組み込みのクエリ式<a class="headerlink" href="#built-in-expressions" title="Link to this heading">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>これらの式は <code class="docutils literal notranslate"><span class="pre">django.db.models.expressions</span></code> と <code class="docutils literal notranslate"><span class="pre">django.db.models.aggregates</span></code> で定義されていますが、利便性のために <a class="reference internal" href="../../topics/db/models.html#module-django.db.models" title="django.db.models"><code class="xref py py-mod docutils literal notranslate"><span class="pre">django.db.models</span></code></a> からインポートできます。</p>
</div>
<section id="s-f-expressions">
<span id="f-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">F()</span></code> 式<a class="headerlink" href="#f-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.F">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">F</span></span><a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L869"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.F" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> オブジェクトはモデルフィールドの値、モデルフィールドを変換した値、アノテーションを付けた列を表します。これを使うことで、実際にデータベースから Python のメモリに取り出さずに、モデルフィールドの値を参照してデータベース操作を行うことができます。</p>
<p>代わりに、 Django は <code class="docutils literal notranslate"><span class="pre">F()</span></code> オブジェクトを使って、データベースレベルで必要な操作を記述する SQL 式を生成します。</p>
<p>例でやってみましょう。通常はこのようにします：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Tintin filed a news story!</span>
<span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tintin&quot;</span><span class="p">)</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">stories_filed</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>ここでは、<code class="docutils literal notranslate"><span class="pre">reporter.stories_filed</span></code> の値をデータベースからメモリに取り込んで、Pythonでおなじみの演算子を使って操作し、そのオブジェクトをデータベースに保存しています。しかし、代わりに次のようにすることもできます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>

<span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tintin&quot;</span><span class="p">)</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">stories_filed</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;stories_filed&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">reporter.stories_filed</span> <span class="pre">=</span> <span class="pre">F('stories_filed')</span> <span class="pre">+</span> <span class="pre">1</span></code> はインスタンス属性に値を代入する普通の Python 構文のように見えますが、実際にはデータベースに対する操作を記述するSQL構文です。</p>
<p>Djangoが <code class="docutils literal notranslate"><span class="pre">F()</span></code> インスタンスを見つけると、標準のPython演算子をオーバーライドしてカプセル化されたSQL式を作成します。この場合、<code class="docutils literal notranslate"><span class="pre">reporter.stories_filed</span></code> によって表されるデータベースフィールドをインクリメントするようにデータベースに指示する式が作成されます。</p>
<p><code class="docutils literal notranslate"><span class="pre">reporter.stories_filed</span></code> にどんな値があったとしても、Pythonはそれを知ることはありません。それは完全にデータベースが扱います。Python が Django の <code class="docutils literal notranslate"><span class="pre">F()</span></code> クラスを通して行うことは、フィールドを参照し、処理を記述する SQL 構文を作成することだけです。</p>
<p>このようにして保存された新しい値にアクセスするには、オブジェクトをリロードする必要があります：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">reporter</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
<span class="c1"># Or, more succinctly:</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> は上記のように単一のインスタンスに対する操作で使用されるだけでなく、<code class="docutils literal notranslate"><span class="pre">update()``と一緒にオブジェクトインスタンスの</span> <span class="pre">``QuerySet</span></code> に対して使用することもできます。これにより、上記で使用していた2つのクエリである <code class="docutils literal notranslate"><span class="pre">get()</span></code> と <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> を1つに減らすことができます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tintin&quot;</span><span class="p">)</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stories_filed</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;stories_filed&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>また、 <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.update" title="django.db.models.query.QuerySet.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">update()</span></code></a> を使用して複数のオブジェクトのフィールド値をインクリメントすることもできます。これは、データベースからPythonに全てを引き出し、それら全てをループ処理し、各オブジェクトのフィールド値をインクリメントし、そして各オブジェクトをデータベースに保存するよりも、はるかに高速になる可能性があります：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Reporter</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stories_filed</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;stories_filed&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>つまり、<code class="docutils literal notranslate"><span class="pre">F()</span></code> は、以下のようなパフォーマンス上の利点があります：</p>
<ul class="simple">
<li><p>作業をPythonではなく、データベースに行わせること</p></li>
<li><p>一部の操作に必要なクエリの数を減らすこと</p></li>
</ul>
<section id="s-slicing-f-expressions">
<span id="s-slicing-using-f"></span><span id="slicing-f-expressions"></span><span id="slicing-using-f"></span><h4><code class="docutils literal notranslate"><span class="pre">F()</span></code> 式のスライス<a class="headerlink" href="#slicing-f-expressions" title="Link to this heading">¶</a></h4>
<div class="versionadded">
<span class="title">New in Django 5.1.</span> </div>
<p>文字列ベースのフィールド、テキストベースのフィールド、および <a class="reference internal" href="../contrib/postgres/fields.html#django.contrib.postgres.fields.ArrayField" title="django.contrib.postgres.fields.ArrayField"><code class="xref py py-class docutils literal notranslate"><span class="pre">ArrayField</span></code></a> では、Python の配列スライス構文が使用できます。インデックスは0から始まり、<code class="docutils literal notranslate"><span class="pre">slice</span></code> の <code class="docutils literal notranslate"><span class="pre">step</span></code> 引数はサポートされていません。例えば、次のように記述できます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Replacing a name with a substring of itself.</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span> <span class="o">=</span> <span class="n">Writers</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Priyansh&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span><span class="o">.</span><span class="n">refresh_from_db</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">writer</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;riya&#39;</span>
</pre></div>
</div>
</section>
<section id="s-avoiding-race-conditions-using-f">
<span id="s-id2"></span><span id="avoiding-race-conditions-using-f"></span><span id="id2"></span><h4><code class="docutils literal notranslate"><span class="pre">F()</span></code> を使った競合状態の回避<a class="headerlink" href="#avoiding-race-conditions-using-f" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> のもう一つの便利な利点は、Pythonではなくデータベースがフィールドの値を更新することで <em>競合状態</em> を避けることができるということです。</p>
<p>2つのPythonスレッドが上記の最初の例のコードを実行した場合、1つのスレッドはもう1つのスレッドがデータベースから値を取得した後にフィールドの値を取得、インクリメント、保存する可能性があります。2番目のスレッドが保存する値は元の値に基づいています。</p>
<p>データベースがフィールドの更新を担当する場合、処理はより堅牢になります。 <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> や <code class="docutils literal notranslate"><span class="pre">update()</span></code> が実行されたときに、インスタンスが取得されたときの値ではなく、データベースのフィールドの値だけに基づいてフィールドが更新されます。</p>
</section>
<section id="s-f-assignments-persist-after-model-save">
<span id="f-assignments-persist-after-model-save"></span><h4><code class="docutils literal notranslate"><span class="pre">F()</span></code> への代入は <code class="docutils literal notranslate"><span class="pre">Model.save()</span></code> の後にも残ります<a class="headerlink" href="#f-assignments-persist-after-model-save" title="Link to this heading">¶</a></h4>
<p>モデルフィールドに割り当てられた <code class="docutils literal notranslate"><span class="pre">F()</span></code> オブジェクトはモデルインスタンスを保存した後も保持され、 <a class="reference internal" href="instances.html#django.db.models.Model.save" title="django.db.models.Model.save"><code class="xref py py-meth docutils literal notranslate"><span class="pre">save()</span></code></a> のたびに適用されます。例えば：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporters</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Tintin&quot;</span><span class="p">)</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">stories_filed</span> <span class="o">=</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;stories_filed&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

<span class="n">reporter</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Tintin Jr.&quot;</span>
<span class="n">reporter</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>この場合、 <code class="docutils literal notranslate"><span class="pre">stories_filed</span></code> は2回更新されます。初期値が <code class="docutils literal notranslate"><span class="pre">1</span></code> であれば、最終的な値は <code class="docutils literal notranslate"><span class="pre">3</span></code> になります。このような永続化は、例えば <a class="reference internal" href="instances.html#django.db.models.Model.refresh_from_db" title="django.db.models.Model.refresh_from_db"><code class="xref py py-meth docutils literal notranslate"><span class="pre">refresh_from_db()</span></code></a> を使ってモデルオブジェクトを保存した後にリロードすることで回避できます。</p>
</section>
<section id="s-using-f-in-filters">
<span id="using-f-in-filters"></span><h4>フィルタで <code class="docutils literal notranslate"><span class="pre">F()</span></code> を使う<a class="headerlink" href="#using-f-in-filters" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> は <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> フィルタでも非常に有用で、Python の値ではなく、フィールドの値に基づいてオブジェクトをフィルタリングできます。</p>
<p>これは <a class="reference internal" href="../../topics/db/queries.html#using-f-expressions-in-filters"><span class="std std-ref">クエリで F() 式を使う</span></a> で説明されています。</p>
</section>
<section id="s-using-f-with-annotations">
<span id="s-id3"></span><span id="using-f-with-annotations"></span><span id="id3"></span><h4><code class="docutils literal notranslate"><span class="pre">F()</span></code> をアノテーションと一緒に使う<a class="headerlink" href="#using-f-with-annotations" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> を使うと、算術演算で異なるフィールドを組み合わせてモデルに動的なフィールドを作成できます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">company</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">chairs_needed</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;num_chairs&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>組み合わせるフィールドの型が異なる場合、どのようなフィールドが返されるかを Django に伝える必要があります。ほとんどの式は <a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> をサポートしていますが、 <code class="docutils literal notranslate"><span class="pre">F()</span></code> はサポートしていないので、 <a class="reference internal" href="#django.db.models.ExpressionWrapper" title="django.db.models.ExpressionWrapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">ExpressionWrapper</span></code></a> で式をラップする必要があります：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">DateTimeField</span><span class="p">,</span> <span class="n">ExpressionWrapper</span><span class="p">,</span> <span class="n">F</span>

<span class="n">Ticket</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">expires</span><span class="o">=</span><span class="n">ExpressionWrapper</span><span class="p">(</span>
        <span class="n">F</span><span class="p">(</span><span class="s2">&quot;active_at&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">),</span> <span class="n">output_field</span><span class="o">=</span><span class="n">DateTimeField</span><span class="p">()</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">ForeignKey</span></code> のようなリレーション先フィールドを参照する場合、 <code class="docutils literal notranslate"><span class="pre">F()</span></code> はモデルインスタンスではなくプライマリキーの値を返します：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">car</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">built_by</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;manufacturer&quot;</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">car</span><span class="o">.</span><span class="n">manufacturer</span>
<span class="go">&lt;Manufacturer: Toyota&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">car</span><span class="o">.</span><span class="n">built_by</span>
<span class="go">3</span>
</pre></div>
</div>
</section>
<section id="s-using-f-to-sort-null-values">
<span id="s-id4"></span><span id="using-f-to-sort-null-values"></span><span id="id4"></span><h4>NULL 値のソートに <code class="docutils literal notranslate"><span class="pre">F()</span></code> を使う<a class="headerlink" href="#using-f-to-sort-null-values" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">F()</span></code> と <a class="reference internal" href="#django.db.models.Expression.asc" title="django.db.models.Expression.asc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Expression.asc()</span></code></a> または <a class="reference internal" href="#django.db.models.Expression.desc" title="django.db.models.Expression.desc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">desc()</span></code></a> のキーワード引数 <code class="docutils literal notranslate"><span class="pre">nulls_first</span></code> または <code class="docutils literal notranslate"><span class="pre">nulls_last</span></code> を使用して、フィールドの null 値のソートの順序を制御します。デフォルトでは、ソートの順序はデータベースに依存します。</p>
<p>例えば、まだコンタクトしていない企業 (<code class="docutils literal notranslate"><span class="pre">last_contacted</span></code> がNULL) をコンタクトした企業の後に並べるには次のようにします：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>

<span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;last_contacted&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">(</span><span class="n">nulls_last</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="s-using-f-with-logical-operations">
<span id="using-f-with-logical-operations"></span><h4>論理演算で <code class="docutils literal notranslate"><span class="pre">F()</span></code> を使う<a class="headerlink" href="#using-f-with-logical-operations" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">BooleanField</span></code> を出力する <code class="docutils literal notranslate"><span class="pre">F()</span></code> 式は反転演算子 <code class="docutils literal notranslate"><span class="pre">~F()</span></code> で論理的に否定することができます。たとえば企業の is_active ステータスを反転する場合、以下のようにします：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span>

<span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">is_active</span><span class="o">=~</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;is_active&quot;</span><span class="p">))</span>
</pre></div>
</div>
</section>
</section>
<section id="s-func-expressions">
<span id="s-id5"></span><span id="func-expressions"></span><span id="id5"></span><h3><code class="docutils literal notranslate"><span class="pre">Func()</span></code> 式<a class="headerlink" href="#func-expressions" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">Func()</span></code> 式は <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code> や <code class="docutils literal notranslate"><span class="pre">LOWER</span></code> のようなデータベース関数や、 <code class="docutils literal notranslate"><span class="pre">SUM</span></code> のような集計を含むすべての式の基本型です。これらは直接使用できます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span><span class="p">,</span> <span class="n">Func</span>

<span class="n">queryset</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">field_lower</span><span class="o">=</span><span class="n">Func</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">),</span> <span class="n">function</span><span class="o">=</span><span class="s2">&quot;LOWER&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>または、データベース関数のライブラリを構築するためにも使用できます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Lower</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;LOWER&quot;</span>


<span class="n">queryset</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">field_lower</span><span class="o">=</span><span class="n">Lower</span><span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">))</span>
</pre></div>
</div>
<p>しかし、どちらの場合も、モデルが追加の属性 <code class="docutils literal notranslate"><span class="pre">field_lower</span></code> でアノテーションされたクエリセットを生成します。この属性は、大まかには次のSQLから生成されます：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">    </span><span class="k">LOWER</span><span class="p">(</span><span class="ss">&quot;db_table&quot;</span><span class="p">.</span><span class="ss">&quot;field&quot;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;field_lower&quot;</span>
</pre></div>
</div>
<p>組み込みのデータベース関数の一覧は <a class="reference internal" href="database-functions.html"><span class="doc">データベース関数</span></a> を参照してください。</p>
<p><code class="docutils literal notranslate"><span class="pre">Func</span></code> のAPI は以下の通りです：</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Func">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Func</span></span>(<em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">expressions</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">extra</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1024"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Func" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Func.function">
<span class="sig-name descname"><span class="pre">function</span></span><a class="headerlink" href="#django.db.models.Func.function" title="Link to this definition">¶</a></dt>
<dd><p>生成する関数を指定するクラス属性です。具体的には、 <code class="docutils literal notranslate"><span class="pre">function</span></code> が <a class="reference internal" href="#django.db.models.Func.template" title="django.db.models.Func.template"><code class="xref py py-attr docutils literal notranslate"><span class="pre">template</span></code></a> 内の <code class="docutils literal notranslate"><span class="pre">function</span></code> プレースホルダとして補間されます。デフォルトは <code class="docutils literal notranslate"><span class="pre">None</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Func.template">
<span class="sig-name descname"><span class="pre">template</span></span><a class="headerlink" href="#django.db.models.Func.template" title="Link to this definition">¶</a></dt>
<dd><p>この関数に対して生成される SQL を記述する、フォーマット文字列としてのクラス属性です。デフォルトは <code class="docutils literal notranslate"><span class="pre">'%(function)s(%(expressions)s)'</span></code> です。</p>
<p><code class="docutils literal notranslate"><span class="pre">strftime('%W','date')</span></code> のようなSQLを作成していて、クエリでリテラル文字 <code class="docutils literal notranslate"><span class="pre">%</span></code> が必要な場合は、<code class="docutils literal notranslate"><span class="pre">template</span></code> 属性では <code class="docutils literal notranslate"><span class="pre">%%%%</span></code> と4倍にしてください。文字列は <code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> でのテンプレート補間と、データベースカーソルでのクエリパラメータによるSQL補間の2回補間されるからです。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Func.arg_joiner">
<span class="sig-name descname"><span class="pre">arg_joiner</span></span><a class="headerlink" href="#django.db.models.Func.arg_joiner" title="Link to this definition">¶</a></dt>
<dd><p>クラス属性は <code class="docutils literal notranslate"><span class="pre">expressions</span></code> のリストを結合するために使用される文字を表します。デフォルトは <code class="docutils literal notranslate"><span class="pre">',</span> <span class="pre">'</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Func.arity">
<span class="sig-name descname"><span class="pre">arity</span></span><a class="headerlink" href="#django.db.models.Func.arity" title="Link to this definition">¶</a></dt>
<dd><p>関数が受け付ける引数の数を表すクラス属性です。この属性が設定されていて、関数が異なる数の式で呼び出された場合、 <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> が発生します。デフォルトは <code class="docutils literal notranslate"><span class="pre">None</span></code> です。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Func.as_sql">
<span class="sig-name descname"><span class="pre">as_sql</span></span>(<em class="sig-param"><span class="n"><span class="pre">compiler</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">connection</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">function</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">template</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">arg_joiner</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">extra_context</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1078"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Func.as_sql" title="Link to this definition">¶</a></dt>
<dd><p>データベース関数の SQL フラグメントを生成します。タプル <code class="docutils literal notranslate"><span class="pre">(sql,</span> <span class="pre">params)</span></code> を返します。<code class="docutils literal notranslate"><span class="pre">sql</span></code> は SQL 文字列で、<code class="docutils literal notranslate"><span class="pre">params</span></code> はクエリパラメータのリストまたはタプルです。</p>
<p><code class="docutils literal notranslate"><span class="pre">as_vendor()</span></code> メソッドは、<code class="docutils literal notranslate"><span class="pre">function</span></code>, <code class="docutils literal notranslate"><span class="pre">template</span></code>, <code class="docutils literal notranslate"><span class="pre">arg_joiner</span></code> およびその他の <code class="docutils literal notranslate"><span class="pre">**extra_context</span></code> パラメータを使用して、必要に応じてSQLをカスタマイズするべきです。例えば：</p>
<div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">django/db/models/functions.py</span></code></span><a class="headerlink" href="#id6" title="Link to this code">¶</a></div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ConcatPair</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;CONCAT&quot;</span>
    <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_mysql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_context</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span>
            <span class="n">compiler</span><span class="p">,</span>
            <span class="n">connection</span><span class="p">,</span>
            <span class="n">function</span><span class="o">=</span><span class="s2">&quot;CONCAT_WS&quot;</span><span class="p">,</span>
            <span class="n">template</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(function)s</span><span class="s2">(&#39;&#39;, </span><span class="si">%(expressions)s</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">extra_context</span>
        <span class="p">)</span>
</pre></div>
</div>
</div>
<p>SQL インジェクションの脆弱性を回避するために、<code class="docutils literal notranslate"><span class="pre">extra_context</span></code> は <a class="reference internal" href="#avoiding-sql-injection-in-query-expressions"><span class="std std-ref">信頼できないユーザー入力を含んではいけません</span></a> 。これらの値はデータベースドライバによってエスケープされるクエリパラメータとして渡されるのではなく、SQL文字列に補間されるからです。</p>
</dd></dl>

</dd></dl>

<p>引数 <code class="docutils literal notranslate"><span class="pre">*expressions</span></code> は関数が適用される位置引数としての式のリストです。式は文字列に変換され、 <code class="docutils literal notranslate"><span class="pre">arg_joiner</span></code> で連結された後、 <code class="docutils literal notranslate"><span class="pre">expressions</span></code> プレースホルダとして <code class="docutils literal notranslate"><span class="pre">template</span></code> に挿入されます。</p>
<p>位置引数には式か Python の値を指定できます。文字列はカラム参照とみなされ、 <code class="docutils literal notranslate"><span class="pre">F()</span></code> 式でラップされ、その他の値は <code class="docutils literal notranslate"><span class="pre">Value()</span></code> 式でラップされます。</p>
<p><code class="docutils literal notranslate"><span class="pre">*extra</span></code> kwargs は <code class="docutils literal notranslate"><span class="pre">template</span></code> 属性に補間できる <code class="docutils literal notranslate"><span class="pre">key=value</span></code> のペアです。SQL インジェクションの脆弱性を回避するために、<code class="docutils literal notranslate"><span class="pre">*extra</span></code> は <a class="reference internal" href="#avoiding-sql-injection-in-query-expressions"><span class="std std-ref">信頼できないユーザー入力を含んではいけません</span></a> 。これらの値はデータベースドライバによってエスケープされるクエリパラメータとして渡されるのではなく、SQL文字列に補間されるからです。</p>
<p><code class="docutils literal notranslate"><span class="pre">function</span></code>, <code class="docutils literal notranslate"><span class="pre">template</span></code>, および <code class="docutils literal notranslate"><span class="pre">arg_joiner</span></code> キーワードは、同じ名前の属性を置き換えるために使用でき、独自のクラスを定義する必要はありません。<a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> は、期待される戻り値の型を定義するために使用できます。</p>
</section>
<section id="s-aggregate-expressions">
<span id="aggregate-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">Aggregate()</span></code> 式<a class="headerlink" href="#aggregate-expressions" title="Link to this heading">¶</a></h3>
<p>集計式 (aggregate expression) は <a class="reference internal" href="#func-expressions"><span class="std std-ref">Func() 式</span></a> の特殊なケースで、 <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> 句が必要であることをクエリに通知します。 <code class="docutils literal notranslate"><span class="pre">Sum()</span></code> や <code class="docutils literal notranslate"><span class="pre">Count()</span></code> などの <a class="reference internal" href="querysets.html#aggregation-functions"><span class="std std-ref">集計関数</span></a> はすべて <code class="docutils literal notranslate"><span class="pre">Aggregate()</span></code> を継承しています。</p>
<p><code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> は式であり、ラップ式でもあるので、複雑な計算を表現できます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Count</span>

<span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
    <span class="n">managers_required</span><span class="o">=</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;num_employees&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">Count</span><span class="p">(</span><span class="s2">&quot;num_managers&quot;</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Aggregate</span></code> の API は以下の通りです：</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Aggregate">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Aggregate</span></span>(<em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">expressions</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">distinct</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">filter</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">default</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">extra</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/aggregates.py#L26"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Aggregate" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.template">
<span class="sig-name descname"><span class="pre">template</span></span><a class="headerlink" href="#django.db.models.Aggregate.template" title="Link to this definition">¶</a></dt>
<dd><p>この aggregate 用に生成される SQL を記述する、フォーマット文字列としてのクラス属性です。デフォルトは <code class="docutils literal notranslate"><span class="pre">'%(function)s(%(distinct)s%(expressions)s)'</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.function">
<span class="sig-name descname"><span class="pre">function</span></span><a class="headerlink" href="#django.db.models.Aggregate.function" title="Link to this definition">¶</a></dt>
<dd><p>生成される集計関数を記述するクラス属性です。具体的には、 <code class="docutils literal notranslate"><span class="pre">function</span></code> が <a class="reference internal" href="#django.db.models.Aggregate.template" title="django.db.models.Aggregate.template"><code class="xref py py-attr docutils literal notranslate"><span class="pre">template</span></code></a> 内の <code class="docutils literal notranslate"><span class="pre">function</span></code> プレースホルダとして補間されます。デフォルトは <code class="docutils literal notranslate"><span class="pre">None</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.window_compatible">
<span class="sig-name descname"><span class="pre">window_compatible</span></span><a class="headerlink" href="#django.db.models.Aggregate.window_compatible" title="Link to this definition">¶</a></dt>
<dd><p>ほとんどの集計関数は <a class="reference internal" href="#django.db.models.expressions.Window" title="django.db.models.expressions.Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> のソース式として使用できるので、デフォルトは <code class="docutils literal notranslate"><span class="pre">True</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.allow_distinct">
<span class="sig-name descname"><span class="pre">allow_distinct</span></span><a class="headerlink" href="#django.db.models.Aggregate.allow_distinct" title="Link to this definition">¶</a></dt>
<dd><p>この集計関数が <code class="docutils literal notranslate"><span class="pre">distinct</span></code> キーワード引数を渡すことができるかどうかを決定するクラス属性。 <code class="docutils literal notranslate"><span class="pre">False</span></code> (デフォルト) に設定されている場合、 <code class="docutils literal notranslate"><span class="pre">distinct=True</span></code> が渡されると <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> が発生します。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Aggregate.empty_result_set_value">
<span class="sig-name descname"><span class="pre">empty_result_set_value</span></span><a class="headerlink" href="#django.db.models.Aggregate.empty_result_set_value" title="Link to this definition">¶</a></dt>
<dd><p>ほとんどの集計関数は、空の結果セットに適用すると <code class="docutils literal notranslate"><span class="pre">NULL</span></code> となるため、デフォルトは <code class="docutils literal notranslate"><span class="pre">None</span></code> です。</p>
</dd></dl>

</dd></dl>

<p>位置引数 <code class="docutils literal notranslate"><span class="pre">expressions</span></code> には、式、モデルフィールドのトランスフォーム、またはモデルフィールドの名前を指定できます。これらは文字列に変換され、 <code class="docutils literal notranslate"><span class="pre">template</span></code> 内の <code class="docutils literal notranslate"><span class="pre">expressions</span></code> プレースホルダとして使用されます。</p>
<p>引数 <code class="docutils literal notranslate"><span class="pre">distinct</span></code> は、集計関数を <code class="docutils literal notranslate"><span class="pre">式</span></code> (または複数の <code class="docutils literal notranslate"><span class="pre">式</span></code> の場合は値の集合) ごとに呼び出すかどうかを決定します。この引数は <a class="reference internal" href="#django.db.models.Aggregate.allow_distinct" title="django.db.models.Aggregate.allow_distinct"><code class="xref py py-attr docutils literal notranslate"><span class="pre">allow_distinct</span></code></a> が <code class="docutils literal notranslate"><span class="pre">True</span></code> に設定されている集計でのみサポートされます。</p>
<p>引数 <code class="docutils literal notranslate"><span class="pre">filter</span></code> は <a class="reference internal" href="querysets.html#django.db.models.Q" title="django.db.models.Q"><code class="xref py py-class docutils literal notranslate"><span class="pre">Q</span> <span class="pre">オブジェクト</span></code></a> を取り、集計する行をフィルタリングします。使用例については <a class="reference internal" href="conditional-expressions.html#conditional-aggregation"><span class="std std-ref">条件付きの集計</span></a> と <a class="reference internal" href="../../topics/db/aggregation.html#filtering-on-annotations"><span class="std std-ref">アノテーションのフィルタリング</span></a> を参照してください。</p>
<p>引数 <code class="docutils literal notranslate"><span class="pre">default</span></code> は <a class="reference internal" href="database-functions.html#django.db.models.functions.Coalesce" title="django.db.models.functions.Coalesce"><code class="xref py py-class docutils literal notranslate"><span class="pre">Coalesce</span></code></a> に集計句と一緒に渡される値を取ります。これは、クエリセット(またはグループ化)にエントリがない場合に <code class="docutils literal notranslate"><span class="pre">None</span></code> 以外の値を返すように指定するのに便利です。</p>
<p>この <code class="docutils literal notranslate"><span class="pre">**extra</span></code> キーワード引数は <code class="docutils literal notranslate"><span class="pre">template</span></code> 属性に補間できる <code class="docutils literal notranslate"><span class="pre">key=value</span></code> のペアです。</p>
</section>
<section id="s-creating-your-own-aggregate-functions">
<span id="creating-your-own-aggregate-functions"></span><h3>独自の集計関数 (Aggregate Function) を作る<a class="headerlink" href="#creating-your-own-aggregate-functions" title="Link to this heading">¶</a></h3>
<p>独自の集計関数を作成することもできます。最低限 <code class="docutils literal notranslate"><span class="pre">function</span></code> を定義する必要がありますが、生成される SQL を完全にカスタマイズすることもできます。以下に簡単な例を示します：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Aggregate</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Sum</span><span class="p">(</span><span class="n">Aggregate</span><span class="p">):</span>
    <span class="c1"># Supports SUM(ALL field).</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;SUM&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(function)s</span><span class="s2">(</span><span class="si">%(all_values)s%(expressions)s</span><span class="s2">)&quot;</span>
    <span class="n">allow_distinct</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">all_values</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">all_values</span><span class="o">=</span><span class="s2">&quot;ALL &quot;</span> <span class="k">if</span> <span class="n">all_values</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">extra</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="s-value-expressions">
<span id="value-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">Value()</span></code> 式<a class="headerlink" href="#value-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Value">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Value</span></span>(<em class="sig-param"><span class="n"><span class="pre">value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1129"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Value" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">Value()</span></code> オブジェクトは式の最小の構成要素、つまり単純な値を表します。式の中で整数、真偽値、文字列の値を表す必要がある場合、その値を <code class="docutils literal notranslate"><span class="pre">Value()</span></code> で囲みます。</p>
<p><code class="docutils literal notranslate"><span class="pre">Value()</span></code> を直接使用することはほとんどありません。 <code class="docutils literal notranslate"><span class="pre">F('field')</span> <span class="pre">+</span> <span class="pre">1</span></code> という式を書くと、Djangoは暗黙のうちに <code class="docutils literal notranslate"><span class="pre">1</span></code> を <code class="docutils literal notranslate"><span class="pre">Value()</span></code> でラップし、単純な値をより複雑な式で使用できるようにします。式に文字列を渡したいときは <code class="docutils literal notranslate"><span class="pre">Value()</span></code> を使用する必要があります。ほとんどの式では、文字列引数をフィールド名として解釈します。例えば <code class="docutils literal notranslate"><span class="pre">Lower('name')</span></code> のように。</p>
<p>引数 <code class="docutils literal notranslate"><span class="pre">value</span></code> には、 <code class="docutils literal notranslate"><span class="pre">1</span></code>, <code class="docutils literal notranslate"><span class="pre">True</span></code>, <code class="docutils literal notranslate"><span class="pre">None</span></code> など、式に含める値を記述します。Django はこれらの Python の値を対応するデータベース型に変換する方法を知っています。</p>
<p><a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> が指定されていない場合、多くの一般的な型では <code class="docutils literal notranslate"><span class="pre">value</span></code> の型から推測されます。例えば、 <a class="reference external" href="https://docs.python.org/3/library/datetime.html#datetime.datetime" title="(in Python v3.13)"><code class="xref py py-class docutils literal notranslate"><span class="pre">datetime.datetime</span></code></a> のインスタンスを <code class="docutils literal notranslate"><span class="pre">value</span></code> として渡すと、 <code class="docutils literal notranslate"><span class="pre">output_field</span></code> のデフォルトは <a class="reference internal" href="fields.html#django.db.models.DateTimeField" title="django.db.models.DateTimeField"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTimeField</span></code></a> です。</p>
</section>
<section id="s-expressionwrapper-expressions">
<span id="expressionwrapper-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">ExpressionWrapper()</span></code> 式<a class="headerlink" href="#expressionwrapper-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.ExpressionWrapper">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">ExpressionWrapper</span></span>(<em class="sig-param"><span class="n"><span class="pre">expression</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1416"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.ExpressionWrapper" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">ExpressionWrapper</span></code> は他の式を囲み、 <a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> のような他の式では利用できないプロパティへのアクセスを提供します。 <code class="docutils literal notranslate"><span class="pre">ExpressionWrapper</span></code> は <a class="reference internal" href="#using-f-with-annotations"><span class="std std-ref">F() をアノテーションと一緒に使う</span></a> で説明されているように、異なる型を持つ <code class="docutils literal notranslate"><span class="pre">F()</span></code> 式で算術演算を行う場合に必要です。</p>
</section>
<section id="s-conditional-expressions">
<span id="conditional-expressions"></span><h3>条件式<a class="headerlink" href="#conditional-expressions" title="Link to this heading">¶</a></h3>
<p>条件式を用いると、<a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#if" title="(in Python v3.13)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">if</span></code></a> ... <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#elif" title="(in Python v3.13)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">elif</span></code></a> ... <a class="reference external" href="https://docs.python.org/3/reference/compound_stmts.html#else" title="(in Python v3.13)"><code class="xref std std-keyword docutils literal notranslate"><span class="pre">else</span></code></a> ロジックをクエリーの中で使用できるようになります。Django はネイティブで SQL <code class="docutils literal notranslate"><span class="pre">CASE</span></code> 式をサポートしています。詳細については <a class="reference internal" href="conditional-expressions.html"><span class="doc">条件式</span></a> を読んでください。</p>
</section>
<section id="s-subquery-expressions">
<span id="subquery-expressions"></span><h3><code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> 式<a class="headerlink" href="#subquery-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Subquery">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Subquery</span></span>(<em class="sig-param"><span class="n"><span class="pre">queryset</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1686"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Subquery" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">Subquery</span></code> 式を使うと、 <code class="docutils literal notranslate"><span class="pre">QuerySet</span></code> に明示的にサブクエリを追加できます。</p>
<p>たとえば、各投稿にその投稿の最新コメントの投稿者のメールアドレスをアノテーションとして付けることができます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">OuterRef</span><span class="p">,</span> <span class="n">Subquery</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">newest</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-created_at&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">newest_commenter_email</span><span class="o">=</span><span class="n">Subquery</span><span class="p">(</span><span class="n">newest</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<p>PostgreSQLの場合、SQLは以下のようになります：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;email&quot;</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;comment&quot;</span><span class="w"> </span><span class="n">U0</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;post_id&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="w"> </span><span class="k">DESC</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">&quot;newest_commenter_email&quot;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;post&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>この節の例は、Django にサブクエリを強制する方法を示すものです。場合によっては、同じタスクをより明確に、あるいは効率的に実行する等価なクエリセットを書けるかもしれません。</p>
</div>
<section id="s-referencing-columns-from-the-outer-queryset">
<span id="referencing-columns-from-the-outer-queryset"></span><h4>外側のクエリセットからカラムを参照する<a class="headerlink" href="#referencing-columns-from-the-outer-queryset" title="Link to this heading">¶</a></h4>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.OuterRef">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">OuterRef</span></span>(<em class="sig-param"><span class="n"><span class="pre">field</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L953"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.OuterRef" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">OuterRef</span></code> は <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> 内のクエリセットが外側のクエリまたはそのトランスフォームのフィールドから参照される必要がある場合に使用します。これは <a class="reference internal" href="#django.db.models.F" title="django.db.models.F"><code class="xref py py-class docutils literal notranslate"><span class="pre">F</span></code></a> 式と同じように動作しますが、有効なフィールドを参照しているかどうかのチェックは外側のクエリセットが解決されるまで行われません。</p>
<p><code class="docutils literal notranslate"><span class="pre">OuterRef</span></code> のインスタンスは、入れ子になった <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> のインスタンスと一緒に使用できます。例えば、このクエリセットを正しく解決するには、 <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> インスタンスの入れ子になったペア内にある必要があります：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</section>
<section id="s-limiting-a-subquery-to-a-single-column">
<span id="limiting-a-subquery-to-a-single-column"></span><h4>サブクエリを単一のカラムに絞る<a class="headerlink" href="#limiting-a-subquery-to-a-single-column" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Subquery</span></code> を <code class="docutils literal notranslate"><span class="pre">__in</span></code> ルックアップの対象として使う場合など、<code class="docutils literal notranslate"><span class="pre">Subquery</span></code> から単一のカラムを返さなければならないことがあります。たとえば、直近一日以内に公開された投稿のすべてのコメントを返す場合：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one_day_ago</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">posts</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">published_at__gte</span><span class="o">=</span><span class="n">one_day_ago</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post__in</span><span class="o">=</span><span class="n">Subquery</span><span class="p">(</span><span class="n">posts</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">)))</span>
</pre></div>
</div>
<p>この場合、サブクエリは <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">values()</span></code></a> を使って単一のカラム、つまり投稿のプライマリキーだけを返さなければなりません。</p>
</section>
<section id="s-limiting-the-subquery-to-a-single-row">
<span id="limiting-the-subquery-to-a-single-row"></span><h4>サブクエリを1行に絞る<a class="headerlink" href="#limiting-the-subquery-to-a-single-row" title="Link to this heading">¶</a></h4>
<p>サブクエリが複数行を返すのを防ぐには、クエリセットのスライス (<code class="docutils literal notranslate"><span class="pre">[:1]</span></code>) を使用します：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">subquery</span> <span class="o">=</span> <span class="n">Subquery</span><span class="p">(</span><span class="n">newest</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;email&quot;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">newest_commenter_email</span><span class="o">=</span><span class="n">subquery</span><span class="p">)</span>
</pre></div>
</div>
<p>この場合、サブクエリは単一のカラムの単一の行、つまり最近作成されたコメントのメールアドレスだけを返す必要があります。</p>
<p>（スライスの代わりに <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.get" title="django.db.models.query.QuerySet.get"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get()</span></code></a> を使うと、 <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> 内でクエリセットが使われるまで <code class="docutils literal notranslate"><span class="pre">OuterRef</span></code> が解決できないため失敗します）</p>
</section>
<section id="s-exists-subqueries">
<span id="exists-subqueries"></span><h4><code class="docutils literal notranslate"><span class="pre">Exists()</span></code> サブクエリ<a class="headerlink" href="#exists-subqueries" title="Link to this heading">¶</a></h4>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Exists">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Exists</span></span>(<em class="sig-param"><span class="n"><span class="pre">queryset</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1739"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Exists" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">Exists</span></code> は SQL の <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> ステートメントを使う <code class="docutils literal notranslate"><span class="pre">サブクエリ</span></code> のサブクラスです。多くの場合、最初にマッチする行が見つかった時点でデータベースがサブクエリの評価を停止できるので、サブクエリよりも性能が良くなります。</p>
<p>たとえば、各投稿に直近1日以内のコメントがあるかどうかのアノテーションを付けることができます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Exists</span><span class="p">,</span> <span class="n">OuterRef</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timedelta</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">one_day_ago</span> <span class="o">=</span> <span class="n">timezone</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">recent_comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">post</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">created_at__gte</span><span class="o">=</span><span class="n">one_day_ago</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">recent_comment</span><span class="o">=</span><span class="n">Exists</span><span class="p">(</span><span class="n">recent_comments</span><span class="p">))</span>
</pre></div>
</div>
<p>PostgreSQLの場合、SQLは以下のようになります：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;published_at&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">EXISTS</span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="ss">&quot;a&quot;</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;comment&quot;</span><span class="w"> </span><span class="n">U0</span>
<span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="p">(</span>
<span class="w">        </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;created_at&quot;</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">YYYY</span><span class="o">-</span><span class="n">MM</span><span class="o">-</span><span class="n">DD</span><span class="w"> </span><span class="n">HH</span><span class="p">:</span><span class="n">MM</span><span class="p">:</span><span class="n">SS</span><span class="w"> </span><span class="k">AND</span>
<span class="w">        </span><span class="n">U0</span><span class="p">.</span><span class="ss">&quot;post_id&quot;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ss">&quot;post&quot;</span><span class="p">.</span><span class="ss">&quot;id&quot;</span>
<span class="w">    </span><span class="p">)</span>
<span class="w">    </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">1</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="ss">&quot;recent_comment&quot;</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;post&quot;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Exists</span></code> に単一のカラムの参照を強制する必要はありません。列は破棄され、真偽値の結果が返されるからです。同様に、ソートは SQL の <code class="docutils literal notranslate"><span class="pre">EXISTS</span></code> サブクエリ内では重要ではなく、パフォーマンスを低下させるだけなので、自動的に破棄されます。</p>
<p><code class="docutils literal notranslate"><span class="pre">~Exists()</span></code> を使って <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">EXISTS</span></code> をクエリできます。</p>
</section>
<section id="s-filtering-on-a-subquery-or-exists-expressions">
<span id="filtering-on-a-subquery-or-exists-expressions"></span><h4><code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> または <code class="docutils literal notranslate"><span class="pre">Exists()</span></code> 式におけるフィルタリング<a class="headerlink" href="#filtering-on-a-subquery-or-exists-expressions" title="Link to this heading">¶</a></h4>
<p>真偽値を返す <code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> と <code class="docutils literal notranslate"><span class="pre">Exists()</span></code> は <a class="reference internal" href="conditional-expressions.html#django.db.models.expressions.When" title="django.db.models.expressions.When"><code class="xref py py-class docutils literal notranslate"><span class="pre">When</span></code></a> 式で <code class="docutils literal notranslate"><span class="pre">condition</span></code> として使用したり、クエリセットに直接フィルタをかけたりすることができます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">recent_comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># From above</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Exists</span><span class="p">(</span><span class="n">recent_comments</span><span class="p">))</span>
</pre></div>
</div>
<p>これにより、サブクエリが <code class="docutils literal notranslate"><span class="pre">SELECT</span></code> カラムに追加されなくなり、パフォーマンスが向上する可能性があります。</p>
</section>
<section id="s-using-aggregates-within-a-subquery-expression">
<span id="using-aggregates-within-a-subquery-expression"></span><h4><code class="docutils literal notranslate"><span class="pre">Subquery</span></code> 式の中で集計 (aggregate) を使う<a class="headerlink" href="#using-aggregates-within-a-subquery-expression" title="Link to this heading">¶</a></h4>
<p>集計 (aggregate) は <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> の中で使用できますが、サブクエリのグループ化を正しく行うためには <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">filter()</span></code></a>, <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.values" title="django.db.models.query.QuerySet.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">values()</span></code></a>, <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.annotate" title="django.db.models.query.QuerySet.annotate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">annotate()</span></code></a> の特定の組み合わせを必要とします。</p>
<p>両方のモデルに <code class="docutils literal notranslate"><span class="pre">length</span></code> フィールドがあると仮定すると、投稿の長さがすべてのコメントの長さの合計よりも大きい投稿を見つけることができます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">OuterRef</span><span class="p">,</span> <span class="n">Subquery</span><span class="p">,</span> <span class="n">Sum</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">OuterRef</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;post&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">total_comments</span> <span class="o">=</span> <span class="n">comments</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;length&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">length__gt</span><span class="o">=</span><span class="n">Subquery</span><span class="p">(</span><span class="n">total_comments</span><span class="p">))</span>
</pre></div>
</div>
<p>最初の <code class="docutils literal notranslate"><span class="pre">filter(...)</span></code> はサブクエリを関連するパラメータに制限します。 <code class="docutils literal notranslate"><span class="pre">order_by()</span></code> は <code class="docutils literal notranslate"><span class="pre">Comment</span></code> モデルのデフォルトの <a class="reference internal" href="options.html#django.db.models.Options.ordering" title="django.db.models.Options.ordering"><code class="xref py py-attr docutils literal notranslate"><span class="pre">ordering</span></code></a> (もしあれば) を削除します。 <code class="docutils literal notranslate"><span class="pre">value('post')</span></code> はコメントを <code class="docutils literal notranslate"><span class="pre">Post</span></code> で集計します。最後に、 <code class="docutils literal notranslate"><span class="pre">annotate(...)</span></code> が集計を行います。これらのクエリセットメソッドを適用する順番は重要です。この場合、サブクエリは1つのカラムに限定する必要があるため、 <code class="docutils literal notranslate"><span class="pre">values('total')</span></code> が必要となります。</p>
<p>これは <code class="docutils literal notranslate"><span class="pre">Subquery</span></code> 内で集計を行う唯一の方法です。 <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.aggregate" title="django.db.models.query.QuerySet.aggregate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">aggregate()</span></code></a> を使用すると、クエリセットを評価しようとします（そして <code class="docutils literal notranslate"><span class="pre">OuterRef</span></code> がある場合、これを解決することはできません）。</p>
</section>
</section>
<section id="s-raw-sql-expressions">
<span id="raw-sql-expressions"></span><h3>素の SQL 式<a class="headerlink" href="#raw-sql-expressions" title="Link to this heading">¶</a></h3>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.RawSQL">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">RawSQL</span></span>(<em class="sig-param"><span class="n"><span class="pre">sql</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">params</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1209"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.expressions.RawSQL" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<p>データベース式では複雑な <code class="docutils literal notranslate"><span class="pre">WHERE</span></code> 句を簡単に表現できないことがあります。このような場合は <code class="docutils literal notranslate"><span class="pre">RawSQL</span></code> 式を使用してください。たとえば：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.expressions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RawSQL</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="n">RawSQL</span><span class="p">(</span><span class="s2">&quot;select col from sometable where othercol = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">param</span><span class="p">,)))</span>
</pre></div>
</div>
<p>このような特別なルックアップは、（明示的にSQLコードを記述しているため）異なるデータベースエンジンに移植できない可能性があり、DRY原則に反するので、可能なら避けるべきです。</p>
<p><code class="docutils literal notranslate"><span class="pre">RawSQL</span></code> 式は <code class="docutils literal notranslate"><span class="pre">__in</span></code> フィルタの対象としても使用できます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">RawSQL</span><span class="p">(</span><span class="s2">&quot;select id from sometable where col = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">param</span><span class="p">,)))</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p><a class="reference external" href="https://ja.wikipedia.org/wiki/SQL%E3%82%A4%E3%83%B3%E3%82%B8%E3%82%A7%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3">SQLインジェクション攻撃</a> を防ぐために、 <code class="docutils literal notranslate"><span class="pre">params</span></code> を使って、ユーザが操作できるパラメータをエスケープする必要があります。 <code class="docutils literal notranslate"><span class="pre">params</span></code> は必須引数で、ユーザが入力したデータでSQLを補間しないことを強制するためのものです。</p>
<p>また、SQL文字列のプレースホルダを引用符で囲んではいけません。 この例では <code class="docutils literal notranslate"><span class="pre">%s</span></code> を引用符で囲んでいるため、SQLインジェクションの脆弱性があります：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RawSQL</span><span class="p">(</span><span class="s2">&quot;select col from sometable where othercol = &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">)</span>  <span class="c1"># unsafe!</span>
</pre></div>
</div>
<p>Django が <a class="reference internal" href="../../topics/security.html#sql-injection-protection"><span class="std std-ref">SQL インジェクションを防ぐ</span></a> 仕組みの説明があります。</p>
</div>
</section>
<section id="s-window-functions">
<span id="window-functions"></span><h3>ウィンドウ関数<a class="headerlink" href="#window-functions" title="Link to this heading">¶</a></h3>
<p>ウィンドウ関数は、パーティション上で関数を適用する方法を提供します。通常の集計関数が group by で定義された各セットに対して最終結果を計算するのに対し、ウィンドウ関数は <a class="reference internal" href="#window-frames"><span class="std std-ref">フレーム</span></a> とパーティション上で操作し、各行に対して結果を計算します。</p>
<p>同じクエリ内で複数のウィンドウを指定することができ、Django ORM では <a class="reference internal" href="../../topics/db/aggregation.html"><span class="doc">QuerySet.annotate()</span></a> 呼び出しに複数の式を含めることで実現します。ORMは名前付きウィンドウを使用しませんが、代わりに選択されたカラムの一部となります。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.Window">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Window</span></span>(<em class="sig-param"><span class="n"><span class="pre">expression</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">partition_by</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">order_by</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">frame</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">output_field</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1861"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.expressions.Window" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.Window.template">
<span class="sig-name descname"><span class="pre">template</span></span><a class="headerlink" href="#django.db.models.expressions.Window.template" title="Link to this definition">¶</a></dt>
<dd><p>デフォルトは <code class="docutils literal notranslate"><span class="pre">%(expression)s</span> <span class="pre">OVER</span> <span class="pre">(%(window)s)</span></code> です。引数 <code class="docutils literal notranslate"><span class="pre">expression</span></code> だけを指定した場合、window 句は空白になります。</p>
</dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">Window</span></code> クラスは <code class="docutils literal notranslate"><span class="pre">OVER</span></code> 句のメインの式です。</p>
<p>引数の <code class="docutils literal notranslate"><span class="pre">expression</span></code> は <a class="reference internal" href="database-functions.html#window-functions"><span class="std std-ref">ウィンドウ関数</span></a>, <a class="reference internal" href="querysets.html#aggregation-functions"><span class="std std-ref">集計関数</span></a>, またはwindow句で互換性のある式です。</p>
<p><code class="docutils literal notranslate"><span class="pre">partition_by</span></code> 引数には、行のパーティショニングを制御する式または一連の式 (カラム名は <code class="docutils literal notranslate"><span class="pre">F</span></code> オブジェクトで囲む必要があります) を指定します。パーティショニングは、結果セットを計算するために使用する行を絞り込みます。</p>
<p><a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> は引数か式で指定します。</p>
<p><code class="docutils literal notranslate"><span class="pre">order_by</span></code> 引数には <a class="reference internal" href="#django.db.models.Expression.asc" title="django.db.models.Expression.asc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">asc()</span></code></a> と <a class="reference internal" href="#django.db.models.Expression.desc" title="django.db.models.Expression.desc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">desc()</span></code></a> を呼び出せる式、フィールド名の文字列 (オプションで降順を示す <code class="docutils literal notranslate"><span class="pre">&quot;-&quot;</span></code> をプレフィックスに付けられます)、または文字列や式のタプルやリストを渡すことができます。順序は式が適用される順番を制御します。例えば、パーティション内の行を合計した場合、最初の結果は最初の行の値になり、2番目は最初の行と2番目の行の合計になります。</p>
<p>パラメータ <code class="docutils literal notranslate"><span class="pre">frame</span></code> は、計算に使用する他の行を指定します。詳細は <a class="reference internal" href="#window-frames"><span class="std std-ref">フレーム</span></a> を参照してください。</p>
<p>たとえば、各映画に同じスタジオによる同じジャンル・公開年の映画の平均レーティングでアノテーションを付ける場合：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Window</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">avg_rating</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;studio&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)],</span>
<span class="gp">... </span>        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;released__year&quot;</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<p>これにより、映画の評価が他の映画より高いか低いかをチェックできます。</p>
<p>同じウィンドウ、つまり同じパーティションとフレームに複数の式を適用したい場合があります。例えば、同じクエリで3つのウィンドウ関数を使用することで、各映画のグループ（同じスタジオ、ジャンル、リリース年）のベストとワーストの評価も含めるように、前の例を修正できます。前の例のパーティションとソートは、繰り返しを減らすために辞書に抽出されます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Min</span><span class="p">,</span> <span class="n">Window</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">window</span> <span class="o">=</span> <span class="p">{</span>
<span class="gp">... </span>    <span class="s2">&quot;partition_by&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;studio&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)],</span>
<span class="gp">... </span>    <span class="s2">&quot;order_by&quot;</span><span class="p">:</span> <span class="s2">&quot;released__year&quot;</span><span class="p">,</span>
<span class="gp">... </span><span class="p">}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">avg_rating</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="o">**</span><span class="n">window</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span>    <span class="n">best</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="o">**</span><span class="n">window</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span>    <span class="n">worst</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Min</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="o">**</span><span class="n">window</span><span class="p">,</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<p>ウィンドウ関数に対するフィルタリングは、ルックアップが分離型でない（コネクタとして <code class="docutils literal notranslate"><span class="pre">OR</span></code> や <code class="docutils literal notranslate"><span class="pre">XOR</span></code> を使用していない）限り、集計を実行するクエリセットに対してもサポートされます。</p>
<p>たとえば、集計に依存し、ウィンドウ関数とフィールドに対して <code class="docutils literal notranslate"><span class="pre">OR</span></code> でフィルタされたクエリはサポートされていません。集計後に真偽値を返す関数を適用すると、通常はグループから除外されるはずの行が含まれる可能性があります：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span> <span class="o">=</span> <span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">category_rank</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span><span class="n">Rank</span><span class="p">(),</span> <span class="n">partition_by</span><span class="o">=</span><span class="s2">&quot;category&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;-rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">scenes_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;actors&quot;</span><span class="p">),</span>
<span class="gp">... </span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">category_rank__lte</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">title__contains</span><span class="o">=</span><span class="s2">&quot;Batman&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
<span class="go">NotImplementedError: Heterogeneous disjunctive predicates against window functions</span>
<span class="go">are not implemented when performing conditional aggregation.</span>
</pre></div>
</div>
<p>Django に組み込みのデータベースバックエンドでは、MySQL、 PostgreSQL、 Oracle がウィンドウ表現をサポートしています。ウィンドウ表現機能のサポートはデータベースによって異なります。例えば、 <a class="reference internal" href="#django.db.models.Expression.asc" title="django.db.models.Expression.asc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">asc()</span></code></a> や <a class="reference internal" href="#django.db.models.Expression.desc" title="django.db.models.Expression.desc"><code class="xref py py-meth docutils literal notranslate"><span class="pre">desc()</span></code></a> のオプションはサポートされていないかもしれません。必要に応じてデータベースのドキュメントを参照してください。</p>
<section id="s-frames">
<span id="s-window-frames"></span><span id="frames"></span><span id="window-frames"></span><h4>フレーム<a class="headerlink" href="#frames" title="Link to this heading">¶</a></h4>
<p>ウィンドウフレームでは、範囲ベースの行のシーケンスか、通常の行のシーケンスのいずれかを選択できます。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.ValueRange">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">ValueRange</span></span>(<em class="sig-param"><span class="n"><span class="pre">start</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">end</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exclusion</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L2081"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.expressions.ValueRange" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.ValueRange.frame_type">
<span class="sig-name descname"><span class="pre">frame_type</span></span><a class="headerlink" href="#django.db.models.expressions.ValueRange.frame_type" title="Link to this definition">¶</a></dt>
<dd><p>この属性は <code class="docutils literal notranslate"><span class="pre">'RANGE'</span></code> に設定されています。</p>
</dd></dl>

<p>PostgreSQLは <code class="docutils literal notranslate"><span class="pre">ValueRange</span></code> のサポートに制限があり、 <code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code> や <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">FOLLOWING</span></code> のような標準的な開始点と終了点の使用しかサポートしていません。</p>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">exclusion</span></code> 引数が追加されました。</p>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.RowRange">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">RowRange</span></span>(<em class="sig-param"><span class="n"><span class="pre">start</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">end</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">exclusion</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L2074"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.expressions.RowRange" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.RowRange.frame_type">
<span class="sig-name descname"><span class="pre">frame_type</span></span><a class="headerlink" href="#django.db.models.expressions.RowRange.frame_type" title="Link to this definition">¶</a></dt>
<dd><p>この属性は <code class="docutils literal notranslate"><span class="pre">'ROWS'</span></code> に設定されています。</p>
</dd></dl>

<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">exclusion</span></code> 引数が追加されました。</p>
</div>
</dd></dl>

<p>どちらのクラスもテンプレートとともにSQLを返します：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="p">(</span><span class="n">frame_type</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="k">start</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="k">end</span><span class="p">)</span><span class="n">s</span>
</pre></div>
</div>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">WindowFrameExclusion</span></span><a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L1977"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion" title="Link to this definition">¶</a></dt>
<dd><div class="versionadded">
<span class="title">New in Django 5.1.</span> </div>
<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion.CURRENT_ROW">
<span class="sig-name descname"><span class="pre">CURRENT_ROW</span></span><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion.CURRENT_ROW" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion.GROUP">
<span class="sig-name descname"><span class="pre">GROUP</span></span><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion.GROUP" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion.TIES">
<span class="sig-name descname"><span class="pre">TIES</span></span><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion.TIES" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.expressions.WindowFrameExclusion.NO_OTHERS">
<span class="sig-name descname"><span class="pre">NO_OTHERS</span></span><a class="headerlink" href="#django.db.models.expressions.WindowFrameExclusion.NO_OTHERS" title="Link to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<p><code class="docutils literal notranslate"><span class="pre">exclusion</span></code> 引数は、サポートされているデータベースでウィンドウフレームから行（<a class="reference internal" href="#django.db.models.expressions.WindowFrameExclusion.CURRENT_ROW" title="django.db.models.expressions.WindowFrameExclusion.CURRENT_ROW"><code class="xref py py-attr docutils literal notranslate"><span class="pre">CURRENT_ROW</span></code></a>）、グループ（<a class="reference internal" href="#django.db.models.expressions.WindowFrameExclusion.GROUP" title="django.db.models.expressions.WindowFrameExclusion.GROUP"><code class="xref py py-attr docutils literal notranslate"><span class="pre">GROUP</span></code></a>）、および同点（<a class="reference internal" href="#django.db.models.expressions.WindowFrameExclusion.TIES" title="django.db.models.expressions.WindowFrameExclusion.TIES"><code class="xref py py-attr docutils literal notranslate"><span class="pre">TIES</span></code></a>）を除外するために使用できます。</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="p">(</span><span class="n">frame_type</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">BETWEEN</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="k">start</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="k">end</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="n">EXCLUDE</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">exclusion</span><span class="p">)</span><span class="n">s</span>
</pre></div>
</div>
<p>フレームは、結果を計算するために使用される行を絞り込みます。ある開始点から指定された終了点までシフトします。フレームはパーティションの有無に関係なく使用できますが、決定論的な結果を得るためには、ウィンドウの順序を指定することを推奨します。フレームでは、フレーム内のピアは等価値を持つ行であり、ソート句がない場合はすべての行です。</p>
<p>フレームのデフォルトの開始点は <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span></code> で、パーティションの最初の行になります。終了点は ORM が生成する SQL に常に明示的に含まれ、デフォルトでは <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">FOLLOWING</span></code> です。デフォルトのフレームは、パーティションからセットの最後の行までの全ての行を含みます。</p>
<p><code class="docutils literal notranslate"><span class="pre">start</span></code> および <code class="docutils literal notranslate"><span class="pre">end</span></code> 引数に受け入れられる値は、<code class="docutils literal notranslate"><span class="pre">None</span></code>、整数、またはゼロです。<code class="docutils literal notranslate"><span class="pre">start</span></code> に負の整数を指定するとN行前 <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">PRECEDING</span></code> となり、<code class="docutils literal notranslate"><span class="pre">None</span></code> は先頭行 <code class="docutils literal notranslate"><span class="pre">UNBOUNDED</span> <span class="pre">PRECEDING</span></code> となります。<code class="docutils literal notranslate"><span class="pre">ROWS</span></code> モードでは、<code class="docutils literal notranslate"><span class="pre">start</span></code> に正の整数を指定するとN行後 <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">FOLLOWING</span></code> となります。<code class="docutils literal notranslate"><span class="pre">end</span></code> には正の整数も受け入れられ、これによりN行後 <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">FOLLOWING</span></code> となります。<code class="docutils literal notranslate"><span class="pre">ROWS</span></code> モードでは、<code class="docutils literal notranslate"><span class="pre">end</span></code> に負の整数を指定するとN行前 <code class="docutils literal notranslate"><span class="pre">N</span> <span class="pre">PRECEDING</span></code> となります。<code class="docutils literal notranslate"><span class="pre">start</span></code> と <code class="docutils literal notranslate"><span class="pre">end</span></code> の両方でゼロを指定すると現在の行 <code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code> が返されます。</p>
<p><code class="docutils literal notranslate"><span class="pre">CURRENT</span> <span class="pre">ROW</span></code> が含むものには違いがあります。 <code class="docutils literal notranslate"><span class="pre">ROWS</span></code> モードで指定された場合、フレームは現在の行から開始または終了します。 <code class="docutils literal notranslate"><span class="pre">RANGE</span></code> モードで指定された場合、フレームはソートの順序に従って最初か最後のピアから開始または終了します。 したがって、 <code class="docutils literal notranslate"><span class="pre">RANGE</span> <span class="pre">CURRENT</span> <span class="pre">ROW</span></code> は、ソートで指定された同じ値を持つ行に対して式を評価します。テンプレートは <code class="docutils literal notranslate"><span class="pre">start</span></code> と <code class="docutils literal notranslate"><span class="pre">end</span></code> の両方を含むので、これは次のように表現できます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ValueRange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>映画の &quot;ピア&quot; が同じ年に同じジャンルで同じスタジオからリリースされた映画として記述されている場合、この <code class="docutils literal notranslate"><span class="pre">RowRange</span></code> の例では、映画の2つ前から2つ後のピアの平均評価で各映画にアノテーションを付けます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">RowRange</span><span class="p">,</span> <span class="n">Window</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">avg_rating</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;studio&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)],</span>
<span class="gp">... </span>        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;released__year&quot;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">frame</span><span class="o">=</span><span class="n">RowRange</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mi">2</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<p>データベースがサポートしていれば、パーティション内の式の値に基づいて開始点と終了点を指定することもできます。もし <code class="docutils literal notranslate"><span class="pre">Movie</span></code> モデルの <code class="docutils literal notranslate"><span class="pre">released</span></code> フィールドが各映画の公開月を保存している場合、この <code class="docutils literal notranslate"><span class="pre">ValueRange</span></code> の例では、各映画の12ヶ月前から12ヶ月後に公開された映画の同業者の平均レーティングでアノテーションを付けます：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">ValueRange</span><span class="p">,</span> <span class="n">Window</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Movie</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">avg_rating</span><span class="o">=</span><span class="n">Window</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">expression</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;rating&quot;</span><span class="p">),</span>
<span class="gp">... </span>        <span class="n">partition_by</span><span class="o">=</span><span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;studio&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;genre&quot;</span><span class="p">)],</span>
<span class="gp">... </span>        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;released__year&quot;</span><span class="p">,</span>
<span class="gp">... </span>        <span class="n">frame</span><span class="o">=</span><span class="n">ValueRange</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mi">12</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
<div class="versionchanged">
<span class="title">Changed in Django 5.1:</span> <p><code class="docutils literal notranslate"><span class="pre">RowRange</span></code> に対して、正の整数の <code class="docutils literal notranslate"><span class="pre">start</span></code> と負の整数の <code class="docutils literal notranslate"><span class="pre">end</span></code> のサポートが追加されました。</p>
</div>
</section>
</section>
</section>
<section id="s-technical-information">
<span id="technical-information"></span><h2>技術的な情報<a class="headerlink" href="#technical-information" title="Link to this heading">¶</a></h2>
<p>以下に、ライブラリの作者に役立つ技術的な実装の詳細を示します。以下の技術的な API と例は、 Django が提供する組み込み機能を拡張する汎用的なクエリ式を作成するのに役立ちます。</p>
<section id="s-expression-api">
<span id="expression-api"></span><h3>式 (Expression) API<a class="headerlink" href="#expression-api" title="Link to this heading">¶</a></h3>
<p>クエリ式は <a class="reference internal" href="lookups.html#query-expression"><span class="std std-ref">クエリ式 (expression) API</span></a> を実装していますが、以下のようなメソッドや属性も公開しています。すべてのクエリ式は <code class="docutils literal notranslate"><span class="pre">Expression()</span></code> または関連するサブクラスを継承しなければなりません。</p>
<p>クエリ式が別の式をラップする場合、ラップされた式の適切なメソッドを呼び出す責任があります。</p>
<dl class="py class">
<dt class="sig sig-object py" id="django.db.models.Expression">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-name descname"><span class="pre">Expression</span></span><a class="reference external" href="https://github.com/django/django/blob/stable/5.1.x/django/db/models/expressions.py#L505"><span class="viewcode-link"><span class="pre">[ソース]</span></span></a><a class="headerlink" href="#django.db.models.Expression" title="Link to this definition">¶</a></dt>
<dd><dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.allowed_default">
<span class="sig-name descname"><span class="pre">allowed_default</span></span><a class="headerlink" href="#django.db.models.Expression.allowed_default" title="Link to this definition">¶</a></dt>
<dd><div class="versionadded">
<span class="title">New in Django 5.0.</span> </div>
<p>この式が <a class="reference internal" href="fields.html#django.db.models.Field.db_default" title="django.db.models.Field.db_default"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Field.db_default</span></code></a> で使えることを Django に伝えます。デフォルトは <code class="docutils literal notranslate"><span class="pre">False</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.constraint_validation_compatible">
<span class="sig-name descname"><span class="pre">constraint_validation_compatible</span></span><a class="headerlink" href="#django.db.models.Expression.constraint_validation_compatible" title="Link to this definition">¶</a></dt>
<dd><div class="versionadded">
<span class="title">New in Django 5.1.</span> </div>
<p>この式が制約の検証中に使用できることを Django に教えます。<code class="docutils literal notranslate"><span class="pre">constraint_validation_compatible</span></code> が <code class="docutils literal notranslate"><span class="pre">False</span></code> に設定された式は、ソース式を1つだけ持つ必要があります。デフォルトでは <code class="docutils literal notranslate"><span class="pre">True</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.contains_aggregate">
<span class="sig-name descname"><span class="pre">contains_aggregate</span></span><a class="headerlink" href="#django.db.models.Expression.contains_aggregate" title="Link to this definition">¶</a></dt>
<dd><p>Django に、この式が集計を含んでいて、クエリに <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code> 句を追加する必要があることを伝えます。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.contains_over_clause">
<span class="sig-name descname"><span class="pre">contains_over_clause</span></span><a class="headerlink" href="#django.db.models.Expression.contains_over_clause" title="Link to this definition">¶</a></dt>
<dd><p>この式が <a class="reference internal" href="#django.db.models.expressions.Window" title="django.db.models.expressions.Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> 式を含んでいることを Django に伝えます。これは例えば、データを変更するクエリでウィンドウ関数式を許可しないようにするのに使います。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.filterable">
<span class="sig-name descname"><span class="pre">filterable</span></span><a class="headerlink" href="#django.db.models.Expression.filterable" title="Link to this definition">¶</a></dt>
<dd><p>この式が <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.filter" title="django.db.models.query.QuerySet.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">QuerySet.filter()</span></code></a> で参照できることを Django に伝えます。デフォルトは <code class="docutils literal notranslate"><span class="pre">True</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.window_compatible">
<span class="sig-name descname"><span class="pre">window_compatible</span></span><a class="headerlink" href="#django.db.models.Expression.window_compatible" title="Link to this definition">¶</a></dt>
<dd><p>この式を <a class="reference internal" href="#django.db.models.expressions.Window" title="django.db.models.expressions.Window"><code class="xref py py-class docutils literal notranslate"><span class="pre">Window</span></code></a> のソース式として使えるかどうかを Django に伝えます。デフォルトは <code class="docutils literal notranslate"><span class="pre">False</span></code> です。</p>
</dd></dl>

<dl class="py attribute">
<dt class="sig sig-object py" id="django.db.models.Expression.empty_result_set_value">
<span class="sig-name descname"><span class="pre">empty_result_set_value</span></span><a class="headerlink" href="#django.db.models.Expression.empty_result_set_value" title="Link to this definition">¶</a></dt>
<dd><p>Django に、式が空の結果セットに対して関数を適用する際にどの値を返すべきかを 指示します。デフォルトは <a class="reference external" href="https://docs.python.org/3/library/constants.html#NotImplemented" title="(in Python v3.13)"><code class="xref py py-data docutils literal notranslate"><span class="pre">NotImplemented</span></code></a> で、式はデータベースで計算されます。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.resolve_expression">
<span class="sig-name descname"><span class="pre">resolve_expression</span></span>(<em class="sig-param"><span class="n"><span class="pre">query</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">allow_joins</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reuse</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">summarize</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">for_save</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.resolve_expression" title="Link to this definition">¶</a></dt>
<dd><p>クエリに追加する前に、式の前処理や検証を行う機会を提供します。 <code class="docutils literal notranslate"><span class="pre">resolve_expression()</span></code> は、ネストした式に対しても必ず呼び出されなければなりません。 <code class="docutils literal notranslate"><span class="pre">self</span></code> の <code class="docutils literal notranslate"><span class="pre">copy()</span></code> は、必要な変換を行ったものを返すべきです。</p>
<p><code class="docutils literal notranslate"><span class="pre">query</span></code> はバックエンドクエリの実装です。</p>
<p><code class="docutils literal notranslate"><span class="pre">allow_joins</span></code> はクエリで結合を使用するかどうかを指定する真偽値です。</p>
<p><code class="docutils literal notranslate"><span class="pre">reuse</span></code> は複数結合シナリオのための再利用可能な結合のセットです。</p>
<p><code class="docutils literal notranslate"><span class="pre">summarize</span></code> は真偽値で、<code class="docutils literal notranslate"><span class="pre">True</span></code> の場合、計算中のクエリが終端の集計クエリであることを示します。</p>
<p><code class="docutils literal notranslate"><span class="pre">for_save</span></code> は真偽値で、 <code class="docutils literal notranslate"><span class="pre">True</span></code> の場合、実行中のクエリが作成または更新を行うことを示します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.get_source_expressions">
<span class="sig-name descname"><span class="pre">get_source_expressions</span></span>()<a class="headerlink" href="#django.db.models.Expression.get_source_expressions" title="Link to this definition">¶</a></dt>
<dd><p>内部式の順序ありリストを返します。例えば：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Sum</span><span class="p">(</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">get_source_expressions</span><span class="p">()</span>
<span class="go">[F(&#39;foo&#39;)]</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.set_source_expressions">
<span class="sig-name descname"><span class="pre">set_source_expressions</span></span>(<em class="sig-param"><span class="n"><span class="pre">expressions</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.set_source_expressions" title="Link to this definition">¶</a></dt>
<dd><p>式のリストを受け取り、それを <code class="docutils literal notranslate"><span class="pre">get_source_expressions()</span></code> が返せるように格納します。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.relabeled_clone">
<span class="sig-name descname"><span class="pre">relabeled_clone</span></span>(<em class="sig-param"><span class="n"><span class="pre">change_map</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.relabeled_clone" title="Link to this definition">¶</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">self</span></code> のクローン（コピー）を返し、すべてのカラムエイリアスが再ラベル付けされます。カラムエイリアスは、サブクエリが作成される際に名前が変更されます。<code class="docutils literal notranslate"><span class="pre">relabeled_clone()</span></code> は、任意のネストされた式にも呼び出され、クローンに割り当てられるべきです。</p>
<p><code class="docutils literal notranslate"><span class="pre">change_map</span></code> は古いエイリアスを新しいエイリアスにマッピングする辞書です。</p>
<p>実装例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">relabeled_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">change_map</span><span class="p">):</span>
    <span class="n">clone</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="n">clone</span><span class="o">.</span><span class="n">expression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expression</span><span class="o">.</span><span class="n">relabeled_clone</span><span class="p">(</span><span class="n">change_map</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clone</span>
</pre></div>
</div>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.convert_value">
<span class="sig-name descname"><span class="pre">convert_value</span></span>(<em class="sig-param"><span class="n"><span class="pre">value</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expression</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">connection</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.convert_value" title="Link to this definition">¶</a></dt>
<dd><p>式が <code class="docutils literal notranslate"><span class="pre">value</span></code> をより適切な型に強制するためのフック。</p>
<p><code class="docutils literal notranslate"><span class="pre">expression</span></code> は <code class="docutils literal notranslate"><span class="pre">self</span></code> と同様です。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.get_group_by_cols">
<span class="sig-name descname"><span class="pre">get_group_by_cols</span></span>()<a class="headerlink" href="#django.db.models.Expression.get_group_by_cols" title="Link to this definition">¶</a></dt>
<dd><p>この式によって参照されるカラムのリストを返す責任があります。<code class="docutils literal notranslate"><span class="pre">get_group_by_cols()</span></code> は、任意のネストされた式に対して呼び出されるべきです。特に、<code class="docutils literal notranslate"><span class="pre">F()</span></code> オブジェクトはカラムへの参照を保持しています。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.asc">
<span class="sig-name descname"><span class="pre">asc</span></span>(<em class="sig-param"><span class="n"><span class="pre">nulls_first</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nulls_last</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.asc" title="Link to this definition">¶</a></dt>
<dd><p>昇順でソートする準備が整った式を返します。</p>
<p><code class="docutils literal notranslate"><span class="pre">nulls_first</span></code> と <code class="docutils literal notranslate"><span class="pre">nulls_last</span></code> は、null値がどのようにソートされるかを定義します。使用例については、<a class="reference internal" href="#using-f-to-sort-null-values"><span class="std std-ref">NULL 値のソートに F() を使う</span></a> を参照してください。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.desc">
<span class="sig-name descname"><span class="pre">desc</span></span>(<em class="sig-param"><span class="n"><span class="pre">nulls_first</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nulls_last</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>)<a class="headerlink" href="#django.db.models.Expression.desc" title="Link to this definition">¶</a></dt>
<dd><p>降順にソートする準備が整った式を返します。</p>
<p><code class="docutils literal notranslate"><span class="pre">nulls_first</span></code> と <code class="docutils literal notranslate"><span class="pre">nulls_last</span></code> は、null値がどのようにソートされるかを定義します。使用例については、<a class="reference internal" href="#using-f-to-sort-null-values"><span class="std std-ref">NULL 値のソートに F() を使う</span></a> を参照してください。</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="django.db.models.Expression.reverse_ordering">
<span class="sig-name descname"><span class="pre">reverse_ordering</span></span>()<a class="headerlink" href="#django.db.models.Expression.reverse_ordering" title="Link to this definition">¶</a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">order_by</span></code> 呼び出しの順序を逆にするために必要な修正を加えた <code class="docutils literal notranslate"><span class="pre">self</span></code> を返します。例として、 <code class="docutils literal notranslate"><span class="pre">NULLS</span> <span class="pre">LAST</span></code> を実装した式は、その値を <code class="docutils literal notranslate"><span class="pre">NULLS</span> <span class="pre">FIRST</span></code> に変更します。この実装が必要なのは <code class="docutils literal notranslate"><span class="pre">OrderBy</span></code> のようなソート順を実装した式だけです。このメソッドは <a class="reference internal" href="querysets.html#django.db.models.query.QuerySet.reverse" title="django.db.models.query.QuerySet.reverse"><code class="xref py py-meth docutils literal notranslate"><span class="pre">reverse()</span></code></a> がクエリセットに対して呼び出されたときに呼び出されます。</p>
</dd></dl>

</dd></dl>

</section>
<section id="s-writing-your-own-query-expressions">
<span id="writing-your-own-query-expressions"></span><h3>独自のクエリ式を書く<a class="headerlink" href="#writing-your-own-query-expressions" title="Link to this heading">¶</a></h3>
<p>他のクエリ式を使用したり、他のクエリ式と統合したりする独自のクエリ式クラスを書くことができます。組み込みの <a class="reference internal" href="#func-expressions"><span class="std std-ref">Func() 式</span></a> を使用せずに <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code> SQL関数の実装を書く例を見てみましょう。</p>
<p>SQL 関数 <code class="docutils literal notranslate"><span class="pre">COALESCE</span></code> はカラムや値のリストを受け取るように定義されています。この関数は <code class="docutils literal notranslate"><span class="pre">NULL</span></code> でない最初のカラムまたは値を返します。</p>
<p>まずはSQL生成に使用するテンプレートと、いくつかの属性を設定する <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> メソッドを定義します：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Expression</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Coalesce</span><span class="p">(</span><span class="n">Expression</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;COALESCE( </span><span class="si">%(expressions)s</span><span class="s2"> )&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expressions</span><span class="p">,</span> <span class="n">output_field</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">output_field</span><span class="o">=</span><span class="n">output_field</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">expressions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;expressions must have at least 2 elements&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="s2">&quot;resolve_expression&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is not an Expression&quot;</span> <span class="o">%</span> <span class="n">expression</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span> <span class="o">=</span> <span class="n">expressions</span>
</pre></div>
</div>
<p>少なくとも 2 つのカラムまたは値を必要とし、式であることを確認するなど、パラメータの基本的な検証を行います。ここで <a class="reference internal" href="#output-field"><span class="std std-ref">output_field</span></a> を要求しているのは、 Django が最終的な結果をどのようなモデルフィールドに代入すべきかを知るためです。</p>
<p>前処理とバリデーションを実装します。この時点では独自のバリデーションを行っていないので、ネストした式に委譲します：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">resolve_expression</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_joins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">reuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">summarize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">for_save</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">is_summary</span> <span class="o">=</span> <span class="n">summarize</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span> <span class="n">expression</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expressions</span><span class="p">):</span>
        <span class="n">c</span><span class="o">.</span><span class="n">expressions</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">resolve_expression</span><span class="p">(</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">allow_joins</span><span class="p">,</span> <span class="n">reuse</span><span class="p">,</span> <span class="n">summarize</span><span class="p">,</span> <span class="n">for_save</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">c</span>
</pre></div>
</div>
<p>次に、SQLを生成するメソッドを書きます：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">sql_expressions</span><span class="p">,</span> <span class="n">sql_params</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span><span class="p">:</span>
        <span class="n">sql</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
        <span class="n">sql_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
        <span class="n">sql_params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">template</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">template</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;expressions&quot;</span><span class="p">:</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sql_expressions</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">template</span> <span class="o">%</span> <span class="n">data</span><span class="p">,</span> <span class="n">sql_params</span>


<span class="k">def</span><span class="w"> </span><span class="nf">as_oracle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Example of vendor specific handling (Oracle in this case).</span>
<span class="sd">    Let&#39;s make the function name lowercase.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">template</span><span class="o">=</span><span class="s2">&quot;coalesce( </span><span class="si">%(expressions)s</span><span class="s2"> )&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> メソッドはカスタムキーワード引数をサポート可能で、これにより <code class="docutils literal notranslate"><span class="pre">as_vendorname()</span></code> メソッドがSQL文字列を生成するためのデータをオーバーライドできます。<code class="docutils literal notranslate"><span class="pre">as_vendorname()</span></code> メソッド内で <code class="docutils literal notranslate"><span class="pre">self</span></code> を変更するよりも、<code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> キーワード引数を使用してカスタマイズする方が好ましいです。前者は異なるデータベースバックエンドで実行する際にエラーを引き起こす可能性があるためです。クラスがクラス属性に依存してデータを定義している場合は、<code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> メソッドでオーバーライドを許可することを検討してください。</p>
<p><code class="docutils literal notranslate"><span class="pre">compiler.compile()</span></code> メソッドを使って各 <code class="docutils literal notranslate"><span class="pre">expressions</span></code> のSQLを生成し、その結果をカンマで連結します。そして、テンプレートにデータを入力し、SQLとパラメータを返します。</p>
<p>また、Oracle バックエンドに特化したカスタム実装も定義しました。Oracle バックエンドが使用されている場合は、 <code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> の代わりに <code class="docutils literal notranslate"><span class="pre">as_oracle()</span></code> 関数が呼び出されます。</p>
<p>最後に、クエリ式が他のクエリ式と協調できるようにするためのメソッドを実装します：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_source_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span>


<span class="k">def</span><span class="w"> </span><span class="nf">set_source_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expressions</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span> <span class="o">=</span> <span class="n">expressions</span>
</pre></div>
</div>
<p>どう動作するか見てみましょう：</p>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">F</span><span class="p">,</span> <span class="n">Value</span><span class="p">,</span> <span class="n">CharField</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">qs</span> <span class="o">=</span> <span class="n">Company</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">tagline</span><span class="o">=</span><span class="n">Coalesce</span><span class="p">(</span>
<span class="gp">... </span>        <span class="p">[</span><span class="n">F</span><span class="p">(</span><span class="s2">&quot;motto&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;ticker_name&quot;</span><span class="p">),</span> <span class="n">F</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">),</span> <span class="n">Value</span><span class="p">(</span><span class="s2">&quot;No Tagline&quot;</span><span class="p">)],</span>
<span class="gp">... </span>        <span class="n">output_field</span><span class="o">=</span><span class="n">CharField</span><span class="p">(),</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="gp">... </span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
<span class="gp">... </span>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tagline</span><span class="p">))</span>
<span class="gp">...</span>
<span class="go">Google: Do No Evil</span>
<span class="go">Apple: AAPL</span>
<span class="go">Yahoo: Internet Company</span>
<span class="go">Django Software Foundation: No Tagline</span>
</pre></div>
</div>
<section id="s-avoiding-sql-injection">
<span id="s-avoiding-sql-injection-in-query-expressions"></span><span id="avoiding-sql-injection"></span><span id="avoiding-sql-injection-in-query-expressions"></span><h4>SQL インジェクションを防ぐ<a class="headerlink" href="#avoiding-sql-injection" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Func</span></code> の <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> (<code class="docutils literal notranslate"><span class="pre">**extra</span></code>) および <code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> (<code class="docutils literal notranslate"><span class="pre">**extra_context</span></code>) のキーワード引数は、 (データベースドライバがエスケープするような) クエリパラメータとして渡されるのではなく、SQL 文字列に補間されるので、信頼できないユーザ入力を含んではいけません。</p>
<p>例えば、<code class="docutils literal notranslate"><span class="pre">substring</span></code> がユーザーが入力したものである場合、この関数は SQL インジェクションに対して脆弱です：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Func</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Position</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;POSITION&quot;</span>
    <span class="n">template</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%(function)s</span><span class="s2">(&#39;</span><span class="si">%(substring)s</span><span class="s2">&#39; in </span><span class="si">%(expressions)s</span><span class="s2">)&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">substring</span><span class="p">):</span>
        <span class="c1"># substring=substring is an SQL injection vulnerability!</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">substring</span><span class="o">=</span><span class="n">substring</span><span class="p">)</span>
</pre></div>
</div>
<p>この関数はパラメータなしで SQL 文字列を生成します。 <code class="docutils literal notranslate"><span class="pre">substring</span></code> はキーワード引数として <code class="docutils literal notranslate"><span class="pre">super().__init__()</span></code> に渡されるので、クエリがデータベースに送信される前に SQL 文字列に補間されます。</p>
<p>以下が修正後の実装です：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Position</span><span class="p">(</span><span class="n">Func</span><span class="p">):</span>
    <span class="n">function</span> <span class="o">=</span> <span class="s2">&quot;POSITION&quot;</span>
    <span class="n">arg_joiner</span> <span class="o">=</span> <span class="s2">&quot; IN &quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">substring</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">substring</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
</pre></div>
</div>
<p>代わりに <code class="docutils literal notranslate"><span class="pre">substring</span></code> を位置引数として渡すと、データベースクエリのパラメータとして渡されます。</p>
</section>
</section>
<section id="s-adding-support-in-third-party-database-backends">
<span id="adding-support-in-third-party-database-backends"></span><h3>サードパーティのデータベースバックエンドへのサポートを追加する<a class="headerlink" href="#adding-support-in-third-party-database-backends" title="Link to this heading">¶</a></h3>
<p>ある関数で異なる SQL 構文を使用するデータベースバックエンドを使用している場合は、 その関数のクラスに新しいメソッドを追加することで対応できます。</p>
<p>例えば Microsoft SQL Server 用のバックエンドを書くとしましょう。このバックエンドでは <a class="reference internal" href="database-functions.html#django.db.models.functions.Length" title="django.db.models.functions.Length"><code class="xref py py-class docutils literal notranslate"><span class="pre">Length</span></code></a> 関数に <code class="docutils literal notranslate"><span class="pre">LENGTH</span></code> の代わりに <code class="docutils literal notranslate"><span class="pre">LEN</span></code> という SQL を使用します。 <code class="docutils literal notranslate"><span class="pre">as_sqlserver()</span></code> という新しいメソッドを <code class="docutils literal notranslate"><span class="pre">Length</span></code> クラスに追加します：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.functions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Length</span>


<span class="k">def</span><span class="w"> </span><span class="nf">sqlserver_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">compiler</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="s2">&quot;LEN&quot;</span><span class="p">)</span>


<span class="n">Length</span><span class="o">.</span><span class="n">as_sqlserver</span> <span class="o">=</span> <span class="n">sqlserver_length</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">as_sql()</span></code> の <code class="docutils literal notranslate"><span class="pre">template</span></code> パラメータを使って SQL をカスタマイズすることもできます。</p>
<p><code class="docutils literal notranslate"><span class="pre">django.db.connection.vendor</span></code> がバックエンドに <code class="docutils literal notranslate"><span class="pre">sqlserver</span></code> を返すので、 <code class="docutils literal notranslate"><span class="pre">as_sqlserver()</span></code> を使用します。</p>
<p>サードパーティのバックエンドは、バックエンドパッケージのトップレベルの <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> ファイル、またはトップレベルの <code class="docutils literal notranslate"><span class="pre">__init__.py</span></code> からインポートされたトップレベルの <code class="docutils literal notranslate"><span class="pre">expressions.py</span></code> ファイル (またはパッケージ) に関数を登録できます。</p>
<p>使用しているバックエンドにパッチを当てたいユーザプロジェクトでは、このコードを <a class="reference internal" href="../applications.html#django.apps.AppConfig.ready" title="django.apps.AppConfig.ready"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AppConfig.ready()</span></code></a> メソッドに記述します。</p>
</section>
</section>
</section>


          </div>
        </div>
      </div>
      
        
          <div class="yui-b" id="sidebar">
            
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../contents.html">目次</a></h3>
    <ul>
<li><a class="reference internal" href="#">クエリ式 (Query Expression)</a><ul>
<li><a class="reference internal" href="#supported-arithmetic">サポートされている算術演算</a></li>
<li><a class="reference internal" href="#output-field">出力フィールド (<code class="docutils literal notranslate"><span class="pre">output_field</span></code>)</a></li>
<li><a class="reference internal" href="#some-examples">例</a></li>
<li><a class="reference internal" href="#built-in-expressions">組み込みのクエリ式</a><ul>
<li><a class="reference internal" href="#f-expressions"><code class="docutils literal notranslate"><span class="pre">F()</span></code> 式</a><ul>
<li><a class="reference internal" href="#slicing-f-expressions"><code class="docutils literal notranslate"><span class="pre">F()</span></code> 式のスライス</a></li>
<li><a class="reference internal" href="#avoiding-race-conditions-using-f"><code class="docutils literal notranslate"><span class="pre">F()</span></code> を使った競合状態の回避</a></li>
<li><a class="reference internal" href="#f-assignments-persist-after-model-save"><code class="docutils literal notranslate"><span class="pre">F()</span></code> への代入は <code class="docutils literal notranslate"><span class="pre">Model.save()</span></code> の後にも残ります</a></li>
<li><a class="reference internal" href="#using-f-in-filters">フィルタで <code class="docutils literal notranslate"><span class="pre">F()</span></code> を使う</a></li>
<li><a class="reference internal" href="#using-f-with-annotations"><code class="docutils literal notranslate"><span class="pre">F()</span></code> をアノテーションと一緒に使う</a></li>
<li><a class="reference internal" href="#using-f-to-sort-null-values">NULL 値のソートに <code class="docutils literal notranslate"><span class="pre">F()</span></code> を使う</a></li>
<li><a class="reference internal" href="#using-f-with-logical-operations">論理演算で <code class="docutils literal notranslate"><span class="pre">F()</span></code> を使う</a></li>
</ul>
</li>
<li><a class="reference internal" href="#func-expressions"><code class="docutils literal notranslate"><span class="pre">Func()</span></code> 式</a></li>
<li><a class="reference internal" href="#aggregate-expressions"><code class="docutils literal notranslate"><span class="pre">Aggregate()</span></code> 式</a></li>
<li><a class="reference internal" href="#creating-your-own-aggregate-functions">独自の集計関数 (Aggregate Function) を作る</a></li>
<li><a class="reference internal" href="#value-expressions"><code class="docutils literal notranslate"><span class="pre">Value()</span></code> 式</a></li>
<li><a class="reference internal" href="#expressionwrapper-expressions"><code class="docutils literal notranslate"><span class="pre">ExpressionWrapper()</span></code> 式</a></li>
<li><a class="reference internal" href="#conditional-expressions">条件式</a></li>
<li><a class="reference internal" href="#subquery-expressions"><code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> 式</a><ul>
<li><a class="reference internal" href="#referencing-columns-from-the-outer-queryset">外側のクエリセットからカラムを参照する</a></li>
<li><a class="reference internal" href="#limiting-a-subquery-to-a-single-column">サブクエリを単一のカラムに絞る</a></li>
<li><a class="reference internal" href="#limiting-the-subquery-to-a-single-row">サブクエリを1行に絞る</a></li>
<li><a class="reference internal" href="#exists-subqueries"><code class="docutils literal notranslate"><span class="pre">Exists()</span></code> サブクエリ</a></li>
<li><a class="reference internal" href="#filtering-on-a-subquery-or-exists-expressions"><code class="docutils literal notranslate"><span class="pre">Subquery()</span></code> または <code class="docutils literal notranslate"><span class="pre">Exists()</span></code> 式におけるフィルタリング</a></li>
<li><a class="reference internal" href="#using-aggregates-within-a-subquery-expression"><code class="docutils literal notranslate"><span class="pre">Subquery</span></code> 式の中で集計 (aggregate) を使う</a></li>
</ul>
</li>
<li><a class="reference internal" href="#raw-sql-expressions">素の SQL 式</a></li>
<li><a class="reference internal" href="#window-functions">ウィンドウ関数</a><ul>
<li><a class="reference internal" href="#frames">フレーム</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#technical-information">技術的な情報</a><ul>
<li><a class="reference internal" href="#expression-api">式 (Expression) API</a></li>
<li><a class="reference internal" href="#writing-your-own-query-expressions">独自のクエリ式を書く</a><ul>
<li><a class="reference internal" href="#avoiding-sql-injection">SQL インジェクションを防ぐ</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-support-in-third-party-database-backends">サードパーティのデータベースバックエンドへのサポートを追加する</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>前のトピックへ</h4>
    <p class="topless"><a href="lookups.html"
                          title="前の章へ">ルックアップ API リファレンス</a></p>
  </div>
  <div>
    <h4>次のトピックへ</h4>
    <p class="topless"><a href="conditional-expressions.html"
                          title="次の章へ">条件式</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>このページ</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/ref/models/expressions.txt"
            rel="nofollow">ソースコードを表示</a></li>
    </ul>
   </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="検索" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
              <h3>Last update:</h3>
              <p class="topless">1月 22, 2025</p>
          </div>
        
      
    </div>

    <div id="ft">
      <div class="nav">
    &laquo; <a href="lookups.html" title="ルックアップ API リファレンス">previous</a>
     |
    <a href="../index.html" title="API リファレンス" accesskey="U">up</a>
   |
    <a href="conditional-expressions.html" title="条件式">next</a> &raquo;</div>
    </div>
  </div>

      <div class="clearer"></div>
    </div>
  </body>
</html>